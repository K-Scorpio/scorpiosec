<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>THM: SeeTwo</title>
<meta name=description content="Platform: TryHackMe Link: SeeTwo Level: Medium In this room we have to investigate a pcap file. At first we find what looks like some benign traffic, however …"><meta name=keywords content="TryHackMe"><meta property="og:url" content="https://scorpiosec.com/posts/thm-seetwo/"><meta property="og:type" content="website"><meta property="og:title" content="THM: SeeTwo"><meta property="og:description" content="Platform: TryHackMe Link: SeeTwo Level: Medium In this room we have to investigate a pcap file. At first we find what looks like some benign traffic, however …"><meta property="og:image" content="https://scorpiosec.com/images/THM-SeeTwo/SeeTwo.png"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/THM-SeeTwo/SeeTwo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="THM: SeeTwo"><meta name=twitter:description content="Platform: TryHackMe Link: SeeTwo Level: Medium In this room we have to investigate a pcap file. At first we find what looks like some benign traffic, however …"><meta property="twitter:domain" content="https://scorpiosec.com/posts/thm-seetwo/"><meta property="twitter:url" content="https://scorpiosec.com/posts/thm-seetwo/"><meta name=twitter:image content="https://scorpiosec.com/images/THM-SeeTwo/SeeTwo.png"><link rel=canonical href=https://scorpiosec.com/posts/thm-seetwo/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://scorpiosec.com/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://scorpiosec.com/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/categories/ aria-label><span data-feather=folder></span> Categories</a></div><div class="nav-link language-switcher"><a href=/fr/posts/thm-seetwo/>Français</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://scorpiosec.com/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://scorpiosec.com/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/categories/><span data-feather=folder></span> Categories</a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>THM: SeeTwo</h1><small role=doc-subtitle></small><p class=post-date>5 min read |
<span class=post-date>November 4, 2024</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/tags/tryhackme>TryHackMe</a></li></ul></div><div class=post-content><ul><li>Platform: TryHackMe</li><li>Link: <a href=https://tryhackme.com/r/room/seetworoom>SeeTwo</a></li><li>Level: Medium</li></ul><hr><p>In this room we have to investigate a pcap file. At first we find what looks like some benign traffic, however after digging deeper we find an ELF binary containing some <code>.pyc</code> files. Decompiling one the file allows us to understand the tactics used by the attacker, and with a python script we find all the information we need.</p><h2 id=investigation>Investigation</h2><p>Right after loading the pcap file, we get an overview of the traffic. Let&rsquo;s use the <code>Conversations</code> feature in Wireshark (Statistics &ndash;> Conversations).</p><p>Under <code>IPv4</code> we find two communications:</p><ul><li><code>10.0.2.64</code> sent 2152 packets to <code>10.0.2.71</code>. We also notice that 16 MB of data were transfer, that&rsquo;s definitely worth investigating.</li><li><code>10.0.2.71</code> sent 2 packets to <code>10.0.2.3</code>.</li></ul><p><img src=/images/THM-SeeTwo/IPv4_conv.png alt="SeeTwo - Wireshark IPv4 conversations"></p><p>Under the <code>TCP</code> section, we find more information, we see that there is traffic on ports: <code>22</code> likely SSH, <code>1337</code> and <code>80</code> probably HTTP. The 16 MB of data was sent transferred via port 80.</p><p><img src=/images/THM-SeeTwo/TCP_conv.png alt="SeeTwo - Wireshark TCP conversations"></p><p>As we were thinking the traffic over port 22 is indeed SSH, we can skip it since we do not have a key for decryption at this moment.</p><p><img src=/images/THM-SeeTwo/SSH_traffic.png alt="Wireshark SSH traffic"></p><p>We cannot say for sure which protocol is running on port <code>1337</code>, so let&rsquo;s check that traffic. We&rsquo;ll begin by examining the conversation containing <code>60kB</code> of data.</p><p>After the TCP handshake we find some data being transferred on frame <code>1810</code>.</p><p><img src=/images/THM-SeeTwo/frame_1810.png alt="Wireshark 1337 traffic"></p><p>We copy the data and head to <a href=https://gchq.github.io/CyberChef/>CyberChef</a>, it turns out to be a picture.</p><p><img src=/images/THM-SeeTwo/pokeball_pic.png alt="Pokeball image"></p><p>After decoding some other data from that same conversation, we get another image.</p><p><img src=/images/THM-SeeTwo/frame_1856.png alt="Milk image"></p><p>The traffic on port <code>1337</code> seems to be a dead end, so far we only get images. We turn our attention to the HTTP conversation, but first let&rsquo;s see if we can export files related to the protocol (File &ndash;> Export Objects &ndash;> HTTP).</p><p>We get a file called <code>base64_client</code>.</p><p><img src=/images/THM-SeeTwo/base64_client.png alt="base64_client file"></p><p><img src=/images/THM-SeeTwo/base64_client_filetype.png alt="base64_client file type"></p><p>After decoding the data we end up with a Linux binary.</p><p><img src=/images/THM-SeeTwo/Linux_ELF.png alt="Linux ELF"></p><p>Running <code>strings</code> on the file we can read <code>pydata</code> at the end.</p><pre tabindex=0><code>strings decoded_base64 | tail
</code></pre><p><img src=/images/THM-SeeTwo/pydata.png alt=pydata></p><p>Assuming that it is related to Python, we can try to find all the <code>python</code> mentions from the output.</p><pre tabindex=0><code>strings decoded_base64 | grep &#34;python&#34;
</code></pre><p><img src=/images/THM-SeeTwo/strings_python.png alt="grep on python"></p><p>There are a lot of mentions about <code>CPython</code> and python <code>version 3.8</code>. We can use a tool such as <a href=https://github.com/extremecoders-re/pyinstxtractor>PyInstaller Extractor</a> to extract the content of the ELF binary.</p><pre tabindex=0><code>git clone https://github.com/extremecoders-re/pyinstxtractor
cd pyinstxtractor
python pyinstxtractor.py ELF_binary_location
</code></pre><p><img src=/images/THM-SeeTwo/pyinstxtractor.png alt="pyinstextractor command"></p><p>We get some <code>.pyc</code> files which are compiled python files. We need to use a decompiler for Python version <code>3.8</code>.</p><p><img src=/images/THM-SeeTwo/pyc_files.png alt="pyc files"></p><p>We can use <a href=https://github.com/rocky/python-decompile3>decompyle3</a> to decompile our files. After installing it we run the command below.</p><pre tabindex=0><code>decompyle3 client.pyc_location &gt; client.py
</code></pre><p><img src=/images/THM-SeeTwo/decompyle3_clientpyc.png alt="decompyle3 command"></p><p>We then read the content of <code>client.py</code>.</p><p><img src=/images/THM-SeeTwo/client_py.png alt="client.py code"></p><p>Now we have a better picture of what is happening, this code is a command-and-control communication (C2) with the IP address <code>10.0.2.64</code> and it is using port <code>1337</code>. It also leverages some <code>XOR encryption</code>, we have the key so we can do some decrytion.</p><p>The command sent by the attacker and the response he/she gets are always split into two parts <code>encoded_image</code> and <code>encoded_command</code>. These two parts are separated by <code>AAAAAAAAAA</code>.</p><p>Going back to Wireshark, we use the filter <code>tcp.port == 1337</code> and follow the TCP stream.</p><p><img src=/images/THM-SeeTwo/separator.png alt="separator in Wireshark"></p><blockquote><p>The request data is in blue and the response is in red.</p></blockquote><p>When we decrypt the entire data of a request or a response we get an image and we are tricked to believe that this is a harmless communication. The command is actually whatever comes after the separator.</p><p>Let&rsquo;s use <code>JB0=</code> which is the first encoded command sent by the attacker. We use the key below for the XOR decryption.</p><pre tabindex=0><code>MySup3rXoRKeYForCommandandControl
</code></pre><p><img src=/images/THM-SeeTwo/cmd_decoded.png alt="decoded command in CyberChef"></p><p><img src=/images/THM-SeeTwo/C2_response_decoded.png alt="decoded response in CyberChef"></p><p>The command is <code>id</code> and the response was <code>uid=1000(bella) gid=1000(bella) groups=1000(bella),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev)</code>.</p><p>If we keep doing this we will discover everything that was done by the attacker on the server, but this manual process is slow, so we will use a script.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#e06c75>scapy.all</span> <span style=color:#c678dd>import</span> <span style=color:#e06c75>rdpcap</span>, <span style=color:#e06c75>TCP</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>base64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>PCAP_FILE</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>&#34;capture.pcap&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>TARGET_PORT</span> <span style=color:#56b6c2>=</span> <span style=color:#d19a66>1337</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>SEPARATOR</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>&#34;AAAAAAAAAA&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>XOR_KEY</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>&#34;MySup3rXoRKeYForCommandandControl&#34;</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>encode</span>(<span style=color:#98c379>&#34;utf-8&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>xor_crypt</span>(<span style=color:#e06c75>data</span>, <span style=color:#e06c75>key</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>key_length</span> <span style=color:#56b6c2>=</span> <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>key</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e5c07b>bytes</span>([<span style=color:#e06c75>byte</span> <span style=color:#56b6c2>^</span> <span style=color:#e06c75>key</span>[<span style=color:#e06c75>i</span> <span style=color:#56b6c2>%</span> <span style=color:#e06c75>key_length</span>] <span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span>, <span style=color:#e06c75>byte</span> <span style=color:#56b6c2>in</span> <span style=color:#e5c07b>enumerate</span>(<span style=color:#e06c75>data</span>)])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>decode_and_decrypt</span>(<span style=color:#e06c75>payload</span>):
</span></span><span style=display:flex><span>    <span style=color:#c678dd>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#e06c75>parts</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>payload</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>split</span>(<span style=color:#e06c75>SEPARATOR</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>parts</span>) <span style=color:#56b6c2>&lt;</span> <span style=color:#d19a66>2</span>:
</span></span><span style=display:flex><span>            <span style=color:#c678dd>return</span> <span style=color:#e5c07b>None</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#e06c75>encoded_part</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>parts</span>[<span style=color:#d19a66>1</span>]
</span></span><span style=display:flex><span>        <span style=color:#e06c75>decoded_part</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>base64</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>b64decode</span>(<span style=color:#e06c75>encoded_part</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>encode</span>(<span style=color:#98c379>&#34;utf-8&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#e06c75>decrypted_data</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>xor_crypt</span>(<span style=color:#e06c75>decoded_part</span>, <span style=color:#e06c75>XOR_KEY</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#e06c75>decrypted_data</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>decode</span>(<span style=color:#98c379>&#34;utf-8&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>except</span> <span style=color:#e06c75>Exception</span> <span style=color:#c678dd>as</span> <span style=color:#e06c75>e</span>:
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;Error decoding payload: </span><span style=color:#98c379>{</span><span style=color:#e06c75>e</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#e5c07b>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>packets</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>rdpcap</span>(<span style=color:#e06c75>PCAP_FILE</span>)
</span></span><span style=display:flex><span><span style=color:#c678dd>for</span> <span style=color:#e06c75>packet</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>packets</span>:
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#e06c75>packet</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>haslayer</span>(<span style=color:#e06c75>TCP</span>):
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> <span style=color:#e06c75>packet</span>[<span style=color:#e06c75>TCP</span>]<span style=color:#56b6c2>.</span><span style=color:#e06c75>sport</span> <span style=color:#56b6c2>==</span> <span style=color:#e06c75>TARGET_PORT</span>:
</span></span><span style=display:flex><span>            <span style=color:#e06c75>payload</span> <span style=color:#56b6c2>=</span> <span style=color:#e5c07b>bytes</span>(<span style=color:#e06c75>packet</span>[<span style=color:#e06c75>TCP</span>]<span style=color:#56b6c2>.</span><span style=color:#e06c75>payload</span>)<span style=color:#56b6c2>.</span><span style=color:#e06c75>decode</span>(<span style=color:#98c379>&#34;utf-8&#34;</span>, <span style=color:#e06c75>errors</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;ignore&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#e06c75>decoded_command</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>decode_and_decrypt</span>(<span style=color:#e06c75>payload</span>)
</span></span><span style=display:flex><span>            <span style=color:#c678dd>if</span> <span style=color:#e06c75>decoded_command</span>:
</span></span><span style=display:flex><span>                <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;Decoded C2 Command:&#34;</span>, <span style=color:#e06c75>decoded_command</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>elif</span> <span style=color:#e06c75>packet</span>[<span style=color:#e06c75>TCP</span>]<span style=color:#56b6c2>.</span><span style=color:#e06c75>dport</span> <span style=color:#56b6c2>==</span> <span style=color:#e06c75>TARGET_PORT</span>:
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>            <span style=color:#e06c75>payload</span> <span style=color:#56b6c2>=</span> <span style=color:#e5c07b>bytes</span>(<span style=color:#e06c75>packet</span>[<span style=color:#e06c75>TCP</span>]<span style=color:#56b6c2>.</span><span style=color:#e06c75>payload</span>)<span style=color:#56b6c2>.</span><span style=color:#e06c75>decode</span>(<span style=color:#98c379>&#34;utf-8&#34;</span>, <span style=color:#e06c75>errors</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;ignore&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#e06c75>decoded_response</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>decode_and_decrypt</span>(<span style=color:#e06c75>payload</span>)
</span></span><span style=display:flex><span>            <span style=color:#c678dd>if</span> <span style=color:#e06c75>decoded_response</span>:
</span></span><span style=display:flex><span>                <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;Decoded C2 Response:&#34;</span>, <span style=color:#e06c75>decoded_response</span>)
</span></span></code></pre></div><p>The output of the script provides all the answers.</p><h3 id=what-is-the-first-file-that-is-read-enter-the-full-path-of-the-file>What is the first file that is read? Enter the full path of the file.</h3><p>Run the script and find the <code>cat</code> command.</p><h3 id=what-is-the-output-of-the-file-from-question-1>What is the output of the file from question 1?</h3><p>The answer is the output of the <code>cat</code> command.</p><h3 id=what-is-the-user-that-the-attacker-created-as-a-backdoor-enter-the-entire-line-that-indicates-the-user>What is the user that the attacker created as a backdoor? Enter the entire line that indicates the user.</h3><p>The first <code>echo</code> command gives you the annswer.</p><h3 id=what-is-the-name-of-the-backdoor-executable>What is the name of the backdoor executable?</h3><p>Find the command adding the <code>SUID bit</code> to the binary.</p><h3 id=what-is-the-md5-hash-value-of-the-executable-from-question-4>What is the md5 hash value of the executable from question 4?</h3><p>The attacker computed the md5 hash with the <code>md5sum</code> command, find it and read its output.</p><h3 id=what-was-the-first-cronjob-that-was-placed-by-the-attacker>What was the first cronjob that was placed by the attacker?</h3><p>Find the second <code>echo</code> command and you will get the answer.</p><h3 id=what-is-the-flag>What is the flag?</h3><p>With the third <code>echo</code> command, the attacker encoded a string, decode it and you will get the flag.</p></div><div class=prev-next><div class=prev-post><p><a href=/posts/thm-rabbithole/>&#8592;
Previous:
THM: Rabbit Hole</a></p><p class=prev-post-date>October 29, 2024</p></div><div class=next-post><p><a href=/posts/htb-blazorized/>Next:
HTB: Blazorized
&#8594;</a></p><p class=next-post-date>November 7, 2024</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#investigation>Investigation</a><ul><li><a href=#what-is-the-first-file-that-is-read-enter-the-full-path-of-the-file>What is the first file that is read? Enter the full path of the file.</a></li><li><a href=#what-is-the-output-of-the-file-from-question-1>What is the output of the file from question 1?</a></li><li><a href=#what-is-the-user-that-the-attacker-created-as-a-backdoor-enter-the-entire-line-that-indicates-the-user>What is the user that the attacker created as a backdoor? Enter the entire line that indicates the user.</a></li><li><a href=#what-is-the-name-of-the-backdoor-executable>What is the name of the backdoor executable?</a></li><li><a href=#what-is-the-md5-hash-value-of-the-executable-from-question-4>What is the md5 hash value of the executable from question 4?</a></li><li><a href=#what-was-the-first-cronjob-that-was-placed-by-the-attacker>What was the first cronjob that was placed by the attacker?</a></li><li><a href=#what-is-the-flag>What is the flag?</a></li></ul></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>